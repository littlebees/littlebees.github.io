<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>metaclass - class與instance的融合 | 記事本</title>
<meta name=keywords content><meta name=description content="動機
之前欠的要補&mldr;"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2020/10/metaclass-class%E8%88%87instance%E7%9A%84%E8%9E%8D%E5%90%88/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2020/10/metaclass-class%E8%88%87instance%E7%9A%84%E8%9E%8D%E5%90%88/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="metaclass - class與instance的融合"><meta property="og:description" content="動機
之前欠的要補&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2020/10/metaclass-class%E8%88%87instance%E7%9A%84%E8%9E%8D%E5%90%88/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-17T02:53:47+00:00"><meta property="article:modified_time" content="2020-10-17T02:53:47+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="metaclass - class與instance的融合"><meta name=twitter:description content="動機
之前欠的要補&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"metaclass - class與instance的融合","item":"https://littlebees.github.io/2020/10/metaclass-class%E8%88%87instance%E7%9A%84%E8%9E%8D%E5%90%88/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"metaclass - class與instance的融合","name":"metaclass - class與instance的融合","description":"動機 之前欠的要補\u0026hellip;\n","keywords":[],"articleBody":"動機 之前欠的要補…\n希望你知道… interpreter的結構 scheme(或lisp) class的演化 lambda的部分是interpreter的一部份code\n其實這裡的重點是struct(這裡叫record)有什麼，只要了解為什麼struct這樣設計大概就會了解到底發生什麼事\nclass \u0026 instance 把東西分成class與class之下的instance\ninstance有\n其所屬的class attribute的值 class有\nclass var的symbol(名字) class var的值 attribute的symbol(名字) method的表(method_name =\u003e real_proc) (define-record instance (class i-vals)) (define-record class (c-vars c-vals i-vars m-env)) (lambda (exp env class inst) (variant-case exp (i-varref (var) (lookup var (class-\u003ei-vars (something-\u003evalue class)) (instance-\u003ei-vals (something-\u003evalue inst)))) (c-varref (var) (lookup var (class-\u003ec-vars (something-\u003evalue class)) (class-\u003ec-vals (something-\u003evalue class)))) (i-varassign (var exp) (let ((value (eval-exp exp env class inst))) (void-\u003eexpressed (assign! var value (class-\u003ei-vars (something-\u003evalue class)) (instance-\u003ei-vals (something-\u003evalue inst)))))) (c-varassign (var exp) (let ((value (eval-exp exp env class inst)) (c-vals (class-\u003ec-vals (something-\u003evalue class)))) (void-\u003eexpressed (assign! var value (class-\u003ec-vars (something-\u003evalue class)) c-vals)))) (method (formals body) (let ((new-formals (cons 'self formals))) (open-method-\u003eexpressed (lambda (class-thunk) ;; class has not instanced, wait for the class here (lambda (args) (eval-exp body (extend-env new-formals (map expressed-\u003edenoted args) env) (make-something (class-thunk)) (make-something (car args)))))))) (meth-app (name rands) (let ((args (map (lambda (rand) (eval-exp rand env class inst)) rands))) (meth-call name (instance-\u003eclass (car args)) args))) (new-simpleinst (class-exp) (let ((inst-class (eval-exp class-exp env class inst))) (let ((new-inst (make-instance inst-class (make-vals (class-\u003ei-vars inst-class))))) (ignore (meth-call 'initialize inst-class (list new-inst))) new-inst))) (new-simpleclass (c-vars i-vars methdecls init-exp) (let ((open-methods (map (lambda (decl) (expressed-\u003eopen-method (eval-exp (decl-\u003eexp decl) env class inst))) methdecls))) (letrec ((new-class (make-class c-vars (make-vals c-vars) i-vars (extend-method-env (map decl-\u003evar methdecls) (map (lambda (open-meth) (open-meth (lambda () new-class))) open-methods) init-meth-env)))) (ignore (eval-exp init-exp env (make-something new-class) (make-nothing))) new-class))))) inherence 現在class可以往上找，所以多一個parent指到另一個class\n(define-record instance (class i-vals)) (define-record class (parent c-vars c-vals i-vars m-env)) (lambda (exp env class inst) (variant-case exp (new-class (parent-exp c-vars i-vars methdecls init-exp) (let ((parent-class (eval-exp parent-exp env class inst)) (open-methods (map (lambda (decl) (expressed-\u003eopen-method (eval-exp (decl-\u003eexp decl) env class inst))) methdecls))) (let ((new-c-vars (append c-vars (class-\u003ec-vars parent-class))) (new-i-vars (append i-vars (class-\u003ei-vars parent-class))) (new-c-vals ; NEW! (make-shared-c-vals (class-\u003ec-vals parent-class) c-vars))) (letrec ((new-class (make-class (make-something parent-class) new-c-vars new-c-vals new-i-vars (extend-method-env (map decl-\u003evar methdecls) (map (lambda (open-method) (open-method (lambda () new-class))) open-methods) (class-\u003em-env parent-class))))) (ignore (eval-exp init-exp env (make-something new-class) (make-nothing))) new-class)))) (super-meth-app (name rands) (let ((args (map (lambda (x) (eval-exp x env class inst)) rands))) (meth-call name (something-\u003evalue (class-\u003eparent (something-\u003evalue class))) (cons (something-\u003evalue inst) args)))) ;; Figure 7.1.3 : page 219 (i-varref (var) (lookup var (class-\u003ei-vars (something-\u003evalue class)) (instance-\u003ei-vals (something-\u003evalue inst)))) (c-varref (var) (lookup var (class-\u003ec-vars (something-\u003evalue class)) (class-\u003ec-vals (something-\u003evalue class)))) (i-varassign (var exp) (let ((value (eval-exp exp env class inst))) (void-\u003eexpressed (assign! var value (class-\u003ei-vars (something-\u003evalue class)) (instance-\u003ei-vals (something-\u003evalue inst)))))) (c-varassign (var exp) (let ((value (eval-exp exp env class inst)) (c-vals (class-\u003ec-vals (something-\u003evalue class)))) (void-\u003eexpressed (assign! var value (class-\u003ec-vars (something-\u003evalue class)) c-vals)))) (method (formals body) (let ((new-formals (cons 'self formals))) (open-method-\u003eexpressed (lambda (class-thunk) (lambda (args) (eval-exp body (extend-env new-formals (map expressed-\u003edenoted args) env) (make-something (class-thunk)) (make-something (car args)))))))) (meth-app (name rands) (let ((args (map (lambda (rand) (eval-exp rand env class inst)) rands))) (meth-call name (instance-\u003eclass (car args)) args))) (new-simpleinst (class-exp) (let ((inst-class (eval-exp class-exp env class inst))) (let ((new-inst (make-instance inst-class (make-vals (class-\u003ei-vars inst-class))))) (ignore (meth-call 'initialize inst-class (list new-inst))) new-inst))) ;; The following is a convenience to make old examples work (stackclass). ;; Syntax-expand can't handle simpleclass, because then it would be ;; expanded away in section 7.1 (new-simpleclass (c-vars i-vars methdecls init-exp) (eval-exp (make-new-class (make-varref 'baseobject) c-vars i-vars methdecls init-exp) env class inst)))) metaclass 從繼承那邊可以看出來，其實parent與class(struct中的ptr)很像，都是往被指到的東西中找值，所以其實我們也不用區分是class還是instance\n把class與instance和在一起，會發現，我們不需要c-vals與c-vars，因為\n如果要instance變數，就看i-vals 如果要class變數，就看class的i-vals 到這裡就可以知道，為什麼python與ruby的class都可以有自己的變數，同時可以在某種程度上當class變數用\n(define-record instance (class parent i-vars m-env i-vals)) (lambda (exp env class inst) (variant-case exp (c-varref (var) (lookup var (class-\u003ei-vars (something-\u003evalue (instance-\u003eclass (something-\u003evalue class)))) (instance-\u003ei-vals (something-\u003evalue class)))) (c-varassign (var exp) (let ((value (eval-exp exp env class inst))) (void-\u003eexpressed (assign! var value (class-\u003ei-vars (something-\u003evalue (instance-\u003eclass (something-\u003evalue class)))) (instance-\u003ei-vals (something-\u003evalue class)))))) (new-instance (class-exp parent-exp i-vars methdecls) (let ((inst-class (eval-exp class-exp env class inst)) (parent-class (eval-exp parent-exp env class inst)) (open-methods (map (lambda (decl) (expressed-\u003eopen-method (eval-exp (decl-\u003eexp decl) env class inst))) methdecls))) (let ((new-i-vars (append i-vars (class-\u003ei-vars parent-class)))) (letrec ((new-inst (make-instance (make-something inst-class) (make-something parent-class) new-i-vars (extend-method-env (map decl-\u003evar methdecls) (map (lambda (open-method) (open-method (lambda () new-inst))) open-methods) (class-\u003em-env parent-class)) (make-vals (class-\u003ei-vars inst-class))))) (ignore (meth-call 'initialize inst-class (list new-inst))) new-inst)))) ;; Figure 7.2.4 : page 228 (super-meth-app (name rands) (let ((args (map (lambda (x) (eval-exp x env class inst)) rands))) (meth-call name (something-\u003evalue (class-\u003eparent (something-\u003evalue class))) (cons (something-\u003evalue inst) args)))) ;; Figure 7.1.3 : page 219 (i-varref (var) (lookup var (class-\u003ei-vars (something-\u003evalue class)) (instance-\u003ei-vals (something-\u003evalue inst)))) (i-varassign (var exp) (let ((value (eval-exp exp env class inst))) (void-\u003eexpressed (assign! var value (class-\u003ei-vars (something-\u003evalue class)) (instance-\u003ei-vals (something-\u003evalue inst)))))) (method (formals body) (let ((new-formals (cons 'self formals))) (open-method-\u003eexpressed (lambda (class-thunk) (lambda (args) (eval-exp body (extend-env new-formals (map expressed-\u003edenoted args) env) (make-something (class-thunk)) (make-something (car args)))))))) (meth-app (name rands) (let ((args (map (lambda (rand) (eval-exp rand env class inst)) rands))) (meth-call name (something-\u003evalue (instance-\u003eclass (car args))) args))))) python 從剛剛metaclass的struct來看，先不管i-vals與i-vars與m-env\n看到下面的code的class C 可以發現 B 是 parent，而A是 class\n再看到type.__new__(ins, name,parent,attrs) attrs就是Dict，可以放值或是function，可以當成i-vals與i-vars與m-env的結合\n所以ins是 class， parent是parent，這裡生的就是instance\n剛剛是把python的metaclass與之前說的metaclass做結合， 剩下的部分就是__new__與__init__，__new__就是會丟出instance，而__init__就是instance的終點 另外super就是找繼承鍊上的instance，詳情可以看Ref的文章\nclass A(type): def __new__(ins, name, parent, attrs): print(\"in A\") attrs['ins_var_of_C'] = 101 ins.class_var_of_C = '123' ret = type.__new__(ins, name,parent,attrs) return ret def from_A(self): return 1000 class B(object): def __new__(ins): print(\"in B\") ins.b = 19 return super().__new__(ins) class C(B,metaclass=A): def __new__(ins): print(\"in C\") ins.from_here = 876 return super().__new__(ins) def __init__(self): self.a = 999 C.from_A() c = C() print(c.b) print(c.a) print(c.from_here) print(C.ins_var_of_C) print(C.class_var_of_C) print(c.ins_var_of_C) ruby 與python不同的是，class的部分(metaclass in Python)，沒有指定的機會，Ruby會自己生\n但是Ruby有eval來做許多壞事\ninstance_eval 就是用 之前提到的instance來做eval，可以想像成用instance的所有資料作為跑code的環境 class_eval 其實就是會檢查 執行的obj是不是class，其實用{class}.instance_eval是等於{class}.class_eval的\nclass Object # The hidden singleton lurks behind everyone def metaclass; class \u003c\u003c self; self; end; end def meta_eval \u0026blk; metaclass.instance_eval \u0026blk; end # Adds methods to a metaclass def meta_def name, \u0026blk meta_eval { define_method name, \u0026blk } end # Defines an instance method within a class def class_def name, \u0026blk class_eval { define_method name, \u0026blk } end end class MailTruck def self.company( name ) meta_def :company do; name; end # 吃當下的class的metaclass來加method，也就是替被執行該method的class加一個class method，叫company end end class HappyTruck \u003c MailTruck company \"Happy's -- We Bring the Mail, and That's It!\" end class Creature def self.traits( *arr ) return @traits if arr.empty? attr_accessor *arr arr.each do |trait| meta_def trait do |val| @traits ||= {} @traits[trait] = val end end class_def :initialize do self.class.traits.each do |k,v| instance_variable_set( \"@#{k}\", v ) end end class_def :hi do self.class.traits.each do |k,_| puts \"#{self.instance_eval \"self.#{k}\"}\" end end end end class A \u003c Creature traits :a, :b, :c end A.a 10 A.b 20 A.c 30 x = A.new y = A.new puts \"x content\" x.hi puts \"y content\" y.hi puts \"change\" y.b = 100 y.hi Ref EoPL1 Ch10 Metaprogramming in Ruby 你不知道的 super\n","wordCount":"1038","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2020-10-17T02:53:47Z","dateModified":"2020-10-17T02:53:47Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2020/10/metaclass-class%E8%88%87instance%E7%9A%84%E8%9E%8D%E5%90%88/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">metaclass - class與instance的融合</h1><div class=post-meta><span title='2020-10-17 02:53:47 +0000 UTC'>October 17, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#%e5%b8%8c%e6%9c%9b%e4%bd%a0%e7%9f%a5%e9%81%93 aria-label=希望你知道&mldr;>希望你知道&mldr;</a></li><li><a href=#class%e7%9a%84%e6%bc%94%e5%8c%96 aria-label=class的演化>class的演化</a><ul><li><a href=#class--instance aria-label="class & instance">class & instance</a></li><li><a href=#inherence aria-label=inherence>inherence</a></li><li><a href=#metaclass aria-label=metaclass>metaclass</a></li></ul></li><li><a href=#python aria-label=python>python</a></li><li><a href=#ruby aria-label=ruby>ruby</a></li><li><a href=#ref aria-label=Ref>Ref</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>之前欠的要補&mldr;</p><h2 id=希望你知道>希望你知道&mldr;<a hidden class=anchor aria-hidden=true href=#希望你知道>#</a></h2><ol><li>interpreter的結構</li><li>scheme(或lisp)</li></ol><h2 id=class的演化>class的演化<a hidden class=anchor aria-hidden=true href=#class的演化>#</a></h2><p>lambda的部分是interpreter的一部份code</p><p>其實這裡的重點是struct(這裡叫record)有什麼，只要了解為什麼struct這樣設計大概就會了解到底發生什麼事</p><h3 id=class--instance>class & instance<a hidden class=anchor aria-hidden=true href=#class--instance>#</a></h3><p>把東西分成class與class之下的instance</p><p>instance有</p><ul><li>其所屬的class</li><li>attribute的值</li></ul><p>class有</p><ul><li>class var的symbol(名字)</li><li>class var的值</li><li>attribute的symbol(名字)</li><li>method的表(method_name => real_proc)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-scheme data-lang=scheme><span class=line><span class=cl><span class=p>(</span><span class=nf>define-record</span> <span class=nv>instance</span> <span class=p>(</span><span class=nf>class</span> <span class=nv>i-vals</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nf>define-record</span> <span class=nv>class</span> <span class=p>(</span><span class=nf>c-vars</span> <span class=nv>c-vals</span> <span class=nv>i-vars</span> <span class=nv>m-env</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nb>exp </span><span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nf>variant-case</span> <span class=nv>exp</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>i-varref</span> <span class=p>(</span><span class=nf>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>lookup</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>instance-&gt;i-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>c-varref</span> <span class=p>(</span><span class=nf>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>lookup</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>class-&gt;c-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>class-&gt;c-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>i-varassign</span> <span class=p>(</span><span class=nf>var</span> <span class=nv>exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>value</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=nf>void-&gt;expressed</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>assign!</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>value</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>instance-&gt;i-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>))))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>c-varassign</span> <span class=p>(</span><span class=nf>var</span> <span class=nv>exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>value</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=nf>c-vals</span> <span class=p>(</span><span class=nf>class-&gt;c-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=nf>void-&gt;expressed</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>assign!</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>value</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>class-&gt;c-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>c-vals</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>method</span> <span class=p>(</span><span class=nf>formals</span> <span class=nv>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                          <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-formals</span> <span class=p>(</span><span class=nb>cons </span><span class=ss>&#39;self</span> <span class=nv>formals</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>open-method-&gt;expressed</span>
</span></span><span class=line><span class=cl>                             <span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>class-thunk</span><span class=p>)</span> <span class=c1>;; class has not instanced, wait for the class here</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=nf>eval-exp</span>
</span></span><span class=line><span class=cl>                                  <span class=nv>body</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>extend-env</span> <span class=nv>new-formals</span> <span class=p>(</span><span class=nb>map </span><span class=nv>expressed-&gt;denoted</span> <span class=nv>args</span><span class=p>)</span> <span class=nv>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>make-something</span> <span class=p>(</span><span class=nf>class-thunk</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>make-something</span> <span class=p>(</span><span class=nb>car </span><span class=nv>args</span><span class=p>))))))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>meth-app</span> <span class=p>(</span><span class=nf>name</span> <span class=nv>rands</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>args</span> <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                               <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>rand</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                             <span class=nv>rands</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                              <span class=p>(</span><span class=nf>meth-call</span> <span class=nv>name</span> <span class=p>(</span><span class=nf>instance-&gt;class</span> <span class=p>(</span><span class=nb>car </span><span class=nv>args</span><span class=p>))</span> <span class=nv>args</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>new-simpleinst</span> <span class=p>(</span><span class=nf>class-exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>inst-class</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>class-exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-inst</span> <span class=p>(</span><span class=nf>make-instance</span> <span class=nv>inst-class</span>
</span></span><span class=line><span class=cl>                                                                   <span class=p>(</span><span class=nf>make-vals</span> <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=nv>inst-class</span><span class=p>)))))</span>
</span></span><span class=line><span class=cl>                                      <span class=p>(</span><span class=nf>ignore</span> <span class=p>(</span><span class=nf>meth-call</span> <span class=ss>&#39;initialize</span> <span class=nv>inst-class</span> <span class=p>(</span><span class=nb>list </span><span class=nv>new-inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                      <span class=nv>new-inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>new-simpleclass</span> <span class=p>(</span><span class=nf>c-vars</span> <span class=nv>i-vars</span> <span class=nv>methdecls</span> <span class=nv>init-exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                   <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>open-methods</span>
</span></span><span class=line><span class=cl>                                          <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>decl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                 <span class=p>(</span><span class=nf>expressed-&gt;open-method</span>
</span></span><span class=line><span class=cl>                                                  <span class=p>(</span><span class=nf>eval-exp</span> <span class=p>(</span><span class=nf>decl-&gt;exp</span> <span class=nv>decl</span><span class=p>)</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                               <span class=nv>methdecls</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=k>letrec </span><span class=p>((</span><span class=nf>new-class</span>
</span></span><span class=line><span class=cl>                                               <span class=p>(</span><span class=nf>make-class</span>
</span></span><span class=line><span class=cl>                                                <span class=nv>c-vars</span>
</span></span><span class=line><span class=cl>                                                <span class=p>(</span><span class=nf>make-vals</span> <span class=nv>c-vars</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                <span class=nv>i-vars</span>
</span></span><span class=line><span class=cl>                                                <span class=p>(</span><span class=nf>extend-method-env</span>
</span></span><span class=line><span class=cl>                                                 <span class=p>(</span><span class=nb>map </span><span class=nv>decl-&gt;var</span> <span class=nv>methdecls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                 <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>open-meth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                        <span class=p>(</span><span class=nf>open-meth</span> <span class=p>(</span><span class=k>lambda </span><span class=p>()</span> <span class=nv>new-class</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                                      <span class=nv>open-methods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                 <span class=nv>init-meth-env</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                                       <span class=p>(</span><span class=nf>ignore</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>init-exp</span>
</span></span><span class=line><span class=cl>                                                         <span class=nv>env</span>
</span></span><span class=line><span class=cl>                                                         <span class=p>(</span><span class=nf>make-something</span> <span class=nv>new-class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                         <span class=p>(</span><span class=nf>make-nothing</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                       <span class=nv>new-class</span><span class=p>)))))</span>
</span></span></code></pre></div><h3 id=inherence>inherence<a hidden class=anchor aria-hidden=true href=#inherence>#</a></h3><p>現在class可以往上找，所以多一個parent指到另一個class</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scheme data-lang=scheme><span class=line><span class=cl><span class=p>(</span><span class=nf>define-record</span> <span class=nv>instance</span> <span class=p>(</span><span class=nf>class</span> <span class=nv>i-vals</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nf>define-record</span> <span class=nv>class</span> <span class=p>(</span><span class=nf>parent</span> <span class=nv>c-vars</span> <span class=nv>c-vals</span> <span class=nv>i-vars</span> <span class=nv>m-env</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nb>exp </span><span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nf>variant-case</span> <span class=nv>exp</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>new-class</span> <span class=p>(</span><span class=nf>parent-exp</span> <span class=nv>c-vars</span> <span class=nv>i-vars</span> <span class=nv>methdecls</span> <span class=nv>init-exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                             <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>parent-class</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>parent-exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                   <span class=p>(</span><span class=nf>open-methods</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>decl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>expressed-&gt;open-method</span>
</span></span><span class=line><span class=cl>                                            <span class=p>(</span><span class=nf>eval-exp</span> <span class=p>(</span><span class=nf>decl-&gt;exp</span> <span class=nv>decl</span><span class=p>)</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                         <span class=nv>methdecls</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-c-vars</span> <span class=p>(</span><span class=nb>append </span><span class=nv>c-vars</span> <span class=p>(</span><span class=nf>class-&gt;c-vars</span> <span class=nv>parent-class</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=nf>new-i-vars</span> <span class=p>(</span><span class=nb>append </span><span class=nv>i-vars</span> <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=nv>parent-class</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=nf>new-c-vals</span> <span class=c1>; NEW!</span>
</span></span><span class=line><span class=cl>                                      <span class=p>(</span><span class=nf>make-shared-c-vals</span> <span class=p>(</span><span class=nf>class-&gt;c-vals</span> <span class=nv>parent-class</span><span class=p>)</span> <span class=nv>c-vars</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=k>letrec </span><span class=p>((</span><span class=nf>new-class</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>make-class</span>
</span></span><span class=line><span class=cl>                                            <span class=p>(</span><span class=nf>make-something</span> <span class=nv>parent-class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                            <span class=nv>new-c-vars</span>
</span></span><span class=line><span class=cl>                                            <span class=nv>new-c-vals</span>
</span></span><span class=line><span class=cl>                                            <span class=nv>new-i-vars</span>
</span></span><span class=line><span class=cl>                                            <span class=p>(</span><span class=nf>extend-method-env</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nb>map </span><span class=nv>decl-&gt;var</span> <span class=nv>methdecls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>open-method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                    <span class=p>(</span><span class=nf>open-method</span> <span class=p>(</span><span class=k>lambda </span><span class=p>()</span> <span class=nv>new-class</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                                  <span class=nv>open-methods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>class-&gt;m-env</span> <span class=nv>parent-class</span><span class=p>)))))</span>
</span></span><span class=line><span class=cl>                                   <span class=p>(</span><span class=nf>ignore</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>init-exp</span>
</span></span><span class=line><span class=cl>                                              <span class=nv>env</span>
</span></span><span class=line><span class=cl>                                              <span class=p>(</span><span class=nf>make-something</span> <span class=nv>new-class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                              <span class=p>(</span><span class=nf>make-nothing</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                   <span class=nv>new-class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>super-meth-app</span> <span class=p>(</span><span class=nf>name</span> <span class=nv>rands</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>args</span> <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>x</span><span class=p>)</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>x</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span> <span class=nv>rands</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>meth-call</span> <span class=nv>name</span>
</span></span><span class=line><span class=cl>                                               <span class=p>(</span><span class=nf>something-&gt;value</span>
</span></span><span class=line><span class=cl>                                                <span class=p>(</span><span class=nf>class-&gt;parent</span>
</span></span><span class=line><span class=cl>                                                 <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                               <span class=p>(</span><span class=nb>cons </span><span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>)</span> <span class=nv>args</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=c1>;; Figure 7.1.3 : page 219</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>i-varref</span> <span class=p>(</span><span class=nf>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>lookup</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>instance-&gt;i-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>c-varref</span> <span class=p>(</span><span class=nf>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>lookup</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>class-&gt;c-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>class-&gt;c-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>i-varassign</span> <span class=p>(</span><span class=nf>var</span> <span class=nv>exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>value</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=nf>void-&gt;expressed</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>assign!</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>value</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>instance-&gt;i-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>))))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>c-varassign</span> <span class=p>(</span><span class=nf>var</span> <span class=nv>exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>value</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=nf>c-vals</span> <span class=p>(</span><span class=nf>class-&gt;c-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=nf>void-&gt;expressed</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>assign!</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>value</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>class-&gt;c-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>c-vals</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>method</span> <span class=p>(</span><span class=nf>formals</span> <span class=nv>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                          <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-formals</span> <span class=p>(</span><span class=nb>cons </span><span class=ss>&#39;self</span> <span class=nv>formals</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>open-method-&gt;expressed</span>
</span></span><span class=line><span class=cl>                             <span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>class-thunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=nf>eval-exp</span>
</span></span><span class=line><span class=cl>                                  <span class=nv>body</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>extend-env</span> <span class=nv>new-formals</span> <span class=p>(</span><span class=nb>map </span><span class=nv>expressed-&gt;denoted</span> <span class=nv>args</span><span class=p>)</span> <span class=nv>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>make-something</span> <span class=p>(</span><span class=nf>class-thunk</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>make-something</span> <span class=p>(</span><span class=nb>car </span><span class=nv>args</span><span class=p>))))))))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>meth-app</span> <span class=p>(</span><span class=nf>name</span> <span class=nv>rands</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>args</span> <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                               <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>rand</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                             <span class=nv>rands</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                              <span class=p>(</span><span class=nf>meth-call</span> <span class=nv>name</span> <span class=p>(</span><span class=nf>instance-&gt;class</span> <span class=p>(</span><span class=nb>car </span><span class=nv>args</span><span class=p>))</span> <span class=nv>args</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>new-simpleinst</span> <span class=p>(</span><span class=nf>class-exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>inst-class</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>class-exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-inst</span> <span class=p>(</span><span class=nf>make-instance</span> <span class=nv>inst-class</span>
</span></span><span class=line><span class=cl>                                                                   <span class=p>(</span><span class=nf>make-vals</span> <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=nv>inst-class</span><span class=p>)))))</span>
</span></span><span class=line><span class=cl>                                      <span class=p>(</span><span class=nf>ignore</span> <span class=p>(</span><span class=nf>meth-call</span> <span class=ss>&#39;initialize</span> <span class=nv>inst-class</span> <span class=p>(</span><span class=nb>list </span><span class=nv>new-inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                      <span class=nv>new-inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                  <span class=c1>;; The following is a convenience to make old examples work (stackclass).</span>
</span></span><span class=line><span class=cl>                  <span class=c1>;; Syntax-expand can&#39;t handle simpleclass, because then it would be</span>
</span></span><span class=line><span class=cl>                  <span class=c1>;; expanded away in section 7.1</span>
</span></span><span class=line><span class=cl>                  <span class=p>(</span><span class=nf>new-simpleclass</span> <span class=p>(</span><span class=nf>c-vars</span> <span class=nv>i-vars</span> <span class=nv>methdecls</span> <span class=nv>init-exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                   <span class=p>(</span><span class=nf>eval-exp</span> <span class=p>(</span><span class=nf>make-new-class</span> <span class=p>(</span><span class=nf>make-varref</span> <span class=ss>&#39;baseobject</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                             <span class=nv>c-vars</span> <span class=nv>i-vars</span> <span class=nv>methdecls</span> <span class=nv>init-exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                             <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))))</span>
</span></span></code></pre></div><h3 id=metaclass>metaclass<a hidden class=anchor aria-hidden=true href=#metaclass>#</a></h3><p>從繼承那邊可以看出來，其實parent與class(struct中的ptr)很像，都是往被指到的東西中找值，所以其實我們也不用區分是class還是instance</p><p>把class與instance和在一起，會發現，我們不需要c-vals與c-vars，因為</p><ul><li>如果要instance變數，就看i-vals</li><li>如果要class變數，就看class的i-vals</li></ul><p>到這裡就可以知道，為什麼python與ruby的class都可以有自己的變數，同時可以在某種程度上當class變數用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scheme data-lang=scheme><span class=line><span class=cl><span class=p>(</span><span class=nf>define-record</span> <span class=nv>instance</span> <span class=p>(</span><span class=nf>class</span> <span class=nv>parent</span> <span class=nv>i-vars</span> <span class=nv>m-env</span> <span class=nv>i-vals</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nb>exp </span><span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nf>variant-case</span> <span class=nv>exp</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>c-varref</span> <span class=p>(</span><span class=nf>var</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                          <span class=p>(</span><span class=nf>lookup</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>class-&gt;i-vars</span>
</span></span><span class=line><span class=cl>                                   <span class=p>(</span><span class=nf>something-&gt;value</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>instance-&gt;class</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>instance-&gt;i-vals</span>
</span></span><span class=line><span class=cl>                                   <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>c-varassign</span> <span class=p>(</span><span class=nf>var</span> <span class=nv>exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                             <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>value</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=nf>void-&gt;expressed</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=nf>assign!</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                         <span class=nv>value</span>
</span></span><span class=line><span class=cl>                                         <span class=p>(</span><span class=nf>class-&gt;i-vars</span>
</span></span><span class=line><span class=cl>                                          <span class=p>(</span><span class=nf>something-&gt;value</span>
</span></span><span class=line><span class=cl>                                           <span class=p>(</span><span class=nf>instance-&gt;class</span>
</span></span><span class=line><span class=cl>                                            <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                                         <span class=p>(</span><span class=nf>instance-&gt;i-vals</span>
</span></span><span class=line><span class=cl>                                          <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))))))</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>new-instance</span> <span class=p>(</span><span class=nf>class-exp</span> <span class=nv>parent-exp</span> <span class=nv>i-vars</span> <span class=nv>methdecls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                              <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>inst-class</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>class-exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>parent-class</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>parent-exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>open-methods</span>
</span></span><span class=line><span class=cl>                                     <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>decl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                            <span class=p>(</span><span class=nf>expressed-&gt;open-method</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>eval-exp</span> <span class=p>(</span><span class=nf>decl-&gt;exp</span> <span class=nv>decl</span><span class=p>)</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                          <span class=nv>methdecls</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-i-vars</span> <span class=p>(</span><span class=nb>append </span><span class=nv>i-vars</span> <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=nv>parent-class</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=k>letrec </span><span class=p>((</span><span class=nf>new-inst</span>
</span></span><span class=line><span class=cl>                                            <span class=p>(</span><span class=nf>make-instance</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>make-something</span> <span class=nv>inst-class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>make-something</span> <span class=nv>parent-class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                             <span class=nv>new-i-vars</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>extend-method-env</span> <span class=p>(</span><span class=nb>map </span><span class=nv>decl-&gt;var</span> <span class=nv>methdecls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                                <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>open-method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                                       <span class=p>(</span><span class=nf>open-method</span> <span class=p>(</span><span class=k>lambda </span><span class=p>()</span> <span class=nv>new-inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                                                     <span class=nv>open-methods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                                <span class=p>(</span><span class=nf>class-&gt;m-env</span> <span class=nv>parent-class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>make-vals</span> <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=nv>inst-class</span><span class=p>)))))</span>
</span></span><span class=line><span class=cl>                                    <span class=p>(</span><span class=nf>ignore</span> <span class=p>(</span><span class=nf>meth-call</span> <span class=ss>&#39;initialize</span> <span class=nv>inst-class</span> <span class=p>(</span><span class=nb>list </span><span class=nv>new-inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                    <span class=nv>new-inst</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                <span class=c1>;; Figure 7.2.4 : page 228</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>super-meth-app</span> <span class=p>(</span><span class=nf>name</span> <span class=nv>rands</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>args</span> <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>x</span><span class=p>)</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>x</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span> <span class=nv>rands</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>meth-call</span> <span class=nv>name</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>something-&gt;value</span>
</span></span><span class=line><span class=cl>                                              <span class=p>(</span><span class=nf>class-&gt;parent</span>
</span></span><span class=line><span class=cl>                                               <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nb>cons </span><span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>)</span> <span class=nv>args</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                <span class=c1>;; Figure 7.1.3 : page 219</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>i-varref</span> <span class=p>(</span><span class=nf>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                          <span class=p>(</span><span class=nf>lookup</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=nf>instance-&gt;i-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>i-varassign</span> <span class=p>(</span><span class=nf>var</span> <span class=nv>exp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                             <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>value</span> <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>exp</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=nf>void-&gt;expressed</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=nf>assign!</span> <span class=nv>var</span>
</span></span><span class=line><span class=cl>                                         <span class=nv>value</span>
</span></span><span class=line><span class=cl>                                         <span class=p>(</span><span class=nf>class-&gt;i-vars</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                         <span class=p>(</span><span class=nf>instance-&gt;i-vals</span> <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=nv>inst</span><span class=p>))))))</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>method</span> <span class=p>(</span><span class=nf>formals</span> <span class=nv>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>new-formals</span> <span class=p>(</span><span class=nb>cons </span><span class=ss>&#39;self</span> <span class=nv>formals</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                          <span class=p>(</span><span class=nf>open-method-&gt;expressed</span>
</span></span><span class=line><span class=cl>                           <span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>class-thunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                             <span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=nf>eval-exp</span>
</span></span><span class=line><span class=cl>                                <span class=nv>body</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=nf>extend-env</span> <span class=nv>new-formals</span> <span class=p>(</span><span class=nb>map </span><span class=nv>expressed-&gt;denoted</span> <span class=nv>args</span><span class=p>)</span> <span class=nv>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=nf>make-something</span> <span class=p>(</span><span class=nf>class-thunk</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=nf>make-something</span> <span class=p>(</span><span class=nb>car </span><span class=nv>args</span><span class=p>))))))))</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=nf>meth-app</span> <span class=p>(</span><span class=nf>name</span> <span class=nv>rands</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                          <span class=p>(</span><span class=k>let </span><span class=p>((</span><span class=nf>args</span> <span class=p>(</span><span class=nb>map </span><span class=p>(</span><span class=k>lambda </span><span class=p>(</span><span class=nf>rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                             <span class=p>(</span><span class=nf>eval-exp</span> <span class=nv>rand</span> <span class=nv>env</span> <span class=nv>class</span> <span class=nv>inst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                           <span class=nv>rands</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=nf>meth-call</span> <span class=nv>name</span>
</span></span><span class=line><span class=cl>                                       <span class=p>(</span><span class=nf>something-&gt;value</span> <span class=p>(</span><span class=nf>instance-&gt;class</span> <span class=p>(</span><span class=nb>car </span><span class=nv>args</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                       <span class=nv>args</span><span class=p>)))))</span>
</span></span></code></pre></div><h2 id=python>python<a hidden class=anchor aria-hidden=true href=#python>#</a></h2><p>從剛剛metaclass的struct來看，先不管i-vals與i-vars與m-env</p><p>看到下面的code的class C
可以發現 B 是 parent，而A是 class</p><p>再看到<code>type.__new__(ins, name,parent,attrs)</code>
attrs就是Dict，可以放值或是function，可以當成i-vals與i-vars與m-env的結合</p><p>所以ins是 class， parent是parent，這裡生的就是instance</p><p>剛剛是把python的metaclass與之前說的metaclass做結合，
剩下的部分就是__new__與__init__，__new__就是會丟出instance，而__init__就是instance的終點
另外super就是找繼承鍊上的instance，詳情可以看Ref的文章</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>type</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=n>ins</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=n>attrs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;ins_var_of_C&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>101</span>
</span></span><span class=line><span class=cl>        <span class=n>ins</span><span class=o>.</span><span class=n>class_var_of_C</span> <span class=o>=</span> <span class=s1>&#39;123&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nb>type</span><span class=o>.</span><span class=fm>__new__</span><span class=p>(</span><span class=n>ins</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span><span class=n>parent</span><span class=p>,</span><span class=n>attrs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>from_A</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=n>ins</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ins</span><span class=o>.</span><span class=n>b</span> <span class=o>=</span> <span class=mi>19</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__new__</span><span class=p>(</span><span class=n>ins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>C</span><span class=p>(</span><span class=n>B</span><span class=p>,</span><span class=n>metaclass</span><span class=o>=</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=n>ins</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;in C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ins</span><span class=o>.</span><span class=n>from_here</span> <span class=o>=</span> <span class=mi>876</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__new__</span><span class=p>(</span><span class=n>ins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=mi>999</span>
</span></span><span class=line><span class=cl><span class=n>C</span><span class=o>.</span><span class=n>from_A</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=n>C</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_here</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>C</span><span class=o>.</span><span class=n>ins_var_of_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>C</span><span class=o>.</span><span class=n>class_var_of_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>ins_var_of_C</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=ruby>ruby<a hidden class=anchor aria-hidden=true href=#ruby>#</a></h2><p>與python不同的是，class的部分(metaclass in Python)，沒有指定的機會，Ruby會自己生</p><p>但是Ruby有eval來做許多壞事</p><p>instance_eval 就是用 之前提到的instance來做eval，可以想像成用instance的所有資料作為跑code的環境
class_eval 其實就是會檢查 執行的obj是不是class，其實用{class}.instance_eval是等於{class}.class_eval的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>class</span> <span class=nc>Object</span>
</span></span><span class=line><span class=cl>   <span class=c1># The hidden singleton lurks behind everyone</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>metaclass</span><span class=p>;</span> <span class=k>class</span> <span class=o>&lt;&lt;</span> <span class=nb>self</span><span class=p>;</span> <span class=nb>self</span><span class=p>;</span> <span class=k>end</span><span class=p>;</span> <span class=k>end</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>meta_eval</span> <span class=o>&amp;</span><span class=n>blk</span><span class=p>;</span> <span class=n>metaclass</span><span class=o>.</span><span class=n>instance_eval</span> <span class=o>&amp;</span><span class=n>blk</span><span class=p>;</span> <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1># Adds methods to a metaclass</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>meta_def</span> <span class=nb>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>blk</span>
</span></span><span class=line><span class=cl>     <span class=n>meta_eval</span> <span class=p>{</span> <span class=n>define_method</span> <span class=nb>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>blk</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1># Defines an instance method within a class</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>class_def</span> <span class=nb>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>blk</span>
</span></span><span class=line><span class=cl>     <span class=nb>class_eval</span> <span class=p>{</span> <span class=n>define_method</span> <span class=nb>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>blk</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>class</span> <span class=nc>MailTruck</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>company</span><span class=p>(</span> <span class=nb>name</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>meta_def</span> <span class=ss>:company</span> <span class=k>do</span><span class=p>;</span> <span class=nb>name</span><span class=p>;</span> <span class=k>end</span>
</span></span><span class=line><span class=cl>     <span class=c1># 吃當下的class的metaclass來加method，也就是替被執行該method的class加一個class method，叫company</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>class</span> <span class=nc>HappyTruck</span> <span class=o>&lt;</span> <span class=no>MailTruck</span>
</span></span><span class=line><span class=cl>   <span class=n>company</span> <span class=s2>&#34;Happy&#39;s -- We Bring the Mail, and That&#39;s It!&#34;</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>class</span> <span class=nc>Creature</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>traits</span><span class=p>(</span> <span class=o>*</span><span class=n>arr</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=k>return</span> <span class=vi>@traits</span> <span class=k>if</span> <span class=n>arr</span><span class=o>.</span><span class=n>empty?</span>
</span></span><span class=line><span class=cl>     <span class=kp>attr_accessor</span> <span class=o>*</span><span class=n>arr</span>
</span></span><span class=line><span class=cl>     <span class=n>arr</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>trait</span><span class=o>|</span>
</span></span><span class=line><span class=cl>       <span class=n>meta_def</span> <span class=n>trait</span> <span class=k>do</span> <span class=o>|</span><span class=n>val</span><span class=o>|</span>
</span></span><span class=line><span class=cl>         <span class=vi>@traits</span> <span class=o>||=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>         <span class=vi>@traits</span><span class=o>[</span><span class=n>trait</span><span class=o>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>       <span class=k>end</span>
</span></span><span class=line><span class=cl>     <span class=k>end</span>
</span></span><span class=line><span class=cl>     <span class=n>class_def</span> <span class=ss>:initialize</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>       <span class=nb>self</span><span class=o>.</span><span class=n>class</span><span class=o>.</span><span class=n>traits</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=o>|</span>
</span></span><span class=line><span class=cl>         <span class=nb>instance_variable_set</span><span class=p>(</span> <span class=s2>&#34;@</span><span class=si>#{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>v</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=k>end</span>
</span></span><span class=line><span class=cl>     <span class=k>end</span>
</span></span><span class=line><span class=cl>     <span class=n>class_def</span> <span class=ss>:hi</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=nb>self</span><span class=o>.</span><span class=n>class</span><span class=o>.</span><span class=n>traits</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>k</span><span class=p>,</span><span class=n>_</span><span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=nb>puts</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=nb>self</span><span class=o>.</span><span class=n>instance_eval</span> <span class=s2>&#34;self.</span><span class=si>#{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>class</span> <span class=nc>A</span> <span class=o>&lt;</span> <span class=no>Creature</span>
</span></span><span class=line><span class=cl>  <span class=n>traits</span> <span class=ss>:a</span><span class=p>,</span> <span class=ss>:b</span><span class=p>,</span> <span class=ss>:c</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=n>A</span><span class=o>.</span><span class=n>a</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl> <span class=n>A</span><span class=o>.</span><span class=n>b</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl> <span class=n>A</span><span class=o>.</span><span class=n>c</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl> <span class=n>x</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl> <span class=n>y</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl> <span class=nb>puts</span> <span class=s2>&#34;x content&#34;</span>
</span></span><span class=line><span class=cl><span class=n>x</span><span class=o>.</span><span class=n>hi</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=s2>&#34;y content&#34;</span>
</span></span><span class=line><span class=cl><span class=n>y</span><span class=o>.</span><span class=n>hi</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=s2>&#34;change&#34;</span>
</span></span><span class=line><span class=cl><span class=n>y</span><span class=o>.</span><span class=n>b</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>y</span><span class=o>.</span><span class=n>hi</span>
</span></span></code></pre></div><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p>EoPL1 Ch10
<a href=http://ruby-metaprogramming.rubylearning.com/html/seeingMetaclassesClearly.html>Metaprogramming in Ruby</a>
<a href=https://wiki.jikexueyuan.com/project/explore-python/Class/super.html>你不知道的 super</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2020/10/netns%E8%88%87%E8%99%9B%E6%93%AC%E7%B6%B2%E8%B7%AF%E8%A3%9D%E7%BD%AE/><span class=title>« Prev</span><br><span>netns與虛擬網路裝置</span>
</a><a class=next href=https://littlebees.github.io/2020/10/rails%E5%B8%B8%E8%A6%8B%E9%9D%A2%E8%A9%A6%E5%95%8F%E9%A1%8C%E6%95%B4%E7%90%86/><span class=title>Next »</span><br><span>rails常見面試問題整理</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>