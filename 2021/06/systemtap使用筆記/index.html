<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>systemtap使用筆記 | 記事本</title>
<meta name=keywords content="Linux"><meta name=description content="動機
受不了只能一直放printf與printk來猜到底哪裡錯的日子，所以來看看systemtap
發現他真的很強!!"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2021/06/systemtap%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="systemtap使用筆記"><meta property="og:description" content="動機
受不了只能一直放printf與printk來猜到底哪裡錯的日子，所以來看看systemtap
發現他真的很強!!"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2021/06/systemtap%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-30T03:48:53+00:00"><meta property="article:modified_time" content="2021-06-30T03:48:53+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="systemtap使用筆記"><meta name=twitter:description content="動機
受不了只能一直放printf與printk來猜到底哪裡錯的日子，所以來看看systemtap
發現他真的很強!!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"systemtap使用筆記","item":"https://littlebees.github.io/2021/06/systemtap%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"systemtap使用筆記","name":"systemtap使用筆記","description":"動機 受不了只能一直放printf與printk來猜到底哪裡錯的日子，所以來看看systemtap 發現他真的很強!!\n","keywords":["Linux"],"articleBody":"動機 受不了只能一直放printf與printk來猜到底哪裡錯的日子，所以來看看systemtap 發現他真的很強!!\nsystemtap probe\nscript -\u003e C -\u003e kernel module 基本就是probe { } event: what-to-traced-type.suffix1.suffix2.... 起點與終點 begin end error 同步 kernel \u0026 module(mpat) \u0026 process(pmat) \u0026 syscall mpat: 放lib的名字，支援*,[],?等wildcard pmat: pid | \"path-to-proc\" process還可以 thread: 看生出來的thread begin end 接下面的function, statement syscall的用法: syscall(num) 或 syscall.name 或 syscall.* syscall提供4個變數: argstr, name, retvat, retstr function(pat) : 函數 pat: function-name[@source-path[{:line-number|:first-line-last-line|+relative-line-number}]] | * exported callee callees statement(pat) : 其中的code nearest 可以指定觸發的時機 call return inline 省略就是 call+inline 在handler中可以看source code中的變數(context(target) variable) $var @var(“varname@src/file.c”) 這個能access到extern或是不在scope中的變數 deref $var-\u003ea $var[0] check cxt var exists @defined(expr) pretty-print $$var print struct $var$ nested: $var$$ cast (如果struct在不同地方) @cast(tv, “timeval”, “”)-\u003etvsec tmp = \u0026@cast(tv, “timeval”, “”)[0]; tmp-\u003etvsec 沒有DWARF(debug訊息) kprobe module(mpat) funtion \u0026 statement function與module不能用wildcard nd_syscall 異步 timer ms jiffies profile 週期性的在每顆cpu上發作 略過 procfs: 在systemtap的/proc/systemtap/mod-name/中創檔案 java: 能看java input: 能吃stdin netfilter: 看netfilter perf: 看perf event python: 看python 還有硬體追蹤的功能，去man stapprobes看看吧 handler function: buildin tid, pid execname: 現在跑的proc name cpu: cpuid gettimeofday_s pp: probe目前的位置(配合pat有wildcard時可以印code檔名與行數與函數名) ppfunc: 被probe的func name print_backtrace: kernel stack print_ubacktrace: userspace stack thread_indent: 會根據stack深度噴indent exit 所有builtin 自訂 function func_name(var, ...) {} embedded c function func_name(var:type, ...):type %{ ... %} 如果要取systemtap的變數要 參數: STAP_ARG_varname 全域: STAP_GLOBAL_GET_varname() 怎麼set 一般: STAP_GLOBAL_SET_varname(val) array: STAP_GLOBAL_SET_varname(key1,...,val) c的code要加 /* pragma:read:varname */ /* pragma:write:varname */ return時要注意，使用特別語法 STAP_RETURN(expr) STAP_RETVALUE = expr 目前看到的type 數字: long 字串: string controll structrue if (expr) ... else ... while (expr) ... for (A;B;C) ... comment: #, //, /**/ str concan: strA . strB var type: numder, string var = expr scope: block, global global will be auto lock\u0026unlock global: global data structrue array: 其實是hash，只能global foreach (VALUE = [KEY1, KEY2, …] in ARRAY) STMT delete array[KEY1, KEY2, …] if ([KEY1, KEY2, …] in array) ... aggregate: 這是set，只能用systemtap提供的函數來操作 append: a \u003c\u003c\u003c @avg(a) @count(a) @hist_linear @hist_log example: probe kernel.function(\"*@net/socket.c\") { } man stapex systemtap’s module: tapset 與CSS一樣，後面會override前面 Probe point aliases probe的wrapper，或是叫decorator，用python的話來說 probe name.suffix = probe, probe.... { .. } 後面就是把name.suffix當成一般的probe，但會先跑handler他handler的東西 stap 參數 -l PROBE: List matching probes. -L PROBE: List matching probes and local variables. 據說可以用這個追函數的實際地點(像用wildcard會把所有相關的列出來) 但我在我ubuntuVM上都出不來啊 還有ubuntu 20.04上的systemtap不能從apt裝，動不了 -g: guru mode(如果要用embed c的話) all man Ref 短短的tutorial 讚 其他大大的筆記 systemtap的使用技巧 感覺值得深入去看\n","wordCount":"331","inLanguage":"en","datePublished":"2021-06-30T03:48:53Z","dateModified":"2021-06-30T03:48:53Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2021/06/systemtap%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">systemtap使用筆記</h1><div class=post-meta><span title='2021-06-30 03:48:53 +0000 UTC'>June 30, 2021</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#systemtap aria-label=systemtap>systemtap</a></li><li><a href=#ref aria-label=Ref>Ref</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>受不了只能一直放printf與printk來猜到底哪裡錯的日子，所以來看看systemtap
發現他真的很強!!</p><h2 id=systemtap>systemtap<a hidden class=anchor aria-hidden=true href=#systemtap>#</a></h2><ul><li><p>probe</p><ul><li>script -> C -> kernel module</li><li>基本就是<code>probe &lt;event> { &lt;handler> }</code></li><li>event: <code>what-to-traced-type.suffix1.suffix2....</code><ul><li>起點與終點<ul><li>begin</li><li>end</li><li>error</li></ul></li><li>同步<ul><li>kernel & module(mpat) & process(pmat) & syscall<ul><li>mpat: 放lib的名字，支援<code>*</code>,<code>[]</code>,<code>?</code>等wildcard</li><li>pmat: <code>pid | "path-to-proc"</code></li><li>process還可以<ul><li>thread: 看生出來的thread<ul><li>begin</li><li>end</li></ul></li><li>接下面的function, statement</li></ul></li><li>syscall的用法: <code>syscall(num)</code> 或 <code>syscall.name</code> 或 <code>syscall.*</code></li><li>syscall提供4個變數: <code>argstr</code>, <code>name</code>, <code>retvat</code>, <code>retstr</code><ul><li>function(pat) : 函數<ul><li>pat: <code>function-name[@source-path[{:line-number|:first-line-last-line|+relative-line-number}]] | *</code></li><li>exported</li><li>callee</li><li>callees</li></ul></li><li>statement(pat) : 其中的code<ul><li>nearest</li></ul></li><li>可以指定觸發的時機<ul><li>call</li><li>return</li><li>inline</li><li>省略就是 call+inline</li></ul></li><li>在handler中可以看source code中的變數(context(target) variable)<ul><li><code>$var</code></li><li><code>@var(“varname@src/file.c”)</code><ul><li>這個能access到extern或是不在scope中的變數</li></ul></li><li>deref<ul><li><code>$var->a</code></li><li><code>$var[0]</code></li></ul></li><li>check cxt var exists<ul><li><code>@defined(expr)</code></li></ul></li><li>pretty-print<ul><li><code>$$var</code></li></ul></li><li>print struct<ul><li><code>$var$</code></li><li>nested: <code>$var$$</code></li></ul></li><li>cast (如果struct在不同地方)<ul><li><code>@cast(tv, “timeval”, “&lt;sys/time.h>”)->tvsec</code></li><li><code>tmp = &@cast(tv, “timeval”, “&lt;sys/time.h>”)[0]; tmp->tvsec</code></li></ul></li></ul></li></ul></li></ul></li><li>沒有DWARF(debug訊息)<ul><li>kprobe<ul><li>module(mpat)</li><li>funtion & statement</li><li>function與module不能用wildcard</li></ul></li><li>nd_syscall</li></ul></li></ul></li><li>異步<ul><li>timer<ul><li>ms</li><li>jiffies</li><li>profile<ul><li>週期性的在每顆cpu上發作</li></ul></li></ul></li></ul></li><li>略過<ul><li>procfs: 在systemtap的<code>/proc/systemtap/mod-name/</code>中創檔案</li><li>java: 能看java</li><li>input: 能吃stdin</li><li>netfilter: 看netfilter</li><li>perf: 看perf event</li><li>python: 看python</li><li>還有硬體追蹤的功能，去<code>man stapprobes</code>看看吧</li></ul></li></ul></li><li>handler<ul><li>function:<ul><li>buildin<ul><li>tid, pid</li><li>execname: 現在跑的proc name</li><li>cpu: cpuid</li><li>gettimeofday_s</li><li>pp: probe目前的位置(配合pat有wildcard時可以印code檔名與行數與函數名)</li><li>ppfunc: 被probe的func name</li><li>print_backtrace: kernel stack</li><li>print_ubacktrace: userspace stack</li><li>thread_indent: 會根據stack深度噴indent</li><li>exit</li><li><a href=https://sourceware.org/systemtap/tapsets/>所有builtin</a></li></ul></li><li>自訂<ul><li><code>function func_name(var, ...) {}</code></li></ul></li><li>embedded c<ul><li><code>function func_name(var:type, ...):type %{ ... %}</code></li><li>如果要取systemtap的變數要<ul><li>參數: <code>STAP_ARG_varname</code></li><li>全域: <code>STAP_GLOBAL_GET_varname()</code><ul><li>怎麼set<ul><li>一般: <code>STAP_GLOBAL_SET_varname(val)</code></li><li>array: <code>STAP_GLOBAL_SET_varname(key1,...,val)</code></li></ul></li><li>c的code要加<ul><li><code>/* pragma:read:varname */ /* pragma:write:varname */</code></li></ul></li></ul></li></ul></li><li>return時要注意，使用特別語法<ul><li><code>STAP_RETURN(expr)</code></li><li><code>STAP_RETVALUE = expr</code></li></ul></li><li>目前看到的type<ul><li>數字: long</li><li>字串: string</li></ul></li></ul></li></ul></li><li>controll structrue<ul><li><code>if (expr) ... else ...</code></li><li><code>while (expr) ...</code></li><li><code>for (A;B;C) ...</code></li><li>comment: <code>#</code>, <code>//</code>, <code>/**/</code></li><li>str concan: strA . strB</li><li>var<ul><li>type: numder, string</li><li><code>var = expr</code></li><li>scope: block, global<ul><li>global will be auto lock&amp;unlock</li><li>global: <code>global &lt;name></code></li></ul></li></ul></li></ul></li><li>data structrue<ul><li>array: 其實是hash，只能global<ul><li><code>foreach (VALUE = [KEY1, KEY2, …] in ARRAY) STMT</code></li><li><code>delete array[KEY1, KEY2, …]</code></li><li><code>if ([KEY1, KEY2, …] in array) ...</code></li></ul></li><li>aggregate: 這是<code>set&lt;int></code>，只能用systemtap提供的函數來操作<ul><li>append: <code>a &lt;&lt;&lt; &lt;number></code></li><li><code>@avg(a) @count(a) @hist_linear @hist_log</code></li></ul></li></ul></li></ul></li><li>example: <code>probe kernel.function("*@net/socket.c") { }</code><ul><li><code>man stapex</code></li></ul></li><li>systemtap&rsquo;s module: tapset<ul><li>與CSS一樣，後面會override前面</li></ul></li><li>Probe point aliases<ul><li>probe的wrapper，或是叫decorator，用python的話來說</li><li><code>probe name.suffix = probe, probe.... { .. }</code></li><li>後面就是把<code>name.suffix</code>當成一般的probe，但會先跑handler他handler的東西</li></ul></li><li>stap 參數<ul><li>-l PROBE: List matching probes.</li><li>-L PROBE: List matching probes and local variables.<ul><li>據說可以用這個追函數的實際地點(像用wildcard會把所有相關的列出來)</li><li>但我在我ubuntuVM上都出不來啊</li><li>還有ubuntu 20.04上的systemtap不能從apt裝，動不了</li></ul></li><li>-g: guru mode(如果要用embed c的話)</li></ul></li><li><a href=https://sourceware.org/systemtap/man/index.html>all man</a></li></ul><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p><a href=https://sourceware.org/systemtap/tutorial.pdf>短短的tutorial 讚</a>
<a href=https://nanxiao.me/category/%e6%8a%80%e6%9c%af/systemtap-%e7%ac%94%e8%ae%b0/>其他大大的筆記</a>
<a href=https://blog.csdn.net/wangzuxi/category_2647873.html>systemtap的使用技巧 感覺值得深入去看</a></p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://littlebees.github.io/tags/linux/>Linux</a></li></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2021/06/flamegraph%E7%AD%86%E8%A8%98/><span class=title>« Prev</span><br><span>flamegraph筆記</span>
</a><a class=next href=https://littlebees.github.io/2021/06/grep%E5%B8%B8%E7%94%A8%E6%95%B4%E7%90%86/><span class=title>Next »</span><br><span>grep常用整理</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>