<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="AEpTGuQAkxnTOlmfF4INDna3S660LxrkyZ4BQzVbRSw">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"littlebees.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="動機 不記實際上怎麼跑與跑了什麼，只記設計與方便未來查詢的部分 畢竟這是基於linux2.6的">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Kernel Development 3rd筆記">
<meta property="og:url" content="https://littlebees.github.io/2021/06/Linux-Kernel-Development-3rd-note/index.html">
<meta property="og:site_name" content="記事本">
<meta property="og:description" content="動機 不記實際上怎麼跑與跑了什麼，只記設計與方便未來查詢的部分 畢竟這是基於linux2.6的">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2021-06-25T19:31:56.000Z">
<meta property="article:modified_time" content="2022-03-31T02:52:02.991Z">
<meta property="article:author" content="zhengcf">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://littlebees.github.io/2021/06/Linux-Kernel-Development-3rd-note/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>Linux Kernel Development 3rd筆記 | 記事本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">記事本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">寫下來，不然會忘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://littlebees.github.io/2021/06/Linux-Kernel-Development-3rd-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhengcf">
      <meta itemprop="description" content="想到什麼就寫什麼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="記事本">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux Kernel Development 3rd筆記
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-26 03:31:56" itemprop="dateCreated datePublished" datetime="2021-06-26T03:31:56+08:00">2021-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-31 10:52:02" itemprop="dateModified" datetime="2022-03-31T10:52:02+08:00">2022-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/" itemprop="url" rel="index"><span itemprop="name">System</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/Linux/Reading/" itemprop="url" rel="index"><span itemprop="name">Reading</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="動機-654">動機</h2>
<p>不記實際上怎麼跑與跑了什麼，只記設計與方便未來查詢的部分<br>
畢竟這是基於linux2.6的</p>
<span id="more"></span>
<h2 id="整體心得">整體心得</h2>
<p>讀完上一本工作原理來讀這本剛好，可以互補</p>
<p>推薦讀<br>
中斷: ch7~10<br>
mem: ch12&amp;ch15</p>
<p>省略掉<br>
ch1, 14, 20</p>
<p>簡體版的翻譯錯誤有點多要小心，覺得怪就去看原文</p>
<h2 id="ch1-2">ch1</h2>
<p>skip</p>
<h2 id="ch2-2">ch2</h2>
<h3 id="folder">folder</h3>
<table>
<thead>
<tr>
<th>folder</th>
<th>descrition</th>
</tr>
</thead>
<tbody>
<tr>
<td>arch</td>
<td>x86, amd64之類的</td>
</tr>
<tr>
<td>block</td>
<td>block device 的 IO層</td>
</tr>
<tr>
<td>crypto</td>
<td>加密API</td>
</tr>
<tr>
<td>Documentation</td>
<td>文件</td>
</tr>
<tr>
<td>drivers</td>
<td>device driver</td>
</tr>
<tr>
<td>firmware</td>
<td>driver需要的fw</td>
</tr>
<tr>
<td>fs</td>
<td>file system</td>
</tr>
<tr>
<td>include</td>
<td>kernel的header file</td>
</tr>
<tr>
<td>init</td>
<td>kernel引導與初始化</td>
</tr>
<tr>
<td>ipc</td>
<td>跨proc溝通</td>
</tr>
<tr>
<td>kernel</td>
<td>核心的kernel code(sched之類的)</td>
</tr>
<tr>
<td>lib</td>
<td>通用kernel function</td>
</tr>
<tr>
<td>mm</td>
<td>記憶體管理與virtual memory</td>
</tr>
<tr>
<td>net</td>
<td>網路</td>
</tr>
<tr>
<td>samples</td>
<td>範例</td>
</tr>
<tr>
<td>scripts</td>
<td>compile kernel用的腳本</td>
</tr>
<tr>
<td>security</td>
<td>安全模組</td>
</tr>
<tr>
<td>sound</td>
<td>聲音</td>
</tr>
<tr>
<td>usr</td>
<td>userspace的code</td>
</tr>
<tr>
<td>tools</td>
<td>linux的開發工具</td>
</tr>
<tr>
<td>virt</td>
<td>虛擬化</td>
</tr>
</tbody>
</table>
<h3 id="make-2">make</h3>
<ul>
<li><code>make menuconfig</code>
<ul>
<li>調linux的設定</li>
</ul>
</li>
<li><code>make defconfig</code>
<ul>
<li>把menuconfig的設定設成預設</li>
</ul>
</li>
<li><code>make oldconfig</code>
<ul>
<li>load從其他地方來的<code>.config</code></li>
</ul>
</li>
<li><code>make</code>
<ul>
<li>compile</li>
<li>在kernel code的根目錄會產生System.map，裡面有symbol，需要可以看</li>
</ul>
</li>
</ul>
<h3 id="kernel-dev的特點">kernel dev的特點</h3>
<ul>
<li>沒有libc與stdlib
<ul>
<li>linux有自己的工具，可以看include裡面的header，像<code>/inlucde/linux</code>就是linux kernel的函數</li>
</ul>
</li>
<li>用gnu c
<ul>
<li>inline</li>
<li>asmembly 內嵌</li>
<li>likely, unlikely之類的if優化</li>
</ul>
</li>
<li>沒有mem保護
<ul>
<li>沒有seg fault，只剩panic</li>
</ul>
</li>
<li>幾乎不能用floating point</li>
<li>kernel stack十分小，並隨arch不同而有改變</li>
<li>同步很重要
<ul>
<li>preempt</li>
<li>smp(多對稱處理器，多cpu)</li>
</ul>
</li>
</ul>
<h2 id="ch3-2">ch3</h2>
<p>proc</p>
<h3 id="相關struct">相關struct</h3>
<ul>
<li>struct task_struct
<ul>
<li>在<code>&lt;linux/sched.h&gt;</code></li>
<li>proc的DS，有
<ul>
<li>pid</li>
<li>addr space</li>
<li>打開的文件 等…</li>
</ul>
</li>
</ul>
</li>
<li>struct thraed_info
<ul>
<li>在<code>&lt;asm/thraed_info.h&gt;</code></li>
<li>放在kernel stack上，用以找到task_struct
<ul>
<li>為什麼不直接放task_struct</li>
</ul>
</li>
<li>放proc中與arch有關的訊息
<ul>
<li>可以想成goroutines的struct P</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="proc-state">proc state</h3>
<ul>
<li>正在跑、可以跑
<ul>
<li>TASK_RUNNING</li>
</ul>
</li>
<li>睡
<ul>
<li>TASK_INTERRUPTABLE
<ul>
<li>等interrupt或其他或signal</li>
</ul>
</li>
<li>TASK_UNINTERRUPTABLE
<ul>
<li>不管signal，其他與TASK_INTERRUPTABLE一樣</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="clone-syscall">clone syscall</h3>
<ul>
<li>fork
<ul>
<li><code>clone(SIGCHID, 0)</code></li>
</ul>
</li>
<li>kthread
<ul>
<li><code>clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, 0)</code>
<ul>
<li>VM: virtual mem</li>
<li>FS: file system</li>
<li>FILES: opend files</li>
<li>SIGHAND: signal handler</li>
</ul>
</li>
</ul>
</li>
<li>vfork (會sync執行的fork)
<ul>
<li><code>clone(CLONE_VFORK | CLONE_VM | SIGCHID, 0)</code></li>
</ul>
</li>
</ul>
<h2 id="ch4-2">ch4</h2>
<p>proc scheduler</p>
<h3 id="proc吃">proc吃?</h3>
<ul>
<li>IO
<ul>
<li>scheduler應該要多拉吃IO的proc
<ul>
<li>不然response time會變慢</li>
</ul>
</li>
<li>但throughput會低</li>
</ul>
</li>
<li>cpu
<ul>
<li>scheduler應該多拉吃cpu的proc
<ul>
<li>不然throughput會變慢</li>
</ul>
</li>
<li>但response time會變慢</li>
</ul>
</li>
</ul>
<h3 id="time-slice">time slice</h3>
<ul>
<li>一個proc能佔cpu多少時間
<ul>
<li>太長
<ul>
<li>對吃cpu有利</li>
<li>對吃IO不利</li>
<li>高throughput</li>
<li>差response time</li>
<li>cxt switch的總計花費時間小</li>
</ul>
</li>
<li>太短
<ul>
<li>對吃cpu不利</li>
<li>對吃IO有利</li>
<li>低throughput</li>
<li>好response time</li>
<li>cxt switch的總計花費時間多</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="proc優先級">proc優先級</h3>
<ul>
<li>nice
<ul>
<li>-20~19</li>
<li>越小越優先</li>
</ul>
</li>
<li>real-time priority
<ul>
<li>0~99</li>
<li>越大越優先</li>
<li>RT proc永遠優先於普通proc</li>
</ul>
</li>
<li>兩個是各自獨立的系統</li>
</ul>
<h3 id="公平調度-CFS">公平調度(CFS)</h3>
<ul>
<li>概念
<ul>
<li>依據cpu的使用比例分配
<ul>
<li>分配到的時間與系統負載密切相關</li>
</ul>
</li>
<li>搶的時機是如果有proc花的使用比比當前proc少，就換上去</li>
<li>每個proc預設拿到<code>1/n</code>個cpu時間
<ul>
<li>n是proc個數</li>
<li>就是想像一共有<code>proc個數 個cpu</code></li>
<li>cpu時間在書中叫<code>目標延遲</code></li>
</ul>
</li>
<li>nice就是原本的<code>1/n</code>再乘上nice換出來的比值</li>
</ul>
</li>
<li>實作
<ul>
<li>計時
<ul>
<li>在<code>&lt;linux/sched.h&gt;</code></li>
<li>struct_sched_entity
<ul>
<li>vruntime
<ul>
<li>會記錄運行時間</li>
<li>以及以proc總數做標準化</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>choose proc
<ul>
<li>挑vruntime最小的</li>
</ul>
</li>
<li>sched的interface
<ul>
<li><code>schedule()</code>
<ul>
<li>如果要睡覺
<ul>
<li>就是設定proc state再call這個</li>
<li>假喚醒
<ul>
<li>如果state是TASK_INTERRUPTABLE就會被signal叫醒</li>
<li>所以要檢查喚醒後發生什麼事</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cxt switch
<ul>
<li>在<code>&lt;asm/mmu_context.h&gt;</code>
<ul>
<li>switch_mm換virtual mem</li>
</ul>
</li>
<li>在<code>&lt;asm/system.h&gt;</code>
<ul>
<li>switch_to換cpu state</li>
</ul>
</li>
</ul>
</li>
<li>preempt
<ul>
<li>用一個flag，<code>need_resched</code>去看該不該被搶</li>
<li>誰可以設?
<ul>
<li>scheduler</li>
<li>proc自己</li>
</ul>
</li>
<li>preempt發生時機
<ul>
<li>user preempt
<ul>
<li>從syscall回到userspace</li>
<li>從中斷處理程序回到userspace</li>
</ul>
</li>
<li>kernel preempt
<ul>
<li>中斷處理程序結束，且回到kernel space之前</li>
<li>kernel的code再一次可以被搶的時候
<ul>
<li><code>need_resched</code>被設</li>
<li><code>preempt_count</code>是0 (在thread_info)</li>
</ul>
</li>
<li>kernel的code被block時</li>
<li>kernel的code調用<code>schedule()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>RT schedule
<ul>
<li>SCHED_FIFO
<ul>
<li>proc一直跑，除非
<ul>
<li>block</li>
<li>自己想換</li>
</ul>
</li>
</ul>
</li>
<li>SCHED_RR
<ul>
<li>有time slice的SCHED_FIFO</li>
<li>低優先無法搶高優先即使對方的time slice花完了</li>
</ul>
</li>
<li>都是soft rt</li>
</ul>
</li>
</ul>
<h2 id="ch5-2">ch5</h2>
<p>syscall在上一篇筆記就說了，所以這裡focus在一些之前沒提到的東西</p>
<ul>
<li>asmlinkage
<ul>
<li>叫compiler只能從stack拿參數</li>
</ul>
</li>
<li>參數驗證
<ul>
<li>ptr的addr是userspace的addr</li>
<li>ptr的addr在proc的addr space中</li>
<li>讀寫要符合原本的讀寫限制</li>
<li>參數有效
<ul>
<li>pid有效</li>
<li>檔案有效</li>
</ul>
</li>
</ul>
</li>
<li>process context
<ul>
<li>syscall是在process cxt</li>
<li>會睡覺</li>
<li>會被搶</li>
</ul>
</li>
<li>在你想多加一個syscall(衝動)之前，可以
<ul>
<li>用dev file實現read, write，配合ioctl</li>
<li>創其他操作介面，像semaphore可以像file一樣操作</li>
<li>sysfs</li>
</ul>
</li>
</ul>
<h2 id="ch6-2">ch6</h2>
<h3 id="list-elment">list_elment</h3>
<ul>
<li>在<code>&lt;linux/list.h&gt;</code></li>
<li>Linked List (bidiretion)</li>
<li>用法是在自己的struct中放一個list_elment
<ul>
<li>因為c沒泛型!!</li>
<li>c應該叫mem描述語言才對</li>
</ul>
</li>
<li>沒有特別需求時優先用list</li>
</ul>
<h3 id="kfifo">kfifo</h3>
<ul>
<li>在<code>&lt;linux/kfifo.h&gt;</code></li>
<li>Queue</li>
<li>遇到 consumer/producer時用</li>
</ul>
<h3 id="idr">idr</h3>
<ul>
<li>在<code>&lt;linux/idr.h&gt;</code></li>
<li>Hash table
<ul>
<li><code>uid</code>(int) -&gt; <code>void *</code></li>
</ul>
</li>
<li>要mapping時就用</li>
</ul>
<h3 id="rbtree">rbtree</h3>
<ul>
<li>在<code>&lt;linux/rbtree.h&gt;</code></li>
<li>紅黑樹</li>
<li>沒有find與insert，要自己寫
<ul>
<li>因為c沒泛型!!</li>
</ul>
</li>
<li>大量data與反覆search就用</li>
</ul>
<h2 id="ch7-2">ch7</h2>
<h3 id="中斷-IRQ">中斷(IRQ)</h3>
<ul>
<li>就是一個數字</li>
<li>異常與中斷很像
<ul>
<li>但異常要與cpu時鐘同步</li>
</ul>
</li>
</ul>
<h3 id="中斷上下文">中斷上下文</h3>
<ul>
<li>不會block(睡覺)</li>
<li>當他出現時，一定是
<ul>
<li>打斷了某個proc</li>
<li>甚至是，不同irq stack的irq</li>
</ul>
</li>
</ul>
<h3 id="上半段-與-下半段">上半段 與 下半段</h3>
<ul>
<li>上半段: 馬上處理</li>
<li>下半段: 原本中斷中可以之後再處理的</li>
</ul>
<h3 id="request-irq">request_irq</h3>
<ul>
<li>註冊irq</li>
<li>會sleep</li>
</ul>
<h3 id="reenter">reenter?</h3>
<ul>
<li>irq被call時，該irq會被mask起來，其他cpu看不到</li>
</ul>
<h3 id="IRQF-SHARED">IRQF_SHARED</h3>
<ul>
<li>多個dev用同一個irq</li>
<li>所以
<ul>
<li>dev的addr唯一，也就是可以區分不同device</li>
<li>code有辦法對應不同device</li>
</ul>
</li>
</ul>
<h3 id="procs-interrupts">/procs/interrupts</h3>
<ul>
<li>PC上所有irq的資訊</li>
</ul>
<h3 id="中斷控制器">中斷控制器</h3>
<ul>
<li>停用
<ul>
<li>cpu上的整個中斷
<ul>
<li>這樣這個cpu上就不會被preempt</li>
<li>但其他cpu還是可以中斷!!</li>
</ul>
</li>
<li>所有cpu的某個中斷</li>
</ul>
</li>
<li>看<code>&lt;asm/system.h&gt;</code>與<code>&lt;asm/irq.h&gt;</code></li>
</ul>
<h2 id="ch8-2">ch8</h2>
<p>中斷，下半段</p>
<h3 id="softirq">softirq</h3>
<ul>
<li>同一個softirq可以同時跑在其他cpu上</li>
<li>靜態註冊 (compile-time)
<ul>
<li>在<code>&lt;linux/interrupt.h&gt;</code>
<ul>
<li>struct softirq_action</li>
</ul>
</li>
<li>softirq放在array中(32個)</li>
</ul>
</li>
<li>中斷上下文</li>
<li>softirq沒辦法搶其他的softirq
<ul>
<li>softirq只會被irq搶!!</li>
</ul>
</li>
<li>跑什麼softirq
<ul>
<li>irq handler在return前會標</li>
</ul>
</li>
<li>什麼時候跑softirq?
<ul>
<li>irq handler在return時</li>
<li>在softirqd中</li>
<li>有人去看還有哪些softirq還沒跑與直接執行softirq的時候</li>
</ul>
</li>
</ul>
<h3 id="tasklet">tasklet</h3>
<ul>
<li>同一個tasklet<strong>不</strong>可以同時跑在其他cpu上</li>
<li>動態註冊
<ul>
<li>在<code>&lt;linux/interrupt.h&gt;</code>
<ul>
<li>struct tasklet_struct</li>
<li>有執行狀態
<ul>
<li>所以其他cpu不會跑正在跑的tasklet</li>
</ul>
</li>
</ul>
</li>
<li>tasklet放在cpu上的linked list
<ul>
<li>tasklet_vec</li>
<li>tasklet_hi_vec (hi是high)</li>
<li>所以可以動態加</li>
</ul>
</li>
</ul>
</li>
<li>中斷上下文</li>
<li>tasklet就是掛在兩個softirq上
<ul>
<li>把task往裡面放，需要時就跑</li>
</ul>
</li>
</ul>
<h3 id="ksoftirqd">ksoftirqd</h3>
<ul>
<li>每個cpu上會有一個</li>
<li>處理大量softirq
<ul>
<li>在最低nice的kthread中去調用還沒跑的softirq</li>
</ul>
</li>
</ul>
<h3 id="work-queue">work queue</h3>
<ul>
<li>proc上下文
<ul>
<li>可以allocate大mem</li>
<li>semaphore</li>
<li>用block IO</li>
</ul>
</li>
<li>每個cpu一個queue與kthread，跑task
<ul>
<li>我們需要一個可以看到所有cpu的struct
<ul>
<li>在<code>&lt;linux/workqueue.h&gt;</code>
<ul>
<li>struct workqueue_struct
<ul>
<li>放workqueue訊息</li>
</ul>
</li>
</ul>
</li>
<li>proc叫<code>event/n</code>
<ul>
<li>在<code>&lt;kernel/workqueue.c&gt;</code>
<ul>
<li>struct cpu_workqueue_struct
<ul>
<li>就是queue</li>
</ul>
</li>
</ul>
</li>
<li>在<code>&lt;linux/workqueue.h&gt;</code>
<ul>
<li>struct work_struct
<ul>
<li>就是task</li>
</ul>
</li>
</ul>
</li>
<li>每個cpu上會有一個</li>
<li>n是cpu編號</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="how-to-lock">how to lock</h3>
<ul>
<li>proc cxt與bottom half分享data
<ul>
<li>鎖bottom half</li>
<li>拿鎖</li>
</ul>
</li>
<li>irq cxt與bottom half分享data
<ul>
<li>鎖irq</li>
<li>拿鎖</li>
</ul>
</li>
<li>irq -&gt; softirq/tasklet -&gt; proc
<ul>
<li>如果要和上一層share data
<ul>
<li>鎖上一層!!
<ul>
<li>防smp與preempt</li>
</ul>
</li>
<li>拿鎖</li>
</ul>
</li>
<li>可以看<span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvaHRtbC92NC4xMy9rZXJuZWwtaGFja2luZy9sb2NraW5nLmh0bWw=">Unreliable Guide To Locking<i class="fa fa-external-link-alt"></i></span>有詳細的解釋</li>
</ul>
</li>
</ul>
<h2 id="ch9-10">ch9&amp;10</h2>
<h3 id="怎麼等鎖">怎麼等鎖</h3>
<ul>
<li>busy waiting
<ul>
<li>都能用</li>
</ul>
</li>
<li>sleep
<ul>
<li>only in proc ctx</li>
</ul>
</li>
</ul>
<h3 id="要同步的原因是">要同步的原因是</h3>
<ul>
<li>in userspace</li>
<li>preempt</li>
<li>re schedule</li>
<li>in kernel space
<ul>
<li>irq</li>
<li>softirq/tasklet</li>
<li>preempt</li>
<li>sleep &amp; sync with userspace</li>
<li>smp</li>
</ul>
</li>
</ul>
<h3 id="struct什麼時候加鎖">struct什麼時候加鎖</h3>
<ul>
<li>kernel struct大部分都要</li>
<li>有其他proc可以access</li>
<li>任何人都看的到的</li>
</ul>
<h3 id="原子性與順序性">原子性與順序性</h3>
<ul>
<li>原子性
<ul>
<li>執行期間不打斷，只有兩個case
<ul>
<li>沒有跑</li>
<li>跑完了</li>
</ul>
</li>
</ul>
</li>
<li>順序性
<ul>
<li>ABC分散在不同中，也要ABC去跑
<ul>
<li>用lock只能保證，ABC一起跑，一起不跑</li>
<li>用semaphore可以幹出來</li>
<li>主要用barrier</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="讀寫鎖-RW">讀寫鎖(RW)</h3>
<ul>
<li>只能有下面的其中一種case
<ul>
<li>1寫</li>
<li>多讀</li>
</ul>
</li>
<li>有利於<strong>讀</strong>
<ul>
<li>只要一堆讀，寫就只要等就飽了</li>
</ul>
</li>
</ul>
<h3 id="工具-2">工具</h3>
<ul>
<li>atomic_t</li>
<li>spinlock
<ul>
<li>busy waiting
<ul>
<li>使用時不能sleep</li>
<li>不然就是增加整體的response time</li>
</ul>
</li>
<li>如果lock時間小於2次ctx switch才有利</li>
<li>no recur
<ul>
<li>不能鎖了又鎖</li>
</ul>
</li>
<li>在irq中用的話
<ul>
<li>先關irq</li>
<li>不然被中斷，另一irq又拿同一個鎖的話…</li>
</ul>
</li>
<li>有RW版</li>
<li>禁止preempt
<ul>
<li>持有spinlock就是禁止preempt</li>
</ul>
</li>
</ul>
</li>
<li>semaphore
<ul>
<li>sleep
<ul>
<li>only in proc ctx</li>
</ul>
</li>
<li>任何持有人都可以上鎖或解鎖!!</li>
<li>可以超過一個人到critical zone</li>
<li>有RW版</li>
</ul>
</li>
<li>mutex
<ul>
<li>sleep
<ul>
<li>only in proc ctx</li>
</ul>
</li>
<li>上鎖的人才能解鎖</li>
<li>只有一個人能到critical zone</li>
<li>可以recur</li>
<li>可以處理priority inversion</li>
</ul>
</li>
<li>complete variable
<ul>
<li>cond var</li>
</ul>
</li>
<li>seq lock
<ul>
<li>實作
<ul>
<li>有一個acc</li>
<li>當write拿鎖時，會<code>acc++</code></li>
<li>read時就是確認開始與結束的acc值是不是一樣
<ul>
<li>確認中間沒有write</li>
</ul>
</li>
<li>也可以透過acc是不是偶數看寫結束語否</li>
</ul>
</li>
<li>有利於<strong>寫</strong></li>
</ul>
</li>
<li>mem barrier
<ul>
<li>barrier前面的code跑完前，絕對不會跑後面去</li>
<li>起因於
<ul>
<li>指令重排，所以有些指令會跑到後面去</li>
<li>前半部的code不會到reorder到後面去</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="priority-inversion">priority inversion</h3>
<ul>
<li>一般來說是在RT才會提，但想到就記一下</li>
<li>情境
<ul>
<li>pri最小(A)拿到lock中被中斷</li>
<li>pri高的(C)想拿lock，但拿不到!!
<ul>
<li>像spinlock會busy waiting</li>
</ul>
</li>
<li>pri高的跑不動，time slice吃完</li>
<li>有下一個pri比較低的(B)，來了，也做完了!?</li>
<li>但pri高的還沒做完阿!!</li>
</ul>
</li>
<li>起因
<ul>
<li>lock的效果會影響優先權，但是沒有納入原有優先權的系統中
<ul>
<li>像只要有人拿了spiclock，那他在這一塊就是最優先的</li>
<li>不管其他優先權怎麼設，bust waiting就是wait，沒有轉圜的機會</li>
<li>同時也無法打斷，不然就不是crtical zone了</li>
</ul>
</li>
</ul>
</li>
<li>解法
<ul>
<li>大方向: crtical zone要先跑!!
<ul>
<li>要改crtical zone的優先權
<ul>
<li>改到與現在最高的一樣高</li>
<li>改到沒有人比crtical zone高</li>
</ul>
</li>
</ul>
</li>
<li>Priority inheritance
<ul>
<li>在crtical zone時，遇到更高的proc同時要進來</li>
<li>把crtical zone的優先權拉到與那個proc一樣高</li>
<li>跑完crtical zone就降回去</li>
</ul>
</li>
<li>Priority ceiling protocol
<ul>
<li>在crtical zone時拉到最高</li>
<li>跑完crtical zone就降回去</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch11">ch11</h2>
<h3 id="怎麼算1秒">怎麼算1秒</h3>
<ul>
<li>系統計時器會依一定頻率(tick rate)打中斷
<ul>
<li>這樣kernel知道兩次中斷之間的間隔時間(tick)</li>
</ul>
</li>
<li>HZ就是1sec打幾次
<ul>
<li>HZ可以改!!</li>
<li>HZ越高
<ul>
<li>時間精準度越高
<ul>
<li>連帶與時間有關的都會變準
<ul>
<li>poll, select</li>
<li>preempt</li>
</ul>
</li>
</ul>
</li>
<li>system load上升</li>
</ul>
</li>
<li>這是kernel用的
<ul>
<li>userspace的叫USER_HZ</li>
</ul>
</li>
</ul>
</li>
<li>1sec = tick * HZ</li>
</ul>
<h3 id="開機多久了">開機多久了</h3>
<ul>
<li>jiffies
<ul>
<li>紀錄系統計時器中斷打了幾次</li>
</ul>
</li>
<li>jiffies/HZ =&gt; 開機多久</li>
</ul>
<h3 id="硬體">硬體</h3>
<ul>
<li>RTC
<ul>
<li>bios上存時間(幾點幾分之類的)的</li>
<li>就算電腦關機，還是藉由CMOS繼續跑</li>
<li>開機時初始化xtime變數</li>
</ul>
</li>
<li>系統計時器
<ul>
<li>由kernel設定tick rate</li>
</ul>
</li>
</ul>
<h3 id="關於proc的計時">關於proc的計時</h3>
<ul>
<li>每一次中斷時就把當前proc狀態(idle, run…)的變數遞增一次
<ul>
<li>如果在這中斷之間多次換狀態?
<ul>
<li>不管，現在他在這個狀態，這一段時間都是這個狀態的</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="如何delay">如何delay</h3>
<p>delay執行，不應該在有lock時或是關閉中斷後發生</p>
<ul>
<li>busy wait
<ul>
<li>base on jiffies</li>
</ul>
</li>
<li>short delay
<ul>
<li>如果要的delay比tick小</li>
<li>用<code>udelay(),ndelay(),mdelay()</code>
<ul>
<li>裡面其實也是loop，但是kernel知道他會跑多久且不用jiffies</li>
</ul>
</li>
</ul>
</li>
<li><code>schedule_timeout()</code>
<ul>
<li>讓task睡，在超過指定時間後跑
<ul>
<li>沒辦法說很精確在時間到就馬上跑</li>
</ul>
</li>
<li>soft rt</li>
</ul>
</li>
</ul>
<h2 id="ch12">ch12</h2>
<p>kernel space的mem</p>
<h3 id="整體">整體</h3>
<ul>
<li>phy
<ul>
<li>mem
<ul>
<li>byte</li>
<li>word</li>
</ul>
</li>
<li>cpu
<ul>
<li>page</li>
</ul>
</li>
</ul>
</li>
<li>kernel
<ul>
<li>struct zone
<ul>
<li>在<code>&lt;linux/mmzone.h&gt;</code></li>
<li>struct page
<ul>
<li>在<code>&lt;linux/mm_types.h&gt;</code></li>
<li>對應到<strong>實體的page</strong></li>
<li>再從page換成addr
<ul>
<li>alloc_pages -&gt; page_address</li>
<li>kmalloc
<ul>
<li>不能要求<code>ZONE_HIGHEM</code>
<ul>
<li>因為可能還沒分配邏輯addr</li>
<li>用alloc_pages</li>
</ul>
</li>
</ul>
</li>
<li>上面都是
<ul>
<li>連續的page</li>
<li>可以sleep時用<code>GFP_KERNEL</code></li>
<li>不可以sleep時用<code>GFP_ATOMIC</code></li>
</ul>
</li>
<li>vmalloc
<ul>
<li>可能不連續的page</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>不同page在不同位置，所以有不同區</li>
<li>4種
<ul>
<li>ZONE_DMA</li>
<li>ZONE_DMA32
<ul>
<li>only for 32bits device</li>
</ul>
</li>
<li>ZONE_NORMAL</li>
<li>ZONE_HIGHEM
<ul>
<li>high mem用，不能用永久map到kernel addr空間</li>
<li>想想kernel都是用<strong>低</strong>的mem，所以高的其實算是userspace的
<ul>
<li>如果要用就要map
<ul>
<li>永久: kmap (low與high都能用，會睡覺)</li>
<li>臨時: kmap_atomic (不會睡，但是會被下一個)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>slab
<ul>
<li>在快取記憶體上(kmem_cache)開一個list當成object pool
<ul>
<li>之後重複利用裡面已經存在的obj</li>
<li>slab就是list上的node，node裡面放obj</li>
</ul>
</li>
<li>struct slab
<ul>
<li>在<code>&lt;mm/slab.c&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="額外">額外</h3>
<ul>
<li>stack
<ul>
<li>每個proc有
<ul>
<li>kernel stack
<ul>
<li>1~2 page (根據arch)</li>
<li>原本中斷也是用被中斷的proc的stack</li>
<li>kernel stack本來就很小，還是別吧
<ul>
<li>最後有了interrupt stack</li>
</ul>
</li>
</ul>
</li>
<li>user stack
<ul>
<li>就一般的stack</li>
<li>kernel stack是為了與user stack分開</li>
<li>想想兩個混在一起會發生什麼事</li>
</ul>
</li>
</ul>
</li>
<li>每個cpu有
<ul>
<li>interrupt stack</li>
</ul>
</li>
</ul>
</li>
<li>percpu
<ul>
<li>每個cpu自己的data</li>
<li>因為是cpu自己的，所以
<ul>
<li>cache失效降低</li>
<li>不用擔心smp
<ul>
<li>preempt還是要怕</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch15">ch15</h2>
<p>user space的mem</p>
<h3 id="整體-2">整體</h3>
<ul>
<li>proc的userspace的mem空間
<ul>
<li>struct mm_struct
<ul>
<li>在<code>&lt;linux/sched.h&gt;</code></li>
<li>可以到<code>/proc/&lt;pid&gt;/maps</code>看proc現在有什麼</li>
<li>主要兩個
<ul>
<li>struct vm_area_struct
<ul>
<li>在<code>&lt;linux/mm_types.h&gt;</code></li>
<li>就是這裡的page，加上權限與狀態之類的</li>
<li>在mm_struct有兩個obj放vm_area_struct
<ul>
<li>list: 方便iterate</li>
<li>rbtree: 方便找定點</li>
</ul>
</li>
</ul>
</li>
<li>pgd_t
<ul>
<li>phy的page表
<ul>
<li>三層 (pgd -&gt; pmd -&gt; pte)</li>
</ul>
</li>
<li>用這個換出實際addr</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="額外-2">額外</h3>
<ul>
<li>kthread的mm
<ul>
<li>kthread天生沒有mm (不然怎麼有k)</li>
<li>當需要的時候會從proc的ptr拿到
<ul>
<li>當schedule會存前一個proc的mm (active_mm)</li>
<li>當kthread需要(像page table)，就直接用active_mm看</li>
</ul>
</li>
</ul>
</li>
<li>mmap
<ul>
<li>把file放到proc的userspace的mem空間
<ul>
<li>生一個addr出來</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch13">ch13</h2>
<h3 id="virtual-file-system的流程">virtual file system的流程</h3>
<ol>
<li>userspace</li>
<li>virtual file system</li>
<li>真的file system</li>
<li>phy</li>
</ol>
<h3 id="VFS的attribute">VFS的attribute</h3>
<ul>
<li>superblock
<ul>
<li>真的file system (ext4, brtfs…)
<ul>
<li>struct file_system_type
<ul>
<li>在<code>&lt;linux/fs.h&gt;</code></li>
<li>放fs的訊息(kernel關心的)</li>
</ul>
</li>
<li>struct vfsmount
<ul>
<li>在<code>&lt;linux/mount.h&gt;</code></li>
<li>fs的統計數據與安裝訊息(root, dev等等)與安裝點
<ul>
<li>可以當成實際fs的入口</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>放fs的訊息(VFS關心的)</li>
<li>struct super_block
<ul>
<li>在<code>&lt;linux/fs.h&gt;</code></li>
</ul>
</li>
</ul>
</li>
<li>inode
<ul>
<li>file or folder</li>
<li>放file/folder的訊息</li>
<li>struct inode
<ul>
<li>在<code>&lt;linux/fs.h&gt;</code></li>
</ul>
</li>
</ul>
</li>
<li>dentry
<ul>
<li>path的一部份
<ul>
<li><code>/usr/bin/vi</code>的
<ul>
<li><code>/</code>, <code>usr</code>, <code>bin</code>, <code>vi</code></li>
</ul>
</li>
<li>其實可以當成inode，但是為了查找path，所以獨立出來</li>
</ul>
</li>
<li>struct dentry
<ul>
<li>在<code>&lt;linux/dcache.h&gt;</code></li>
</ul>
</li>
<li>state
<ul>
<li>被用
<ul>
<li>有對應的file</li>
<li>也正在被ref</li>
</ul>
</li>
<li>還沒被用
<ul>
<li>有對應的file</li>
<li>沒被ref</li>
</ul>
</li>
<li>不在
<ul>
<li>根本沒這個file
<ul>
<li>總不能每次要等整個找完才丟沒有指定的檔案吧</li>
<li>同時，因為有這個與slab，在之後真的有檔案也可以直接快取</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>file
<ul>
<li>opend file</li>
<li>struct file
<ul>
<li>在<code>&lt;linux/fs.h&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="看看proc">看看proc</h3>
<ul>
<li>每個proc都有
<ul>
<li>struct files_struct
<ul>
<li>在<code>&lt;linux/fdtable.h&gt;</code></li>
<li>紀錄 開過的檔案</li>
</ul>
</li>
<li>struct fs_struct
<ul>
<li>在<code>&lt;linux/fs_struct.h&gt;</code></li>
<li>紀錄 pwd, 現在跑的檔案</li>
</ul>
</li>
</ul>
</li>
<li>每個namespace都有
<ul>
<li>struct mmt_namespace
<ul>
<li>在<code>&lt;linux/mmt_namespace.h&gt;</code></li>
<li>放vfsmount，讓同一namespace的去找</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch14">ch14</h2>
<p>skip</p>
<h2 id="ch16">ch16</h2>
<h3 id="快取策略">快取策略</h3>
<ul>
<li>nowrite
<ul>
<li>不管cache，直接寫到mem</li>
<li>cache直接失效</li>
</ul>
</li>
<li>write-through
<ul>
<li>同時更新cache與mem</li>
</ul>
</li>
<li>write back
<ul>
<li>先更cache</li>
<li>再找時間更mem</li>
</ul>
</li>
</ul>
<h3 id="快取無效策略">快取無效策略</h3>
<ul>
<li>LRU
<ul>
<li>從list中拿掉最少用到的</li>
</ul>
</li>
<li>LRU/2
<ul>
<li>兩條list
<ul>
<li>熱的</li>
<li>不熱的</li>
</ul>
</li>
<li>變成熱的方式
<ul>
<li>在不熱的中</li>
<li>有被用到</li>
</ul>
</li>
<li>如何調整兩條list
<ul>
<li>熱的比不熱的長</li>
<li>把一些去掉</li>
</ul>
</li>
<li>怎麼去掉
<ul>
<li>fifo (不是最少用到)</li>
<li>熱的list就是原本LRU中記錄頻率的腳色</li>
<li>只要在熱的list就是有用過</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="page快取-上一篇心得的file快取">page快取(上一篇心得的file快取)</h3>
<ul>
<li>struct address_space
<ul>
<li>在<code>&lt;linux/fs.h&gt;</code></li>
<li>應該叫page_cache_entity</li>
</ul>
</li>
<li>這是write back
<ul>
<li>什麼時候寫回去
<ul>
<li>cache要沒了</li>
<li>cache放太久了</li>
<li>有人call<code>sync(),fsync()</code></li>
</ul>
</li>
<li>誰去寫
<ul>
<li>靠flusher的多thread去寫 (原本是單thread)
<ul>
<li>但還是會被底下的IO給bound</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch17">ch17</h2>
<h3 id="編module">編module</h3>
<h4 id="makefile">makefile</h4>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj-m += foo.o</span><br><span class="line"><span class="comment"># obj-m += foo.o 加在sourcetree中的makefile中</span></span><br><span class="line">foo-objs := foo-main.o foo-utils.o</span><br></pre></td></tr></table></figure>
<ul>
<li>編
<ul>
<li><code>make -C /kernel/path SUBDIRS=$PWD modules</code></li>
</ul>
</li>
<li>安裝
<ul>
<li><code>make modules_install</code></li>
</ul>
</li>
<li>生相依訊息
<ul>
<li><code>depmod</code></li>
<li><code>depmod -A</code> only for new added modules</li>
</ul>
</li>
<li>加編譯選項
<ul>
<li>改Kconfig</li>
</ul>
</li>
</ul>
<h3 id="export-what">export what?</h3>
<ul>
<li>參數
<ul>
<li><code>static int a = 1;</code></li>
<li><code>module_param_named(exported_name, a, int, 0644);</code></li>
</ul>
</li>
<li>symbol table
<ul>
<li><code>EXPORT_SYMBOL(your_func);</code></li>
<li><code>EXPORT_SYMBOL_GPL(your_func);</code></li>
</ul>
</li>
</ul>
<h3 id="device-model-sysfs">device model &amp; sysfs</h3>
<ul>
<li>device model
<ul>
<li>
<p>struct kobject</p>
<ul>
<li>在<code>&lt;linux/kobject.h&gt;</code></li>
<li>就是obj</li>
<li>與list一樣要嵌到其他struct上才有用</li>
<li>在sysfs中會變成folder
<ul>
<li>他的參數會變成file
<ul>
<li>struct attribute
<ul>
<li>在<code>&lt;linux/sysfs.h&gt;</code></li>
</ul>
</li>
<li>會有值，可讀寫
<ul>
<li>struct sysfs_ops
<ul>
<li>在<code>&lt;linux/sysfs.h&gt;</code></li>
<li>有read/write可以實作</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>struct ktype</p>
<ul>
<li>在<code>&lt;linux/kobject.h&gt;</code></li>
<li>就是放methods</li>
</ul>
</li>
<li>
<p>struct kset</p>
<ul>
<li>在<code>&lt;linux/kobject.h&gt;</code></li>
<li>就是class(obj的base，js的prototype)</li>
</ul>
</li>
</ul>
</li>
<li>sysfs
<ul>
<li>block
<ul>
<li>列出註冊的block dev</li>
</ul>
</li>
<li>bus
<ul>
<li>列出系統的bus</li>
</ul>
</li>
<li>class
<ul>
<li>列出依func排列的dev
<ul>
<li>net, block, ppp, rtc等等</li>
</ul>
</li>
</ul>
</li>
<li>dev
<ul>
<li>列出註冊的dev
<ul>
<li>block, char</li>
</ul>
</li>
</ul>
</li>
<li>devices
<ul>
<li>列出dev的topo
<ul>
<li>platform, system, virtual等等</li>
</ul>
</li>
</ul>
</li>
<li>firmware
<ul>
<li>與系統有關的low-level子系統
<ul>
<li>ACPI, EDD, EFI</li>
</ul>
</li>
</ul>
</li>
<li>fs
<ul>
<li>列出filesystem</li>
</ul>
</li>
<li>kernel
<ul>
<li>列出kernel狀態與option</li>
</ul>
</li>
<li>modules
<ul>
<li>列出載入的module</li>
</ul>
</li>
<li>power
<ul>
<li>列出電源管理的資料</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch18-19">ch18&amp;19</h2>
<h3 id="開發tips">開發tips</h3>
<ul>
<li>保留一個能動的，一個用新版，其他用舊版
<ul>
<li>用uid(user)去切</li>
<li>加個condition</li>
</ul>
</li>
<li>加統計量</li>
<li>限制output的頻率
<ul>
<li>每個幾秒印一次</li>
<li>只印幾次</li>
</ul>
</li>
<li>輸出自己的錯誤訊息
<ul>
<li>我自己會在一定看的到的地方(像家目錄)，放log</li>
</ul>
</li>
</ul>
<h3 id="align">align</h3>
<p>由大到小去排</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// total: 12</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> a; <span class="comment">// 1+3</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> b;  <span class="comment">// 4+0</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> c; <span class="comment">// 2+1+1</span></span><br><span class="line">  <span class="keyword">char</span> d;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// total: 8</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> b; <span class="comment">// 4+0</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> c; <span class="comment">// 2+1+1</span></span><br><span class="line">  <span class="keyword">char</span> a;</span><br><span class="line">  <span class="keyword">char</span> d;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="big-little-endian">big/little endian</h3>
<ul>
<li>變成binary: 會變成abcd</li>
<li>最左是最高有效位</li>
<li>big-endian: 最高有效位放arr第一個</li>
<li>little-endian: 最低有效位放arr第一個</li>
</ul>
<p>最高有效位與最低有效位的技法: 下坡(反斜線)，所以最高在左邊</p>
<h3 id="一些數字">一些數字</h3>
<ul>
<li>不要假設HZ、page的長度</li>
<li>沒有寫明長度的type的長度都是不確定的
<ul>
<li>除了
<ul>
<li>char是1byte (ansi c)</li>
<li>int通常是32位</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch20">ch20</h2>
<p>skip</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/windows-pxe/" rel="prev" title="windows上用win10的pxe檔案與架pxe server">
      <i class="fa fa-chevron-left"></i> windows上用win10的pxe檔案與架pxe server
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/mem-models/" rel="next" title="記憶體模型筆記">
      記憶體模型筆記 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8B%95%E6%A9%9F-654"><span class="nav-number">1.</span> <span class="nav-text">動機</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E9%AB%94%E5%BF%83%E5%BE%97"><span class="nav-number">2.</span> <span class="nav-text">整體心得</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch1-2"><span class="nav-number">3.</span> <span class="nav-text">ch1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch2-2"><span class="nav-number">4.</span> <span class="nav-text">ch2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#folder"><span class="nav-number">4.1.</span> <span class="nav-text">folder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#make-2"><span class="nav-number">4.2.</span> <span class="nav-text">make</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-dev%E7%9A%84%E7%89%B9%E9%BB%9E"><span class="nav-number">4.3.</span> <span class="nav-text">kernel dev的特點</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch3-2"><span class="nav-number">5.</span> <span class="nav-text">ch3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E9%97%9Cstruct"><span class="nav-number">5.1.</span> <span class="nav-text">相關struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proc-state"><span class="nav-number">5.2.</span> <span class="nav-text">proc state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#clone-syscall"><span class="nav-number">5.3.</span> <span class="nav-text">clone syscall</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch4-2"><span class="nav-number">6.</span> <span class="nav-text">ch4</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#proc%E5%90%83"><span class="nav-number">6.1.</span> <span class="nav-text">proc吃?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#time-slice"><span class="nav-number">6.2.</span> <span class="nav-text">time slice</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proc%E5%84%AA%E5%85%88%E7%B4%9A"><span class="nav-number">6.3.</span> <span class="nav-text">proc優先級</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AC%E5%B9%B3%E8%AA%BF%E5%BA%A6-CFS"><span class="nav-number">6.4.</span> <span class="nav-text">公平調度(CFS)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch5-2"><span class="nav-number">7.</span> <span class="nav-text">ch5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch6-2"><span class="nav-number">8.</span> <span class="nav-text">ch6</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#list-elment"><span class="nav-number">8.1.</span> <span class="nav-text">list_elment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kfifo"><span class="nav-number">8.2.</span> <span class="nav-text">kfifo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#idr"><span class="nav-number">8.3.</span> <span class="nav-text">idr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rbtree"><span class="nav-number">8.4.</span> <span class="nav-text">rbtree</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch7-2"><span class="nav-number">9.</span> <span class="nav-text">ch7</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E6%96%B7-IRQ"><span class="nav-number">9.1.</span> <span class="nav-text">中斷(IRQ)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E6%96%B7%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-number">9.2.</span> <span class="nav-text">中斷上下文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8A%E5%8D%8A%E6%AE%B5-%E8%88%87-%E4%B8%8B%E5%8D%8A%E6%AE%B5"><span class="nav-number">9.3.</span> <span class="nav-text">上半段 與 下半段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#request-irq"><span class="nav-number">9.4.</span> <span class="nav-text">request_irq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reenter"><span class="nav-number">9.5.</span> <span class="nav-text">reenter?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IRQF-SHARED"><span class="nav-number">9.6.</span> <span class="nav-text">IRQF_SHARED</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#procs-interrupts"><span class="nav-number">9.7.</span> <span class="nav-text">&#x2F;procs&#x2F;interrupts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E6%96%B7%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">9.8.</span> <span class="nav-text">中斷控制器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch8-2"><span class="nav-number">10.</span> <span class="nav-text">ch8</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#softirq"><span class="nav-number">10.1.</span> <span class="nav-text">softirq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tasklet"><span class="nav-number">10.2.</span> <span class="nav-text">tasklet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ksoftirqd"><span class="nav-number">10.3.</span> <span class="nav-text">ksoftirqd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#work-queue"><span class="nav-number">10.4.</span> <span class="nav-text">work queue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-lock"><span class="nav-number">10.5.</span> <span class="nav-text">how to lock</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch9-10"><span class="nav-number">11.</span> <span class="nav-text">ch9&amp;10</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%8E%E9%BA%BC%E7%AD%89%E9%8E%96"><span class="nav-number">11.1.</span> <span class="nav-text">怎麼等鎖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%81%E5%90%8C%E6%AD%A5%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AF"><span class="nav-number">11.2.</span> <span class="nav-text">要同步的原因是</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#struct%E4%BB%80%E9%BA%BC%E6%99%82%E5%80%99%E5%8A%A0%E9%8E%96"><span class="nav-number">11.3.</span> <span class="nav-text">struct什麼時候加鎖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7%E8%88%87%E9%A0%86%E5%BA%8F%E6%80%A7"><span class="nav-number">11.4.</span> <span class="nav-text">原子性與順序性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%80%E5%AF%AB%E9%8E%96-RW"><span class="nav-number">11.5.</span> <span class="nav-text">讀寫鎖(RW)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7-2"><span class="nav-number">11.6.</span> <span class="nav-text">工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#priority-inversion"><span class="nav-number">11.7.</span> <span class="nav-text">priority inversion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch11"><span class="nav-number">12.</span> <span class="nav-text">ch11</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%8E%E9%BA%BC%E7%AE%971%E7%A7%92"><span class="nav-number">12.1.</span> <span class="nav-text">怎麼算1秒</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%96%8B%E6%A9%9F%E5%A4%9A%E4%B9%85%E4%BA%86"><span class="nav-number">12.2.</span> <span class="nav-text">開機多久了</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E9%AB%94"><span class="nav-number">12.3.</span> <span class="nav-text">硬體</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%9C%E6%96%BCproc%E7%9A%84%E8%A8%88%E6%99%82"><span class="nav-number">12.4.</span> <span class="nav-text">關於proc的計時</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95delay"><span class="nav-number">12.5.</span> <span class="nav-text">如何delay</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch12"><span class="nav-number">13.</span> <span class="nav-text">ch12</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E9%AB%94"><span class="nav-number">13.1.</span> <span class="nav-text">整體</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%8D%E5%A4%96"><span class="nav-number">13.2.</span> <span class="nav-text">額外</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch15"><span class="nav-number">14.</span> <span class="nav-text">ch15</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E9%AB%94-2"><span class="nav-number">14.1.</span> <span class="nav-text">整體</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%8D%E5%A4%96-2"><span class="nav-number">14.2.</span> <span class="nav-text">額外</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch13"><span class="nav-number">15.</span> <span class="nav-text">ch13</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual-file-system%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">15.1.</span> <span class="nav-text">virtual file system的流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VFS%E7%9A%84attribute"><span class="nav-number">15.2.</span> <span class="nav-text">VFS的attribute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9C%8B%E7%9C%8Bproc"><span class="nav-number">15.3.</span> <span class="nav-text">看看proc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch14"><span class="nav-number">16.</span> <span class="nav-text">ch14</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch16"><span class="nav-number">17.</span> <span class="nav-text">ch16</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E5%8F%96%E7%AD%96%E7%95%A5"><span class="nav-number">17.1.</span> <span class="nav-text">快取策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E5%8F%96%E7%84%A1%E6%95%88%E7%AD%96%E7%95%A5"><span class="nav-number">17.2.</span> <span class="nav-text">快取無效策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#page%E5%BF%AB%E5%8F%96-%E4%B8%8A%E4%B8%80%E7%AF%87%E5%BF%83%E5%BE%97%E7%9A%84file%E5%BF%AB%E5%8F%96"><span class="nav-number">17.3.</span> <span class="nav-text">page快取(上一篇心得的file快取)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch17"><span class="nav-number">18.</span> <span class="nav-text">ch17</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B7%A8module"><span class="nav-number">18.1.</span> <span class="nav-text">編module</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#makefile"><span class="nav-number">18.1.1.</span> <span class="nav-text">makefile</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#export-what"><span class="nav-number">18.2.</span> <span class="nav-text">export what?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#device-model-sysfs"><span class="nav-number">18.3.</span> <span class="nav-text">device model &amp; sysfs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch18-19"><span class="nav-number">19.</span> <span class="nav-text">ch18&amp;19</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%96%8B%E7%99%BCtips"><span class="nav-number">19.1.</span> <span class="nav-text">開發tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#align"><span class="nav-number">19.2.</span> <span class="nav-text">align</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#big-little-endian"><span class="nav-number">19.3.</span> <span class="nav-text">big&#x2F;little endian</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E6%95%B8%E5%AD%97"><span class="nav-number">19.4.</span> <span class="nav-text">一些數字</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch20"><span class="nav-number">20.</span> <span class="nav-text">ch20</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhengcf</p>
  <div class="site-description" itemprop="description">想到什麼就寫什麼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">693</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengcf</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 1000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://littlebees.github.io/2021/06/Linux-Kernel-Development-3rd-note/',]
      });
      });
  </script>

</body>
</html>
