<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>k8s筆記 | 記事本</title>
<meta name=keywords content="k8s"><meta name=description content="動機
突然想起有k8s，就來看看
越看越像linux主機的抽象化，最後變成近乎linux主機的framework"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2020/08/k8s%E7%AD%86%E8%A8%98/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2020/08/k8s%E7%AD%86%E8%A8%98/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="k8s筆記"><meta property="og:description" content="動機
突然想起有k8s，就來看看
越看越像linux主機的抽象化，最後變成近乎linux主機的framework"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2020/08/k8s%E7%AD%86%E8%A8%98/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-15T20:41:18+00:00"><meta property="article:modified_time" content="2020-08-15T20:41:18+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="k8s筆記"><meta name=twitter:description content="動機
突然想起有k8s，就來看看
越看越像linux主機的抽象化，最後變成近乎linux主機的framework"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"k8s筆記","item":"https://littlebees.github.io/2020/08/k8s%E7%AD%86%E8%A8%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"k8s筆記","name":"k8s筆記","description":"動機 突然想起有k8s，就來看看 越看越像linux主機的抽象化，最後變成近乎linux主機的framework\n","keywords":["k8s"],"articleBody":"動機 突然想起有k8s，就來看看 越看越像linux主機的抽象化，最後變成近乎linux主機的framework\n架構: 把主機拆掉再變多 一開始主機是 一台電腦有\n應用程式 檔案(設定檔) 處理連線的介面(load balancer或是firewall) 應用程式 \u0026 虛擬的主機 都是共用同一台實體主機的資源\n但應用程式越來越多會彼此影響 所以在同一台實體主機中用chroot與network namespace分開應用程式 但彼此之間要溝通就不能透過 記憶體與filesystem 他們已經被分開了 所以彼此之間用網路連接在一起 這就是container或是pod\n如果每個應用程式都是用網路連接在一起，那應用程式還需要限定在同一台實體主機上嗎? 因此我們可以把實體主機變多，讓應用程式跑在不同的主機上 這就是cluster\n對於使用者來說這些實體主機都是可以提供服務的，所以cluster也可以說是虛擬的主機\n如果相同的應用程式跑在不同的主機上，都提供一樣的服務，這叫scaling 如果子任務跑在不同的主機上，來跑出計算結果，這叫parllelism\n有了這麼多實體主機要怎麼分配pod? 在k8s就是deployment\n處理連線的介面 原本在同一台主機上，使怎麼區分要把連線導到哪個應用程式? 用port，像http是80、https是443 在應用程式用bind就可以綁到指定的port\n但現在每個應用程式都是被分開，所以會需要\nip(在不同的network namespace) port(在第四層網路) 這個除了用bind外，還要用iptables，也就是firewall去控制ip的封包往那邊走\n但這都還在同一台實體主機上\n如果變成像cluster那樣的虛擬主機要怎麼辦?\n基本上就是用主從式架構 一個收連線分配到某台cluster下的主機，等資料return到這裡\n這就是master node的由來\n接下去要問的是 怎麼使用服務?\n現在master node知道服務的ip與port\n所以要讓服務可以被使用，方法有\nport forwarding reverse proxy port forwarding就是service(type: NodePort) reverse proxy就是ClusterIP(ingress可以想成加料過的loadbalancer)\nservice的NodePort \u0026 LoadBalancer差在? port開在哪裡， NodePort開在主機上， LoadBalancer會先拉一台主機出來再開port\nLoadBalancer可以看成把master node的firewall部份抽出來單獨用\n為什麼service再分配一個ClusterIP? 為了可以用service的name直接連到Pod，service的name會被放在kube-dns中 這樣用service的name做nslookup就會拿到ip，就像部屬一台server一樣\n同樣都是讓服務可以被使用， 比起實體主機，為什麼k8s還多了ingress? 第一個是現在應用程式都有了自己的ip 第二個是一般常見的服務都是 network protocol綁定port的，像80,443\n所以ingress可以想像成DNS不過是把path換成ip\u0026port DNS是domain name換成ip\n(有注意到嗎，在網站上，path是換成對應的controller，所以ingress的角色其實是與網站上的router相當)\nservice不加上selector(不是把流量導到cluster中)的話? service就是在實體主機上的bind 所以也可以把流量導到其他地方去，像\napiVersion: v1 kind: Service metadata: name: my-service spec: ports: - protocol: TCP port: 80 targetPort: 9376 apiVersion: v1 kind: Endpoints metadata: name: my-service subsets: - addresses: - ip: 192.0.2.42 ports: - port: 9376 Namespaces就是不同的cluster，其實就是不同的虛擬主機\n部署服務 流程是\ndeployment生pod service把port綁到指定的pod ingress把路徑綁到port(service) 指定某東西 如何指定就是用label，像\napiVersion: apps/v1beta2 # for kubectl versions \u003e= 1.9.0 use apps/v1 kind: Deployment metadata: name: hello-deployment spec: replicas: 3 selector: matchLabels: # here app: my-deployment matchExpressions: - {key: tier, operator: In, values: [cache]} - {key: environment, operator: NotIn, values: [dev]} template: metadata: labels: # here app: my-deployment spec: containers: - name: my-pod image: zxcvbnius/docker-demo:latest ports: - containerPort: 3000 如果是在commandline上要指定的話\nkubectl get pods -l environment=production,tier=frontend kubectl get pods -l 'environment in (production),tier in (frontend)' kubectl get pods -l 'environment in (production, qa)' kubectl get pods -l 'environment,environment notin (frontend)' 另外可以用go-template，來客製顯示的資訊\n[root@node root]# kubectl get pods --all-namespaces -o go-template --template='{{range .items}}{{.metadata.uid}} {{end}}' 0313ffff-f1f4-11e7-9cda-40f2e9b98448 ee49bdcd-f1f2-11e7-9cda-40f2e9b98448 f1e0eb80-f1f2-11e7-9cda-40f2e9b98448 [root@node root]# kubectl get pods --all-namespaces -o go-template --template='{{range .items}}{{printf \"|%-20s|%-50s|%-30s|\\n\" .metadata.namespace .metadata.name .metadata.uid}}{{end}}' |console |console-4d2d7eab-1377218307-7lg5v |0313ffff-f1f4-11e7-9cda-40f2e9b98448| |console |console-4d2d7eab-1377218307-q3bjd |ee49bdcd-f1f2-11e7-9cda-40f2e9b98448| |cxftest |ipreserve-f15257ec-3788284754-nmp3x |f1e0eb80-f1f2-11e7-9cda-40f2e9b98448| Horizontal Pod Autoscaling Deployment控制Pod的數量 Horizontal Pod Autoscaling控制Deployment的數量\napiVersion: autoscaling/v1 kind: HorizontalPodAutoscaler metadata: name: helloworld-hpa spec: scaleTargetRef: apiVersion: apps/v1beta2 kind: Deployment name: helloworld-deployment minReplicas: 2 maxReplicas: 5 targetCPUUtilizationPercentage: 50 DaemonSet 如果每個Node都要跑這個pod，像是monitor或log 就可以用DaemonSet\napiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: kube-system labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: tolerations: # this toleration is to have the daemonset runnable on master nodes # remove it if your masters can't run pods - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: fluentd-elasticsearch image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2 resources: limits: memory: 200Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log - name: varlibdockercontainers mountPath: /var/lib/docker/containers readOnly: true terminationGracePeriodSeconds: 30 volumes: - name: varlog hostPath: path: /var/log - name: varlibdockercontainers hostPath: path: /var/lib/docker/containers 管理Node 停用node: kubectl drain {node_name} 啟用node: kubectl uncordon {node_name} 限制資源 Pod本身可以限制或要求最多或最少需要多少資源\n當然也可以從外部限制\napiVersion: v1 kind: List items: - apiVersion: v1 kind: ResourceQuota metadata: name: pods-high spec: hard: cpu: \"1000\" memory: 200Gi pods: \"10\" scopeSelector: matchExpressions: - operator : In scopeName: PriorityClass values: [\"high\"] - apiVersion: v1 kind: ResourceQuota metadata: name: pods-medium spec: hard: cpu: \"10\" memory: 20Gi pods: \"10\" scopeSelector: matchExpressions: - operator : In scopeName: PriorityClass values: [\"medium\"] - apiVersion: v1 kind: ResourceQuota metadata: name: pods-low spec: hard: cpu: \"5\" memory: 10Gi pods: \"10\" scopeSelector: matchExpressions: - operator : In scopeName: PriorityClass values: [\"low\"] apiVersion: v1 kind: Pod metadata: name: high-priority spec: containers: - name: high-priority image: ubuntu command: [\"/bin/sh\"] args: [\"-c\", \"while true; do echo hello; sleep 10;done\"] resources: requests: memory: \"10Gi\" cpu: \"500m\" limits: memory: \"10Gi\" cpu: \"500m\" priorityClassName: high 除了pod的限制，也能限制namespace\napiVersion: v1 kind: ResourceQuota metadata: name: compute-resources spec: hard: requests.cpu: \"1\" requests.memory: 1Gi limits.cpu: \"2\" limits.memory: 2Gi requests.nvidia.com/gpu: 4 --- apiVersion: v1 kind: ResourceQuota metadata: name: object-counts spec: hard: configmaps: \"10\" persistentvolumeclaims: \"4\" pods: \"4\" replicationcontrollers: \"20\" secrets: \"10\" services: \"10\" services.loadbalancers: \"2\" 角色控制 Role是指定在一個namespace下可以操作的資源 ClusterRole是在任何namespace下都可以操作的資源\n資源是在不同的apigroup下\n用rolebinding把Role與user或group或service account綁在一起\n儲存 在 使用檔案 之前我們需要 filesystem 在 使用filesystem 之前我們需要 做partition 在 做partition 之前我們需要 硬碟\nfilesystem 就是 volumne 做partition 就是 PersistentVolumeClaim 虛擬的硬碟(有特別的屬性) 就是 Storage Class 實體的硬碟 就是 Persistent Volume (docker的volumne)\n這裡就轉貼一些別人的範例\nkind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: standard provisioner: kubernetes.io/aws-ebs parameters: type: gp2 zone: us-west-2 reclaimPolicy: Delete # [Delete | Retain] apiVersion: v1 metadata: name: myclaim spec: accessModes: - ReadWriteOnce # [ReadWriteOnce | ReadOnlyMany | ReadWriteMany] resources: requests: storage: 8Gi storageClassName: standard # Ref apiVersion: v1 kind: Pod metadata: name: apiserver labels: app: apiserver tier: backend spec: containers: - name: my-pod image: zxcvbnius/docker-demo ports: - containerPort: 3000 volumeMounts: # \\/ 看下面的volumes - name: my-pvc mountPath: \"/tmp\" volumes: - name: my-pvc persistentVolumeClaim: claimName: myclaim # Ref Persistent Volume的例子 (注意到在這裡PVC沒有指定storageClassName，PVC直接從PV拿)\napiVersion: v1 kind: PersistentVolume \u003c=== 指定物件種類為 PV metadata: name: pv001\t\u003c=== PV 名稱 spec: capacity: storage: 2Gi \u003c=== 指定大小 accessModes: - ReadWriteOnce \u003c=== 指定存取模式 hostPath: \u003c=== 綁定在 host 的 /tmp 目錄 path: /tmp --- apiVersion: v1 kind: Pod \u003c=== 使用一個 Pod 並試著掛載 Volume metadata: name: pvc-nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 volumeMounts: \u003c=== 將名為 volume-pv 的 Volume 掛載到 /usr/share/nginx/html 目錄底下 - name: volume-pv mountPath: /usr/share/nginx/html volumes: - name: volume-pv \u003c=== 宣告一個名為 volume-pv 的 Volume 物件 persistentVolumeClaim: \u003c=== 綁定名為 pv-claim 的 PVC 物件 claimName: pv-claim --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: pv-claim spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi \u003c=== 要求 1G 容量 filesystem只能從硬碟開始嗎? 沒有現成的嗎?\n有，\n實體主機的檔案 (emptyDir, hostPath) NFS apiVersion: v1 kind: Pod metadata: name: apiserver spec: containers: - name: apiserver image: zxcvbnius/docker-demo volumeMounts: - mountPath: /tmp name: tmp-volume imagePullPolicy: Always volumes: - name: tmp-volume hostPath: path: /tmp - name: nfs-volumes nfs: server: {YOUR_NFS_SERVER_URL} path: / type: Directory - name: cache-volume emptyDir: {} 從剛剛的資料來源來看可分成\n網路: NFS、Storage Class\u0026PersistentVolumeClaim 實體主機: emptyDir、hostPath 哪虛擬主機有沒有自己的檔案(資料)? 有，ConfigMap 與 Secret\n不過因為secret是放秘密的資料 所以也會透過env var傳\n要注意到ConfigMap 與 Secret都是hash table， 也就是用key去取值\napiVersion: v1 kind: Pod metadata: name: apiserver labels: app: webserver tier: backend spec: containers: - name: nodejs-app image: zxcvbnius/docker-demo ports: - containerPort: 3000 - name: nginx image: nginx:1.13 ports: - containerPort: 80 volumeMounts: - name: nginx-conf-volume mountPath: /etc/nginx/conf.d env: - name: SECRET_USERNAME valueFrom: secretKeyRef: name: demo-secret-from-yaml key: username - name: SECRET_PASSWORD valueFrom: secretKeyRef: name: demo-secret-from-yaml key: password volumes: - name: nginx-conf-volume configMap: name: nginx-conf items: - key: my-nginx.conf path: my-nginx.conf - name: secret-volume secret: secretName: demo-secret-from-yaml 只想跑某個指令 只跑一次: Job apiVersion: batch/v1 kind: Job metadata: name: pi spec: template: spec: containers: - name: pi image: perl command: [\"perl\", \"-Mbignum=bpi\", \"-wle\", \"print bpi(2000)\"] restartPolicy: Never backoffLimit: 4 也可以平行跑，見官方文件\n反覆: CronJob apiVersion: batch/v1beta1 kind: CronJob metadata: name: hello spec: schedule: \"*/1 * * * *\" jobTemplate: spec: template: spec: containers: - name: hello image: apline args: - /bin/sh - -c - echo \"Hi, current time is $(date)\" restartPolicy: OnFailure Ref Job NodePort\u0026Loadbalancer 官網 30天鐵人賽 go-template\n","wordCount":"1004","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2020-08-15T20:41:18Z","dateModified":"2020-08-15T20:41:18Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2020/08/k8s%E7%AD%86%E8%A8%98/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">k8s筆記</h1><div class=post-meta><span title='2020-08-15 20:41:18 +0000 UTC'>August 15, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#%e6%9e%b6%e6%a7%8b-%e6%8a%8a%e4%b8%bb%e6%a9%9f%e6%8b%86%e6%8e%89%e5%86%8d%e8%ae%8a%e5%a4%9a aria-label="架構: 把主機拆掉再變多">架構: 把主機拆掉再變多</a><ul><li><a href=#%e6%87%89%e7%94%a8%e7%a8%8b%e5%bc%8f--%e8%99%9b%e6%93%ac%e7%9a%84%e4%b8%bb%e6%a9%9f aria-label="應用程式 & 虛擬的主機">應用程式 & 虛擬的主機</a></li><li><a href=#%e8%99%95%e7%90%86%e9%80%a3%e7%b7%9a%e7%9a%84%e4%bb%8b%e9%9d%a2 aria-label=處理連線的介面>處理連線的介面</a></li></ul></li><li><a href=#%e9%83%a8%e7%bd%b2%e6%9c%8d%e5%8b%99 aria-label=部署服務>部署服務</a><ul><li><a href=#%e6%8c%87%e5%ae%9a%e6%9f%90%e6%9d%b1%e8%a5%bf aria-label=指定某東西>指定某東西</a></li><li><a href=#horizontal-pod-autoscaling aria-label="Horizontal Pod Autoscaling">Horizontal Pod Autoscaling</a></li><li><a href=#daemonset aria-label=DaemonSet>DaemonSet</a></li><li><a href=#%e7%ae%a1%e7%90%86node aria-label=管理Node>管理Node</a></li></ul></li><li><a href=#%e9%99%90%e5%88%b6%e8%b3%87%e6%ba%90 aria-label=限制資源>限制資源</a></li><li><a href=#%e8%a7%92%e8%89%b2%e6%8e%a7%e5%88%b6 aria-label=角色控制>角色控制</a></li><li><a href=#%e5%84%b2%e5%ad%98 aria-label=儲存>儲存</a></li><li><a href=#%e5%8f%aa%e6%83%b3%e8%b7%91%e6%9f%90%e5%80%8b%e6%8c%87%e4%bb%a4 aria-label=只想跑某個指令>只想跑某個指令</a><ul><li><a href=#%e5%8f%aa%e8%b7%91%e4%b8%80%e6%ac%a1-job aria-label="只跑一次: Job">只跑一次: Job</a></li><li><a href=#%e5%8f%8d%e8%a6%86-cronjob aria-label="反覆: CronJob">反覆: CronJob</a></li></ul></li><li><a href=#ref aria-label=Ref>Ref</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>突然想起有k8s，就來看看
越看越像linux主機的抽象化，最後變成近乎linux主機的framework</p><h2 id=架構-把主機拆掉再變多>架構: 把主機拆掉再變多<a hidden class=anchor aria-hidden=true href=#架構-把主機拆掉再變多>#</a></h2><p>一開始主機是
一台電腦有</p><ol><li>應用程式</li><li>檔案(設定檔)</li><li>處理連線的介面(load balancer或是firewall)</li></ol><h3 id=應用程式--虛擬的主機>應用程式 & 虛擬的主機<a hidden class=anchor aria-hidden=true href=#應用程式--虛擬的主機>#</a></h3><p>都是共用同一台實體主機的資源</p><hr><p>但應用程式越來越多會彼此影響
所以在同一台實體主機中用chroot與network namespace分開應用程式
但彼此之間要溝通就不能透過 記憶體與filesystem 他們已經被分開了
所以彼此之間用網路連接在一起
這就是container或是pod</p><hr><p>如果每個應用程式都是用網路連接在一起，那應用程式還需要限定在同一台實體主機上嗎?
因此我們可以把實體主機變多，讓應用程式跑在不同的主機上
這就是cluster</p><p>對於使用者來說這些實體主機都是可以提供服務的，所以cluster也可以說是虛擬的主機</p><p>如果相同的應用程式跑在不同的主機上，都提供一樣的服務，這叫scaling
如果子任務跑在不同的主機上，來跑出計算結果，這叫parllelism</p><hr><p>有了這麼多實體主機要怎麼分配pod?
在k8s就是deployment</p><h3 id=處理連線的介面>處理連線的介面<a hidden class=anchor aria-hidden=true href=#處理連線的介面>#</a></h3><p>原本在同一台主機上，使怎麼區分要把連線導到哪個應用程式?
用port，像http是80、https是443
在應用程式用bind就可以綁到指定的port</p><hr><p>但現在每個應用程式都是被分開，所以會需要</p><ol><li>ip(在不同的network namespace)</li><li>port(在第四層網路)</li></ol><p>這個除了用bind外，還要用iptables，也就是firewall去控制ip的封包往那邊走</p><p>但這都還在同一台實體主機上</p><hr><p>如果變成像cluster那樣的虛擬主機要怎麼辦?</p><p>基本上就是用主從式架構
一個收連線分配到某台cluster下的主機，等資料return到這裡</p><p>這就是master node的由來</p><hr><p>接下去要問的是
怎麼使用服務?</p><p>現在master node知道服務的ip與port</p><p>所以要讓服務可以被使用，方法有</p><ol><li>port forwarding</li><li>reverse proxy</li></ol><p>port forwarding就是service(type: NodePort)
reverse proxy就是ClusterIP(ingress可以想成加料過的loadbalancer)</p><p>service的NodePort & LoadBalancer差在?
port開在哪裡，
NodePort開在主機上，
LoadBalancer會先拉一台主機出來再開port</p><p>LoadBalancer可以看成把master node的firewall部份抽出來單獨用</p><p>為什麼service再分配一個ClusterIP?
為了可以用service的name直接連到Pod，service的name會被放在kube-dns中
這樣用service的name做nslookup就會拿到ip，就像部屬一台server一樣</p><p>同樣都是讓服務可以被使用，
比起實體主機，為什麼k8s還多了ingress?
第一個是現在應用程式都有了自己的ip
第二個是一般常見的服務都是 network protocol綁定port的，像80,443</p><p>所以ingress可以想像成DNS不過是把path換成ip&amp;port
DNS是domain name換成ip</p><p>(有注意到嗎，在網站上，path是換成對應的controller，所以ingress的角色其實是與網站上的router相當)</p><p>service不加上selector(不是把流量導到cluster中)的話?
service就是在實體主機上的bind
所以也可以把流量導到其他地方去，像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9376</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>addresses</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.0.2.42</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9376</span><span class=w>
</span></span></span></code></pre></div><hr><p>Namespaces就是不同的cluster，其實就是不同的虛擬主機</p><h2 id=部署服務>部署服務<a hidden class=anchor aria-hidden=true href=#部署服務>#</a></h2><p>流程是</p><ol><li>deployment生pod</li><li>service把port綁到指定的pod</li><li>ingress把路徑綁到port(service)</li></ol><h3 id=指定某東西>指定某東西<a hidden class=anchor aria-hidden=true href=#指定某東西>#</a></h3><p>如何指定就是用label，像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1beta2</span><span class=w> </span><span class=c># for kubectl versions &gt;= 1.9.0 use apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w> </span><span class=c># here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span>- {<span class=nt>key: tier, operator: In, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>cache]}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span>- {<span class=nt>key: environment, operator: NotIn, values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>dev]}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class=c># here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>zxcvbnius/docker-demo:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span></code></pre></div><p>如果是在commandline上要指定的話</p><pre tabindex=0><code>kubectl get pods -l environment=production,tier=frontend

kubectl get pods -l &#39;environment in (production),tier in (frontend)&#39;

kubectl get pods -l &#39;environment in (production, qa)&#39;

kubectl get pods -l &#39;environment,environment notin (frontend)&#39;
</code></pre><p>另外可以用go-template，來客製顯示的資訊</p><pre tabindex=0><code>[root@node root]# kubectl get pods --all-namespaces -o go-template --template=&#39;{{range .items}}{{.metadata.uid}}
{{end}}&#39;
0313ffff-f1f4-11e7-9cda-40f2e9b98448
ee49bdcd-f1f2-11e7-9cda-40f2e9b98448
f1e0eb80-f1f2-11e7-9cda-40f2e9b98448

[root@node root]# kubectl get pods --all-namespaces -o go-template --template=&#39;{{range .items}}{{printf &#34;|%-20s|%-50s|%-30s|\n&#34; .metadata.namespace .metadata.name .metadata.uid}}{{end}}&#39;
|console             |console-4d2d7eab-1377218307-7lg5v                 |0313ffff-f1f4-11e7-9cda-40f2e9b98448|
|console             |console-4d2d7eab-1377218307-q3bjd                 |ee49bdcd-f1f2-11e7-9cda-40f2e9b98448|
|cxftest             |ipreserve-f15257ec-3788284754-nmp3x               |f1e0eb80-f1f2-11e7-9cda-40f2e9b98448|
</code></pre><h3 id=horizontal-pod-autoscaling>Horizontal Pod Autoscaling<a hidden class=anchor aria-hidden=true href=#horizontal-pod-autoscaling>#</a></h3><p>Deployment控制Pod的數量
Horizontal Pod Autoscaling控制Deployment的數量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld-hpa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetCPUUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></div><h3 id=daemonset>DaemonSet<a hidden class=anchor aria-hidden=true href=#daemonset>#</a></h3><p>如果每個Node都要跑這個pod，像是monitor或log
就可以用DaemonSet</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># this toleration is to have the daemonset runnable on master nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># remove it if your masters can&#39;t run pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>200Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>200Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker/containers</span><span class=w>
</span></span></span></code></pre></div><h3 id=管理node>管理Node<a hidden class=anchor aria-hidden=true href=#管理node>#</a></h3><p>停用node: <code>kubectl drain {node_name}</code>
啟用node: <code>kubectl uncordon {node_name}</code></p><h2 id=限制資源>限制資源<a hidden class=anchor aria-hidden=true href=#限制資源>#</a></h2><p>Pod本身可以限制或要求最多或最少需要多少資源</p><p>當然也可以從外部限制</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>List</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pods-high</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>200Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scopeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>operator </span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scopeName</span><span class=p>:</span><span class=w> </span><span class=l>PriorityClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;high&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pods-medium</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>20Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scopeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>operator </span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scopeName</span><span class=p>:</span><span class=w> </span><span class=l>PriorityClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;medium&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pods-low</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scopeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>operator </span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scopeName</span><span class=p>:</span><span class=w> </span><span class=l>PriorityClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;low&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>high-priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>high-priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;while true; do echo hello; sleep 10;done&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>priorityClassName</span><span class=p>:</span><span class=w> </span><span class=l>high</span><span class=w>
</span></span></span></code></pre></div><p>除了pod的限制，也能限制namespace</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>compute-resources</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests.cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests.memory</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limits.cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limits.memory</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests.nvidia.com/gpu</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>object-counts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configmaps</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentvolumeclaims</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replicationcontrollers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secrets</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services.loadbalancers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 id=角色控制>角色控制<a hidden class=anchor aria-hidden=true href=#角色控制>#</a></h2><p>Role是指定在一個namespace下可以操作的資源
ClusterRole是在任何namespace下都可以操作的資源</p><p>資源是在不同的apigroup下</p><p>用rolebinding把Role與user或group或service account綁在一起</p><h2 id=儲存>儲存<a hidden class=anchor aria-hidden=true href=#儲存>#</a></h2><p>在 使用檔案 之前我們需要 filesystem
在 使用filesystem 之前我們需要 做partition
在 做partition 之前我們需要 硬碟</p><p>filesystem 就是 volumne
做partition 就是 PersistentVolumeClaim
虛擬的硬碟(有特別的屬性) 就是 Storage Class
實體的硬碟 就是 Persistent Volume (docker的volumne)</p><p>這裡就轉貼一些別人的範例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>standard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/aws-ebs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gp2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>us-west-2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>reclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Delete</span><span class=w> </span><span class=c># [Delete | Retain]</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myclaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w> </span><span class=c># [ReadWriteOnce | ReadOnlyMany | ReadWriteMany]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>8Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>standard</span><span class=w> </span><span class=c># Ref</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>zxcvbnius/docker-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w> </span><span class=c># \/ 看下面的volumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>myclaim</span><span class=w> </span><span class=c># Ref</span><span class=w>
</span></span></span></code></pre></div><p>Persistent Volume的例子
(注意到在這裡PVC沒有指定storageClassName，PVC直接從PV拿)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume    &lt;=== 指定物件種類為 PV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv001		      &lt;=== PV 名稱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi          &lt;=== 指定大小</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce         &lt;=== 指定存取模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>               </span><span class=l>&lt;=== 綁定在 host 的 /tmp 目錄</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod         &lt;=== 使用一個 Pod 並試著掛載 Volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>       </span><span class=l>&lt;=== 將名為 volume-pv 的 Volume 掛載到 /usr/share/nginx/html 目錄底下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume-pv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volume-pv   &lt;=== 宣告一個名為 volume-pv 的 Volume 物件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>   </span><span class=l>&lt;=== 綁定名為 pv-claim 的 PVC 物件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>pv-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi   &lt;=== 要求 1G 容量</span><span class=w>
</span></span></span></code></pre></div><p>filesystem只能從硬碟開始嗎?
沒有現成的嗎?</p><p>有，</p><ol><li>實體主機的檔案 (emptyDir, hostPath)</li><li>NFS</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>zxcvbnius/docker-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tmp-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tmp-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-volumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>server</span><span class=p>:</span><span class=w> </span>{<span class=l>YOUR_NFS_SERVER_URL}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><p>從剛剛的資料來源來看可分成</p><ol><li>網路: NFS、Storage Class&amp;PersistentVolumeClaim</li><li>實體主機: emptyDir、hostPath</li></ol><p>哪虛擬主機有沒有自己的檔案(資料)?
有，ConfigMap 與 Secret</p><p>不過因為secret是放秘密的資料
所以也會透過env var傳</p><p>要注意到ConfigMap 與 Secret都是hash table，
也就是用key去取值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>webserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nodejs-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>zxcvbnius/docker-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-conf-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/nginx/conf.d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SECRET_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-secret-from-yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SECRET_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-secret-from-yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-conf-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>demo-secret-from-yaml</span><span class=w>
</span></span></span></code></pre></div><h2 id=只想跑某個指令>只想跑某個指令<a hidden class=anchor aria-hidden=true href=#只想跑某個指令>#</a></h2><h3 id=只跑一次-job>只跑一次: Job<a hidden class=anchor aria-hidden=true href=#只跑一次-job>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>perl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;perl&#34;</span><span class=p>,</span><span class=w>  </span><span class=s2>&#34;-Mbignum=bpi&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-wle&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;print bpi(2000)&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span></code></pre></div><p>也可以平行跑，見官方文件</p><h3 id=反覆-cronjob>反覆: CronJob<a hidden class=anchor aria-hidden=true href=#反覆-cronjob>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/1 * * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>apline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>echo &#34;Hi, current time is $(date)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span></code></pre></div><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p><a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/>Job</a>
<a href=http://dockone.io/article/4884>NodePort&amp;Loadbalancer</a>
<a href=https://kubernetes.io/>官網</a>
<a href=https://ithelp.ithome.com.tw/users/20103753/ironman/1590>30天鐵人賽</a>
<a href=https://www.cnblogs.com/xuxinkun/p/8304854.html>go-template</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://littlebees.github.io/tags/k8s/>K8s</a></li></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2020/08/%E6%94%B9kernel%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85/><span class=title>« Prev</span><br><span>改kernel的注意事項</span>
</a><a class=next href=https://littlebees.github.io/2020/08/dockerfile%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AF%A6%E8%B8%90%E6%95%B4%E7%90%86/><span class=title>Next »</span><br><span>dockerfile的最佳實踐整理</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>