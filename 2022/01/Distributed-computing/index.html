<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="AEpTGuQAkxnTOlmfF4INDna3S660LxrkyZ4BQzVbRSw">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"littlebees.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="動機 論選好課、書的重要性">
<meta property="og:type" content="article">
<meta property="og:title" content="Distributed computing">
<meta property="og:url" content="https://littlebees.github.io/2022/01/Distributed-computing/index.html">
<meta property="og:site_name" content="記事本">
<meta property="og:description" content="動機 論選好課、書的重要性">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/DOj27J0.png">
<meta property="og:image" content="https://i.imgur.com/kAes3y7.png">
<meta property="og:image" content="https://i.imgur.com/pUbx57g.png">
<meta property="og:image" content="https://i.imgur.com/ZgnstJj.png">
<meta property="og:image" content="https://i.imgur.com/WPhU2qf.png">
<meta property="og:image" content="https://i.imgur.com/5Z3HV4j.png">
<meta property="og:image" content="https://i.imgur.com/KVvBgul.png">
<meta property="og:image" content="https://i.imgur.com/VNv4Siy.png">
<meta property="og:image" content="https://i.imgur.com/lKzhUJo.png">
<meta property="og:image" content="https://i.imgur.com/6J6DSfc.png">
<meta property="og:image" content="https://i.imgur.com/kAfy95j.png">
<meta property="og:image" content="https://i.imgur.com/2fE1ov3.png">
<meta property="og:image" content="https://i.imgur.com/5gQOlhZ.png">
<meta property="og:image" content="https://i.imgur.com/qWH3jVT.png">
<meta property="og:image" content="https://i.imgur.com/EWegnFj.png">
<meta property="og:image" content="https://i.imgur.com/DG1yL5w.png">
<meta property="og:image" content="https://i.imgur.com/kZF7Dxa.png">
<meta property="og:image" content="https://i.imgur.com/MNYzEK2.png">
<meta property="og:image" content="https://i.imgur.com/pJPOCMv.png">
<meta property="og:image" content="https://i.imgur.com/pLv6p3a.png">
<meta property="og:image" content="https://i.imgur.com/AKXTyBE.png">
<meta property="og:image" content="https://i.imgur.com/jBbn5rf.png">
<meta property="og:image" content="https://i.imgur.com/BqJpIWH.png">
<meta property="og:image" content="https://i.imgur.com/7u6ScII.png">
<meta property="og:image" content="https://i.imgur.com/2x26pwz.png">
<meta property="og:image" content="https://i.imgur.com/aajmr03.png">
<meta property="og:image" content="https://i.imgur.com/d9g7UZu.png">
<meta property="og:image" content="https://i.imgur.com/VUk3uP8.png">
<meta property="og:image" content="https://i.imgur.com/R1jU3Ii.png">
<meta property="og:image" content="https://i.imgur.com/OhWk7O6.png">
<meta property="og:image" content="https://i.imgur.com/lPMblfp.png">
<meta property="og:image" content="https://i.imgur.com/lJkuN6R.png">
<meta property="og:image" content="https://i.imgur.com/19CVQAL.png">
<meta property="og:image" content="https://i.imgur.com/TbniB5b.png">
<meta property="og:image" content="https://i.imgur.com/zux8dtF.png">
<meta property="og:image" content="https://i.imgur.com/oY41Fk7.png">
<meta property="og:image" content="https://i.imgur.com/11w62Ts.png">
<meta property="og:image" content="https://i.imgur.com/Z35Dk17.png">
<meta property="og:image" content="https://i.imgur.com/XQcTkSw.png">
<meta property="og:image" content="https://i.imgur.com/iYdUDV0.png">
<meta property="og:image" content="https://i.imgur.com/CpAjww1.png">
<meta property="og:image" content="https://i.imgur.com/OeBQ63c.png">
<meta property="og:image" content="https://i.imgur.com/Lj5OqBj.png">
<meta property="og:image" content="https://i.imgur.com/Gbnhidk.png">
<meta property="og:image" content="https://i.imgur.com/U8744mn.png">
<meta property="og:image" content="https://i.imgur.com/pbm0oxw.png">
<meta property="og:image" content="https://i.imgur.com/oeUDKYv.png">
<meta property="og:image" content="https://i.imgur.com/CZpjVYN.png">
<meta property="og:image" content="https://i.imgur.com/8WnwAfe.png">
<meta property="og:image" content="https://i.imgur.com/hHiFnJE.png">
<meta property="og:image" content="https://i.imgur.com/wElkybh.png">
<meta property="og:image" content="https://i.imgur.com/T3DpsNF.png">
<meta property="og:image" content="https://i.imgur.com/0TRFMd4.png">
<meta property="og:image" content="https://i.imgur.com/Wwrf5YJ.png">
<meta property="og:image" content="https://i.imgur.com/11XKqz2.png">
<meta property="og:image" content="https://i.imgur.com/tVoFVQi.png">
<meta property="og:image" content="https://i.imgur.com/4euc5IX.png">
<meta property="og:image" content="https://i.imgur.com/cgC72Fo.png">
<meta property="article:published_time" content="2022-01-17T08:17:07.000Z">
<meta property="article:modified_time" content="2022-03-31T02:37:43.199Z">
<meta property="article:author" content="zhengcf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/DOj27J0.png">

<link rel="canonical" href="https://littlebees.github.io/2022/01/Distributed-computing/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>Distributed computing | 記事本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">記事本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">寫下來，不然會忘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://littlebees.github.io/2022/01/Distributed-computing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhengcf">
      <meta itemprop="description" content="想到什麼就寫什麼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="記事本">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Distributed computing
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-17 16:17:07" itemprop="dateCreated datePublished" datetime="2022-01-17T16:17:07+08:00">2022-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-31 10:37:43" itemprop="dateModified" datetime="2022-03-31T10:37:43+08:00">2022-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/" itemprop="url" rel="index"><span itemprop="name">System</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="動機-657">動機</h2>
<p>論選好課、書的重要性</p>
<span id="more"></span>
<h2 id="Models-of-distributed-systems">Models of distributed systems</h2>
<p><img src="https://i.imgur.com/DOj27J0.png" alt=""></p>
<p><img src="https://i.imgur.com/kAes3y7.png" alt=""><br>
<img src="https://i.imgur.com/pUbx57g.png" alt=""></p>
<p>怎麼處理上面會騙人的狀況?<br>
只有兩人無法判斷對錯，所以如果有一個壞人，就要有兩個好人，才能抵銷</p>
<p><img src="https://i.imgur.com/ZgnstJj.png" alt=""></p>
<p>剛剛的兩個問題都有兩項東西</p>
<ul>
<li>Node</li>
<li>Network</li>
</ul>
<p>還有另一個要考慮的是 latency!!</p>
<ul>
<li>
<p>system model是由下面3項組成</p>
<ul>
<li>Network behaviour (e.g. message loss)
<ul>
<li>(assume) bidirectional point-to-point communication
<ul>
<li>Reliable (perfect) links
<ul>
<li>如果收到msg，就代表他有被送出</li>
<li>可能重排
<ul>
<li>Fair-loss links + retry&amp;消除重複</li>
</ul>
</li>
</ul>
</li>
<li>Fair-loss links
<ul>
<li>msg可能消失、重複、重排</li>
<li>但一直try總會到對面去
<ul>
<li>Arbitrary links + TLS</li>
</ul>
</li>
</ul>
</li>
<li>Arbitrary links
<ul>
<li>中間有不懷好意的人</li>
</ul>
</li>
</ul>
</li>
<li>Network partition
<ul>
<li>線路會drop或是delay</li>
</ul>
</li>
</ul>
</li>
<li>Node behaviour (e.g. crashes)
<ul>
<li>如果出事(faulty)的話
<ul>
<li>Crash-stop (fail-stop)
<ul>
<li>crash就直接停下來</li>
</ul>
</li>
<li>Crash-recovery (fail-recovery)
<ul>
<li>crash會失去mem中的狀態</li>
<li>在一段時間之後會自己復原</li>
</ul>
</li>
<li>Byzantine (fail-arbitrary)
<ul>
<li>crash後什麼事都有可能發生</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Timing behaviour (e.g. latency)
<ul>
<li>Node &amp; Network
<ul>
<li>Synchronous
<ul>
<li>latency有上限</li>
<li>node的執行速度是可以預估的</li>
</ul>
</li>
<li>Partially synchronous
<ul>
<li>有些部分是async的(會結束，但不知道多久)</li>
<li>其他都是sync</li>
</ul>
</li>
<li>Asynchronous
<ul>
<li>latency不確定</li>
<li>node也不確定會不會隨時停下</li>
</ul>
</li>
</ul>
</li>
<li>Node的意外
<ul>
<li>Operating system scheduling (priority inversion)</li>
<li>Stop-the-world garbage collection</li>
<li>Page faults, swap, thrashing</li>
</ul>
</li>
<li>Network的意外
<ul>
<li>Message loss requiring retry</li>
<li>Congestion/contention causing queueing</li>
<li>Network/route reconfiguration</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Failure: system完全不動</p>
</li>
<li>
<p>Fault: 一部份不動了</p>
<ul>
<li>node
<ul>
<li>crash (crash-stop/crash-recovery)</li>
<li>deviating from algorithm (Byzantine)</li>
</ul>
</li>
<li>Network
<ul>
<li>dropping or significantly delaying messages</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Failure detectors</p>
<ul>
<li>Perfect failure detector
<ul>
<li>labels a node as faulty iff it has crashed</li>
</ul>
</li>
<li>Typical implementation
<ul>
<li>send message</li>
<li>await response</li>
<li>label node as crashed if no reply within some timeout</li>
</ul>
</li>
<li>Problem
<ul>
<li>不能區分是
<ul>
<li>crashed node</li>
<li>temporarily unresponsive node</li>
<li>lost message</li>
<li>delayed message</li>
</ul>
</li>
<li>所以只能在
<ul>
<li>synchronous crash-stop system with reliable links</li>
<li>Eventually perfect failure detector
<ul>
<li>temporarily
<ul>
<li>標成 crashed, 就算是 correct</li>
<li>標成 correct, 就算是 crashed</li>
</ul>
</li>
<li>eventually
<ul>
<li>標成 crashed, iff crashed</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Time-clocks-and-ordering-of-events">Time, clocks, and ordering of events</h2>
<ul>
<li>two types of clock
<ul>
<li>physical clocks
<ul>
<li>就是時間，數花掉的時間</li>
<li>會有誤差 (可能在調整時變大變小)
<ul>
<li>Coordinated Universal Time (UTC)
<ul>
<li>UTC 是由 TAI 配合地球自轉速度做修正
<ul>
<li>International Atomic Time(TAI): from 原子鐘</li>
<li>地球自轉速度不是常數</li>
</ul>
</li>
</ul>
</li>
<li>Leap seconds
<ul>
<li>在 on 30 June and 31 December at 23:59:59 UTC
<ul>
<li>negative leap second: 直接跳過去</li>
<li>positive leap second: 跳到 23:59:60等1秒，再跳過去</li>
</ul>
</li>
</ul>
</li>
<li>timestamps格式
<ul>
<li>Unix time: number of seconds since 1 January 1970 00:00:00 UTC
<ul>
<li>不算Leap seconds</li>
</ul>
</li>
<li>ISO 8601: year, month, day, hour, minute, second, and timezone offset relative to UTC
<ul>
<li>2020-11-09T09:50:17+00:00</li>
</ul>
</li>
</ul>
</li>
<li>NTP
<ul>
<li>Clock skew: 兩個clock的差</li>
<li>作法
<ul>
<li>
<p>對多台server取樣，跑算式</p>
<ul>
<li><img src="https://i.imgur.com/WPhU2qf.png" alt=""></li>
</ul>
</li>
<li>
<p>開始調時間</p>
<ul>
<li><img src="https://i.imgur.com/5Z3HV4j.png" alt=""></li>
</ul>
</li>
</ul>
</li>
<li><img src="https://i.imgur.com/KVvBgul.png" alt="">
<ul>
<li>Time-of-day clock
<ul>
<li>從某個時間點開始</li>
<li>適合比較</li>
<li>可能會變動 (NTP矯正)</li>
</ul>
</li>
<li>Monotonic clock
<ul>
<li>隨便一個點開始</li>
<li>適合計算花費的時間</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>logical clocks
<ul>
<li>用來數有多少事件</li>
<li>單調遞增</li>
<li>happens-before relation (就是有向圖的path)
<ul>
<li>定義
<ul>
<li>同一個process
<ul>
<li>a發生在b之前</li>
</ul>
</li>
<li>不同process
<ul>
<li>a送msg，b收到</li>
</ul>
</li>
<li>遞移律
<ul>
<li>a -&gt; b -&gt; c: a -&gt; c</li>
</ul>
</li>
</ul>
</li>
<li>就是有向圖的path
<ul>
<li>partial order</li>
</ul>
</li>
<li>concurrent: 不是 a -&gt; b 或 b -&gt; a
<ul>
<li>a || b</li>
</ul>
</li>
<li><img src="https://i.imgur.com/VNv4Siy.png" alt=""></li>
</ul>
</li>
<li>Causality
<ul>
<li>concurrent代表兩者一定沒有因果關係</li>
<li>有hb就是可能有因果關係</li>
<li>定義
<ul>
<li>a strict total order on events</li>
<li><img src="https://i.imgur.com/lKzhUJo.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Broadcast-protocols-and-logical-time">Broadcast protocols and logical time</h2>
<ul>
<li>
<p>capture causal dependencies</p>
<ul>
<li>No Physical timestamps!!</li>
<li>two types of logical clocks
<ul>
<li>Lamport clocks
<ul>
<li>作法
<ul>
<li>每個process init自己的時間
<ul>
<li><code>t = 0</code></li>
</ul>
</li>
<li>有event發生
<ul>
<li><code>t++</code></li>
</ul>
</li>
<li>send某個m
<ul>
<li><code>t++</code></li>
<li><code>send((t, m))</code></li>
</ul>
</li>
<li>recv到某個(tx, m)
<ul>
<li><code>t = max(tx, t) + 1</code></li>
<li>對m做事</li>
</ul>
</li>
</ul>
</li>
<li>Properties
<ul>
<li>L是取t的函數、N是取在哪個process的函數</li>
<li><img src="https://i.imgur.com/6J6DSfc.png" alt=""></li>
</ul>
</li>
<li>the pair (L(e), N(e)) <strong>uniquely identifies</strong> event e</li>
<li>用Lamport clocks定義total order
<ul>
<li><img src="https://i.imgur.com/kAfy95j.png" alt=""></li>
</ul>
</li>
<li>BUT
<ul>
<li>不同process的timestamp可能會一樣!!
<ul>
<li>不能分辨 a -&gt; b 或是 a || b
<ul>
<li>因為把自己與其他人的時間混在一起了</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Vector clocks
<ul>
<li>作法
<ul>
<li>每個process(假設叫i) init自己的時間
<ul>
<li><code>t = [0] * len(procs)</code></li>
</ul>
</li>
<li>有event發生
<ul>
<li><code>t[i]++</code></li>
</ul>
</li>
<li>send某個m
<ul>
<li><code>t[i]++</code></li>
<li><code>send((t, m))</code></li>
</ul>
</li>
<li>recv到某個(tx, m)
<ul>
<li><code>t = [max(t[j], tx[j]) if j != i else t[i]+1 for j in range(len(procs))]</code></li>
<li>對m做事</li>
</ul>
</li>
</ul>
</li>
<li>用Vector clocks定義total order
<ul>
<li><img src="https://i.imgur.com/2fE1ov3.png" alt=""></li>
<li><img src="https://i.imgur.com/5gQOlhZ.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Broadcast protocols</p>
<ul>
<li><img src="https://i.imgur.com/qWH3jVT.png" alt=""></li>
<li>broadcast的種類
<ul>
<li>FIFO
<ul>
<li>從同一個process出來的msg，收到msg的順序，與送的順序一樣</li>
<li><img src="https://i.imgur.com/EWegnFj.png" alt="">
<ul>
<li>vaild order: (m1一定在m3前面，其他隨便)
<ul>
<li>(m2, m1, m3)</li>
<li>(m1, m2, m3)</li>
<li>(m1, m3, m2)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Causal
<ul>
<li>broadcast(m1) -&gt; broadcast(m2)，那m1一定先收到，之後才是m2</li>
<li><img src="https://i.imgur.com/DG1yL5w.png" alt="">
<ul>
<li>vaild order: (m1 -&gt; m2，m1 -&gt; m3)
<ul>
<li>(m1, m2, m3)</li>
<li>(m1, m3, m2)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Total order
<ul>
<li>只要m1先收到，在所有process都會是m1先收到</li>
<li><img src="https://i.imgur.com/kZF7Dxa.png" alt="">
<ul>
<li>vaild order:
<ul>
<li>(m1, m2, m3)</li>
</ul>
</li>
</ul>
</li>
<li><img src="https://i.imgur.com/MNYzEK2.png" alt="">
<ul>
<li>vaild order:
<ul>
<li>(m1, m3, m2)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>FIFO-total order
<ul>
<li>FIFO + Total order</li>
</ul>
</li>
<li><img src="https://i.imgur.com/pJPOCMv.png" alt=""></li>
</ul>
</li>
<li>Broadcast algorithms
<ul>
<li>要處理兩個部分
<ul>
<li>把best-effort broadcast變成reliable
<ul>
<li>利用retransmitting</li>
</ul>
</li>
<li>保持送(收)的順序</li>
</ul>
</li>
<li>Not Reliable (Naive)
<ul>
<li>直接送到process去</li>
<li>Problem
<ul>
<li>送的process中間掛掉怎麼辦</li>
</ul>
</li>
</ul>
</li>
<li>Reliable
<ul>
<li>Eager reliable broadcast
<ul>
<li>process只要是<strong>第一次</strong>收到時就re-boardcast!!
<ul>
<li>到所有process</li>
</ul>
</li>
<li>Problem
<ul>
<li>總共有O(n^2)個msg在流動!!</li>
</ul>
</li>
</ul>
</li>
<li>Gossip protocols
<ul>
<li>process只要是<strong>第一次</strong>收到時就re-boardcast!!
<ul>
<li>到3個process (隨機選)</li>
</ul>
</li>
<li>適合用在process很多時</li>
<li>Problem
<ul>
<li><strong>Eventually</strong> reaches all nodes (with high probability)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>FIFO broadcast algorithm
<ul>
<li><img src="https://i.imgur.com/pLv6p3a.png" alt=""></li>
<li>重點是在buffer中找有對到自己的delivered的msg才做下一步動作
<ul>
<li>這樣就是FIFO，從同一個process出來的msg的順序是對的</li>
</ul>
</li>
</ul>
</li>
<li>Causal broadcast algorithm
<ul>
<li><img src="https://i.imgur.com/AKXTyBE.png" alt=""></li>
<li>延伸FIFO broadcast algorithm，但
<ul>
<li>改成vector clock!! (這樣就完成CO了!!)</li>
</ul>
</li>
</ul>
</li>
<li>Total order broadcast algorithms
<ol>
<li>Single leader (轉成BFS tree)
<ul>
<li><img src="https://i.imgur.com/jBbn5rf.png" alt=""></li>
<li>會有單點失敗!!</li>
</ul>
</li>
<li>Lamport clocks (用Lamport clocks排序)
<ul>
<li><img src="https://i.imgur.com/BqJpIWH.png" alt=""></li>
<li>怎麼確定我現在拿到的msg是最小的?
<ul>
<li>要等到<strong>每個</strong>process的msg的stamp都比較大才會知道</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="Replication">Replication</h2>
<ul>
<li>Use best-effort broadcast
<ul>
<li>
<p>Idempotence</p>
<ul>
<li>多次操作後不用dedup的操作</li>
<li>retry behaviour
<ul>
<li>At-most-once
<ul>
<li>不retry</li>
</ul>
</li>
<li>At-least-once
<ul>
<li>Retry到收到ack</li>
</ul>
</li>
<li>Exactly-once
<ul>
<li>Retry +
<ul>
<li>idempotence</li>
<li>deduplication</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>就算是idempotence，還是有影響到狀態
<ul>
<li>所以下面的client2到了最後沒辦法看到移除了client1 add的資料的狀態</li>
<li><img src="https://i.imgur.com/7u6ScII.png" alt=""></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Timestamps and tombstones (soft delete)</p>
<ul>
<li>
<p><img src="https://i.imgur.com/2x26pwz.png" alt=""></p>
</li>
<li>
<p>資料會放一個flag，標有沒有被刪過</p>
<ul>
<li><img src="https://i.imgur.com/aajmr03.png" alt=""></li>
</ul>
</li>
<li>
<p>Reconciling replicas</p>
<ul>
<li>還會放一個timestamp標什麼時候被寫入</li>
<li><img src="https://i.imgur.com/d9g7UZu.png" alt=""></li>
</ul>
</li>
<li>
<p>Concurrent writes by different clients</p>
<ul>
<li><img src="https://i.imgur.com/VUk3uP8.png" alt=""></li>
<li>兩種做法
<ul>
<li>Last writer wins
<ul>
<li>取timestamp最大的
<ul>
<li>total order (e.g. Lamport clock)</li>
</ul>
</li>
<li>注意 data loss</li>
</ul>
</li>
<li>Multi-value register
<ul>
<li>如果可以比，取最大；不能比，都存
<ul>
<li>partial order (e.g. vector clock)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Quorum (Byzantine problem)</p>
<ul>
<li>Read-after-write consistency
<ul>
<li><img src="https://i.imgur.com/R1jU3Ii.png" alt=""></li>
</ul>
</li>
<li>只要read(read quorum)/write(write quorum)的response有到達指定人數就取這個結果
<ul>
<li><code>read quorum + write quorum &gt; nodes</code>
<ul>
<li>一般取，<code>(nodes+1)/2</code></li>
<li>可以在write時忍受<code>nodes-write quorum</code>壞掉，read是<code>nodes-read quorum</code></li>
<li><img src="https://i.imgur.com/OhWk7O6.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Use Total order broadcast (在每個process中msg的順序都是一樣的!!)
<ul>
<li>State machine replication
<ul>
<li>FIFO total order broadcast送update msg: 一定會到、順序一樣
<ul>
<li>能不能用更弱的broadcast
<ul>
<li>這樣就沒有順序的保證了!!
<ul>
<li>但是update的順序如果不影響最後的結果的話
<ul>
<li>commutative: <code>f(g(x)) = g(f(x))</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>所以可以把update msg當成map，Replica當成DFA
<ul>
<li>same input, same output: deterministic</li>
</ul>
</li>
<li>限制
<ul>
<li>不能馬上更新，要等msg傳遞</li>
<li>需要 fault-tolerant total order broadcast</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><img src="https://i.imgur.com/lPMblfp.png" alt=""></li>
</ul>
<h2 id="Consensus">Consensus</h2>
<ul>
<li>Fault-tolerant total order broadcast
<ul>
<li>total order broadcast一定要leader!!
<ul>
<li>leader壞了怎麼辦?
<ul>
<li>自己選一個
<ul>
<li>用failure detector (timeout)看leader壞了沒
<ul>
<li>壞了就選下一個</li>
<li>確保只有一個leader
<ul>
<li>用term區份這個任期中誰是該區市民與leader
<ul>
<li>需要定義Quorum (過 半+1)</li>
<li>每個process在每個任期中最多只能投一次票</li>
<li><img src="https://i.imgur.com/lJkuN6R.png" alt=""></li>
</ul>
</li>
<li>這樣可以確保一個任期只有一個leader
<ul>
<li><img src="https://i.imgur.com/19CVQAL.png" alt=""></li>
<li>leader在傳msg之前都要ack，不然怕場面尷尬</li>
<li><img src="https://i.imgur.com/TbniB5b.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Consensus and total order broadcast
<ul>
<li>Consensus: 大家都同意某一個值
<ul>
<li>total order broadcast: 大家都同意下一個msg要送什麼</li>
</ul>
</li>
<li>Consensus and total order broadcast are formally equivalent</li>
</ul>
</li>
<li>Common consensus algorithms: Paxos, Multi-Paxos, Raft</li>
</ul>
</li>
<li>Distributed mutual exclusion
<ul>
<li>作法
<ul>
<li>central lock server
<ul>
<li>leader是bottleneck</li>
<li>單點失敗
<ul>
<li>怎麼重選leader</li>
</ul>
</li>
</ul>
</li>
<li>token passing
<ul>
<li>用一個token去傳(整個要連成一個ring)，拿到就當成拿到lock</li>
<li>單點失敗
<ul>
<li>怎麼rebuild ring</li>
<li>怎麼重生token</li>
</ul>
</li>
</ul>
</li>
<li>Totally ordered multicast
<ul>
<li>只有一個人held，所以讓所有人投票，要拿到N-1
<ul>
<li>raft是(N+1)/2</li>
</ul>
</li>
<li>concurrent requests (兩個以上want lock)
<ul>
<li><img src="https://i.imgur.com/zux8dtF.png" alt=""></li>
<li>看pid比大小
<ul>
<li>哲學家用餐問題!!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Consensus system models
<ul>
<li>假設system model是
<ul>
<li>partially synchronous
<ul>
<li>not asynchronous (FLP result)
<ul>
<li>in an asynchronous crash-stop system model
<ul>
<li>no deterministic consensus algorithm that is guaranteed to terminate</li>
</ul>
</li>
</ul>
</li>
<li>use clocks only used
<ul>
<li>for timeouts/failure detector
<ul>
<li>to ensure progress</li>
</ul>
</li>
<li>not Safety (correctness)</li>
</ul>
</li>
</ul>
</li>
<li>crash-recovery</li>
</ul>
</li>
</ul>
</li>
<li>Raft
<ul>
<li>state(腳色) 變化
<ul>
<li><img src="https://i.imgur.com/oY41Fk7.png" alt=""></li>
</ul>
</li>
<li>元件
<ul>
<li>log: leader傳過的msg 或是 follower收到的msg (array)
<ul>
<li>msg</li>
<li>term: 傳msg當時的term</li>
</ul>
</li>
<li>term: 任期
<ul>
<li>主要是看這個</li>
</ul>
</li>
<li>sentLength: leader傳了多長的log給follower</li>
<li>ackedLength: follower回報他們的log多長</li>
<li>commitLength: 真的有deliver的有多少</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.init_runtime_state()</span><br><span class="line">        self.Term = <span class="number">0</span></span><br><span class="line">        self.votedFor = <span class="literal">None</span></span><br><span class="line">        self.log = []</span><br><span class="line">        self.commitLength = <span class="number">0</span></span><br><span class="line">        self.<span class="built_in">id</span> = <span class="string">&quot;whatever&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_runtime_state</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.Role = <span class="string">&quot;follower&quot;</span></span><br><span class="line">        self.Leader = <span class="literal">None</span></span><br><span class="line">        self.votesReceived = <span class="built_in">set</span>()</span><br><span class="line">        self.sentLength = [<span class="number">0</span>]*<span class="built_in">len</span>(nodes)</span><br><span class="line">        self.ackedLength = [<span class="number">0</span>]*<span class="built_in">len</span>(nodes)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">when_leader_fail_OR_election_timeout</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.Term += <span class="number">1</span></span><br><span class="line">        self.Role = <span class="string">&quot;candidate&quot;</span></span><br><span class="line">        self.votedFor = self.<span class="built_in">id</span></span><br><span class="line">        self.votesReceived.add(self.<span class="built_in">id</span>)</span><br><span class="line">        lastTerm = self.log[-<span class="number">1</span>].term <span class="keyword">if</span> <span class="built_in">len</span>(self.log) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> nodes:</span><br><span class="line">            __send(n, (<span class="string">&quot;VoteRequest&quot;</span>, self.<span class="built_in">id</span>, self.Term, <span class="built_in">len</span>(self.log), lastTerm))</span><br><span class="line">        __startElectionTimer()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">when_recv_VoteRequest</span>(<span class="params">self, cId, cTerm, CLogLen, cLogTerm</span>):</span></span><br><span class="line">        myLogTerm = self.log[-<span class="number">1</span>].term</span><br><span class="line">        </span><br><span class="line">        isLargeLogTerm = cLogTerm &gt; myLogTerm</span><br><span class="line">        inSameLogTerm = myLogTerm == myLogTerm</span><br><span class="line">        hasMoreLog = CLogLen &gt;= <span class="built_in">len</span>(self.log)</span><br><span class="line">        logOK = isLargeLogTerm <span class="keyword">or</span> (inSameLogTerm <span class="keyword">and</span> hasMoreLog)</span><br><span class="line">        </span><br><span class="line">        isLargeTerm = cTerm &gt; self.Term</span><br><span class="line">        inSameTerm = cTerm == self.Term</span><br><span class="line">        notVoted_OR_voteSame = self.votedFor <span class="keyword">in</span> &#123;cId, <span class="literal">None</span>&#125;</span><br><span class="line">        termOK = isLargeTerm <span class="keyword">or</span> (inSameTerm <span class="keyword">and</span> notVoted_OR_voteSame)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> logOK <span class="keyword">and</span> termOK:</span><br><span class="line">            self.Term, self.Role, self.votedFor = cTerm, <span class="string">&quot;follower&quot;</span>, cId</span><br><span class="line">            __send(cId, (<span class="string">&quot;VoteResponse&quot;</span>, self.<span class="built_in">id</span>, self.Term, <span class="literal">True</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            __send(cId, (<span class="string">&quot;VoteResponse&quot;</span>, self.<span class="built_in">id</span>, self.Term, <span class="literal">False</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">when_recv_VoteResponse</span>(<span class="params">self, vId, vTerm, isAgree</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.Role == <span class="string">&quot;candidate&quot;</span> <span class="keyword">and</span> self.Term == vTerm <span class="keyword">and</span> isAgree:</span><br><span class="line">            self.votesReceived.add(vId)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(self.votesReceived) &gt;= (<span class="built_in">len</span>(nodes)+<span class="number">1</span>)//<span class="number">2</span>:</span><br><span class="line">                self.Role, self.Leader = <span class="string">&quot;leader&quot;</span>, self.<span class="built_in">id</span></span><br><span class="line">                __stopElectionTimer()</span><br><span class="line">                <span class="keyword">for</span> n <span class="keyword">in</span> &#123;n <span class="keyword">in</span> nodes <span class="keyword">if</span> n <span class="keyword">is</span> <span class="keyword">not</span> self&#125;:</span><br><span class="line">                    self.sentLength[n], self.ackedLength[n] = <span class="built_in">len</span>(self.log), <span class="number">0</span></span><br><span class="line">                    self.copyLogTo(n)</span><br><span class="line">        <span class="keyword">elif</span> vTerm &gt; self.term:</span><br><span class="line">            self.Role, self.Term, self.votedFor = <span class="string">&quot;follower&quot;</span>, vTerm, <span class="literal">None</span></span><br><span class="line">            __stopElectionTimer()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">broadcast</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.Role == <span class="string">&quot;leader&quot;</span>:</span><br><span class="line">            self.log.append((msg, self.Term))</span><br><span class="line">            self.ackedLength[self.<span class="built_in">id</span>] = <span class="built_in">len</span>(self.log)</span><br><span class="line">            <span class="keyword">for</span> n <span class="keyword">in</span> &#123;n <span class="keyword">in</span> nodes <span class="keyword">if</span> n <span class="keyword">is</span> <span class="keyword">not</span> self&#125;:</span><br><span class="line">                self.copyLogTo(n)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             __forwarding_to_leader(msg)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">periodically_do</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.Role == <span class="string">&quot;leader&quot;</span>:</span><br><span class="line">            <span class="keyword">for</span> n <span class="keyword">in</span> &#123;n <span class="keyword">in</span> nodes <span class="keyword">if</span> n <span class="keyword">is</span> <span class="keyword">not</span> self&#125;:</span><br><span class="line">                self.copyLogTo(n)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copyLogTo</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        i = self.sentLength[n]</span><br><span class="line">        diffLogs = self.log[i:]</span><br><span class="line">        prevFollowerTerm = self.log[<span class="built_in">max</span>(<span class="number">0</span>, i-<span class="number">1</span>)]</span><br><span class="line">        __send(n, (<span class="string">&quot;LogRequest&quot;</span>, self.<span class="built_in">id</span>, self.Term, i, prevFollowerTerm, self.commitLength, diffLogs))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">when_recv_LogRequest</span>(<span class="params">self, lId, lTerm, followerLogStart, followerLogTerm, lCommitLen, diffLogs</span>):</span></span><br><span class="line">        isLargeTerm = lTerm &gt; self.Term</span><br><span class="line">        isCandidate = lTerm == self.Term <span class="keyword">and</span> self.Role == <span class="string">&quot;candidate&quot;</span></span><br><span class="line">        <span class="keyword">if</span> isLargeTerm <span class="keyword">or</span> isCandidate:</span><br><span class="line">            self.Role, self.Leader = <span class="string">&quot;follower&quot;</span>, lId</span><br><span class="line">            <span class="keyword">if</span> isCandidate:</span><br><span class="line">                self.Term, self.votedFor = lTerm, <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        largerLog = <span class="built_in">len</span>(self.log) &gt;= followerLogStart <span class="comment"># follower不能比較大，不然就沒有更新的意義了</span></span><br><span class="line">        isFreshStart = followerLogStart == <span class="number">0</span></span><br><span class="line">        isLogStartInSameTerm = followerLogTerm == self.log[followerLogStart-<span class="number">1</span>].term</span><br><span class="line">        logOK = largerLog <span class="keyword">and</span> (isFreshStart <span class="keyword">or</span> isLogStartInSameTerm)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.Term == lTerm <span class="keyword">and</span> logOK:</span><br><span class="line">            self.patchDiff(followerLogStart, lCommitLen, diffLogs)</span><br><span class="line">            ack = <span class="built_in">len</span>(diffLogs) + followerLogStart</span><br><span class="line">            __send(lId, (<span class="string">&quot;LogResponse&quot;</span>, self.<span class="built_in">id</span>, self.Term, ack, <span class="literal">True</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            __send(lId, (<span class="string">&quot;LogResponse&quot;</span>, self.<span class="built_in">id</span>, self.Term, <span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patchDiff</span>(<span class="params">self, start, lCommitLen, diff</span>):</span></span><br><span class="line">        <span class="comment">#shrink log</span></span><br><span class="line">        <span class="keyword">if</span> diff <span class="keyword">and</span> <span class="built_in">len</span>(self.log) &gt; start <span class="keyword">and</span> self.log[start].term != diff[<span class="number">0</span>].term:</span><br><span class="line">            self.log = self.log[:start]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> start+<span class="built_in">len</span>(diff) &gt; <span class="built_in">len</span>(self.log):</span><br><span class="line">            self.log += diff[<span class="built_in">len</span>(self.log)-start:]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> lCommitLen &gt; self.commitLength:</span><br><span class="line">            <span class="keyword">for</span> msg,_ <span class="keyword">in</span> self.log[self.commitLength:lCommitLen]:</span><br><span class="line">                __deliver(msg)</span><br><span class="line">            self.commitLength = lCommitLen</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">when_recv_LogResponse</span>(<span class="params">self, fId, fTerm, ack, good</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.Term == fTerm <span class="keyword">and</span> self.Role == <span class="string">&quot;leader&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> good <span class="keyword">and</span> ack &gt;= self.ackedLength[fId]:</span><br><span class="line">                self.sentLength[fId] = self.ackedLength[Utils, CId] = ack</span><br><span class="line">                self.commitLogEntries()</span><br><span class="line">            <span class="keyword">elif</span> self.sentLength[fId] &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 太長啦</span></span><br><span class="line">                self.sentLength[fId] -= <span class="number">1</span></span><br><span class="line">                self.copyLogTo(fId)</span><br><span class="line">        <span class="keyword">elif</span> fTerm &gt; self.Term:</span><br><span class="line">            self.Term, self.Role, self.votedFor = fTerm, <span class="string">&quot;follower&quot;</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">commitLogEntries</span>(<span class="params">self</span>):</span></span><br><span class="line">        acks = <span class="keyword">lambda</span> l: <span class="built_in">len</span>(n <span class="keyword">for</span> n <span class="keyword">in</span> nodes <span class="keyword">if</span> self.ackedLength[n] &gt;= l)</span><br><span class="line">        newCommitLen = <span class="built_in">max</span>(&#123;l <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(self.log+<span class="number">1</span>)) <span class="keyword">if</span> acks(l) &gt;= (<span class="built_in">len</span>(nodes)+<span class="number">1</span>)//<span class="number">2</span>&#125;, default=-<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> newCommitLen &gt; self.commitLength <span class="keyword">and</span> self.log[newCommitLen-<span class="number">1</span>].term == self.Term:</span><br><span class="line">            <span class="keyword">for</span> msg,_ <span class="keyword">in</span> self.log[self.commitLength:newCommitLen]:</span><br><span class="line">                __deliver(msg)</span><br><span class="line">            self.commitLength = newCommitLen</span><br></pre></td></tr></table></figure>
<h2 id="Replica-consistency">Replica consistency</h2>
<ul>
<li>各種情境下的Consistency
<ul>
<li>ACID
<ul>
<li>DB在跑完transaction後會從consistent state到另一個consistent state
<ul>
<li>consistent: satisfying application-specific invariants</li>
</ul>
</li>
</ul>
</li>
<li>Read-after-write consistency</li>
<li>Replication: 每個replica都要consistent
<ul>
<li>同樣狀態? 從什麼時候開始算</li>
<li>read都要return一樣的結果</li>
</ul>
</li>
</ul>
</li>
<li>Atomic commit
<ul>
<li>ACID的transaction是
<ul>
<li>either <strong>commits</strong> or <strong>aborts</strong>
<ul>
<li>commit: 是持久的(後面都看的到)</li>
<li>abort: 沒有可見的side-effect</li>
</ul>
</li>
<li>所以如果很多DB，也是either <strong>commits</strong> or <strong>aborts</strong></li>
</ul>
</li>
<li><img src="https://i.imgur.com/11w62Ts.png" alt=""></li>
<li>Two-phase commit
<ul>
<li><img src="https://i.imgur.com/Z35Dk17.png" alt="">
<ul>
<li>如果process在等coordinator回commit或是abort之前掛了?
<ul>
<li>就是等coordinator回來</li>
</ul>
</li>
</ul>
</li>
<li>Fault-tolerant two-phase commit
<ul>
<li>就是傳commit時會帶所有有關的replica
<ul>
<li>這樣只要有人發現在有關的replica掛了就可以發abort
<ul>
<li>total order broadcast</li>
</ul>
</li>
</ul>
</li>
<li>之後就是等return ok
<ul>
<li>都ok，commit</li>
<li>出事，abort</li>
</ul>
</li>
<li><img src="https://i.imgur.com/XQcTkSw.png" alt=""></li>
<li><img src="https://i.imgur.com/iYdUDV0.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Linearizability (strong consistency)
<ul>
<li>多node的atomic operation
<ul>
<li>每個operation的return都是最新的結果</li>
</ul>
</li>
<li>not happens-before
<ul>
<li><img src="https://i.imgur.com/CpAjww1.png" alt=""></li>
<li>set之後的get都要能看到set的結果 (Linearizability)</li>
<li>client1與client2沒有send/recv (not happens-before)
<ul>
<li>所以不能用Lamport clocks!!</li>
<li>只能用phy clock!!</li>
</ul>
</li>
<li>Operations overlapping in time
<ul>
<li>order沒差，這裡的重點是看的到</li>
</ul>
</li>
</ul>
</li>
<li>Serializability &amp; Linearizability
<ul>
<li>Linearizability: 都拿到最新的結果 (cache coherense)</li>
<li>Serializability: 多個transaction同時跑就像是transaction按照某個順序去跑 (mem model)</li>
</ul>
</li>
<li><img src="https://i.imgur.com/OeBQ63c.png" alt="">
<ul>
<li>client2與client3拿到的結果不對 (not Linearizability)!!</li>
</ul>
</li>
<li><img src="https://i.imgur.com/Lj5OqBj.png" alt="">
<ul>
<li>手法
<ul>
<li>get的linearizability
<ul>
<li>quorum read</li>
</ul>
</li>
<li>set的linearizability
<ul>
<li>blind write to quorum</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Linearizable compare-and-swap (CAS)
<ul>
<li>total order broadcast</li>
<li><img src="https://i.imgur.com/Gbnhidk.png" alt=""></li>
</ul>
</li>
<li>advantages
<ul>
<li>分散式不像分散式</li>
<li>使用上就變簡單了</li>
</ul>
</li>
<li>Downsides
<ul>
<li>Performance: 很多msg與一直在等</li>
<li>Scalability: 需要leader</li>
<li>Availability: 連不到quorum什麼事都不用做</li>
</ul>
</li>
</ul>
</li>
<li>Eventual consistency
<ul>
<li>The CAP theorem
<ul>
<li>在網路會gg的情況下 (network <strong>P</strong>artition)，只能保證一個
<ul>
<li><strong>C</strong>onsistent (linearizable)
<ul>
<li>等</li>
</ul>
</li>
<li><strong>A</strong>vailable
<ul>
<li>不等，直接傳自己的舊資料</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>只要沒有進一步的update，所有replica都會變成一樣的state</li>
<li>Strong eventual consistency
<ul>
<li>Convergence: 只要是同一個state跑同一集合的update(order沒差)，最後會是一樣的狀態</li>
<li>Eventual delivery: 只要有人被update到，最後所有人都會被update到</li>
</ul>
</li>
<li>Properties
<ul>
<li>不用等</li>
<li>只要Causal broadcast或以下就可以update</li>
<li>Concurrent updates =&gt; 只要能處理conflict就沒事</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/U8744mn.png" alt=""></p>
<h2 id="Concurrency-control-in-applications-152">Concurrency control in applications (152)</h2>
<ul>
<li>
<p>Conflicts due to concurrent updates</p>
<ul>
<li><img src="https://i.imgur.com/pbm0oxw.png" alt=""></li>
<li>解法
<ul>
<li>
<p>Conflict-free Replicated Data Types (CRDTs)</p>
<ul>
<li>就是有timestamp的dict
<ul>
<li><img src="https://i.imgur.com/oeUDKYv.png" alt=""></li>
</ul>
</li>
<li>作法
<ul>
<li>Operation-based
<ul>
<li>傳的是action (set)
<ul>
<li>reliable broadcast (一定要到，但可以是任何順序)
<ul>
<li>action(set)一定要commutative</li>
</ul>
</li>
</ul>
</li>
<li>typically has smaller messages</li>
<li><img src="https://i.imgur.com/CZpjVYN.png" alt=""></li>
<li>例子: Operation-based text CRDT
<ul>
<li><img src="https://i.imgur.com/8WnwAfe.png" alt=""></li>
<li>init &amp; read
<ul>
<li><img src="https://i.imgur.com/hHiFnJE.png" alt="">
<ul>
<li>elementAt就是<code>array[i]</code>，實作在set上</li>
</ul>
</li>
</ul>
</li>
<li>有一段區間，insert就是二分
<ul>
<li><img src="https://i.imgur.com/wElkybh.png" alt=""></li>
<li><img src="https://i.imgur.com/T3DpsNF.png" alt=""></li>
</ul>
</li>
<li>delete就是把tuple從state中去掉
<ul>
<li><img src="https://i.imgur.com/0TRFMd4.png" alt=""></li>
</ul>
</li>
<li>causal broadcast
<ul>
<li>insert要在delete之前先到</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>State-based
<ul>
<li>傳的是state (整個values)
<ul>
<li>best-effort broadcast (不到沒關係)
<ul>
<li>原本reliable確保一定會到，但現在沒有
<ul>
<li>Idempotent</li>
</ul>
</li>
<li>剩下就是原本reliable的事
<ul>
<li>Commutative</li>
<li>不過現在一次多個 (opration based是一次兩個)
<ul>
<li>Associative</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>can tolerate message loss/duplication</li>
<li><img src="https://i.imgur.com/Wwrf5YJ.png" alt="">
<ul>
<li><img src="https://i.imgur.com/11XKqz2.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Operational Transformation (OT)</p>
<ul>
<li>把operation記錄下來，之後需要重組可以重新組合
<ul>
<li><img src="https://i.imgur.com/tVoFVQi.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Consistent snapshots</p>
<ul>
<li>前面做的事(包含transcation)，後面(包含transcation)看的到
<ul>
<li>consistent with causality
<ul>
<li>transcation都要consistent with causality
<ul>
<li>linearizability depends on real-time order
<ul>
<li><img src="https://i.imgur.com/4euc5IX.png" alt="">
<ul>
<li>把誤差補上</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>作法: multi-version concurrency control (MVCC)
<ul>
<li>每一次write都會產生新的版本與相對應的timestamp</li>
<li>read-only transcation就是一個時間
<ul>
<li>read時就是取比自己早且最靠近自己的資料</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>snapshot of system-wide state</p>
<ul>
<li>Consistent cuts
<ul>
<li>區分event的cut
<ul>
<li>在cut中的event都是happens-before
<ul>
<li>除了起點<code>:-)</code>，所以是consistent</li>
</ul>
</li>
</ul>
</li>
<li>也就是，在左手邊的event只有兩種
<ul>
<li>send</li>
<li>recv，同時他的send也在cut(左手邊)中</li>
</ul>
</li>
<li><img src="https://i.imgur.com/cgC72Fo.png" alt="">
<ul>
<li>f只有recv，沒有send在cut中，就不是consistent</li>
</ul>
</li>
</ul>
</li>
<li>收集snapshot of system-wide state
<ul>
<li>把Consistent cut推到的地方才收集local state
<ul>
<li>local state之後可以集合起來變成global state</li>
</ul>
</li>
<li>怎麼代表cut?
<ul>
<li>用marker msg以causal order去發
<ul>
<li>收到marker就收集state
<ul>
<li>但是當初收到marker的channel不用
<ul>
<li>因為前一個process已經收集過了</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Ref-144">Ref</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC83NmZmNzcxOGQzODE=">Linearizability versus Serializability<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cHM6Ly93d3cuY2wuY2FtLmFjLnVrL3RlYWNoaW5nLzIwMjEvQ29uY0Rpc1N5cy9kaXN0LXN5cy1oYW5kb3V0LnBkZg==">Distributed Systems (好地方，如果slide不懂還有lecture note)<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cHM6Ly93d3cuY2wuY2FtLmFjLnVrL3RlYWNoaW5nLzE4MTkvQ29uY0Rpc1N5cy8yMDE4LUNEUy0xQi1MMTMtcm1tLnBkZg==">Lecture 13: Vector clocks, consistent cuts, process groups, and distributed mutual exclusion<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/k8s-concepts/" rel="prev" title="k8s概念">
      <i class="fa fa-chevron-left"></i> k8s概念
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/database-system/" rel="next" title="database system">
      database system <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8B%95%E6%A9%9F-657"><span class="nav-number">1.</span> <span class="nav-text">動機</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Models-of-distributed-systems"><span class="nav-number">2.</span> <span class="nav-text">Models of distributed systems</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Time-clocks-and-ordering-of-events"><span class="nav-number">3.</span> <span class="nav-text">Time, clocks, and ordering of events</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Broadcast-protocols-and-logical-time"><span class="nav-number">4.</span> <span class="nav-text">Broadcast protocols and logical time</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Replication"><span class="nav-number">5.</span> <span class="nav-text">Replication</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consensus"><span class="nav-number">6.</span> <span class="nav-text">Consensus</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Replica-consistency"><span class="nav-number">7.</span> <span class="nav-text">Replica consistency</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Concurrency-control-in-applications-152"><span class="nav-number">8.</span> <span class="nav-text">Concurrency control in applications (152)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ref-144"><span class="nav-number">9.</span> <span class="nav-text">Ref</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhengcf</p>
  <div class="site-description" itemprop="description">想到什麼就寫什麼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">690</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengcf</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 1000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://littlebees.github.io/2022/01/Distributed-computing/',]
      });
      });
  </script>

</body>
</html>
