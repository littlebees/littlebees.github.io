<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rebuilding Rails的心得 | 記事本</title>
<meta name=keywords content="Rails"><meta name=description content='Ch1 Zero to “It Works!” Gem的檔案結構 $ bundle gem rulers create rulers/Gemfile create rulers/Rakefile create rulers/LICENSE.txt create rulers/README.md create rulers/.gitignore create rulers/rulers.gemspec # !! create rulers/lib/rulers.rb # !! create rulers/lib/rulers/version.rb Initializating git repo in src/rulers rulers/rulers.gemspec放的是gem的資訊與dependency
rulers/lib/rulers.rb就是主程式
dependency分成development與runtime # rulers.gemspec gem.add_development_dependency "rspec" gem.add_runtime_dependency "rest-client" rack進入點 與 rack app回傳值的資料結構 # best_quotes/config.ru run proc { [200, {&#39;Content-Type&#39; => &#39;text/html&#39;}, ["Hello, world!"]] } 狀態值,header,資料
rack app 的 interface # rulers/lib/rulers.rb require "rulers/version" module Rulers class Application def call(env) [200, {&#39;Content-Type&#39; => &#39;text/html&#39;}, ["Hello from Ruby on Rulers!'><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2020/04/rebuilding-rails%E7%9A%84%E5%BF%83%E5%BE%97/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2020/04/rebuilding-rails%E7%9A%84%E5%BF%83%E5%BE%97/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Rebuilding Rails的心得"><meta property="og:description" content='Ch1 Zero to “It Works!” Gem的檔案結構 $ bundle gem rulers create rulers/Gemfile create rulers/Rakefile create rulers/LICENSE.txt create rulers/README.md create rulers/.gitignore create rulers/rulers.gemspec # !! create rulers/lib/rulers.rb # !! create rulers/lib/rulers/version.rb Initializating git repo in src/rulers rulers/rulers.gemspec放的是gem的資訊與dependency
rulers/lib/rulers.rb就是主程式
dependency分成development與runtime # rulers.gemspec gem.add_development_dependency "rspec" gem.add_runtime_dependency "rest-client" rack進入點 與 rack app回傳值的資料結構 # best_quotes/config.ru run proc { [200, {&#39;Content-Type&#39; => &#39;text/html&#39;}, ["Hello, world!"]] } 狀態值,header,資料
rack app 的 interface # rulers/lib/rulers.rb require "rulers/version" module Rulers class Application def call(env) [200, {&#39;Content-Type&#39; => &#39;text/html&#39;}, ["Hello from Ruby on Rulers!'><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2020/04/rebuilding-rails%E7%9A%84%E5%BF%83%E5%BE%97/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-17T11:28:15+00:00"><meta property="article:modified_time" content="2020-04-17T11:28:15+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="Rebuilding Rails的心得"><meta name=twitter:description content='Ch1 Zero to “It Works!” Gem的檔案結構 $ bundle gem rulers create rulers/Gemfile create rulers/Rakefile create rulers/LICENSE.txt create rulers/README.md create rulers/.gitignore create rulers/rulers.gemspec # !! create rulers/lib/rulers.rb # !! create rulers/lib/rulers/version.rb Initializating git repo in src/rulers rulers/rulers.gemspec放的是gem的資訊與dependency
rulers/lib/rulers.rb就是主程式
dependency分成development與runtime # rulers.gemspec gem.add_development_dependency "rspec" gem.add_runtime_dependency "rest-client" rack進入點 與 rack app回傳值的資料結構 # best_quotes/config.ru run proc { [200, {&#39;Content-Type&#39; => &#39;text/html&#39;}, ["Hello, world!"]] } 狀態值,header,資料
rack app 的 interface # rulers/lib/rulers.rb require "rulers/version" module Rulers class Application def call(env) [200, {&#39;Content-Type&#39; => &#39;text/html&#39;}, ["Hello from Ruby on Rulers!'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Rebuilding Rails的心得","item":"https://littlebees.github.io/2020/04/rebuilding-rails%E7%9A%84%E5%BF%83%E5%BE%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rebuilding Rails的心得","name":"Rebuilding Rails的心得","description":"Ch1 Zero to “It Works!” Gem的檔案結構 $ bundle gem rulers create rulers/Gemfile create rulers/Rakefile create rulers/LICENSE.txt create rulers/README.md create rulers/.gitignore create rulers/rulers.gemspec # !! create rulers/lib/rulers.rb # !! create rulers/lib/rulers/version.rb Initializating git repo in src/rulers rulers/rulers.gemspec放的是gem的資訊與dependency\nrulers/lib/rulers.rb就是主程式\ndependency分成development與runtime # rulers.gemspec gem.add_development_dependency \u0026#34;rspec\u0026#34; gem.add_runtime_dependency \u0026#34;rest-client\u0026#34; rack進入點 與 rack app回傳值的資料結構 # best_quotes/config.ru run proc { [200, {\u0026#39;Content-Type\u0026#39; =\u0026gt; \u0026#39;text/html\u0026#39;}, [\u0026#34;Hello, world!\u0026#34;]] } 狀態值,header,資料\nrack app 的 interface # rulers/lib/rulers.rb require \u0026#34;rulers/version\u0026#34; module Rulers class Application def call(env) [200, {\u0026#39;Content-Type\u0026#39; =\u0026gt; \u0026#39;text/html\u0026#39;}, [\u0026#34;Hello from Ruby on Rulers!","keywords":["Rails"],"articleBody":"Ch1 Zero to “It Works!” Gem的檔案結構 $ bundle gem rulers create rulers/Gemfile create rulers/Rakefile create rulers/LICENSE.txt create rulers/README.md create rulers/.gitignore create rulers/rulers.gemspec # !! create rulers/lib/rulers.rb # !! create rulers/lib/rulers/version.rb Initializating git repo in src/rulers rulers/rulers.gemspec放的是gem的資訊與dependency\nrulers/lib/rulers.rb就是主程式\ndependency分成development與runtime # rulers.gemspec gem.add_development_dependency \"rspec\" gem.add_runtime_dependency \"rest-client\" rack進入點 與 rack app回傳值的資料結構 # best_quotes/config.ru run proc { [200, {'Content-Type' =\u003e 'text/html'}, [\"Hello, world!\"]] } 狀態值,header,資料\nrack app 的 interface # rulers/lib/rulers.rb require \"rulers/version\" module Rulers class Application def call(env) [200, {'Content-Type' =\u003e 'text/html'}, [\"Hello from Ruby on Rulers!\"]] end end end 要有call的method，吃的是來自rack的env\nnew是編譯期的args，call是runtime的args # best_quotes/config.ru require './config/application' run BestQuotes::Application.new Ch2 Your First Controller # rulers/lib/rulers.rb require \"rulers/version\" require \"rulers/routing\" module Rulers class Application def call(env) klass, act = get_controller_and_action(env) controller = klass.new(env) text = controller.send(act) [200, {'Content-Type' =\u003e 'text/html'}, [text]] end def get_controller_and_action(env) _, cont, action, after = env[\"PATH_INFO\"].split('/', 4) cont = cont.capitalize # \"People\" cont += \"Controller\" # \"PeopleController\" [Object.const_get(cont), action] end end class Controller def initialize(env) @env = env end def env @env end end end 觀察 get_controller_and_action :: env -\u003e (Class, Symbol) Controller :: env -\u003e obj(一堆action) Ch3 Rails Automatic Loading const_missing class Object def self.const_missing(c) require \"./bobo\" Bobo end end Bobo.new.print_bobo CamelCase and snake_case # rulers/lib/rulers/util.rb module Rulers def self.to_underscore(string) string.gsub(/::/, '/'). gsub(/([A-Z]+)([A-Z][a-z])/,'\\1_\\2'). gsub(/([a-z\\d])([A-Z])/,'\\1_\\2'). tr(\"-\", \"_\"). downcase end end auto-load # rulers/lib/rulers/dependencies.rb class Object def self.const_missing(c) require Rulers.to_underscore(c.to_s) Object.const_get(c) end end # best_quotes/config/application.rb require \"rulers\" $LOAD_PATH \u003c\u003c File.join(File.dirname(__FILE__),\"..\", \"app\",\"controllers\") #require要的 # --\u003e No more require here! \u003c-- module BestQuotes class Application \u003c Rulers::Application end end Ch4 Rendering Views erb # some_directory/erb_test.rb require \"erubis\" template = \u003c","wordCount":"1410","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2020-04-17T11:28:15Z","dateModified":"2020-04-17T11:28:15Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2020/04/rebuilding-rails%E7%9A%84%E5%BF%83%E5%BE%97/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Rebuilding Rails的心得</h1><div class=post-meta><span title='2020-04-17 11:28:15 +0000 UTC'>April 17, 2020</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#ch1-zero-to-it-works aria-label="Ch1 Zero to “It Works!”">Ch1 Zero to “It Works!”</a><ul><li><a href=#gem%e7%9a%84%e6%aa%94%e6%a1%88%e7%b5%90%e6%a7%8b aria-label=Gem的檔案結構>Gem的檔案結構</a></li><li><a href=#dependency%e5%88%86%e6%88%90development%e8%88%87runtime aria-label=dependency分成development與runtime>dependency分成development與runtime</a></li><li><a href=#rack%e9%80%b2%e5%85%a5%e9%bb%9e-%e8%88%87-rack-app%e5%9b%9e%e5%82%b3%e5%80%bc%e7%9a%84%e8%b3%87%e6%96%99%e7%b5%90%e6%a7%8b aria-label="rack進入點 與 rack app回傳值的資料結構">rack進入點 與 rack app回傳值的資料結構</a></li><li><a href=#rack-app-%e7%9a%84-interface aria-label="rack app 的 interface">rack app 的 interface</a></li><li><a href=#new%e6%98%af%e7%b7%a8%e8%ad%af%e6%9c%9f%e7%9a%84argscall%e6%98%afruntime%e7%9a%84args aria-label=new是編譯期的args，call是runtime的args>new是編譯期的args，call是runtime的args</a></li></ul></li><li><a href=#ch2-your-first-controller aria-label="Ch2 Your First Controller">Ch2 Your First Controller</a><ul><li><a href=#%e8%a7%80%e5%af%9f aria-label=觀察>觀察</a></li></ul></li><li><a href=#ch3-rails-automatic-loading aria-label="Ch3 Rails Automatic Loading">Ch3 Rails Automatic Loading</a><ul><li><a href=#const_missing aria-label=const_missing>const_missing</a></li><li><a href=#camelcase-and-snake_case aria-label="CamelCase and snake_case">CamelCase and snake_case</a></li><li><a href=#auto-load aria-label=auto-load>auto-load</a></li></ul></li><li><a href=#ch4-rendering-views aria-label="Ch4 Rendering Views">Ch4 Rendering Views</a><ul><li><a href=#erb aria-label=erb>erb</a></li><li><a href=#render aria-label=render>render</a></li><li><a href=#%e8%a7%80%e5%af%9f-1 aria-label=觀察>觀察</a></li></ul></li><li><a href=#ch5-basic-models aria-label="Ch5 Basic Models">Ch5 Basic Models</a></li><li><a href=#ch6-request-response aria-label="Ch6 Request, Response">Ch6 Request, Response</a><ul><li><a href=#request aria-label=Request>Request</a></li><li><a href=#response aria-label=Response>Response</a></li></ul></li><li><a href=#ch7-the-littlest-orm aria-label="Ch7 The Littlest ORM">Ch7 The Littlest ORM</a><ul><li><a href=#migration-%e4%b9%8b%e5%be%8cdb%e5%81%9a%e4%ba%8b%e4%b9%8b%e5%89%8d aria-label="Migration 之後，DB做事之前">Migration 之後，DB做事之前</a></li><li><a href=#model aria-label=Model>Model</a></li><li><a href=#method_missing--define_method aria-label="method_missing & define_method">method_missing & define_method</a></li></ul></li><li><a href=#ch8-rack-middleware aria-label="Ch8 Rack Middleware">Ch8 Rack Middleware</a><ul><li><a href=#rack-app%e7%9a%84interfacetype-signature--%e5%a6%82%e4%bd%95%e7%96%8aapp aria-label="rack app的interface(type signature) & 如何疊app">rack app的interface(type signature) & 如何疊app</a></li><li><a href=#map aria-label=map>map</a></li></ul></li><li><a href=#ch9-real-routing aria-label="Ch9 Real Routing">Ch9 Real Routing</a><ul><li><a href=#controller-actions-are-rack-apps aria-label="Controller Actions are Rack Apps">Controller Actions are Rack Apps</a></li><li><a href=#route-%e4%b9%9f%e5%b0%b1%e6%98%af-match aria-label="Route 也就是 match">Route 也就是 match</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a><ul><li><a href=#from-env-to-res aria-label="from env to res">from env to res</a></li></ul></li><li><a href=#appendix-unobtrusive-javascript aria-label="Appendix: Unobtrusive JavaScript">Appendix: Unobtrusive JavaScript</a></li></ul></div></details></div><div class=post-content><h2 id=ch1-zero-to-it-works>Ch1 Zero to “It Works!”<a hidden class=anchor aria-hidden=true href=#ch1-zero-to-it-works>#</a></h2><h3 id=gem的檔案結構>Gem的檔案結構<a hidden class=anchor aria-hidden=true href=#gem的檔案結構>#</a></h3><pre tabindex=0><code>$ bundle gem rulers
    create rulers/Gemfile
    create rulers/Rakefile
    create rulers/LICENSE.txt
    create rulers/README.md
    create rulers/.gitignore
    create rulers/rulers.gemspec # !!
    create rulers/lib/rulers.rb  # !!
    create rulers/lib/rulers/version.rb
Initializating git repo in src/rulers
</code></pre><p><code>rulers/rulers.gemspec</code>放的是gem的資訊與dependency</p><p><code>rulers/lib/rulers.rb</code>就是主程式</p><h3 id=dependency分成development與runtime>dependency分成development與runtime<a hidden class=anchor aria-hidden=true href=#dependency分成development與runtime>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers.gemspec</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gem</span><span class=o>.</span><span class=n>add_development_dependency</span> <span class=s2>&#34;rspec&#34;</span>
</span></span><span class=line><span class=cl><span class=n>gem</span><span class=o>.</span><span class=n>add_runtime_dependency</span> <span class=s2>&#34;rest-client&#34;</span>
</span></span></code></pre></div><h3 id=rack進入點-與-rack-app回傳值的資料結構>rack進入點 與 rack app回傳值的資料結構<a hidden class=anchor aria-hidden=true href=#rack進入點-與-rack-app回傳值的資料結構>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># best_quotes/config.ru</span>
</span></span><span class=line><span class=cl><span class=n>run</span> <span class=nb>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[</span><span class=s2>&#34;Hello, world!&#34;</span><span class=o>]]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>狀態值,header,資料</p><h3 id=rack-app-的-interface>rack app 的 interface<a hidden class=anchor aria-hidden=true href=#rack-app-的-interface>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers.rb</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rulers/version&#34;</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Application</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[</span><span class=s2>&#34;Hello from Ruby on Rulers!&#34;</span><span class=o>]]</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>要有call的method，吃的是來自rack的env</p><h3 id=new是編譯期的argscall是runtime的args>new是編譯期的args，call是runtime的args<a hidden class=anchor aria-hidden=true href=#new是編譯期的argscall是runtime的args>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># best_quotes/config.ru</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;./config/application&#39;</span>
</span></span><span class=line><span class=cl><span class=n>run</span> <span class=no>BestQuotes</span><span class=o>::</span><span class=no>Application</span><span class=o>.</span><span class=n>new</span>
</span></span></code></pre></div><h2 id=ch2-your-first-controller>Ch2 Your First Controller<a hidden class=anchor aria-hidden=true href=#ch2-your-first-controller>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers.rb</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rulers/version&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rulers/routing&#34;</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Application</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>klass</span><span class=p>,</span> <span class=n>act</span> <span class=o>=</span> <span class=n>get_controller_and_action</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>controller</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>text</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>act</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[</span><span class=n>text</span><span class=o>]]</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_controller_and_action</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>_</span><span class=p>,</span> <span class=n>cont</span><span class=p>,</span> <span class=n>action</span><span class=p>,</span> <span class=n>after</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s2>&#34;PATH_INFO&#34;</span><span class=o>].</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>cont</span> <span class=o>=</span> <span class=n>cont</span><span class=o>.</span><span class=n>capitalize</span> <span class=c1># &#34;People&#34;</span>
</span></span><span class=line><span class=cl>     <span class=n>cont</span> <span class=o>+=</span> <span class=s2>&#34;Controller&#34;</span> <span class=c1># &#34;PeopleController&#34;</span>
</span></span><span class=line><span class=cl>     <span class=o>[</span><span class=no>Object</span><span class=o>.</span><span class=n>const_get</span><span class=p>(</span><span class=n>cont</span><span class=p>),</span> <span class=n>action</span><span class=o>]</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Controller</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=vi>@env</span> <span class=o>=</span> <span class=n>env</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>env</span>
</span></span><span class=line><span class=cl>     <span class=vi>@env</span>
</span></span><span class=line><span class=cl>   <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=觀察>觀察<a hidden class=anchor aria-hidden=true href=#觀察>#</a></h3><ul><li><code>get_controller_and_action</code> :: env -> (Class, Symbol)</li><li><code>Controller</code> :: env -> obj(一堆action)</li></ul><h2 id=ch3-rails-automatic-loading>Ch3 Rails Automatic Loading<a hidden class=anchor aria-hidden=true href=#ch3-rails-automatic-loading>#</a></h2><h3 id=const_missing>const_missing<a hidden class=anchor aria-hidden=true href=#const_missing>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>class</span> <span class=nc>Object</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>const_missing</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span> <span class=s2>&#34;./bobo&#34;</span>
</span></span><span class=line><span class=cl>    <span class=no>Bobo</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=no>Bobo</span><span class=o>.</span><span class=n>new</span><span class=o>.</span><span class=n>print_bobo</span>
</span></span></code></pre></div><h3 id=camelcase-and-snake_case>CamelCase and snake_case<a hidden class=anchor aria-hidden=true href=#camelcase-and-snake_case>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers/util.rb</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>to_underscore</span><span class=p>(</span><span class=n>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>string</span><span class=o>.</span><span class=n>gsub</span><span class=p>(</span><span class=sr>/::/</span><span class=p>,</span> <span class=s1>&#39;/&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=nb>gsub</span><span class=p>(</span><span class=sr>/([A-Z]+)([A-Z][a-z])/</span><span class=p>,</span><span class=s1>&#39;\1_\2&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=nb>gsub</span><span class=p>(</span><span class=sr>/([a-z\d])([A-Z])/</span><span class=p>,</span><span class=s1>&#39;\1_\2&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=n>tr</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=n>downcase</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=auto-load>auto-load<a hidden class=anchor aria-hidden=true href=#auto-load>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers/dependencies.rb</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Object</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>const_missing</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span> <span class=no>Rulers</span><span class=o>.</span><span class=n>to_underscore</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>to_s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=no>Object</span><span class=o>.</span><span class=n>const_get</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># best_quotes/config/application.rb</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rulers&#34;</span>
</span></span><span class=line><span class=cl><span class=vg>$LOAD_PATH</span> <span class=o>&lt;&lt;</span> <span class=no>File</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=bp>__FILE__</span><span class=p>),</span><span class=s2>&#34;..&#34;</span><span class=p>,</span> <span class=s2>&#34;app&#34;</span><span class=p>,</span><span class=s2>&#34;controllers&#34;</span><span class=p>)</span> <span class=c1>#require要的</span>
</span></span><span class=line><span class=cl><span class=c1># --&gt; No more require here! &lt;--</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>BestQuotes</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Application</span> <span class=o>&lt;</span> <span class=no>Rulers</span><span class=o>::</span><span class=no>Application</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=ch4-rendering-views>Ch4 Rendering Views<a hidden class=anchor aria-hidden=true href=#ch4-rendering-views>#</a></h2><h3 id=erb>erb<a hidden class=anchor aria-hidden=true href=#erb>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># some_directory/erb_test.rb</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;erubis&#34;</span>
</span></span><span class=line><span class=cl><span class=n>template</span> <span class=o>=</span> <span class=s>&lt;&lt;TEMPLATE
</span></span></span><span class=line><span class=cl><span class=s></span>    <span class=no>Hello</span><span class=o>!</span> <span class=no>This</span> <span class=n>is</span> <span class=n>a</span> <span class=n>template</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=no>It</span> <span class=n>has</span> <span class=o>&lt;</span><span class=s>%= whatever %&gt;.
</span></span></span><span class=line><span class=cl><span class=s>TEMPLATE
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>eruby =</span> <span class=no>Erubis</span><span class=o>::</span><span class=no>Eruby</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=n>eruby</span><span class=o>.</span><span class=n>src</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=s2>&#34;==========&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=n>eruby</span><span class=o>.</span><span class=n>result</span><span class=p>(</span><span class=ss>:whatever</span> <span class=o>=&gt;</span> <span class=s2>&#34;ponies!&#34;</span><span class=p>)</span>
</span></span></code></pre></div><hr><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>_buf</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>_buf</span> <span class=o>&lt;&lt;</span> <span class=s1>&#39;Hello!   This is a template. It has &#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>_buf</span> <span class=o>&lt;&lt;</span> <span class=p>(</span> <span class=n>whatever</span> <span class=p>)</span><span class=o>.</span><span class=n>to_s</span><span class=p>;</span> <span class=n>_buf</span> <span class=o>&lt;&lt;</span> <span class=s1>&#39;.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>_buf</span><span class=o>.</span><span class=n>to_s</span>
</span></span></code></pre></div><p>==========</p><pre tabindex=0><code>Hello! This is a template.
It has ponies!.
</code></pre><h3 id=render>render<a hidden class=anchor aria-hidden=true href=#render>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers/controller.rb (excerpt)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>render</span><span class=p>(</span><span class=n>view_name</span><span class=p>,</span> <span class=n>locals</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=n>filename</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>join</span> <span class=s2>&#34;app&#34;</span><span class=p>,</span> <span class=s2>&#34;views&#34;</span><span class=p>,</span><span class=s2>&#34;</span><span class=si>#{</span><span class=n>view_name</span><span class=si>}</span><span class=s2>.html.erb&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>template</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>read</span> <span class=n>filename</span>
</span></span><span class=line><span class=cl>    <span class=n>eruby</span> <span class=o>=</span> <span class=no>Erubis</span><span class=o>::</span><span class=no>Eruby</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>eruby</span><span class=o>.</span><span class=n>result</span> <span class=n>locals</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=ss>:env</span> <span class=o>=&gt;</span> <span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>locals是controller的資料
env是來自rack的資料</p><h3 id=觀察-1>觀察<a hidden class=anchor aria-hidden=true href=#觀察-1>#</a></h3><ul><li>parse -> proc having lots of string -> eval -> string</li></ul><h2 id=ch5-basic-models>Ch5 Basic Models<a hidden class=anchor aria-hidden=true href=#ch5-basic-models>#</a></h2><p>skip</p><h2 id=ch6-request-response>Ch6 Request, Response<a hidden class=anchor aria-hidden=true href=#ch6-request-response>#</a></h2><h3 id=request>Request<a hidden class=anchor aria-hidden=true href=#request>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Controller</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>request</span>
</span></span><span class=line><span class=cl>            <span class=vi>@request</span> <span class=o>||=</span> <span class=no>Rack</span><span class=o>::</span><span class=no>Request</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=vi>@env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>params</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=o>.</span><span class=n>params</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>從 <code>env</code> 得到 <code>Request</code> 再從中得到 <code>params</code></p><h3 id=response>Response<a hidden class=anchor aria-hidden=true href=#response>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Controller</span>
</span></span><span class=line><span class=cl>        <span class=c1>#private</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>response</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>status</span> <span class=o>=</span> <span class=mi>200</span><span class=p>,</span> <span class=n>headers</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=s2>&#34;Already responded!&#34;</span> <span class=k>if</span> <span class=vi>@response</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span> <span class=o>=</span> <span class=o>[</span><span class=n>text</span><span class=o>].</span><span class=n>flatten</span>
</span></span><span class=line><span class=cl>            <span class=vi>@response</span> <span class=o>=</span> <span class=no>Rack</span><span class=o>::</span><span class=no>Response</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>render</span><span class=p>(</span><span class=n>view_name</span><span class=p>,</span> <span class=n>locals</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>join</span> <span class=s2>&#34;app&#34;</span><span class=p>,</span> <span class=s2>&#34;views&#34;</span><span class=p>,</span><span class=s2>&#34;</span><span class=si>#{</span><span class=n>view_name</span><span class=si>}</span><span class=s2>.html.erb&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>template</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>read</span> <span class=n>filename</span>
</span></span><span class=line><span class=cl>            <span class=n>eruby</span> <span class=o>=</span> <span class=no>Erubis</span><span class=o>::</span><span class=no>Eruby</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>eruby</span><span class=o>.</span><span class=n>result</span> <span class=n>locals</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=ss>:env</span> <span class=o>=&gt;</span> <span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=c1>#public</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>get_response</span> <span class=c1># Only for Rulers</span>
</span></span><span class=line><span class=cl>            <span class=vi>@response</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>render_response</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=p>(</span><span class=n>render</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p><code>response</code>產生three tuple，就是rack app真正要回傳的東西</p><h2 id=ch7-the-littlest-orm>Ch7 The Littlest ORM<a hidden class=anchor aria-hidden=true href=#ch7-the-littlest-orm>#</a></h2><h3 id=migration-之後db做事之前>Migration 之後，DB做事之前<a hidden class=anchor aria-hidden=true href=#migration-之後db做事之前>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># best_quotes/mini_migration.rb</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;sqlite3&#34;</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=no>SQLite3</span><span class=o>::</span><span class=no>Database</span><span class=o>.</span><span class=n>new</span> <span class=s2>&#34;test.db&#34;</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>execute</span> <span class=s>&lt;&lt;SQL
</span></span></span><span class=line><span class=cl><span class=s></span><span class=n>create</span> <span class=n>table</span> <span class=n>my_table</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=nb>id</span> <span class=no>INTEGER</span> <span class=no>PRIMARY</span> <span class=no>KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=n>posted</span> <span class=no>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=n>title</span> <span class=no>VARCHAR</span><span class=p>(</span><span class=mi>30</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=n>body</span> <span class=no>VARCHAR</span><span class=p>(</span><span class=mi>32000</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=no>SQL</span>
</span></span></code></pre></div><h3 id=model>Model<a hidden class=anchor aria-hidden=true href=#model>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers/sqlite_model.rb</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;sqlite3&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rulers/util&#34;</span>
</span></span><span class=line><span class=cl><span class=no>DB</span> <span class=o>=</span> <span class=no>SQLite3</span><span class=o>::</span><span class=no>Database</span><span class=o>.</span><span class=n>new</span> <span class=s2>&#34;test.db&#34;</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl>    <span class=k>module</span> <span class=nn>Model</span>
</span></span><span class=line><span class=cl>        <span class=k>class</span> <span class=nc>SQLite</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>data</span> <span class=o>=</span> <span class=kp>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=vi>@hash</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=c1># table&#39;s meta data</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>table</span>
</span></span><span class=line><span class=cl>                <span class=no>Rulers</span><span class=o>.</span><span class=n>to_underscore</span> <span class=nb>name</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>schema</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=vi>@schema</span> <span class=k>if</span> <span class=vi>@schema</span>
</span></span><span class=line><span class=cl>                <span class=vi>@schema</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=no>DB</span><span class=o>.</span><span class=n>table_info</span><span class=p>(</span><span class=n>table</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>row</span><span class=o>|</span>
</span></span><span class=line><span class=cl>                    <span class=vi>@schema</span><span class=o>[</span><span class=n>row</span><span class=o>[</span><span class=s2>&#34;name&#34;</span><span class=o>]]</span> <span class=o>=</span> <span class=n>row</span><span class=o>[</span><span class=s2>&#34;type&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=k>end</span>
</span></span><span class=line><span class=cl>                <span class=vi>@schema</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=c1># ruby val -&gt; sql&#39;s ds in ruby string</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>to_sql</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>                    <span class=k>when</span> <span class=no>Numeric</span>
</span></span><span class=line><span class=cl>                        <span class=n>val</span><span class=o>.</span><span class=n>to_s</span>
</span></span><span class=line><span class=cl>                    <span class=k>when</span> <span class=nb>String</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;&#39;</span><span class=si>#{</span><span class=n>val</span><span class=si>}</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span> <span class=s2>&#34;Can&#39;t change </span><span class=si>#{</span><span class=n>val</span><span class=o>.</span><span class=n>class</span><span class=si>}</span><span class=s2> to SQL!&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=c1># 產生新model for a row</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>create</span><span class=p>(</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>values</span><span class=o>.</span><span class=n>delete</span> <span class=s2>&#34;id&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>keys</span> <span class=o>=</span> <span class=n>schema</span><span class=o>.</span><span class=n>keys</span> <span class=o>-</span> <span class=o>[</span><span class=s2>&#34;id&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=n>vals</span> <span class=o>=</span> <span class=n>keys</span><span class=o>.</span><span class=n>map</span> <span class=k>do</span> <span class=o>|</span><span class=n>key</span><span class=o>|</span>
</span></span><span class=line><span class=cl>                    <span class=n>values</span><span class=o>[</span><span class=n>key</span><span class=o>]</span> <span class=p>?</span> <span class=n>to_sql</span><span class=p>(</span><span class=n>values</span><span class=o>[</span><span class=n>key</span><span class=o>]</span><span class=p>)</span> <span class=p>:</span> <span class=s2>&#34;null&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>end</span>
</span></span><span class=line><span class=cl>                <span class=no>DB</span><span class=o>.</span><span class=n>execute</span> <span class=s>&lt;&lt;SQL
</span></span></span><span class=line><span class=cl><span class=s></span>                    <span class=no>INSERT</span> <span class=no>INTO</span> <span class=c1>#{table} (#{keys.join &#34;,&#34;})</span>
</span></span><span class=line><span class=cl>                    <span class=no>VALUES</span> <span class=p>(</span><span class=c1>#{vals.join &#34;,&#34;});</span>
</span></span><span class=line><span class=cl>                <span class=no>SQL</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=no>Hash</span><span class=o>[</span><span class=n>keys</span><span class=o>.</span><span class=n>zip</span> <span class=n>vals</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=s2>&#34;SELECT last_insert_rowid();&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=o>[</span><span class=s2>&#34;id&#34;</span><span class=o>]</span> <span class=o>=</span> <span class=no>DB</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span><span class=o>[</span><span class=mi>0</span><span class=o>][</span><span class=mi>0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=nb>self</span><span class=o>.</span><span class=n>new</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>find</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>row</span> <span class=o>=</span> <span class=no>DB</span><span class=o>.</span><span class=n>execute</span> <span class=s>&lt;&lt;SQL
</span></span></span><span class=line><span class=cl><span class=s></span>                    <span class=nb>select</span> <span class=c1>#{schema.keys.join &#34;,&#34;} from #{table}</span>
</span></span><span class=line><span class=cl>                    <span class=n>where</span> <span class=nb>id</span> <span class=o>=</span> <span class=c1>#{id};</span>
</span></span><span class=line><span class=cl>                <span class=no>SQL</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=no>Hash</span><span class=o>[</span><span class=n>schema</span><span class=o>.</span><span class=n>keys</span><span class=o>.</span><span class=n>zip</span> <span class=n>row</span><span class=o>[</span><span class=mi>0</span><span class=o>]]</span>
</span></span><span class=line><span class=cl>                <span class=nb>self</span><span class=o>.</span><span class=n>new</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=c1># operate on DB directly</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>count</span>
</span></span><span class=line><span class=cl>                <span class=no>DB</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s>&lt;&lt;SQL)[0][0]
</span></span></span><span class=line><span class=cl><span class=s></span>                    <span class=no>SELECT</span> <span class=no>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span> <span class=no>FROM</span> <span class=c1>#{table}</span>
</span></span><span class=line><span class=cl>                <span class=no>SQL</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nf>save!</span>
</span></span><span class=line><span class=cl>                <span class=k>unless</span> <span class=vi>@hash</span><span class=o>[</span><span class=s2>&#34;id&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                    <span class=nb>self</span><span class=o>.</span><span class=n>class</span><span class=o>.</span><span class=n>create</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>                <span class=k>end</span>
</span></span><span class=line><span class=cl>                <span class=n>fields</span> <span class=o>=</span> <span class=vi>@hash</span><span class=o>.</span><span class=n>map</span> <span class=k>do</span> <span class=o>|</span><span class=n>k</span><span class=p>,</span> <span class=n>v</span><span class=o>|</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;</span><span class=si>#{</span><span class=n>k</span><span class=si>}</span><span class=s2>=</span><span class=si>#{</span><span class=nb>self</span><span class=o>.</span><span class=n>class</span><span class=o>.</span><span class=n>to_sql</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>end</span><span class=o>.</span><span class=n>join</span> <span class=s2>&#34;,&#34;</span>
</span></span><span class=line><span class=cl>                <span class=no>DB</span><span class=o>.</span><span class=n>execute</span> <span class=s>&lt;&lt;SQL
</span></span></span><span class=line><span class=cl><span class=s></span>                    <span class=no>UPDATE</span> <span class=c1>#{self.class.table}</span>
</span></span><span class=line><span class=cl>                    <span class=no>SET</span> <span class=c1>#{fields}</span>
</span></span><span class=line><span class=cl>                    <span class=no>WHERE</span> <span class=nb>id</span> <span class=o>=</span> <span class=c1>#{@hash[&#34;id&#34;]}</span>
</span></span><span class=line><span class=cl>                <span class=no>SQL</span>
</span></span><span class=line><span class=cl>                <span class=kp>true</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nf>save</span>
</span></span><span class=line><span class=cl>                <span class=nb>self</span><span class=o>.</span><span class=n>save!</span> <span class=k>rescue</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=c1># operate on model&#39;s hash (no DB business)</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nf>[]</span><span class=p>(</span><span class=nb>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=vi>@hash</span><span class=o>[</span><span class=nb>name</span><span class=o>.</span><span class=n>to_s</span><span class=o>]</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nf>[]=</span><span class=p>(</span><span class=nb>name</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=vi>@hash</span><span class=o>[</span><span class=nb>name</span><span class=o>.</span><span class=n>to_s</span><span class=o>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=method_missing--define_method>method_missing & define_method<a hidden class=anchor aria-hidden=true href=#method_missing--define_method>#</a></h3><p>Model的accessor!!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyClass</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span><span class=s2>&#34;foo&#34;</span><span class=p>,</span> <span class=s2>&#34;bar&#34;</span><span class=o>].</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=nb>method</span><span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=n>define_method</span><span class=p>(</span><span class=nb>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>puts</span> <span class=s2>&#34;Obj </span><span class=si>#{</span><span class=nb>method</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=n>myobj</span> <span class=o>=</span> <span class=no>MyClass</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl><span class=n>myobj</span><span class=o>.</span><span class=n>foo</span>
</span></span><span class=line><span class=cl><span class=n>myobj</span><span class=o>.</span><span class=n>bar</span>
</span></span></code></pre></div><p>When you call a method that doesnʼt exist on an object, its method called “method_missing” will be called to tell it so.
If you override method_missing to check for column names, you can instead just return the column value from method_missing, which will return it from the original call.</p><h2 id=ch8-rack-middleware>Ch8 Rack Middleware<a hidden class=anchor aria-hidden=true href=#ch8-rack-middleware>#</a></h2><h3 id=rack-app的interfacetype-signature--如何疊app>rack app的interface(type signature) & 如何疊app<a hidden class=anchor aria-hidden=true href=#rack-app的interfacetype-signature--如何疊app>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># sample_dir/config.ru</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Canadianize</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>arg</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=vi>@app</span> <span class=o>=</span> <span class=n>app</span> <span class=c1># next rack app</span>
</span></span><span class=line><span class=cl>        <span class=vi>@arg</span> <span class=o>=</span> <span class=n>arg</span> <span class=c1># args</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span> <span class=c1># env -&gt; [ status, headers, content ]</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=p>,</span> <span class=n>headers</span><span class=p>,</span> <span class=n>content</span> <span class=o>=</span> <span class=vi>@app</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>+=</span> <span class=vi>@arg</span> <span class=o>+</span> <span class=s2>&#34;, eh?&#34;</span> 
</span></span><span class=line><span class=cl>        <span class=o>[</span> <span class=n>status</span><span class=p>,</span> <span class=n>headers</span><span class=p>,</span> <span class=n>content</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>use</span> <span class=no>Canadianize</span><span class=p>,</span> <span class=s2>&#34;, simple&#34;</span>
</span></span><span class=line><span class=cl><span class=n>run</span> <span class=nb>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[</span><span class=s2>&#34;Hello, world&#34;</span><span class=o>]]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=map>map<a hidden class=anchor aria-hidden=true href=#map>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># sample_dir/config.ru</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rack/lobster&#34;</span>
</span></span><span class=line><span class=cl><span class=n>use</span> <span class=no>Rack</span><span class=o>::</span><span class=no>ContentType</span>
</span></span><span class=line><span class=cl><span class=n>map</span> <span class=s2>&#34;/lobster&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>use</span> <span class=no>Rack</span><span class=o>::</span><span class=no>ShowExceptions</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span> <span class=no>Rack</span><span class=o>::</span><span class=no>Lobster</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=n>map</span> <span class=s2>&#34;/lobster/but_not&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span> <span class=nb>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{},</span> <span class=o>[</span><span class=s2>&#34;Really not a lobster&#34;</span><span class=o>]]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=n>run</span> <span class=nb>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{},</span> <span class=o>[</span><span class=s2>&#34;Not a lobster&#34;</span><span class=o>]]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If thereʼs could be two that match, the longer path is checked first.</p><h2 id=ch9-real-routing>Ch9 Real Routing<a hidden class=anchor aria-hidden=true href=#ch9-real-routing>#</a></h2><h3 id=controller-actions-are-rack-apps>Controller Actions are Rack Apps<a hidden class=anchor aria-hidden=true href=#controller-actions-are-rack-apps>#</a></h3><p>Before</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl> <span class=k>class</span> <span class=nc>Application</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;PATH_INFO&#39;</span><span class=o>]</span> <span class=o>==</span> <span class=s1>&#39;/favicon.ico&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>[</span><span class=mi>404</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[]]</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=n>klass</span><span class=p>,</span> <span class=n>act</span> <span class=o>=</span> <span class=n>get_controller_and_action</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>controller</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>env</span><span class=p>)</span> <span class=c1># get env from the previous line, so this line should be eliminated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>act</span><span class=p>)</span> <span class=c1># should not expose how to execute an action</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>controller</span><span class=o>.</span><span class=n>get_response</span> <span class=c1># this is controller(rack app)&#39;s responsibility</span>
</span></span><span class=line><span class=cl>            <span class=n>st</span><span class=p>,</span> <span class=n>hd</span><span class=p>,</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>controller</span><span class=o>.</span><span class=n>get_response</span><span class=o>.</span><span class=n>to_a</span>
</span></span><span class=line><span class=cl>            <span class=o>[</span><span class=n>st</span><span class=p>,</span> <span class=n>hd</span><span class=p>,</span> <span class=o>[</span><span class=n>rs</span><span class=o>.</span><span class=n>body</span><span class=o>].</span><span class=n>flatten</span><span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[</span><span class=n>text</span><span class=o>]]</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=c1># rack_app = klass.action(act)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># rack_app.call(env)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers.rb</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl> <span class=k>class</span> <span class=nc>Application</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;PATH_INFO&#39;</span><span class=o>]</span> <span class=o>==</span> <span class=s1>&#39;/favicon.ico&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>[</span><span class=mi>404</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[]]</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=n>klass</span><span class=p>,</span> <span class=n>act</span> <span class=o>=</span> <span class=n>get_controller_and_action</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rack_app</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=n>action</span><span class=p>(</span><span class=n>act</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rack_app</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># rulers/lib/rulers/controller.rb</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Controller</span>
</span></span><span class=line><span class=cl>        <span class=kp>include</span> <span class=no>Rulers</span><span class=o>::</span><span class=no>Model</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=vi>@env</span> <span class=o>=</span> <span class=n>env</span>
</span></span><span class=line><span class=cl>            <span class=vi>@routing_params</span> <span class=o>=</span> <span class=p>{}</span> <span class=c1># Add this line!</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>dispatch</span><span class=p>(</span><span class=n>action</span><span class=p>,</span> <span class=n>routing_params</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>            <span class=vi>@routing_params</span> <span class=o>=</span> <span class=n>routing_params</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span> <span class=o>=</span> <span class=nb>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>get_response</span>
</span></span><span class=line><span class=cl>                <span class=n>st</span><span class=p>,</span> <span class=n>hd</span><span class=p>,</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>get_response</span><span class=o>.</span><span class=n>to_a</span>
</span></span><span class=line><span class=cl>                <span class=o>[</span><span class=n>st</span><span class=p>,</span> <span class=n>hd</span><span class=p>,</span> <span class=o>[</span><span class=n>rs</span><span class=o>].</span><span class=n>flatten</span><span class=o>]</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text/html&#39;</span><span class=p>},</span> <span class=o>[</span><span class=n>text</span><span class=o>].</span><span class=n>flatten</span><span class=o>]</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>action</span><span class=p>(</span><span class=n>act</span><span class=p>,</span> <span class=n>rp</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>            <span class=nb>proc</span> <span class=p>{</span> <span class=o>|</span><span class=n>e</span><span class=o>|</span> <span class=nb>self</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>act</span><span class=p>,</span> <span class=n>rp</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>params</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=o>.</span><span class=n>params</span><span class=o>.</span><span class=n>merge</span> <span class=vi>@routing_params</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=route-也就是-match>Route 也就是 match<a hidden class=anchor aria-hidden=true href=#route-也就是-match>#</a></h3><p>Usuge</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># best_quotes/config.ru</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;./config/application&#34;</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=no>BestQuotes</span><span class=o>::</span><span class=no>Application</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl><span class=n>use</span> <span class=no>Rack</span><span class=o>::</span><span class=no>ContentType</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>route</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;quotes#index&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=s2>&#34;sub-app&#34;</span><span class=p>,</span> <span class=nb>proc</span> <span class=p>{</span> <span class=o>[</span><span class=mi>200</span><span class=p>,</span> <span class=p>{},</span> <span class=o>[</span><span class=s2>&#34;Hello, sub-app!&#34;</span><span class=o>]]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># default routes</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=s2>&#34;:controller/:id/:action&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=s2>&#34;:controller/:id&#34;</span><span class=p>,</span> <span class=ss>:default</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=s2>&#34;action&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;show&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=s2>&#34;:controller&#34;</span><span class=p>,</span> <span class=ss>:default</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=s2>&#34;action&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;index&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=n>run</span> <span class=n>app</span>
</span></span></code></pre></div><p>match & routeObject</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># rulers/lib/rulers/routing.rb</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RouteObject</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>initialize</span>
</span></span><span class=line><span class=cl>        <span class=vi>@rules</span> <span class=o>=</span> <span class=o>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>match</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>pop</span> <span class=k>if</span> <span class=n>args</span><span class=o>[-</span><span class=mi>1</span><span class=o>].</span><span class=n>is_a?</span><span class=p>(</span><span class=no>Hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span><span class=o>[</span><span class=ss>:default</span><span class=o>]</span> <span class=o>||=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dest</span> <span class=o>=</span> <span class=kp>nil</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>pop</span> <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=s2>&#34;Too many args!&#34;</span> <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>parts</span> <span class=o>=</span> <span class=n>url</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>parts</span><span class=o>.</span><span class=n>select!</span> <span class=p>{</span> <span class=o>|</span><span class=nb>p</span><span class=o>|</span> <span class=o>!</span><span class=nb>p</span><span class=o>.</span><span class=n>empty?</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>vars</span> <span class=o>=</span> <span class=o>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>regexp_parts</span> <span class=o>=</span> <span class=n>parts</span><span class=o>.</span><span class=n>map</span> <span class=k>do</span> <span class=o>|</span><span class=n>part</span><span class=o>|</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>part</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>==</span> <span class=s2>&#34;:&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>vars</span> <span class=o>&lt;&lt;</span> <span class=n>part</span><span class=o>[</span><span class=mi>1</span><span class=o>..-</span><span class=mi>1</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;([a-zA-Z0-9]+)&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>elsif</span> <span class=n>part</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>==</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>vars</span> <span class=o>&lt;&lt;</span> <span class=n>part</span><span class=o>[</span><span class=mi>1</span><span class=o>..-</span><span class=mi>1</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;(.*)&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>part</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=n>regexp</span> <span class=o>=</span> <span class=n>regexp_parts</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=vi>@rules</span><span class=o>.</span><span class=n>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=ss>:regexp</span> <span class=o>=&gt;</span> <span class=no>Regexp</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s2>&#34;^/</span><span class=si>#{</span><span class=n>regexp</span><span class=si>}</span><span class=s2>$&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=ss>:vars</span> <span class=o>=&gt;</span> <span class=n>vars</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=ss>:dest</span> <span class=o>=&gt;</span> <span class=n>dest</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=ss>:options</span> <span class=o>=&gt;</span> <span class=n>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_url</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=vi>@rules</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>r</span><span class=o>|</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span> <span class=o>=</span> <span class=n>r</span><span class=o>[</span><span class=ss>:regexp</span><span class=o>].</span><span class=n>match</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>                <span class=n>options</span> <span class=o>=</span> <span class=n>r</span><span class=o>[</span><span class=ss>:options</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span> <span class=o>=</span> <span class=n>options</span><span class=o>[</span><span class=ss>:default</span><span class=o>].</span><span class=n>dup</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>[</span><span class=ss>:vars</span><span class=o>].</span><span class=n>each_with_index</span> <span class=k>do</span> <span class=o>|</span><span class=n>v</span><span class=p>,</span> <span class=n>i</span><span class=o>|</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span><span class=o>[</span><span class=n>v</span><span class=o>]</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>captures</span><span class=o>[</span><span class=n>i</span><span class=o>]</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>                <span class=n>dest</span> <span class=o>=</span> <span class=kp>nil</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>r</span><span class=o>[</span><span class=ss>:dest</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>get_dest</span><span class=p>(</span><span class=n>r</span><span class=o>[</span><span class=ss>:dest</span><span class=o>]</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=n>controller</span> <span class=o>=</span> <span class=n>params</span><span class=o>[</span><span class=s2>&#34;controller&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>action</span> <span class=o>=</span> <span class=n>params</span><span class=o>[</span><span class=s2>&#34;action&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>get_dest</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>#{</span><span class=n>controller</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;#</span><span class=si>#{</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>end</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=kp>nil</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_dest</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>routing_params</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>dest</span> <span class=k>if</span> <span class=n>dest</span><span class=o>.</span><span class=n>respond_to?</span><span class=p>(</span><span class=ss>:call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>dest</span> <span class=o>=~</span> <span class=sr>/^([^#]+)#([^#]+)$/</span>
</span></span><span class=line><span class=cl>            <span class=nb>name</span> <span class=o>=</span> <span class=vg>$1</span><span class=o>.</span><span class=n>capitalize</span>
</span></span><span class=line><span class=cl>            <span class=n>cont</span> <span class=o>=</span> <span class=no>Object</span><span class=o>.</span><span class=n>const_get</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>#{</span><span class=nb>name</span><span class=si>}</span><span class=s2>Controller&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cont</span><span class=o>.</span><span class=n>action</span><span class=p>(</span><span class=vg>$2</span><span class=p>,</span> <span class=n>routing_params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=s2>&#34;No destination: </span><span class=si>#{</span><span class=n>dest</span><span class=o>.</span><span class=n>inspect</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=c1># And now, the Application:</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Rulers</span>
</span></span><span class=line><span class=cl> <span class=k>class</span> <span class=nc>Application</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>route</span><span class=p>(</span><span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=vi>@route_obj</span> <span class=o>||=</span> <span class=no>RouteObject</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl>        <span class=vi>@route_obj</span><span class=o>.</span><span class=n>instance_eval</span><span class=p>(</span><span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_rack_app</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=s2>&#34;No routes!&#34;</span> <span class=k>unless</span> <span class=vi>@route_obj</span>
</span></span><span class=line><span class=cl>        <span class=vi>@route_obj</span><span class=o>.</span><span class=n>check_url</span> <span class=n>env</span><span class=o>[</span><span class=s2>&#34;PATH_INFO&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl> <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><h3 id=from-env-to-res>from env to res<a hidden class=anchor aria-hidden=true href=#from-env-to-res>#</a></h3><pre tabindex=0><code>env -&gt; router -&gt; Controller -----------------------&gt; (Real)Controller -&gt; res
                    / \               / \
                     |                 |
                    env       req -&gt; parmas
                              / \     / \
                               |       |
                              env    router
                                      / \
                                       |
                                      env
</code></pre><p>基本上這本書的九個把Rails的核心精神都帶到了，<a href=https://github.com/xaqi/mini-rails/blob/master/mini-rails.rb>這裡</a>是縮減版的rails與上面的很像，不過某些部分多了一些包裝。</p><h2 id=appendix-unobtrusive-javascript>Appendix: Unobtrusive JavaScript<a hidden class=anchor aria-hidden=true href=#appendix-unobtrusive-javascript>#</a></h2><p>JavaScript 不再需要與 HTML 混在一起</p><p>原本是</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;date&#34;</span> <span class=na>onchange</span><span class=o>=</span><span class=s>&#34;validateDate()&#34;</span><span class=p>/&gt;</span>
</span></span></code></pre></div><p>變成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;date&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;date&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;DOMContentLoaded&#34;</span><span class=err>，</span><span class=kd>function</span><span class=err>（</span><span class=nx>event</span><span class=err>）</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;date&#39;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;change&#34;</span><span class=err>，</span><span class=nx>validateDate</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>先找出要的DOM，之後再JS中設定該DOM。</p><p>找出要的DOM，可透過id或class，甚至是DOM的traversal</p><p>原本但是找到之後，要怎麼儲存這個DOM的狀態??</p><p>原本都是在JS中來保存，但這樣就會變成DOM的狀態與程式邏輯的狀態會混在一起。</p><p>所以之後有了<a href=https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes><code>data attributes</code></a>!!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://littlebees.github.io/tags/rails/>Rails</a></li></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2020/04/js%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5%E7%9A%84%E6%95%B4%E7%90%86/><span class=title>« Prev</span><br><span>JS一些概念的整理</span>
</a><a class=next href=https://littlebees.github.io/2020/04/the-seasoned-schemer%E8%AE%80%E5%BE%8C%E7%AD%86%E8%A8%98/><span class=title>Next »</span><br><span>The Seasoned Schemer讀後筆記</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>