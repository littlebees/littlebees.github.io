<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="AEpTGuQAkxnTOlmfF4INDna3S660LxrkyZ4BQzVbRSw">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"littlebees.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="動機 查漏補缺">
<meta property="og:type" content="article">
<meta property="og:title" content="巨型服務架構：分布式&#x2F;資料庫優化&#x2F;記憶體快取設計&#x2F;IO模型">
<meta property="og:url" content="https://littlebees.github.io/2022/01/mega-service-arch/index.html">
<meta property="og:site_name" content="記事本">
<meta property="og:description" content="動機 查漏補缺">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2022-01-17T02:31:32.000Z">
<meta property="article:modified_time" content="2022-03-31T03:22:07.001Z">
<meta property="article:author" content="zhengcf">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://littlebees.github.io/2022/01/mega-service-arch/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>巨型服務架構：分布式/資料庫優化/記憶體快取設計/IO模型 | 記事本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">記事本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">寫下來，不然會忘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://littlebees.github.io/2022/01/mega-service-arch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhengcf">
      <meta itemprop="description" content="想到什麼就寫什麼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="記事本">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          巨型服務架構：分布式/資料庫優化/記憶體快取設計/IO模型
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-17 10:31:32" itemprop="dateCreated datePublished" datetime="2022-01-17T10:31:32+08:00">2022-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-31 11:22:07" itemprop="dateModified" datetime="2022-03-31T11:22:07+08:00">2022-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/" itemprop="url" rel="index"><span itemprop="name">System</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/Reading/" itemprop="url" rel="index"><span itemprop="name">Reading</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="動機-665">動機</h2>
<p>查漏補缺</p>
<span id="more"></span>
<h2 id="ch1-高性能架構">ch1: 高性能架構</h2>
<h3 id="效能指標">效能指標</h3>
<ul>
<li>throughput
<ul>
<li>TPS(transaction per second)</li>
<li>QPS(queries per second)</li>
</ul>
</li>
<li>併發數
<ul>
<li>同時處理的數目: 同時在線user, 併發連線數…</li>
</ul>
</li>
<li>response time
<ul>
<li>amdahl’s law</li>
</ul>
</li>
<li>可靠度指標
<ul>
<li>無故障時間</li>
</ul>
</li>
</ul>
<h4 id="指標之間的影響">指標之間的影響</h4>
<ul>
<li>throughput &amp; 併發數
<ul>
<li>(一開始) 併發數上升 =&gt; throughput上升</li>
<li>(持平) 併發數上升 =&gt; throughput不變
<ul>
<li>系統臨界點</li>
</ul>
</li>
<li>(下降) 併發數上升 =&gt; throughput下降
<ul>
<li>系統隨時都會崩潰</li>
</ul>
</li>
</ul>
</li>
<li>併發數 &amp; response time
<ul>
<li>(併發req數目) m/m/1的平均時間公式
<ul>
<li>service的處理rate(mu那一個, 系統可以承受的最大併發數)</li>
<li>(一開始) req的數目小於系統可以承受的最大併發數，response time上升不明顯</li>
<li>(過了可以承受的最大併發數) response time急速增加</li>
</ul>
</li>
<li>系統中觀察到正在處理的req/thread數目
<ul>
<li>response time大 =&gt; 卡在system中的req/thread會比較多!!</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch2-分流設計">ch2: 分流設計</h2>
<h3 id="CDN">CDN</h3>
<ul>
<li>優點
<ul>
<li>減少系統併發數</li>
<li>減少response time</li>
<li>減少網路壅塞</li>
</ul>
</li>
<li>原理
<ul>
<li>多個CDN node，DNS做query時根據使用者位置回傳最近的ip</li>
<li>CDN node會變成cache proxy，有就回傳；沒有就relay req到主機</li>
</ul>
</li>
</ul>
<p>可以把CDN對地址動手腳的方法用到service discovery</p>
<h4 id="service-discovery">service discovery</h4>
<ul>
<li>服務註冊
<ul>
<li>user: 去registry找service的實際位置</li>
<li>registry: 維護service的清單</li>
<li>server: 要把自己登記到registry</li>
</ul>
</li>
<li>服務規則
<ul>
<li>user: 去registry找service地址的使用規則</li>
<li>registry: 放service地址的使用規則，讓user自己判斷要去哪</li>
<li>server: 要開發或是營運去調整規則</li>
</ul>
</li>
</ul>
<h3 id="反向代理">反向代理</h3>
<p>由proxy分配req到不同的server (追求load balance就是load balancer；server的任務都不同就是一般的反向代理)</p>
<ul>
<li>原理
<ul>
<li>level 4: 只看ip與port做分配</li>
<li>level 7: 看req內容作分配，eg: http, ftp…
<ul>
<li>對外面來說，ip與port都是一樣的!!</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch3-服務平行設計">ch3: 服務平行設計</h2>
<ul>
<li>叢集: 有很多同樣的server的set，一起提供服務
<ul>
<li>server無狀態
<ul>
<li><em>無狀態的節點叢集</em></li>
<li>一般都是負責query之類沒有狀態的服務</li>
<li>平行喚醒問題
<ul>
<li>在這個set加入定時寄信功能
<ul>
<li>結果所有server一起寄信!?</li>
</ul>
</li>
<li>解法: 外部喚醒
<ul>
<li>打req進來，跑功能，這樣就只會有一台跑</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>server有狀態
<ul>
<li>server自己維護狀態
<ul>
<li>要與別人share
<ul>
<li><em>資訊一致的節點叢集</em></li>
<li>大家都有自己的狀態，但需要與其他server的狀態同步</li>
<li>一致性問題(讀寫不一致): 我在A改的，在B看不到
<ul>
<li>一致性的等級
<ul>
<li>強一致性
<ul>
<li>2 phases commit</li>
<li>3 phases commit</li>
</ul>
</li>
<li>最終一致性
<ul>
<li>有retry的msg queue</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>不要與別人share
<ul>
<li><em>單一服務節點叢集</em></li>
<li>user與server是被綁定的!!</li>
<li>how to bind?
<ul>
<li>user指定
<ul>
<li>online game的選server</li>
</ul>
</li>
<li>根據位置、user id</li>
<li>先隨便assign，把server位置寫到cookie中</li>
</ul>
</li>
<li>單點失敗</li>
</ul>
</li>
</ul>
</li>
<li>server把狀態抽出去
<ul>
<li><em>資訊共用的節點叢集</em></li>
<li>在redis之類的地方紀錄state，像是session</li>
<li>redis之類的地方
<ul>
<li>會是bottleneck</li>
<li>需要concurrent的控制</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>分散式系統
<ul>
<li>把server中的(實體/虛擬)元件拆掉，像web server與DB跑在不同host
<ul>
<li>如果有元件是bottlebeck，可以用叢集拆掉</li>
</ul>
</li>
<li>一致性問題(讀寫不一致): 我在A改的，在B看不到
<ul>
<li>同<em>資訊一致的節點叢集</em></li>
</ul>
</li>
<li>所有元件是可組合的? <em>微服務系統</em></li>
</ul>
</li>
</ul>
<h2 id="ch4-運算併發">ch4: 運算併發</h2>
<ul>
<li>多process
<ul>
<li>可能在不同的cpu跑(平行)，也可能在同一顆跑(共時)</li>
<li>具有很強的隔離
<ul>
<li>像是開兩個server在process
<ul>
<li>可以兩個指定不同的port，就有兩台獨立的server</li>
</ul>
</li>
</ul>
</li>
<li>ctx switch的成本高
<ul>
<li>cache要預熱</li>
<li>在userspace與kernel space之間切換</li>
<li>reg的切換</li>
</ul>
</li>
<li>IPC不好做</li>
<li>sync
<ul>
<li>使用情境
<ul>
<li>獨佔 (競爭)</li>
<li>協作: 等對方好了在一起走</li>
<li>獨佔、協作的詳細介紹，去看Parallel Thinking</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>多thread
<ul>
<li>可能在不同的cpu跑(平行)，也可能在同一顆跑(共時)</li>
<li>ctx switch的成本小
<ul>
<li>都在同一塊記憶體</li>
<li>有locality</li>
</ul>
</li>
<li>使用情境
<ul>
<li>做非同步 (會block的工作)</li>
<li>處理subtask，之後merge</li>
</ul>
</li>
<li>sync
<ul>
<li>使用情境
<ul>
<li>獨佔 (競爭)</li>
<li>協作: 等對方好了在一起走</li>
<li>獨佔、協作的詳細介紹，去看Parallel Thinking</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>fiber就是continuation
<ul>
<li>只能在同一顆跑(共時)</li>
<li>執行fiber就會停下當下的動作，之後執行會回到原本的位置</li>
<li>不會race condition</li>
<li>不會平行是concurrent!!</li>
<li>ctx switch的代價很小</li>
<li>sync
<ul>
<li>使用情境
<ul>
<li>協作: 等對方好了在一起走</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch5-輸入輸出設計">ch5: 輸入輸出設計</h2>
<p>去看之前的文章</p>
<h2 id="ch6-資料庫設計與最佳化">ch6: 資料庫設計與最佳化</h2>
<ul>
<li>設計table
<ul>
<li>當成設計class，但是只有primitive與reference而已
<ul>
<li>array要轉90度，變成table (NF1)</li>
<li>所有的欄位(primitive)可以是來自
<ul>
<li>自己本身的屬性</li>
<li>另一個物件展開的結果 (NF2, NF2, BCNF, 反正規化)</li>
</ul>
</li>
<li>去看之前的文章</li>
</ul>
</li>
</ul>
</li>
<li>index
<ul>
<li>故障
<ul>
<li>一個col做index
<ul>
<li>上index的column做修改</li>
<li>用錯type去query (string卻用成int，雖然會被cast，但index會失效)</li>
</ul>
</li>
<li>多個col做index
<ul>
<li>(Btree) query沒有包含前面的col(左手邊)
<ul>
<li>index從第一個col開始sort，一直下去，所以做query時需要前面的</li>
</ul>
</li>
<li>(hash) 沒有全部的col</li>
</ul>
</li>
<li>對string做index
<ul>
<li>如果有wildcast, btree與hash都會沒用，要用inverted index</li>
</ul>
</li>
<li>btree
<ul>
<li><code>!=</code>, <code>&lt;&gt;</code>, <code>NOT</code></li>
<li><code>IN</code>, <code>NOT IN</code>
<ul>
<li><code>IN</code> =&gt; <code>BETWEEN</code></li>
</ul>
</li>
</ul>
</li>
<li>null
<ul>
<li>index沒辦法對null做任何事
<ul>
<li>用其他值代替!!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>不同的engine不同的index (與其他)
<ul>
<li>innoDB會把hash自動換成btree (innoDB沒有做hash)</li>
</ul>
</li>
</ul>
</li>
<li>自建交易
<ul>
<li>可以undo的action沒差</li>
<li>不能undo的action(對外界有影響)
<ul>
<li>最多只能有一個</li>
<li>只能在最後一位</li>
</ul>
</li>
</ul>
</li>
<li>資料太多了
<ul>
<li>table分區 (partition)
<ul>
<li>把一個table(file)分成多個檔案</li>
<li>對於table的操作不變 (在外面來看這個table還是一樣)</li>
<li>可以存到不同的HDD
<ul>
<li>增加throughput</li>
<li>增加能存的entry數量</li>
<li>可以針對某一區做操作，不影響其他區</li>
</ul>
</li>
<li>query最好要把當初做分區的條件放入query
<ul>
<li>不然要所有分區都跑</li>
</ul>
</li>
</ul>
</li>
<li>分庫
<ul>
<li>把DB切開
<ul>
<li>table怎麼辦?
<ul>
<li>分table</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>分table
<ul>
<li>不分割(split)table
<ul>
<li>每個DB都有一些完整的table</li>
</ul>
</li>
<li>分割(split)table
<ul>
<li>水平分割
<ul>
<li>把資料放到不同的表
<ul>
<li><code>[(1,2), (3,4)]</code> =&gt; <code>[(1,2)]</code>, <code>[(3,4)]</code></li>
</ul>
</li>
</ul>
</li>
<li>垂直分割
<ul>
<li>依據col去割，之後用primiary key來認同一個row
<ul>
<li><code>[(1,2), (3,4)]</code> =&gt; <code>[(1,3)]</code>, <code>[(2,4)]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>原則: 不要跨table
<ul>
<li>水平分割
<ul>
<li>一次需要所有col</li>
</ul>
</li>
<li>垂直分割
<ul>
<li>只要一部份col</li>
</ul>
</li>
</ul>
</li>
<li>對於table的操作要改 (程式要改)
<ul>
<li>table變得不一樣了
<ul>
<li>路由操作: 要改table的name (現在有多個table)</li>
<li>拼接操作: 要多加join (垂直分割如果需要另一個表的col)</li>
</ul>
</li>
</ul>
</li>
<li>讀寫分離
<ul>
<li>多個DB分別處理讀與寫</li>
<li>路由操作: 讀與寫要到對的DB</li>
<li>主從複製: 主從要同步!! (一致性問題)
<ul>
<li>複製的材料
<ul>
<li>log
<ul>
<li>statement: 就是指令 (但遇到調用now_time之類的，就沒辦法反映真實資料到read db上)</li>
<li>row: 就是資料</li>
<li>mixed: 就是指令+資料</li>
</ul>
</li>
</ul>
</li>
<li>非同步複製 (not reliable)
<ul>
<li>write後立刻return，log非同步的傳
<ul>
<li>write db掛了又沒傳log就gg了</li>
</ul>
</li>
</ul>
</li>
<li>半同步複製
<ul>
<li>write後等log傳到<strong>某個</strong>db才return</li>
</ul>
</li>
<li>全同步複製
<ul>
<li>write後等log傳到<strong>所有</strong>db才return</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>DB中介軟體
<ul>
<li>就是DB的middleware，處理上面的路由操作、拼接操作、主從複製之類的問題
<ul>
<li>eg: MyCat</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch7-快取設計">ch7: 快取設計</h2>
<ul>
<li>cache for reading
<ul>
<li>cache會花費到的時間
<ul>
<li>寫入cache時
<ul>
<li>生成key時
<ul>
<li>hash function</li>
<li>比較key</li>
</ul>
</li>
<li>寫入mem時
<ul>
<li>寫mem
<ul>
<li>寫入什麼?
<ul>
<li>序列化物件
<ul>
<li>讀寫時都要經過序列化</li>
</ul>
</li>
<li>原本的物件
<ul>
<li>不用反序列化</li>
<li>如果存的是reference?
<ul>
<li>會發生race condition!!</li>
<li>解法: 存序列化物件 或是 deep copy</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>讀cache時
<ul>
<li>生成key時
<ul>
<li>hash function</li>
<li>比較key</li>
</ul>
</li>
<li>讀mem時
<ul>
<li>中
<ul>
<li>讀mem</li>
</ul>
</li>
<li>沒中
<ul>
<li>跑原本</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache update
<ul>
<li>被動update
<ul>
<li>時效性更新
<ul>
<li>有過期時間</li>
</ul>
</li>
</ul>
</li>
<li>主動update
<ul>
<li>cache aside
<ul>
<li>read: 正常的讀，找不到去後面拉資料
<ul>
<li>去後面拉資料的時候要不要把cache刪了?
<ul>
<li>刪
<ul>
<li>如果寫入中，有另一個read
<ul>
<li>就會拉到舊的值到cache!!</li>
</ul>
</li>
<li>但寫入完成後，雙方資料就不一致了</li>
</ul>
</li>
<li>不刪 (good)
<ul>
<li>read時，如果莫名其妙被block住</li>
<li>之後這之間有write完成</li>
<li>read就會拿到舊的值
<ul>
<li>但這不太可能，只要
<ul>
<li>read夠快</li>
<li>確保不會被preemptive</li>
</ul>
</li>
<li>就不會發生</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>write: 直接往後方寫，不直接更新cache</li>
</ul>
</li>
<li>write through
<ul>
<li>read/write: 都透過cache (同步)
<ul>
<li>cache變成單點失敗的點</li>
</ul>
</li>
</ul>
</li>
<li>write behind
<ul>
<li>改write through的write成非同步
<ul>
<li>如果cache掛了
<ul>
<li>可能沒寫到!!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache clear
<ul>
<li>時效性
<ul>
<li>訂個過期時間
<ul>
<li>時間到就自己不見</li>
<li>讓另一個thread去清</li>
</ul>
</li>
</ul>
</li>
<li>固定pool數量
<ul>
<li>FIFO</li>
<li>LRU</li>
</ul>
</li>
<li>非強引用
<ul>
<li>GC的延伸，有ref到的就是有用的obj，所以不能刪，但沒有就是可以刪
<ul>
<li>這樣obj只有刪與不刪</li>
</ul>
</li>
<li>但有的情況是在mem吃緊時可以刪
<ul>
<li>所以ref要有所區分</li>
</ul>
</li>
<li>ref的分類
<ul>
<li>強引用: 一般的ref</li>
<li>軟引用: 會在mem不足時回收</li>
<li>弱引用: 不管mem夠不夠只要被gc就會被回收</li>
<li>虛引用: gc會當成看不到他</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache 的問題
<ul>
<li>cache穿透
<ul>
<li>如果連後面都沒有結果?
<ul>
<li>沒辦法寫到cache</li>
<li>cache根本沒用!!
<ul>
<li>解法: 丟空值
<ul>
<li>像是linux的dentry(查詢路徑的node)遇到不存在的中間點(資料夾或是file)</li>
<li>dentry會被create，但是標註(state)為不存在</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache擊穿
<ul>
<li>高頻率被access的資料被清掉?
<ul>
<li>所有req都往後了!!</li>
<li>會發生在
<ul>
<li>cache aside (因為沒有一致的保證，throught是強一致，behind是弱一致(最終一致的下一階))
<ul>
<li>時效性清理</li>
<li>FIFO清理</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache預熱
<ul>
<li>需要req讓資料慢慢變多</li>
<li>兩個點
<ul>
<li>如果一次來大量req
<ul>
<li>cache擊穿</li>
</ul>
</li>
<li>如果是 時效性清理 與 長時間沒有req
<ul>
<li>反覆預熱</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache的位置
<ul>
<li>cache越前面越好</li>
<li>常見位置
<ul>
<li>client side
<ul>
<li>browser的
<ul>
<li>localstorage &amp; sessionstorage</li>
<li>indexdb &amp; web sql</li>
<li>application cache</li>
</ul>
</li>
</ul>
</li>
<li>靜態cache
<ul>
<li>CDN</li>
<li>reverse proxy</li>
</ul>
</li>
<li>服務cache
<ul>
<li>在stateful的服務中
<ul>
<li>具有一定通用return的服務(function)做cache</li>
</ul>
</li>
</ul>
</li>
<li>DB的cache</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cache for writing
<ul>
<li>cache在前面cache所有write的資料，之後再由cache去write到db (限流)
<ul>
<li>平滑write，消去大量的同樣的write req</li>
</ul>
</li>
<li>總體而言
<ul>
<li>比起原本的write多了寫入與讀取cache的成本</li>
<li>但是對於user而言，只有cache的response time (比較短!!)</li>
</ul>
</li>
<li>cache要在後方有資源時才開始寫入，不然後面會爆</li>
</ul>
</li>
</ul>
<h2 id="ch8-可靠性設計">ch8: 可靠性設計</h2>
<ul>
<li>module串接方式
<ul>
<li>串聯:
<ul>
<li><code>m1 -&gt; m2 -&gt; m3 ...</code></li>
</ul>
</li>
<li>並聯:
<ul>
<li>m/m/n的圖
<ul>
<li>只能處理不response的server</li>
<li>可以容錯到只要有一台是正確的就好</li>
</ul>
</li>
</ul>
</li>
<li>容錯
<ul>
<li>m/m/n的圖 + 裁決器(有過半數的相同response就當成是對的response)
<ul>
<li>可以處理有惡意(亂回答)與不response的server
<ul>
<li>拜占庭容錯!!</li>
</ul>
</li>
<li>可以容錯到至少有一半+1台有一樣的response就好</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>可靠性設計
<ul>
<li>消除單點依賴</li>
<li>把串聯轉成並聯</li>
<li>叢集
<ul>
<li>相等式: 並聯</li>
<li>主從式: 一台服務、其他backup</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch9-應用保護">ch9: 應用保護</h2>
<ul>
<li>故障等級
<ul>
<li>所有user都能用所有service</li>
<li>部分user都能用所有service</li>
<li>部分user都能用部分service</li>
<li>不能提供service但可以恢復</li>
<li>系統crash但不影響其他系統</li>
<li>系統crash且影響到其他系統</li>
</ul>
</li>
<li>隔離
<ul>
<li>用thread pool(或是semaphore去替代)，去包服務
<ul>
<li>每次invoke就是用thread跑</li>
<li>如果沒有thread可以用了(像是所有thread都因為server掛了，而block)，也繼續跑</li>
</ul>
</li>
</ul>
</li>
<li>限流/恢復
<ul>
<li>tc的qdisc</li>
<li>algo
<ul>
<li>時間窗
<ul>
<li>一段時間中只放最多幾個req進來
<ul>
<li>如果有大量的req在開始計時時，一次出現
<ul>
<li>後面來看根本沒限到流 (還是一次很多)</li>
<li>從system來看
<ul>
<li>會有一堆沒辦法服務到</li>
<li>後面的服務空轉</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>漏桶
<ul>
<li>把時間窗的時間變小，一放一個req，剩下用queue去存
<ul>
<li>現在整個流平順了</li>
<li>但是如果queue不夠大
<ul>
<li>從system來看
<ul>
<li>會有一堆沒辦法服務到</li>
<li>後面的服務空轉</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>token bucket
<ul>
<li>每個單位時間生一個token，1個token放一個req
<ul>
<li>token可以存!!
<ul>
<li>避免服務空轉</li>
</ul>
</li>
</ul>
</li>
<li>如果不調整token的總數，放著讓它長
<ul>
<li>如果有大量的req在開始計時時，一次出現
<ul>
<li>後面來看根本沒限到流 (還是一次很多)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>兩個差在?
<ul>
<li>限流: 把收的req壓在一定數量</li>
<li>恢復: 慢慢把可以收的req往上拉</li>
</ul>
</li>
</ul>
</li>
<li>降級/融斷
<ul>
<li>(手法) 把複雜的server換成簡單的
<ul>
<li>不直接讀db改讀cache</li>
<li>精確結果改成近似結果</li>
<li>返回靜態結果 (不跑運算)</li>
<li>同步改成非同步</li>
<li>停用非必要的功能</li>
<li>禁止寫入</li>
<li>依據user level做diffSrv</li>
</ul>
</li>
<li>降級/融斷依據
<ul>
<li>失敗次數/機率過高</li>
<li>限流啟動時</li>
<li>手動</li>
</ul>
</li>
<li>兩個差在?
<ul>
<li>降級: 以降低response time</li>
<li>融斷: 以維持服務繼續</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch10-前端高性能">ch10: 前端高性能</h2>
<ul>
<li>資源下載
<ul>
<li>資源壓縮
<ul>
<li>content-encoding</li>
</ul>
</li>
<li>減少req
<ul>
<li>資源合併
<ul>
<li>sprite圖</li>
</ul>
</li>
<li>keep-alive與polling與server push</li>
</ul>
</li>
<li>資源快取
<ul>
<li>Etag等等</li>
</ul>
</li>
</ul>
</li>
<li>redner最佳化
<ul>
<li>Reflow &amp; Repaint (最花時間的步驟)
<ul>
<li>整個網頁就是一棵樹
<ul>
<li>最後要排版(reflow)</li>
<li>畫到畫面上(repaint)</li>
</ul>
</li>
<li>讓影響範圍變小</li>
<li>觸發方式
<ul>
<li>dom新增/刪除
<ul>
<li>=&gt; 直接改dom的內容</li>
<li>=&gt; 讓frontend framework代勞</li>
</ul>
</li>
<li>dom大小/定位方式/邊距/pesudo class改變狀態
<ul>
<li>=&gt; 保持上面的不變</li>
<li>(要常常變動) =&gt; 把parent node設成<code>display: none</code>，從一開始就沒有在tree中
<ul>
<li>這樣reflow就會是1次而已</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>lazy loading
<ul>
<li>先載入必要的部分，需要再load其他的</li>
</ul>
</li>
<li>proload/prefetch
<ul>
<li>比較大的檔案可以先下載</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ch11-架構設計理論">ch11: 架構設計理論</h2>
<p>skip</p>
<h2 id="ch12-高性能架構實踐">ch12: 高性能架構實踐</h2>
<p>skip</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/queuing-thoery/" rel="prev" title="queuing thoery的tutorial">
      <i class="fa fa-chevron-left"></i> queuing thoery的tutorial
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/Designing-Data-Intensive-Applications/" rel="next" title="Designing Data-Intensive Applications">
      Designing Data-Intensive Applications <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8B%95%E6%A9%9F-665"><span class="nav-number">1.</span> <span class="nav-text">動機</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch1-%E9%AB%98%E6%80%A7%E8%83%BD%E6%9E%B6%E6%A7%8B"><span class="nav-number">2.</span> <span class="nav-text">ch1: 高性能架構</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%88%E8%83%BD%E6%8C%87%E6%A8%99"><span class="nav-number">2.1.</span> <span class="nav-text">效能指標</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E6%A8%99%E4%B9%8B%E9%96%93%E7%9A%84%E5%BD%B1%E9%9F%BF"><span class="nav-number">2.1.1.</span> <span class="nav-text">指標之間的影響</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch2-%E5%88%86%E6%B5%81%E8%A8%AD%E8%A8%88"><span class="nav-number">3.</span> <span class="nav-text">ch2: 分流設計</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CDN"><span class="nav-number">3.1.</span> <span class="nav-text">CDN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#service-discovery"><span class="nav-number">3.1.1.</span> <span class="nav-text">service discovery</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">3.2.</span> <span class="nav-text">反向代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch3-%E6%9C%8D%E5%8B%99%E5%B9%B3%E8%A1%8C%E8%A8%AD%E8%A8%88"><span class="nav-number">4.</span> <span class="nav-text">ch3: 服務平行設計</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch4-%E9%81%8B%E7%AE%97%E4%BD%B5%E7%99%BC"><span class="nav-number">5.</span> <span class="nav-text">ch4: 運算併發</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch5-%E8%BC%B8%E5%85%A5%E8%BC%B8%E5%87%BA%E8%A8%AD%E8%A8%88"><span class="nav-number">6.</span> <span class="nav-text">ch5: 輸入輸出設計</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch6-%E8%B3%87%E6%96%99%E5%BA%AB%E8%A8%AD%E8%A8%88%E8%88%87%E6%9C%80%E4%BD%B3%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">ch6: 資料庫設計與最佳化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch7-%E5%BF%AB%E5%8F%96%E8%A8%AD%E8%A8%88"><span class="nav-number">8.</span> <span class="nav-text">ch7: 快取設計</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch8-%E5%8F%AF%E9%9D%A0%E6%80%A7%E8%A8%AD%E8%A8%88"><span class="nav-number">9.</span> <span class="nav-text">ch8: 可靠性設計</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch9-%E6%87%89%E7%94%A8%E4%BF%9D%E8%AD%B7"><span class="nav-number">10.</span> <span class="nav-text">ch9: 應用保護</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch10-%E5%89%8D%E7%AB%AF%E9%AB%98%E6%80%A7%E8%83%BD"><span class="nav-number">11.</span> <span class="nav-text">ch10: 前端高性能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch11-%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88%E7%90%86%E8%AB%96"><span class="nav-number">12.</span> <span class="nav-text">ch11: 架構設計理論</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ch12-%E9%AB%98%E6%80%A7%E8%83%BD%E6%9E%B6%E6%A7%8B%E5%AF%A6%E8%B8%90"><span class="nav-number">13.</span> <span class="nav-text">ch12: 高性能架構實踐</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhengcf</p>
  <div class="site-description" itemprop="description">想到什麼就寫什麼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">695</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">85</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengcf</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 1000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://littlebees.github.io/2022/01/mega-service-arch/',]
      });
      });
  </script>

</body>
</html>
