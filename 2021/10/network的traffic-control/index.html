<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>network的traffic control | 記事本</title>
<meta name=keywords content="Network"><meta name=description content="動機
以前遇過，review一下"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2021/10/network%E7%9A%84traffic-control/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2021/10/network%E7%9A%84traffic-control/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="network的traffic control"><meta property="og:description" content="動機
以前遇過，review一下"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2021/10/network%E7%9A%84traffic-control/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-26T22:06:11+00:00"><meta property="article:modified_time" content="2021-10-26T22:06:11+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="network的traffic control"><meta name=twitter:description content="動機
以前遇過，review一下"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"network的traffic control","item":"https://littlebees.github.io/2021/10/network%E7%9A%84traffic-control/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"network的traffic control","name":"network的traffic control","description":"動機 以前遇過，review一下\n","keywords":["Network"],"articleBody":"動機 以前遇過，review一下\n概念 一般做tc就是在意下面4件事\nPOLICING(策略) 進來的pkt要到哪邊 queue的入口 SCHEDULING(調度) 怎麼分配bandwidth (QoS) queue的內部 SHAPING (限制) 調整輸出的速度 queue的出口 DROPPING(丟棄) 爆量了怎麼辦 traffic control就是一個queue接一個queue，變成一個樹狀queue，有三個元件\nqdisc quene (virtual) tree的node (特別是能放class的qdisc) leaf (classless) node (classful，會多兩個元件) filter (另外加的) 要讓traffic去哪 (class或qdisc) 有點像goto class 下一個qdisc的入口，目前qdisc的出口 node的pointer 樹狀queue就是qdisc指到2種東西\nclass qdisc (classless) 另外就是符合條件(filter)直接被指到 class qdisc (classless) classless \u0026 classful qdisc 就qdisc能不能放class\nclassless pfifo: 一般的queue pfifo_fast: 根據ToS去分到對應的一般的queue red: 爆量時隨機drop sfq: Stochastic Fairness Queueing tbf: Token Bucket Filter classful cbq: Class Based Queueing htb: Hierarchy Token Bucket ingress qdisc \u0026 ifb ifb，tc作用在egress(從主機出去的traffic)，如果要用在ingress，就要設ifb把traffic灌進去，把tc設定ifb的egress # init ifb modprobe ifb numifbs=1 ip link set ifb0 up # redirect ingress to ifb0 tc qdisc add dev eth0 ingress handle ffff: tc filter add dev eth0 parent ffff: protocol ip prio 0 u32 match u32 0 0 flowid ffff: action mirred egress redirect dev ifb0 # add qdisc tc qdisc add dev ifb0 root handle 1: htb default 2 r2q 100 # add default class tc class add dev ifb0 parent 1:0 classid 1:1 htb rate 1000mbit ceil 1000mbit tc class add dev ifb0 parent 1:1 classid 1:2 htb prio 5 rate 1000mbit ceil 1000mbit tc qdisc add dev ifb0 parent 1:2 handle 2: pfifo limit 500 # add default filter tc filter add dev ifb0 parent 1:0 prio 5 protocol ip u32 tc filter add dev ifb0 parent 1:0 prio 5 handle 4: protocol ip u32 divisor 256 tc filter add dev ifb0 parent 1:0 prio 5 protocol ip u32 ht 800:: match ip dst 192.168.0.0/16 hashkey mask 0x000000ff at 16 link 4: # add ingress rules for 192.168.0.9 tc class add dev ifb0 parent 1:1 classid 1:9 htb prio 5 rate 3mbit ceil 3mbit tc qdisc add dev ifb0 parent 1:9 handle 9: pfifo limit 500 tc filter add dev ifb0 parent 1: protocol ip prio 5 u32 ht 4:9: match ip dst \"192.168.0.9\" flowid 1:9 sharping的原理 Leaky Bucket: 把流量queue住，一次只出去指定的量 Token Bucket: 把流量queue住，等有token才能出去同等數量的traffic htb就是parent的token可以轉給小孩用 sharping的作法 用netem\ntc qdisc add dev enp0s5 root handle 1: prio tc qdisc add dev enp0s5 parent 1:1 handle 10: netem delay 100ms 10ms tc filter add dev enp0s5 protocol ip parent 1:0 prio 1 u32 match ip dst 151.101.0.0/16 match ip dport 443 0xffff flowid 1:1 用htb\ntc qdisc add dev enp0s5 root handle 1:0 htb tc class add dev enp0s5 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps Ref Linux TC(Traffic Control)框架原理解析 Linux Traffic Control (tc) 研究 流量控制 TC 入門 (traffic control)\n","wordCount":"392","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2021-10-26T22:06:11Z","dateModified":"2021-10-26T22:06:11Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2021/10/network%E7%9A%84traffic-control/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">network的traffic control</h1><div class=post-meta><span title='2021-10-26 22:06:11 +0000 UTC'>October 26, 2021</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#%e6%a6%82%e5%bf%b5 aria-label=概念>概念</a></li><li><a href=#classless--classful-qdisc aria-label="classless & classful qdisc">classless & classful qdisc</a></li><li><a href=#ingress-qdisc--ifb aria-label="ingress qdisc & ifb">ingress qdisc & ifb</a></li><li><a href=#sharping%e7%9a%84%e5%8e%9f%e7%90%86 aria-label=sharping的原理>sharping的原理</a></li><li><a href=#sharping%e7%9a%84%e4%bd%9c%e6%b3%95 aria-label=sharping的作法>sharping的作法</a></li><li><a href=#ref aria-label=Ref>Ref</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>以前遇過，review一下</p><h2 id=概念>概念<a hidden class=anchor aria-hidden=true href=#概念>#</a></h2><p>一般做tc就是在意下面4件事</p><ul><li>POLICING(策略)<ul><li>進來的pkt要到哪邊<ul><li>queue的入口</li></ul></li></ul></li><li>SCHEDULING(調度)<ul><li>怎麼分配bandwidth (QoS)<ul><li>queue的內部</li></ul></li></ul></li><li>SHAPING (限制)<ul><li>調整輸出的速度<ul><li>queue的出口</li></ul></li></ul></li><li>DROPPING(丟棄)<ul><li>爆量了怎麼辦</li></ul></li></ul><p><img loading=lazy src="https://img-blog.csdn.net/20141026225344242?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZG9nMjUw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p><p>traffic control就是一個queue接一個queue，變成一個樹狀queue，有三個元件</p><ul><li><em>qdisc</em><ul><li>quene (virtual)<ul><li>tree的node (特別是能放class的qdisc)<ul><li>leaf (classless)</li><li>node (classful，會多兩個元件)<ul><li><em>filter</em><ul><li>(另外加的) 要讓traffic去哪 (class或qdisc)<ul><li>有點像goto</li></ul></li></ul></li><li><em>class</em><ul><li>下一個qdisc的入口，目前qdisc的出口<ul><li>node的pointer</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul><p>樹狀queue就是qdisc指到2種東西</p><ol><li>class</li><li>qdisc (classless)
另外就是符合條件(filter)直接被指到</li><li>class</li><li>qdisc (classless)</li></ol><p><img loading=lazy src=https://tonydeng.github.io/sdn-handbook/linux/images/tc2.jpeg alt></p><h2 id=classless--classful-qdisc>classless & classful qdisc<a hidden class=anchor aria-hidden=true href=#classless--classful-qdisc>#</a></h2><p>就qdisc能不能放class</p><ul><li>classless<ul><li>pfifo: 一般的queue</li><li>pfifo_fast: 根據ToS去分到對應的一般的queue</li><li>red: 爆量時隨機drop</li><li>sfq: Stochastic Fairness Queueing</li><li>tbf: Token Bucket Filter</li></ul></li><li>classful<ul><li>cbq: Class Based Queueing</li><li>htb: Hierarchy Token Bucket</li></ul></li></ul><h2 id=ingress-qdisc--ifb>ingress qdisc & ifb<a hidden class=anchor aria-hidden=true href=#ingress-qdisc--ifb>#</a></h2><p>ifb，tc作用在egress(從主機出去的traffic)，如果要用在ingress，就要設ifb把traffic灌進去，把tc設定ifb的egress
<img loading=lazy src=https://tonydeng.github.io/sdn-handbook/linux/images/ifb.jpeg alt></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># init ifb</span>
</span></span><span class=line><span class=cl>modprobe ifb <span class=nv>numifbs</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ifb0 up
</span></span><span class=line><span class=cl><span class=c1>#  redirect ingress to ifb0</span>
</span></span><span class=line><span class=cl>tc qdisc add dev eth0 ingress handle ffff:
</span></span><span class=line><span class=cl>tc filter add dev eth0 parent ffff: protocol ip prio <span class=m>0</span> u32 match u32 <span class=m>0</span> <span class=m>0</span> flowid ffff: action mirred egress redirect dev ifb0
</span></span><span class=line><span class=cl><span class=c1># add qdisc</span>
</span></span><span class=line><span class=cl>tc qdisc add dev ifb0 root handle 1: htb default <span class=m>2</span> r2q <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=c1># add default class</span>
</span></span><span class=line><span class=cl>tc class add dev ifb0 parent 1:0 classid 1:1 htb rate 1000mbit ceil 1000mbit
</span></span><span class=line><span class=cl>tc class add dev ifb0 parent 1:1 classid 1:2 htb prio <span class=m>5</span> rate 1000mbit ceil 1000mbit
</span></span><span class=line><span class=cl>tc qdisc add dev ifb0 parent 1:2 handle 2: pfifo limit <span class=m>500</span>
</span></span><span class=line><span class=cl><span class=c1># add default filter</span>
</span></span><span class=line><span class=cl>tc filter add dev ifb0 parent 1:0 prio <span class=m>5</span> protocol ip u32
</span></span><span class=line><span class=cl>tc filter add dev ifb0 parent 1:0 prio <span class=m>5</span> handle 4: protocol ip u32 divisor <span class=m>256</span>
</span></span><span class=line><span class=cl>tc filter add dev ifb0 parent 1:0 prio <span class=m>5</span> protocol ip u32 ht 800:: match ip dst 192.168.0.0/16 hashkey mask 0x000000ff at <span class=m>16</span> link 4:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># add ingress rules for 192.168.0.9</span>
</span></span><span class=line><span class=cl>tc class add dev ifb0 parent 1:1 classid 1:9 htb prio <span class=m>5</span> rate 3mbit ceil 3mbit
</span></span><span class=line><span class=cl>tc qdisc add dev ifb0 parent 1:9 handle 9: pfifo limit <span class=m>500</span>
</span></span><span class=line><span class=cl>tc filter add dev ifb0 parent 1: protocol ip prio <span class=m>5</span> u32 ht 4:9: match ip dst <span class=s2>&#34;192.168.0.9&#34;</span> flowid 1:9
</span></span></code></pre></div><h2 id=sharping的原理>sharping的原理<a hidden class=anchor aria-hidden=true href=#sharping的原理>#</a></h2><p>Leaky Bucket: 把流量queue住，一次只出去指定的量
<img loading=lazy src=https://yuanchieh.page/posts/img/1__JPPMyAsWQM4A6v2ISToeDA.png alt></p><p>Token Bucket: 把流量queue住，等有token才能出去同等數量的traffic
<img loading=lazy src=https://yuanchieh.page/posts/img/1__ZgZl0hEi3WGl6dKiqtkL1Q.jpeg alt></p><p>htb就是parent的token可以轉給小孩用
<img loading=lazy src=https://yuanchieh.page/posts/img/1__yxleicti2yy9F2K0UrpmHA.png alt></p><p><img loading=lazy src=https://tonydeng.github.io/sdn-handbook/linux/images/htb-class.png alt></p><h2 id=sharping的作法>sharping的作法<a hidden class=anchor aria-hidden=true href=#sharping的作法>#</a></h2><p>用netem</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tc qdisc add dev enp0s5 root handle 1: prio
</span></span><span class=line><span class=cl>tc qdisc add dev enp0s5 parent 1:1 handle 10: netem delay 100ms 10ms
</span></span><span class=line><span class=cl>tc filter add dev enp0s5 protocol ip parent 1:0 prio <span class=m>1</span> u32 match ip dst 151.101.0.0/16 match ip dport <span class=m>443</span> 0xffff flowid 1:1
</span></span></code></pre></div><p>用htb</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tc qdisc add dev enp0s5 root handle 1:0 htb
</span></span><span class=line><span class=cl>tc class add dev enp0s5 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps
</span></span></code></pre></div><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p><a href=https://blog.csdn.net/dog250/article/details/40483627>Linux TC(Traffic Control)框架原理解析</a>
<a href=https://yuanchieh.page/posts/2019/2019-04-05_linux-traffic-control/>Linux Traffic Control (tc) 研究</a>
<a href=https://tonydeng.github.io/sdn-handbook/linux/tc.html#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6>流量控制</a>
<a href=http://puremonkey2010.blogspot.com/2015/01/linux-tc-traffic-control.html>TC 入門 (traffic control)</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://littlebees.github.io/tags/network/>Network</a></li></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2021/10/%E6%80%8E%E9%BA%BCsurvey/><span class=title>« Prev</span><br><span>怎麼survey</span>
</a><a class=next href=https://littlebees.github.io/2021/10/%E8%AA%B0%E9%96%8B%E4%BA%86%E6%AA%94%E6%A1%88/><span class=title>Next »</span><br><span>誰開了檔案</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>