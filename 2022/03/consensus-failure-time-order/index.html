<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="AEpTGuQAkxnTOlmfF4INDna3S660LxrkyZ4BQzVbRSw">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"littlebees.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="動機 分散式系統最重要的就是在不同的錯誤情境下達成共識 之後追求performance 串起這一切的就是時間與與之對應的排序 下面就來簡單的整理一下">
<meta property="og:type" content="article">
<meta property="og:title" content="共識、錯誤、時間、排序">
<meta property="og:url" content="https://littlebees.github.io/2022/03/consensus-failure-time-order/index.html">
<meta property="og:site_name" content="記事本">
<meta property="og:description" content="動機 分散式系統最重要的就是在不同的錯誤情境下達成共識 之後追求performance 串起這一切的就是時間與與之對應的排序 下面就來簡單的整理一下">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/0Alc7OF.png">
<meta property="og:image" content="https://i.imgur.com/BNFqQz3.png">
<meta property="article:published_time" content="2022-03-31T03:04:02.000Z">
<meta property="article:modified_time" content="2022-04-02T18:06:07.979Z">
<meta property="article:author" content="zhengcf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/0Alc7OF.png">

<link rel="canonical" href="https://littlebees.github.io/2022/03/consensus-failure-time-order/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>共識、錯誤、時間、排序 | 記事本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">記事本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">寫下來，不然會忘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://littlebees.github.io/2022/03/consensus-failure-time-order/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhengcf">
      <meta itemprop="description" content="想到什麼就寫什麼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="記事本">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          共識、錯誤、時間、排序
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-31 11:04:02" itemprop="dateCreated datePublished" datetime="2022-03-31T11:04:02+08:00">2022-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-03 02:06:07" itemprop="dateModified" datetime="2022-04-03T02:06:07+08:00">2022-04-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/" itemprop="url" rel="index"><span itemprop="name">System</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="動機-643">動機</h2>
<p>分散式系統最重要的就是在不同的錯誤情境下達成共識<br>
之後追求performance</p>
<p>串起這一切的就是時間與與之對應的排序</p>
<p>下面就來簡單的整理一下</p>
<span id="more"></span>
<h2 id="錯誤-2">錯誤</h2>
<p>傳訊時可能遺失、out-of-order、重複<br>
接收方可能當機導致不能回 (但recover會知道自己之前做了什麼)</p>
<p>在上面的情況下，分成兩種錯誤</p>
<ul>
<li>拜占庭
<ul>
<li>在同一個情況(狀態)，出來的output可能不同 (可能是sender在搞，也有可能是在中間被改，換言之 資料損壞)
<ul>
<li>拜占庭中的叛徒
<ul>
<li>leader可以對不同人送不同的msg</li>
<li>不能直接用leader的msg，要參考其他人的</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>非拜占庭
<ul>
<li>在同一個情況(狀態)，出來的output都一樣
<ul>
<li>就算當機，也還是忠誠</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="共識">共識</h2>
<p>共識在不同的情況下有不同的目標</p>
<ul>
<li>拜占庭 (拜占庭將軍問題)
<ul>
<li>忠誠的人最後都要做相同的指令</li>
<li>如果leader忠誠，所有忠誠的人最後都要接受leader的命令</li>
</ul>
</li>
<li>非拜占庭
<ul>
<li>過半數都同意</li>
<li>所有人都同意</li>
</ul>
</li>
</ul>
<h3 id="解法-3">解法</h3>
<p>拜占庭的output可能不同所以分成</p>
<ul>
<li>oral messages: 可以被偽造</li>
<li>signed messages: 不能被偽造簽名&amp;無法改內容(會被抓到)，同時能被任何人驗證</li>
</ul>
<p>同時所有msg都會</p>
<ol>
<li>寄往正確的地方</li>
<li>知道sernder是誰</li>
<li>有辦法知道msg沒有寄成</li>
</ol>
<h4 id="拜占庭-oral-messages">拜占庭 + oral messages</h4>
<p>前提: 至少<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex" xmlns="http://www.w3.org/2000/svg" width="7.015ex" height="1.692ex" role="img" focusable="false" viewBox="0 -666 3100.4 748"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1600.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(2600.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container>個人忠誠 (m是叛徒數量)</p>
<ol>
<li>leader把msg丟給所有人</li>
<li>把收到的msg丟給自己與leader以外的人 (timeout當成retreat)</li>
<li>根據收集到的msg的多數(<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex" xmlns="http://www.w3.org/2000/svg" width="7.015ex" height="1.692ex" role="img" focusable="false" viewBox="0 -666 3100.4 748"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1600.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(2600.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container>個)做事</li>
</ol>
<h5 id="blockchain">blockchain</h5>
<p>在blockchain中，如果有人想做假</p>
<ol>
<li>要巨量的工作量</li>
<li>同時要成為最長鏈 (在fork的時候還會讓交易更慢)</li>
</ol>
<h4 id="拜占庭-signed-messages">拜占庭 + signed messages</h4>
<p>前提: 至少<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></svg></mjx-container>個人忠誠</p>
<ol>
<li>收到leader的msg，放到<code>orders</code>的set中，把該msg加上自己的sign再傳給其他人</li>
<li>收到其他msg，如果msg不同，放到<code>orders</code>的set中，把該msg加上自己的sign再傳給沒有在上面sign的人</li>
<li>都收完了，透過某個神祕choice函數從orders中選一個order (如果leader忠誠，應該只會有一個order)</li>
</ol>
<h4 id="非拜占庭-過半數都同意-consensus">非拜占庭 + 過半數都同意 (consensus)</h4>
<p>paxos</p>
<h4 id="非拜占庭-所有人都同意-uniform-consensus">非拜占庭 + 所有人都同意 (uniform consensus)</h4>
<p>一般這裡都是看uniform consensus的特化問題</p>
<p><em>atomic commit</em></p>
<p>所有人都要一起commit或是abort。</p>
<p>只要有節點發生故障，atomic commit就一定會阻塞嗎？</p>
<p>根源就在於Abort和Commit並不是對等的決策</p>
<p>假設有一個節點宕機了，其它節點大可以選擇Abort決策（注意不能選擇Commit），從而讓整個事務Abort掉<br>
在這個過程中，參與分佈式事務的所有節點（包括宕機的這個節點）對於“執行Commit還是Abort”也是達成了共識的（這個共識是Abort）</p>
<h4 id="同步與異步-拜占庭與一般共識">同步與異步 &amp; 拜占庭與一般共識</h4>
<p>拜占庭需要知道timeout，所以需要同步的時間<br>
一般共識不用知道timeout是異步的</p>
<h5 id="2PC-3PC">2PC &amp; 3PC</h5>
<ul>
<li>發transation</li>
<li>prepare問所有人行不行commit</li>
<li>都ok，發commit</li>
<li>有人不行，發abort</li>
</ul>
<p>看起來很簡單，其實有細節<br>
記得，分散式重要的是不能反悔這件事，在2PC有哪邊不能反悔?</p>
<p><strong>只要回了ok，就必須等到master回commit</strong></p>
<p>其他狀況都可以用發abort處理</p>
<p>但這有可能master在發commit之前死亡，這樣所有人都要等</p>
<p>所以有了3PC，與raft的prevote很像，在要大家prepare之前先問有沒有辦法回ok<br>
因為這個不會<strong>回了ok</strong>這樣就算有人出事也沒差(fail early)</p>
<p>因為prevote已經確認過了大家都ok，這樣如果有人出事都可以直接過。<br>
有人在prevorte，回不能commit就不會到第二階段，就不能動</p>
<p>最後就是看在什麼狀態下能回ok?<br>
server已經到了可以跑transation的狀態，同時沒有其他thread(transaction)可以改。<br>
(因為這個會被persist，所以就算crash也沒事)</p>
<p>3PC的優點： 最大優點就是降低了參與者的阻塞範圍，並且能夠在出現單點故障後繼續達成一致。</p>
<p>3PC的缺點: 參與者接收到了PreCommit消息，然後網絡出現問題，參與者和協調者無法通信，這種情況下，參與者依然會執行事務的提交。</p>
<h2 id="時間、排序">時間、排序</h2>
<p>我們怎麼意識到時間流逝?</p>
<ol>
<li>做了不同的指令</li>
<li>觀察的資料發生變化</li>
</ol>
<p>有沒有我們無法意識到的時間?<br>
也許有，但對於系統來說永遠有一個，現實時間</p>
<p>所以時間是什麼?<br>
不一致的證據(證明)</p>
<p>而時間嚴格遞增，所以可以比較，就有了排序</p>
<h3 id="順序一致性">順序一致性</h3>
<ol>
<li>sort過後的所有指令，每個read都要與最近的write一樣 (全域的read/write序)</li>
<li>在process中的order要在sort過後的順序中保持 (process中的序)</li>
</ol>
<p><img src="https://i.imgur.com/0Alc7OF.png" alt=""></p>
<p>下面是順序一致性的例子<br>
A –&gt; w1(x)<br>
r3(x) –&gt; A // 這是舊的!!<br>
C –&gt; w2(x)<br>
r3(x) –&gt; C<br>
B –&gt; w1(x)<br>
r3(x) –&gt; B</p>
<h3 id="線性一致性">線性一致性</h3>
<p>在順序一致性的基礎上加一個條件</p>
<ul>
<li>只要時間不overlay，指令之間的<strong>在時間上</strong>的order都要保持 (全域的時間序)</li>
</ul>
<p>所以線性一致性可以確保read總是最新的，因此上面的例子不是線性一致</p>
<h3 id="因果一致性">因果一致性</h3>
<p>先定義因果關係 (a -&gt; b，他是transitive，aka happen-before)</p>
<ol>
<li>在同一process，a在b之前執行</li>
<li>a做的write，b做read拿到</li>
</ol>
<p>因果關係是一種偏序，也就是，不是所有東西都可以排序，像沒有因果關係的東西(async的指令)，就沒有排序也不知道怎麼排序；而現實時間是一種全序，都可以用時間點排序</p>
<p>接著定義因果一致性，在某個process的所有指令與其他process的write，可以sort成</p>
<ol>
<li>read拿到的值必須是最近一次的write</li>
<li>sort要依據因果關係</li>
</ol>
<p>這邊的重點是在某個process，也就是我們是從process去看而已。<br>
這有什麼結果?</p>
<p>不同process可能看到的排序結果可能不同!!</p>
<p><img src="https://i.imgur.com/BNFqQz3.png" alt=""></p>
<p>上圖表達了兩個進程的並發執行過程。它是滿足因果一致性的</p>
<p>站在P1視角，有：</p>
<p>A –&gt; w1(x)<br>
B –&gt; w2(x)<br>
r1(x) –&gt; B<br>
站在P2視角，有：</p>
<p>B –&gt; w2(x)<br>
A –&gt; w1(x)<br>
r2(x) –&gt; A</p>
<p>這樣的好處是可以在其他機器死亡時堤供舊資料，反正只要滿足因果關係就好</p>
<h4 id="lamport-clock-Strong-Clock-Condition">lamport clock &amp; Strong Clock Condition</h4>
<p>lamport clock的定義是如果a與b有因果關係，a的clock必定小於b的clock (偏序)</p>
<p>可以為每一個事件上一個數字，之後嚴格遞增，在synchronize時取最大的+1，就會拿到lamport clock。</p>
<p>同時，clock之間的比較，只有在有因果關係才有意義。<br>
像是兩個併發的指令，比較clock就沒意義。</p>
<p>但這是可以實現全域排序的其中一種方法，因為clock隱含因果關係。<br>
用clock排序後就有順序一致，如果同時符合時間序，就有線性一致。</p>
<p>符合時間序叫Strong Clock Condition<br>
因為lamport clock是系統中的時間，與現實(外界)的時間不同步，所以可能看到新的request拿到比較小的lamport clock</p>
<p>不同步?</p>
<ul>
<li>任意兩個時鐘的運行速率有差異，它們的讀數會漂移得越來越遠</li>
<li>時鐘的運行速率跟真實時間的流逝速率可能有差異</li>
</ul>
<h5 id="gc-pause-redlock-fence-token-外界的時間">gc pause &amp; redlock &amp; fence token: 外界的時間</h5>
<p>lamport clock是系統中的時間<br>
Strong Clock Condition是現實或是宇宙的時間</p>
<p>還有其他時間嗎?<br>
如果gc pause發生，變成自己的時間不準了，因為自己的時間與外界的時間不一致<br>
但實際上時間早已流逝!!</p>
<p>所以可以引入下一個時間，在redlock的辯論中叫fence token，其實就是storage的lamport clock</p>
<h4 id="同步時間">同步時間</h4>
<p>NTP可以同步時間，但還是有誤差(還有可能倒退!!)</p>
<p>所以要把誤差也算在時間點中(spanner的truetime)</p>
<h3 id="最終一致性">最終一致性</h3>
<p>這個一致性沒有保證任何東西，因為我們不確定會有什麼，只知道未來一定會有。</p>
<p>線性一致性和順序一致性屬於safety property（安全性）<br>
而最終一致性屬於liveness property（活性）</p>
<p>safety：它表示「壞事」永遠不會發生<br>
liveness：它表示「好事」最終會發生</p>
<p>通常來說，只有當safety和liveness這兩種屬性被同時考慮時，一個系統才能提供有意義的系統保證。<br>
對於系統使用者來說，你必須針對數據不一致的可能性做好補償措施 (compensation)。<br>
這也是最終一致性系統難用的地方</p>
<h2 id="Ref-137">Ref</h2>
<p><span class="exturl" data-url="aHR0cDovL3poYW5ndGllbGVpLmNvbS9wb3N0cy9ibG9nLXRpbWUtY2xvY2stb3JkZXJpbmcuaHRtbA==">分布式领域最重要的一篇论文，到底讲了什么？<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cDovL3poYW5ndGllbGVpLmNvbS9wb3N0cy9ibG9nLXJlZGxvY2stcmVhc29uaW5nLmh0bWw=">基于Redis的分布式锁到底安全吗（上）？<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cDovL3poYW5ndGllbGVpLmNvbS9wb3N0cy9ibG9nLXJlZGxvY2stcmVhc29uaW5nLXBhcnQyLmh0bWw=">基于Redis的分布式锁到底安全吗（下）？<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cDovL3poYW5ndGllbGVpLmNvbS9wb3N0cy9ibG9nLWRpc3RyaWJ1dGVkLWNhdXNhbC1jb25zaXN0ZW5jeS5odG1s">条分缕析分布式：因果一致性和相对论时空<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cHM6Ly9sYW1wb3J0LmF6dXJld2Vic2l0ZXMubmV0L3B1YnMvYnl6LnBkZg==">The Byzantine Generals Problem<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/rest-of-raft/" rel="prev" title="raft補遺">
      <i class="fa fa-chevron-left"></i> raft補遺
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8B%95%E6%A9%9F-643"><span class="nav-number">1.</span> <span class="nav-text">動機</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%8C%AF%E8%AA%A4-2"><span class="nav-number">2.</span> <span class="nav-text">錯誤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B1%E8%AD%98"><span class="nav-number">3.</span> <span class="nav-text">共識</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%B3%95-3"><span class="nav-number">3.1.</span> <span class="nav-text">解法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%9C%E5%8D%A0%E5%BA%AD-oral-messages"><span class="nav-number">3.1.1.</span> <span class="nav-text">拜占庭 + oral messages</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#blockchain"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">blockchain</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%9C%E5%8D%A0%E5%BA%AD-signed-messages"><span class="nav-number">3.1.2.</span> <span class="nav-text">拜占庭 + signed messages</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E6%8B%9C%E5%8D%A0%E5%BA%AD-%E9%81%8E%E5%8D%8A%E6%95%B8%E9%83%BD%E5%90%8C%E6%84%8F-consensus"><span class="nav-number">3.1.3.</span> <span class="nav-text">非拜占庭 + 過半數都同意 (consensus)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E6%8B%9C%E5%8D%A0%E5%BA%AD-%E6%89%80%E6%9C%89%E4%BA%BA%E9%83%BD%E5%90%8C%E6%84%8F-uniform-consensus"><span class="nav-number">3.1.4.</span> <span class="nav-text">非拜占庭 + 所有人都同意 (uniform consensus)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E8%88%87%E7%95%B0%E6%AD%A5-%E6%8B%9C%E5%8D%A0%E5%BA%AD%E8%88%87%E4%B8%80%E8%88%AC%E5%85%B1%E8%AD%98"><span class="nav-number">3.1.5.</span> <span class="nav-text">同步與異步 &amp; 拜占庭與一般共識</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2PC-3PC"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">2PC &amp; 3PC</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%82%E9%96%93%E3%80%81%E6%8E%92%E5%BA%8F"><span class="nav-number">4.</span> <span class="nav-text">時間、排序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A0%86%E5%BA%8F%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">4.1.</span> <span class="nav-text">順序一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B7%9A%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">4.2.</span> <span class="nav-text">線性一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%A0%E6%9E%9C%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">4.3.</span> <span class="nav-text">因果一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#lamport-clock-Strong-Clock-Condition"><span class="nav-number">4.3.1.</span> <span class="nav-text">lamport clock &amp; Strong Clock Condition</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gc-pause-redlock-fence-token-%E5%A4%96%E7%95%8C%E7%9A%84%E6%99%82%E9%96%93"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">gc pause &amp; redlock &amp; fence token: 外界的時間</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E6%99%82%E9%96%93"><span class="nav-number">4.3.2.</span> <span class="nav-text">同步時間</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E7%B5%82%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">4.4.</span> <span class="nav-text">最終一致性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ref-137"><span class="nav-number">5.</span> <span class="nav-text">Ref</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhengcf</p>
  <div class="site-description" itemprop="description">想到什麼就寫什麼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">695</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">85</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengcf</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 1000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://littlebees.github.io/2022/03/consensus-failure-time-order/',]
      });
      });
  </script>

</body>
</html>
