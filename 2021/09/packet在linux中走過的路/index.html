<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>packet在linux中走過的路 | 記事本</title>
<meta name=keywords content="Network"><meta name=description content="動機
有趣的topic"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2021/09/packet%E5%9C%A8linux%E4%B8%AD%E8%B5%B0%E9%81%8E%E7%9A%84%E8%B7%AF/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2021/09/packet%E5%9C%A8linux%E4%B8%AD%E8%B5%B0%E9%81%8E%E7%9A%84%E8%B7%AF/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="packet在linux中走過的路"><meta property="og:description" content="動機
有趣的topic"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2021/09/packet%E5%9C%A8linux%E4%B8%AD%E8%B5%B0%E9%81%8E%E7%9A%84%E8%B7%AF/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-02T21:01:11+00:00"><meta property="article:modified_time" content="2021-09-02T21:01:11+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="packet在linux中走過的路"><meta name=twitter:description content="動機
有趣的topic"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"packet在linux中走過的路","item":"https://littlebees.github.io/2021/09/packet%E5%9C%A8linux%E4%B8%AD%E8%B5%B0%E9%81%8E%E7%9A%84%E8%B7%AF/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"packet在linux中走過的路","name":"packet在linux中走過的路","description":"動機 有趣的topic\n","keywords":["Network"],"articleBody":"動機 有趣的topic\npath of pkt: 從下到上 總路線簡化版 PHY dma 到 kernel ring buffer (1st copy) Nic發signal data link Kernel handler到上半部處理 註冊 device與下半部handler 下半部 取skb 從ring buffer到qdisc 決定往哪一個地方送 (bridge,ip) ip Ip 會照這圖先到preroute hook route (from static, routing protocol, 自動生出來的) 自己要收, output (local in與local out的hook) Forward (forward的hook) 往下之前看要不要切片 把mac填好 (arp或是neighbour) tcp 往上找有沒有開的socket 往prequeue 塞 等read，有就開始往userspace copy (2nd copy) 沒有就drop app Read做recvform的syscall再根據socket類型往下找對應的recvform skb netfilter與總路線 localhost怎麼處理? localhost是到lo interface，也就是假網卡，data直接灌給自己\n有趣的是，只要是本機ip與localhost到本機ip與localhost，不論routing怎麼設，都是過4與3層到lo!!\nRef Queueing in the Linux Network Stack linux network stack Netfilter-TaiwanWorkshop Linux Network Stack Walkthrough (2.4.20) 环回接口(loopback interface)的新认识\n","wordCount":"83","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2021-09-02T21:01:11Z","dateModified":"2021-09-02T21:01:11Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2021/09/packet%E5%9C%A8linux%E4%B8%AD%E8%B5%B0%E9%81%8E%E7%9A%84%E8%B7%AF/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">packet在linux中走過的路</h1><div class=post-meta><span title='2021-09-02 21:01:11 +0000 UTC'>September 2, 2021</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#path-of-pkt-%e5%be%9e%e4%b8%8b%e5%88%b0%e4%b8%8a aria-label="path of pkt: 從下到上">path of pkt: 從下到上</a></li><li><a href=#skb aria-label=skb>skb</a></li><li><a href=#netfilter%e8%88%87%e7%b8%bd%e8%b7%af%e7%b7%9a aria-label=netfilter與總路線>netfilter與總路線</a></li><li><a href=#localhost%e6%80%8e%e9%ba%bc%e8%99%95%e7%90%86 aria-label=localhost怎麼處理?>localhost怎麼處理?</a></li><li><a href=#ref aria-label=Ref>Ref</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>有趣的topic</p><h2 id=path-of-pkt-從下到上>path of pkt: 從下到上<a hidden class=anchor aria-hidden=true href=#path-of-pkt-從下到上>#</a></h2><p>總路線簡化版
<img loading=lazy src=http://myaut.github.io/dtrace-stap-book/images/net.png alt></p><ul><li>PHY<ul><li>dma 到 kernel ring buffer (1st copy)</li><li>Nic發signal</li></ul></li><li>data link<ul><li>Kernel handler到上半部處理<ul><li>註冊 device與下半部handler</li></ul></li><li>下半部<ul><li>取skb<ul><li>從ring buffer到qdisc</li><li><img loading=lazy src=https://i.imgur.com/TwiMd5K.png alt></li></ul></li><li>決定往哪一個地方送 (bridge,ip)</li></ul></li></ul></li><li>ip<ul><li>Ip 會照這圖先到preroute hook<ul><li><img loading=lazy src=https://image-static.segmentfault.com/275/492/2754923766-5cf347d009036_fix732 alt></li></ul></li><li>route (from static, routing protocol, 自動生出來的)<ul><li>自己要收, output (local in與local out的hook)</li><li>Forward (forward的hook)</li></ul></li><li>往下之前看要不要切片</li><li>把mac填好 (arp或是neighbour)</li></ul></li><li>tcp<ul><li>往上找有沒有開的socket<ul><li>往prequeue 塞</li><li>等read，有就開始往userspace copy (2nd copy)</li></ul></li><li>沒有就drop</li></ul></li><li>app<ul><li>Read做recvform的syscall再根據socket類型往下找對應的recvform</li></ul></li></ul><h2 id=skb>skb<a hidden class=anchor aria-hidden=true href=#skb>#</a></h2><p><img loading=lazy src=http://myaut.github.io/dtrace-stap-book/images/linux/net.png alt></p><h2 id=netfilter與總路線>netfilter與總路線<a hidden class=anchor aria-hidden=true href=#netfilter與總路線>#</a></h2><p><img loading=lazy src=https://i.imgur.com/yVR5KN6.jpg alt></p><h2 id=localhost怎麼處理>localhost怎麼處理?<a hidden class=anchor aria-hidden=true href=#localhost怎麼處理>#</a></h2><p>localhost是到lo interface，也就是假網卡，data直接灌給自己</p><p>有趣的是，只要是本機ip與localhost到本機ip與localhost，不論routing怎麼設，都是過4與3層到lo!!</p><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p><a href=https://www.coverfire.com/articles/queueing-in-the-linux-network-stack/>Queueing in the Linux Network Stack</a>
<a href=http://hushi55.github.io/2015/10/22/linux-network-stack>linux network stack</a>
<a href=https://www.facebook.com/Netfilter-TaiwanWorkshop-139380146453712/photos/196293994095660>Netfilter-TaiwanWorkshop</a>
<a href=https://jsevy.com/network/Linux_network_stack_walkthrough.html>Linux Network Stack Walkthrough (2.4.20)</a>
<a href=https://www.cnblogs.com/hustcat/p/3920940.html>环回接口(loopback interface)的新认识</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://littlebees.github.io/tags/network/>Network</a></li></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2021/09/leetcode-962-maximum-width-ramp/><span class=title>« Prev</span><br><span>leetcode-962 - Maximum Width Ramp</span>
</a><a class=next href=https://littlebees.github.io/2021/09/external-sort/><span class=title>Next »</span><br><span>external sort</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>