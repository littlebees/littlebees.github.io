<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>nginx的簡單survey | 記事本</title>
<meta name=keywords content><meta name=description content="動機
之前有用過nginx做reverse proxy連到signal server
提供HTTPS連線
現在想把nginx拿來做別的事，所以先survey一下nginx的基本功能吧"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2020/08/nginx%E7%9A%84%E7%B0%A1%E5%96%AEsurvey/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="nginx的簡單survey"><meta property="og:description" content="動機
之前有用過nginx做reverse proxy連到signal server
提供HTTPS連線
現在想把nginx拿來做別的事，所以先survey一下nginx的基本功能吧"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2020/08/nginx%E7%9A%84%E7%B0%A1%E5%96%AEsurvey/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-29T03:26:40+00:00"><meta property="article:modified_time" content="2020-08-29T03:26:40+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="nginx的簡單survey"><meta name=twitter:description content="動機
之前有用過nginx做reverse proxy連到signal server
提供HTTPS連線
現在想把nginx拿來做別的事，所以先survey一下nginx的基本功能吧"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"nginx的簡單survey","item":"https://littlebees.github.io/2020/08/nginx%E7%9A%84%E7%B0%A1%E5%96%AEsurvey/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"nginx的簡單survey","name":"nginx的簡單survey","description":"動機 之前有用過nginx做reverse proxy連到signal server 提供HTTPS連線\n現在想把nginx拿來做別的事，所以先survey一下nginx的基本功能吧\n","keywords":[],"articleBody":"動機 之前有用過nginx做reverse proxy連到signal server 提供HTTPS連線\n現在想把nginx拿來做別的事，所以先survey一下nginx的基本功能吧\nlocation exact match = 要剛好一樣，遇到後就停止搜尋，優先序最高\nlongest prefix match ^~ 只要前綴符合就結束其他的比對，優先序第二高\nregex match ~ or ~* 可以用?來設定變數 (Perl 5.10 compatible syntax, supported since PCRE-7.0) 同時這個設定變數(name capture)也可以用在server_name\n優先序第三高\nprefix match 一般常見的那種，就算把這種match寫在第一個，也會先看之後有沒有前面三種的可以match 優先序最低，如果有regex的match就會用regex的match\nnamed location 類似function\nlocation / { try_files $uri $uri/ @custom } location @custom { # ...do something } proxy X-Forwarded-For \u0026 Forwarded header X開頭的header都是自訂的header，現在有標準化就可以用標準化的header\nBefore\nX-Forwarded-For: 12.34.56.78, 23.45.67.89 X-Real-IP: 12.34.56.78 X-Forwarded-Host: example.com X-Forwarded-Proto: https After\nForwarded: for=12.34.56.78;host=example.com;proto=https, for=23.45.67.89 用頓號區分ip\n在官網上有把$remote_addr (srcIP)與$http_forwarded (srcIP,port)轉成Forwardedheader的code\nmap $remote_addr $proxy_forwarded_elem { # IPv4 addresses can be sent as-is ~^[0-9.]+$ \"for=$remote_addr\"; # IPv6 addresses need to be bracketed and quoted ~^[0-9A-Fa-f:.]+$ \"for=\\\"[$remote_addr]\\\"\"; # Unix domain socket names cannot be represented in RFC 7239 syntax default \"for=unknown\"; } map $http_forwarded $proxy_add_forwarded { # If the incoming Forwarded header is syntactically valid, append to it \"~^(,[ \\\\t]*)*([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+=([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+|\\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\\"))?(;([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+=([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+|\\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\\"))?)*([ \\\\t]*,([ \\\\t]*([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+=([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+|\\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\\"))?(;([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+=([!#$%\u0026'*+.^_`|~0-9A-Za-z-]+|\\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\\"))?)*)?)*$\" \"$http_forwarded, $proxy_forwarded_elem\"; # Otherwise, replace it default \"$proxy_forwarded_elem\"; } proxy_set_header Forwarded $proxy_add_forwarded; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Coexistence with X- 但要注意ticket #1316的問題，$http_forwarded只會有一個for!!\nsimple example server { listen myhost:80; server_name myhost; location / { root /path/to/myapp/public; proxy_set_header X-Forwarded-Host $host:$server_port; proxy_set_header X-Forwarded-Server $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://myapp:8080; } } redirect: rewrite, if, return, set set set $ val\nreturn \u0026 break return status_code [text | URL] 或是 return URL break就是break\n兩個都是讓rewrite或是if停下來，但return會丟status code與URL\nrewrite rewrite path1 path2 [opt] path1的比對值是$URI 也就是像hi.php?a=b path1的pattern只會與hi.php比對\n如果需要$query_string被改寫 要額外處理像\nif ($query_string ~* \"name=(.*)\") { set $name $1; rewrite /info.php /result.php?newname=$name break; ## rewrite /info.php /result.php?newname=$1 break; } rewrite /info.php /result.php?newname=$1 break;的坑是 $1是看path1比對的結果\nbreak, last, redirect , perminate, 空白 break: 不看其他的rewrite last: 回到location再跑一次 redirect: 302, 臨時的redirect perminate: 301, 永久的轉移 空白: 繼續往下跑其他rewrite(好像switch阿) last \u0026 break 借一下這裡的例子來分析\nrewrite /test2 /tt break; location /test { ## 1 rewrite /test2 /test3 break; rewrite /test /test2 last; ## 2 rewrite /test2 /test3 break; } location /test2 { ## 3 return 508; } location /test3 { return 503; } ## /test =\u003e 508 現在先把rewrite分成 server -\u003e locations -\u003e location\n所以在location的last，會回到上一層在跑一次比對\nrewrite /tt /index.html break; rewrite /test2 /tt last; ## 1 location /test { rewrite /test2 /test3 break; rewrite /test /test2 last; rewrite /test2 /test3 break; } location /test2 { return 508; } location /test3 { return 503; } location / { root html; index index.html index.htm; } ## 2 , no match ## test2 =\u003e not exist 如果把last看成回到上一層再跑一次， server的last因為沒有上一層可以回去，所以她的行為與break，就是直接到下一層的比對\nif 就是bash的if，但是沒有else的部分 可以用location的比對像regex等等\nsafe if 根據這裡的分析 if會產生自己的location block，如果其中有自己的content handler，就會用，不然就繼承外面的\n整個rewrite module，會把他的directive翻成自己的指令 先跑自己所有的指令後才跑其他的directive\n像\nlocation /if-try-files { try_files /file @fallback; ## wont work set $true 1; if ($true) { ## here is new location!! forget previous location # nothing } } 所以安全使用if的原則是\nif中盡量只放rewrite module的directive 把所有if放在非rewrite module的directive前面 或是用其他directive取代if，像if(-f ...)換成try_files Virtual Host 想像有很多nginx.conf(對應一台主機) 都放在sites-available\n而實際對外看到的就是在sites-enabled中有symbol link的conf\nXSendfile (X-Accel) 就是當網站要送檔案時可以直接用header的內容來告訴nginx去送某個檔案。 而不是把檔案放在body中再丟出去\n## /protected/iso.img location /protected/ { internal; root /some/path; ## path: /some/path/protected/iso.img ## alias /some/path/; ## path: /some/path/iso.img } basic server conf server { listen 8080; root /data/up1; #從哪邊開始找檔案 location / { fastcgi_pass localhost:9000; # fastcgi的server在哪? fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; # 與bash串接string的方式一樣 fastcgi_param QUERY_STRING $query_string; } location ~ \\.(gif|jpg|png)$ { root /data/images; } } full example user www www; ## Default: nobody worker_processes 5; ## Default: 1, 能開幾個process error_log logs/error.log; pid logs/nginx.pid; worker_rlimit_nofile 8192; ## 一個process最多能開幾個檔案 events { ## 處理與接收連線有關的參數，實際連線(socket)的參數要去http調 worker_connections 4096; ## Default: 1024 一個process最多能accept幾條連線 } http { include conf/mime.types; ## include就是macro展開 include /etc/nginx/proxy.conf; include /etc/nginx/fastcgi.conf; index index.html index.htm index.php; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] $status ' '\"$request\" $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; server_tokens off; ## 在錯誤頁面顯示nginx的版本號? access_log logs/access.log main; ## 可以調tcp的參數 sendfile on; ## 類似splice，實現zerocopy tcp_nopush on; ## TCP_CORK，等到tcp pkt到一定大小，再丟出封包 server_names_hash_bucket_size 128; # this seems to be required for some vhosts ## 壓縮 gzip on; gzip_vary on; ## vary是cache的key的額外key gzip_disable \"msie6\"; gzip_proxied any; ## 找有沒有壓縮過的 gzip_min_length 1000; gzip_comp_level 6; gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript; server { # php/fastcgi listen 80; server_name domain1.com www.domain1.com; access_log logs/domain1.access.log main; root html; location ~ \\.php$ { fastcgi_pass 127.0.0.1:1025; } } server { # simple reverse-proxy listen 80; server_name domain2.com www.domain2.com; access_log logs/domain2.access.log main; # serve static files location ~ ^/(images|javascript|js|css|flash|media|static)/ { root /var/www/virtual/big.server.com/htdocs; expires 30d; } # pass requests for dynamic content to rails/turbogears/zope, et al location / { proxy_pass http://127.0.0.1:8080; } } upstream big_server_com { ## 做簡單的load balance，用rr server 127.0.0.3:8000 weight=5; server 127.0.0.3:8001 weight=5; server 192.168.0.1:8000; server 192.168.0.1:8001; } server { # simple load balancing listen 80; server_name big.server.com; access_log logs/big.server.access.log main; location / { proxy_pass http://big_server_com; } } } Ref nginx beginner full example advanced conf server name forwarded rewrite_module if is eval rewrite \u0026 query_string bunch of NGINX var list x-accel\n","wordCount":"736","inLanguage":"en","datePublished":"2020-08-29T03:26:40Z","dateModified":"2020-08-29T03:26:40Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2020/08/nginx%E7%9A%84%E7%B0%A1%E5%96%AEsurvey/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">nginx的簡單survey</h1><div class=post-meta><span title='2020-08-29 03:26:40 +0000 UTC'>August 29, 2020</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#location aria-label=location>location</a><ul><li><a href=#exact-match aria-label="exact match">exact match</a></li><li><a href=#longest-prefix-match aria-label="longest prefix match">longest prefix match</a></li><li><a href=#regex-match aria-label="regex match">regex match</a></li><li><a href=#prefix-match aria-label="prefix match">prefix match</a></li><li><a href=#named-location aria-label="named location">named location</a></li></ul></li><li><a href=#proxy aria-label=proxy>proxy</a><ul><li><a href=#x-forwarded-for--forwarded-header aria-label="X-Forwarded-For & Forwarded header">X-Forwarded-For & Forwarded header</a></li><li><a href=#simple-example aria-label="simple example">simple example</a></li></ul></li><li><a href=#redirect-rewrite-if-return-set aria-label="redirect: rewrite, if, return, set">redirect: rewrite, if, return, set</a><ul><li><a href=#set aria-label=set>set</a></li><li><a href=#return--break aria-label="return & break">return & break</a></li><li><a href=#rewrite aria-label=rewrite>rewrite</a><ul><li><a href=#break-last-redirect--perminate-%e7%a9%ba%e7%99%bd aria-label="break, last, redirect , perminate, 空白">break, last, redirect , perminate, 空白</a></li><li><a href=#last--break aria-label="last & break">last & break</a></li></ul></li><li><a href=#if aria-label=if>if</a><ul><li><a href=#safe-if aria-label="safe if">safe if</a></li></ul></li></ul></li><li><a href=#virtual-host aria-label="Virtual Host">Virtual Host</a></li><li><a href=#xsendfile-x-accel aria-label="XSendfile (X-Accel)">XSendfile (X-Accel)</a></li><li><a href=#basic-server-conf aria-label="basic server conf">basic server conf</a></li><li><a href=#full-example aria-label="full example">full example</a></li><li><a href=#ref aria-label=Ref>Ref</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>之前有用過nginx做reverse proxy連到signal server
提供HTTPS連線</p><p>現在想把nginx拿來做別的事，所以先survey一下nginx的基本功能吧</p><h2 id=location>location<a hidden class=anchor aria-hidden=true href=#location>#</a></h2><h3 id=exact-match>exact match<a hidden class=anchor aria-hidden=true href=#exact-match>#</a></h3><p><code>= &lt;pattern></code>
要剛好一樣，遇到後就停止搜尋，優先序最高</p><h3 id=longest-prefix-match>longest prefix match<a hidden class=anchor aria-hidden=true href=#longest-prefix-match>#</a></h3><p><code>^~ &lt;pattern></code>
只要前綴符合就結束其他的比對，優先序第二高</p><h3 id=regex-match>regex match<a hidden class=anchor aria-hidden=true href=#regex-match>#</a></h3><p><code>~ &lt;regex></code> or <code>~* &lt;regex></code>
可以用<code>?&lt;name></code>來設定變數 (Perl 5.10 compatible syntax, supported since PCRE-7.0)
同時這個設定變數(name capture)也可以用在server_name</p><p>優先序第三高</p><h3 id=prefix-match>prefix match<a hidden class=anchor aria-hidden=true href=#prefix-match>#</a></h3><p>一般常見的那種，就算把這種match寫在第一個，也會先看之後有沒有前面三種的可以match
優先序最低，如果有regex的match就會用regex的match</p><h3 id=named-location>named location<a hidden class=anchor aria-hidden=true href=#named-location>#</a></h3><p>類似function</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kn>try_files</span> <span class=nv>$uri</span> <span class=nv>$uri/</span> <span class=s>@custom</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s>location</span> <span class=s>@custom</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=c1># ...do something
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h2 id=proxy>proxy<a hidden class=anchor aria-hidden=true href=#proxy>#</a></h2><h3 id=x-forwarded-for--forwarded-header>X-Forwarded-For & Forwarded header<a hidden class=anchor aria-hidden=true href=#x-forwarded-for--forwarded-header>#</a></h3><p>X開頭的header都是自訂的header，現在有標準化就可以用標準化的header</p><p>Before</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>X-Forwarded-For: 12.34.56.78, 23.45.67.89
</span></span></span><span class=line><span class=cl><span class=err>X-Real-IP: 12.34.56.78
</span></span></span><span class=line><span class=cl><span class=err>X-Forwarded-Host: example.com
</span></span></span><span class=line><span class=cl><span class=err>X-Forwarded-Proto: https
</span></span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>Forwarded: for=12.34.56.78;host=example.com;proto=https, for=23.45.67.89
</span></span></span></code></pre></div><p>用頓號區分ip</p><p>在官網上有把<code>$remote_addr</code> (srcIP)與<code>$http_forwarded</code> (srcIP,port)轉成<code>Forwarded</code>header的code</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>map</span> <span class=nv>$remote_addr</span> <span class=nv>$proxy_forwarded_elem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># IPv4 addresses can be sent as-is
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>~^[0-9.]+$</span>          <span class=s>&#34;for=</span><span class=nv>$remote_addr&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># IPv6 addresses need to be bracketed and quoted
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>~^[0-9A-Fa-f:.]+$</span>   <span class=s>&#34;for=\&#34;[</span><span class=nv>$remote_addr]\&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Unix domain socket names cannot be represented in RFC 7239 syntax
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>default</span>             <span class=s>&#34;for=unknown&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>map</span> <span class=nv>$http_forwarded</span> <span class=nv>$proxy_add_forwarded</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># If the incoming Forwarded header is syntactically valid, append to it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>&#34;~^(,[</span> <span class=s>\\t]*)*([!</span><span class=c1>#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+=([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+|\&#34;([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\&#34;))?(;([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+=([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+|\&#34;([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\&#34;))?)*([ \\t]*,([ \\t]*([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+=([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+|\&#34;([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\&#34;))?(;([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+=([!#$%&amp;&#39;*+.^_`|~0-9A-Za-z-]+|\&#34;([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\&#34;))?)*)?)*$&#34; &#34;$http_forwarded, $proxy_forwarded_elem&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1># Otherwise, replace it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>default</span> <span class=s>&#34;</span><span class=nv>$proxy_forwarded_elem&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>proxy_set_header</span> <span class=s>Forwarded</span> <span class=nv>$proxy_add_forwarded</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span> <span class=c1># Coexistence with X-
</span></span></span></code></pre></div><p>但要注意<a href=https://trac.nginx.org/nginx/ticket/1316>ticket #1316</a>的問題，<code>$http_forwarded</code>只會有一個for!!</p><h3 id=simple-example>simple example<a hidden class=anchor aria-hidden=true href=#simple-example>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=n>myhost</span><span class=p>:</span><span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>  <span class=s>myhost</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span> <span class=s>/path/to/myapp/public</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-Host</span> <span class=nv>$host:$server_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-Server</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://myapp:8080</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=redirect-rewrite-if-return-set>redirect: rewrite, if, return, set<a hidden class=anchor aria-hidden=true href=#redirect-rewrite-if-return-set>#</a></h2><h3 id=set>set<a hidden class=anchor aria-hidden=true href=#set>#</a></h3><p><code>set $&lt;name> val</code></p><h3 id=return--break>return & break<a hidden class=anchor aria-hidden=true href=#return--break>#</a></h3><p><code>return status_code [text | URL]</code> 或是
<code>return URL</code>
break就是break</p><p>兩個都是讓rewrite或是if停下來，但return會丟status code與URL</p><h3 id=rewrite>rewrite<a hidden class=anchor aria-hidden=true href=#rewrite>#</a></h3><p><code>rewrite path1 path2 [opt]</code>
path1的比對值是<code>$URI</code>
也就是像<code>hi.php?a=b</code>
path1的pattern只會與hi.php比對</p><p>如果需要<code>$query_string</code>被改寫
要額外處理像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>if</span> <span class=s>(</span><span class=nv>$query_string</span> <span class=p>~</span><span class=sr>*</span> <span class=s>&#34;name=(.*)&#34;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kn>set</span> <span class=nv>$name</span> <span class=nv>$1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kn>rewrite</span> <span class=s>/info.php</span> <span class=s>/result.php?newname=</span><span class=nv>$name</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>## rewrite /info.php /result.php?newname=$1 break;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p><code>rewrite /info.php /result.php?newname=$1 break;</code>的坑是
<code>$1</code>是看path1比對的結果</p><h4 id=break-last-redirect--perminate-空白>break, last, redirect , perminate, 空白<a hidden class=anchor aria-hidden=true href=#break-last-redirect--perminate-空白>#</a></h4><ol><li>break: 不看其他的rewrite</li><li>last: 回到location再跑一次</li><li>redirect: 302, 臨時的redirect</li><li>perminate: 301, 永久的轉移</li><li>空白: 繼續往下跑其他rewrite(好像switch阿)</li></ol><h4 id=last--break>last & break<a hidden class=anchor aria-hidden=true href=#last--break>#</a></h4><p>借一下<a href=http://longlog.me/2017/03/17/nginx-rewrite-break/>這裡</a>的例子來分析</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>rewrite</span> <span class=s>/test2</span> <span class=s>/tt</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>location</span> <span class=s>/test</span> <span class=p>{</span> <span class=c1>## 1
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kn>rewrite</span> <span class=s>/test2</span> <span class=s>/test3</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kn>rewrite</span> <span class=s>/test</span> <span class=s>/test2</span> <span class=s>last</span><span class=p>;</span> <span class=c1>## 2 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kn>rewrite</span> <span class=s>/test2</span> <span class=s>/test3</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>location</span> <span class=s>/test2</span> <span class=p>{</span> <span class=c1>## 3
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kn>return</span> <span class=mi>508</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>location</span> <span class=s>/test3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kn>return</span> <span class=mi>503</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>## /test =&gt; 508
</span></span></span></code></pre></div><p>現在先把rewrite分成
server -> locations -> location</p><p>所以在location的last，會回到上一層在跑一次比對</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>rewrite</span> <span class=s>/tt</span> <span class=s>/index.html</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>rewrite</span> <span class=s>/test2</span> <span class=s>/tt</span> <span class=s>last</span><span class=p>;</span> <span class=c1>## 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=s>/test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kn>rewrite</span> <span class=s>/test2</span> <span class=s>/test3</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kn>rewrite</span> <span class=s>/test</span> <span class=s>/test2</span> <span class=s>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kn>rewrite</span> <span class=s>/test2</span> <span class=s>/test3</span> <span class=s>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=s>/test2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kn>return</span> <span class=mi>508</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=s>/test3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kn>return</span> <span class=mi>503</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kn>root</span>   <span class=s>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kn>index</span>  <span class=s>index.html</span> <span class=s>index.htm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>## 2 , no match
</span></span></span><span class=line><span class=cl><span class=c1>## test2 =&gt; not exist
</span></span></span></code></pre></div><p>如果把last看成回到上一層再跑一次，
server的last因為沒有上一層可以回去，所以她的行為與break，就是直接到下一層的比對</p><h3 id=if>if<a hidden class=anchor aria-hidden=true href=#if>#</a></h3><p>就是bash的if，但是沒有else的部分
可以用location的比對像regex等等</p><h4 id=safe-if>safe if<a hidden class=anchor aria-hidden=true href=#safe-if>#</a></h4><p>根據<a href=https://agentzh.blogspot.com/2011/03/how-nginx-location-if-works.html>這裡</a>的分析
if會產生自己的location block，如果其中有自己的content handler，就會用，不然就繼承外面的</p><p>整個rewrite module，會把他的directive翻成自己的指令
先跑自己所有的指令後才跑其他的directive</p><p>像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>location</span> <span class=s>/if-try-files</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=kn>try_files</span>  <span class=s>/file</span>  <span class=s>@fallback</span><span class=p>;</span> <span class=c1>## wont work
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>     <span class=kn>set</span> <span class=nv>$true</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=kn>if</span> <span class=s>(</span><span class=nv>$true</span><span class=s>)</span> <span class=p>{</span> <span class=c1>## here is new location!! forget previous location
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1># nothing
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>所以安全使用if的原則是</p><ol><li>if中盡量只放rewrite module的directive</li><li>把所有if放在非rewrite module的directive前面</li><li>或是用其他directive取代if，像<code>if(-f ...)</code>換成<code>try_files</code></li></ol><h2 id=virtual-host>Virtual Host<a hidden class=anchor aria-hidden=true href=#virtual-host>#</a></h2><p>想像有很多nginx.conf(對應一台主機)
都放在sites-available</p><p>而實際對外看到的就是在sites-enabled中有symbol link的conf</p><h2 id=xsendfile-x-accel>XSendfile (X-Accel)<a hidden class=anchor aria-hidden=true href=#xsendfile-x-accel>#</a></h2><p>就是當網站要送檔案時可以直接用header的內容來告訴nginx去送某個檔案。
而不是把檔案放在body中再丟出去</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1>## /protected/iso.img
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=s>/protected/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=kn>internal</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=kn>root</span>   <span class=s>/some/path</span><span class=p>;</span>    <span class=c1>## path: /some/path/protected/iso.img
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>## alias /some/path/; ## path: /some/path/iso.img
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h2 id=basic-server-conf>basic server conf<a hidden class=anchor aria-hidden=true href=#basic-server-conf>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>8080</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>root</span> <span class=s>/data/up1</span><span class=p>;</span> <span class=c1>#從哪邊開始找檔案
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kn>fastcgi_pass</span>  <span class=n>localhost</span><span class=p>:</span><span class=mi>9000</span><span class=p>;</span> <span class=c1># fastcgi的server在哪?
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>fastcgi_param</span> <span class=s>SCRIPT_FILENAME</span> <span class=nv>$document_root$fastcgi_script_name</span><span class=p>;</span> <span class=c1># 與bash串接string的方式一樣
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>fastcgi_param</span> <span class=s>QUERY_STRING</span>    <span class=nv>$query_string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=p>~</span> <span class=sr>\.(gif|jpg|png)$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span> <span class=s>/data/images</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=full-example>full example<a hidden class=anchor aria-hidden=true href=#full-example>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>user</span>       <span class=s>www</span> <span class=s>www</span><span class=p>;</span>  <span class=c1>## Default: nobody
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>worker_processes</span>  <span class=mi>5</span><span class=p>;</span>  <span class=c1>## Default: 1, 能開幾個process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>error_log</span>  <span class=s>logs/error.log</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>pid</span>        <span class=s>logs/nginx.pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>worker_rlimit_nofile</span> <span class=mi>8192</span><span class=p>;</span> <span class=c1>## 一個process最多能開幾個檔案
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>events</span> <span class=p>{</span> <span class=c1>## 處理與接收連線有關的參數，實際連線(socket)的參數要去http調
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>worker_connections</span>  <span class=mi>4096</span><span class=p>;</span>  <span class=c1>## Default: 1024 一個process最多能accept幾條連線
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>include</span>    <span class=s>conf/mime.types</span><span class=p>;</span> <span class=c1>## include就是macro展開
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>include</span>    <span class=s>/etc/nginx/proxy.conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>include</span>    <span class=s>/etc/nginx/fastcgi.conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>index</span>    <span class=s>index.html</span> <span class=s>index.htm</span> <span class=s>index.php</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>default_type</span> <span class=s>application/octet-stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>log_format</span>   <span class=s>main</span> <span class=s>&#39;</span><span class=nv>$remote_addr</span> <span class=s>-</span> <span class=nv>$remote_user</span> <span class=s>[</span><span class=nv>$time_local]</span>  <span class=nv>$status</span> <span class=s>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#39;&#34;</span><span class=nv>$request&#34;</span> <span class=nv>$body_bytes_sent</span> <span class=s>&#34;</span><span class=nv>$http_referer&#34;</span> <span class=s>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#39;&#34;</span><span class=nv>$http_user_agent&#34;</span> <span class=s>&#34;</span><span class=nv>$http_x_forwarded_for&#34;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>server_tokens</span> <span class=no>off</span><span class=p>;</span> <span class=c1>## 在錯誤頁面顯示nginx的版本號?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>access_log</span>   <span class=s>logs/access.log</span>  <span class=s>main</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>## 可以調tcp的參數
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>sendfile</span>     <span class=no>on</span><span class=p>;</span> <span class=c1>## 類似splice，實現zerocopy
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>tcp_nopush</span>   <span class=no>on</span><span class=p>;</span> <span class=c1>## TCP_CORK，等到tcp pkt到一定大小，再丟出封包
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>server_names_hash_bucket_size</span> <span class=mi>128</span><span class=p>;</span> <span class=c1># this seems to be required for some vhosts
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>## 壓縮
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>gzip</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>gzip_vary</span> <span class=no>on</span><span class=p>;</span> <span class=c1>## vary是cache的key的額外key
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>gzip_disable</span> <span class=s>&#34;msie6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>gzip_proxied</span> <span class=s>any</span><span class=p>;</span> <span class=c1>## 找有沒有壓縮過的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>gzip_min_length</span> <span class=mi>1000</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=kn>gzip_comp_level</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>gzip_types</span> <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>application/json</span> <span class=s>application/x-javascript</span> <span class=s>text/xml</span> <span class=s>application/xml</span> <span class=s>application/xml+rss</span> <span class=s>text/javascript</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>server</span> <span class=p>{</span> <span class=c1># php/fastcgi
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>listen</span>       <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>  <span class=s>domain1.com</span> <span class=s>www.domain1.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span>   <span class=s>logs/domain</span><span class=mi>1</span><span class=s>.access.log</span>  <span class=s>main</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>root</span>         <span class=s>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=p>~</span> <span class=sr>\.php$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kn>fastcgi_pass</span>   <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>1025</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>server</span> <span class=p>{</span> <span class=c1># simple reverse-proxy
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>listen</span>       <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>  <span class=s>domain2.com</span> <span class=s>www.domain2.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span>   <span class=s>logs/domain</span><span class=mi>2</span><span class=s>.access.log</span>  <span class=s>main</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># serve static files
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>location</span> <span class=p>~</span> <span class=sr>^/(images|javascript|js|css|flash|media|static)/</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kn>root</span>    <span class=s>/var/www/virtual/big.server.com/htdocs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kn>expires</span> <span class=s>30d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># pass requests for dynamic content to rails/turbogears/zope, et al
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kn>proxy_pass</span>      <span class=s>http://127.0.0.1:8080</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>upstream</span> <span class=s>big_server_com</span> <span class=p>{</span> <span class=c1>## 做簡單的load balance，用rr
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>server</span> <span class=n>127.0.0.3</span><span class=p>:</span><span class=mi>8000</span> <span class=s>weight=5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>127.0.0.3</span><span class=p>:</span><span class=mi>8001</span> <span class=s>weight=5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>192.168.0.1</span><span class=p>:</span><span class=mi>8000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>192.168.0.1</span><span class=p>:</span><span class=mi>8001</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>server</span> <span class=p>{</span> <span class=c1># simple load balancing
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>listen</span>          <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>big.server.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span>      <span class=s>logs/big.server.access.log</span> <span class=s>main</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kn>proxy_pass</span>      <span class=s>http://big_server_com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p><a href=http://nginx.org/en/docs/beginners_guide.html>nginx beginner</a>
<a href=https://www.nginx.com/resources/wiki/start/topics/examples/full/>full example</a>
<a href=https://www.oschina.net/translate/nginx-setup?print>advanced conf</a>
<a href=http://nginx.org/en/docs/http/server_names.html#regex_names>server name</a>
<a href=https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/>forwarded</a>
<a href=http://nginx.org/en/docs/http/ngx_http_rewrite_module.html>rewrite_module</a>
<a href=https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/>if is eval</a>
<a href=http://longlog.me/2016/04/17/nginx-get-rewrite/>rewrite & query_string</a>
<a href=https://www.javatpoint.com/nginx-variables>bunch of NGINX var list</a>
<a href=https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/>x-accel</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2020/09/blackhat-python-network-programming/><span class=title>« Prev</span><br><span>blackhat python - network programming</span>
</a><a class=next href=https://littlebees.github.io/2020/08/%E5%A5%87%E8%81%9E%E8%BB%BC%E4%BA%8B-buildroot%E7%9A%84%E5%9D%91/><span class=title>Next »</span><br><span>奇聞軼事-buildroot的坑</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>