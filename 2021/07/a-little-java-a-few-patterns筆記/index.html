<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A little java, a few patterns筆記 | 記事本</title>
<meta name=keywords content="Java"><meta name=description content="動機
這已經雪藏很久了，久在github page還沒用到之前就在我的google docs中
整理一下貼出來"><meta name=author content="zhengcf"><link rel=canonical href=https://littlebees.github.io/2021/07/a-little-java-a-few-patterns%E7%AD%86%E8%A8%98/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://littlebees.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://littlebees.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://littlebees.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://littlebees.github.io/apple-touch-icon.png><link rel=mask-icon href=https://littlebees.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://littlebees.github.io/2021/07/a-little-java-a-few-patterns%E7%AD%86%E8%A8%98/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="A little java, a few patterns筆記"><meta property="og:description" content="動機
這已經雪藏很久了，久在github page還沒用到之前就在我的google docs中
整理一下貼出來"><meta property="og:type" content="article"><meta property="og:url" content="https://littlebees.github.io/2021/07/a-little-java-a-few-patterns%E7%AD%86%E8%A8%98/"><meta property="og:image" content="https://littlebees.github.io/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-07T00:19:54+00:00"><meta property="article:modified_time" content="2021-07-07T00:19:54+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://littlebees.github.io/images/papermod-cover.png"><meta name=twitter:title content="A little java, a few patterns筆記"><meta name=twitter:description content="動機
這已經雪藏很久了，久在github page還沒用到之前就在我的google docs中
整理一下貼出來"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://littlebees.github.io/posts/"},{"@type":"ListItem","position":2,"name":"A little java, a few patterns筆記","item":"https://littlebees.github.io/2021/07/a-little-java-a-few-patterns%E7%AD%86%E8%A8%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A little java, a few patterns筆記","name":"A little java, a few patterns筆記","description":"動機 這已經雪藏很久了，久在github page還沒用到之前就在我的google docs中 整理一下貼出來\n","keywords":["Java"],"articleBody":"動機 這已經雪藏很久了，久在github page還沒用到之前就在我的google docs中 整理一下貼出來\nCh1 datatype in Java abstract class N {} class Zero extends N {} class AddOne extends N {} =\u003e\ndatatype N = Zero | AddOne of N 就是datatype\nThe First Bit of Advice When specifying a collection data, use abstract classes for datatypes and extended classes for variants.\nCh2 list recur ( [type] -\u003e bool \u0026 [type(‘a)] -\u003e ‘a) onlyA abstract class Ab { abstract boolean onlyA(); } class Base extends Ab { boolean onlyA() { return true; } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } boolean onlyA() { return false; } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } boolean onlyA() { return ab.onlyA(); } } ab.{{func}}，在ML中的ab是{{func}}的參數！！\ndatatype Ab = Base | A of Ab | B of Ab fun onlyA(Base) = true | onlyA(A(ab)) = onlyA(ab) | onlyA(B(ab)) = false (onlyA : Ab -\u003e bool) hold_what abstract class Ab { abstract boolean onlyA(); abstract Object hold_what(); } class Base extends Ab { Object hold; Base(Object _hold) { hold = _hold; } Object hold_what() { return hold; } boolean onlyA() { return true; } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } boolean onlyA() { return false; } Object hold_what() { return ab.hold_what; } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } boolean onlyA() { return ab.onlyA(); } Object hold_what() { return ab.hold_what; } } datatype ‘a Ab = Base of ‘a | A of Ab | B of Ab fun hold_what(Base(x)) = x | hold_what(A(ab)) = hold_what(ab) | hold_what(B(ab)) = hold_what(ab) (hold_what : ‘a Ab -\u003e ‘a) The Second Bit of Advice When writing a function over a datatype, place a method in each of the variants that make up the datatype. If a field of a variant belongs to the same datatype, the method may call the corresponding method of the field in computing the function.\ntemplate method pattern abstract class Point { abstract boolean closerTo(Point p); abstract int dist(); } class C extends Point { int x,y; C(int x,int y) { x = x; y= y;} boolean colserTo(Point p) { return dist() \u003c= p.dist(); } int dist() { return abs(sqrt(x*x+y*y)); } } class M extends Point { int x,y; C(int x,int y) { x = x; y= y;} boolean colserTo(Point p) { return dist() \u003c= p.dist(); } int dist() { return x+y; } } 可以把相同的抽到abstract放著\nabstract class Point { boolean closerTo(Point p) { return dist() \u003c= p.dist(); } abstract int dist(); // template，template method pattern } my tip 在所有variant都一樣的function，可以放到abstract class\nCh3 list recur ([type] -\u003e [type]) remA abstract class Ab { abstract Ab remA(); } class Base extends Ab { Ab remA() { return new Base(); } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } Ab remA() { return new B(ab.remA()); } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } Ab remA() { return ab.remA(); } } datatype Ab = Base | A of Ab | B of Ab fun remA(Base) = Base | remA(A(ab)) = remA(ab) | remA(B(ab)) = B(remA(ab)) (remA : Ab -\u003e Ab) appB abstract class Ab { abstract Ab remA(); abstract Ab appB(); } class Base extends Ab { Ab remA() { return new Base(); } Ab appB() { return new Base(); } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } Ab remA() { return new B(ab.remA()); } Ab appB() { return new B(ab.appB()); } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } Ab remA() { return ab.remA(); } Ab appB() { return new B(new A(ab.appB())); } } (這還需要翻成ML嗎)\n如果 appB().remA()，其實與replace A成B是一樣的所以\nrepA abstract class Ab { abstract Ab repA(); } class Base extends Ab { Ab repA() { return new Base(); } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } Ab repA() { return new B(ab.repA()); } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } Ab repA() { return new B(ab.repA()); } } The Third Bit of Advice When writing a function that returns values of a datatype, use new to create these values.\ncomposite \u0026 interpreter pattern abstract class PizzaD { abstract PizzaD remA(); abstract PizzaD topAwC(); abstract PizzaD subAbC(); } class Crust extends PizzaD { PizzaD subAbC(){ return new Crust(); } PizzaD topAwC(){ return new Crust(); } PizzaD subAbC(){ return new Crust(); } } class Cheese extends PizzaD { PizzaD p; Cheese (PizzaD _p) { p = _p; } PizzaD remA(){ return new Cheese(p.remA()); } PizzaD topAwC(){ return new Cheese(p.topAwC()); } PizzaD subAbC(){ return new Cheese(p.subAbC()); } } class Olive extends PizzaD { PizzaD p; Olive (PizzaD _p) { p = _p; } PizzaD remA(){ return new Olive(p.remA()); } PizzaD topAwC(){ return new Olive(p.topAwC()); } PizzaD subAbC(){ return new Olive(p.subAbC()); } } class Anchovy extends PizzaD { PizzaD p; Anchovy (PizzaD _p) { p = _p; } PizzaD remA(){ return p.remA(); } PizzaD topAwC(){ return new Cheese(new Anchovy(p.topAwC())); } PizzaD subAbC(){ return new Cheese(p.subAbC()); } } class Sausage extends PizzaD { PizzaD p; Sausage (PizzaD _p) { p = _p; } PizzaD remA(){ return new Sausage(p.remA()); } PizzaD topAwC(){ return new Sausage(p.topAwC()); } PizzaD subAbC(){ return new Sausage(p.subAbC()); } } 這兩個pattern的本質是都是自己嵌套自己的datatype，所以可以達成如同list效果，可以無限嵌套來組合\nCh4 pattern match ver1(pass all args by myself \u0026 func in abstract class) 從Java到SML? 先複習onlyA\nabstract class Ab { abstract boolean onlyA(); } class Base extends Ab { boolean onlyA() { return true; } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } boolean onlyA() { return false; } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } boolean onlyA() { return ab.onlyA(); } } 接著改寫成像ML的樣子，把所有動作都放到同一個地方\nclass OnlyA { // closure!! OR visitor boolean forBase() { return true; } boolean forA(Ab ab) { return ab.onlyA(); } boolean forB(Ab ab) { return false; } } datatype Ab = Base | A of Ab | B of Ab fun onlyA(Base) = true | onlyA(A(ab)) = onlyA(ab) | onlyA(B(ab)) = false (onlyA : Ab -\u003e bool) 這下把執行動作從variant分離出來了．\n但這要怎麼用？？ 如果這closure固定在一個所有variant可以碰到的地方的話\nvisitor (first try) abstract class Ab { OnlyA func = new OnlyA(); abstract boolean onlyA(); } class Base extends Ab { boolean onlyA() { return func.forBase(); } } class B extends Ab { Ab ab; B(Ab _ab) { ab = _ab; } boolean onlyA() { return func.forB(ab); } } class A extends Ab { Ab ab; A(Ab _ab) { ab = _ab; } boolean onlyA() { return func.forA(ab); } } The Fourth Bit of Advice When writing several functions for the same self-referential datatype, use visitor protocols so that all methods for a function can be found in a single class.\nCh5 equal!?(match self-defined type) \u0026 object as type var 原本應該要用equals去幹一個，但我懶所以用Integer class Rem1 { IntList forNull() { return new Null(); } IntList forCons(IntList l, Object i) { if(1.equals(i)) return l.rem1(); else return new Cons(i,l.rem1()); } } abstract class IntList { Rem1 func = new Rem1(); abstract IntList rem1(); } class Null extends IntList { IntList rem1() { return func.forNull(); } } class Cons extends IntList { Integer i; IntList next; // ….. IntList rem1() { return func.forCons(next, i); } } 這裡省略了一個地方，因為我這裡是用integer所以不用override euqals，但是書上是自訂的class(variant)，所以要用equals要自己實作，而相等的條件就是同類的class的實體，所以用instanceof．\nSubstV class SubstV { PieD forBot(Object n, Object o) { return new Bot(); } PieD forTop (Object t, PieD r, Object n, Object o) { if (o.equals(t)) return new Top(n, r.subst(n, o)); else return new Top(t, r.subst(n, 0)); } } abstract class PieD { RemV remFn = new RemV(); SubsbV substFn = new SubstV(); abstract PieD rem(Object o); abstract PieD subst(Object n, Object o); } class Bot extends PieD { PieD rem(Object o){ return remFn.forBot(o); } PieD subst(Object n, Object o){ return substFn.forBot(n, o) } } class Top extends PieD { Object t; // type var PieD r; Top(Object _t, PieD _r){ t = _t; r = _r; } PieD rem(Object o){ return remFn.forTop(t, r, o); } PieD subst(Object n, Object o){ return substFn.forTop(t, r, n, o) } } 這是不是與list很像，不過注意到subst的Object n, Object o在遞迴的時候其實不會變，所以應該要把它抽出來，scheme是letrec或curry，ML是curry，那這邊要怎麼做？\nCh6 pattern match ver2 (pass closure to invoker \u0026 curry func) class SubstV { Object n,o; // …. PieD forBot() { return new Bot(); } PieD forTop (Object t, PieD r) { if (o.equals(t)) return new Top(n, r.subst(this)); else return new Top(t, r.subst(this)); } } 如果照原本的把closure固定在一個所有variant可以碰到的地方的方式，我們沒機會使用我們自己new出來的clousre!!\n從upper class傳closure變成從參數傳 那要做出一個空間出來！！\nabstract class PieD { abstract PieD subst(SubstV func); } class Bot extends PieD { PieD subst(SubstV func){ return func.forBot(); } } class Top extends PieD { Object t; PieD r; Top(Object _t, PieD _r){ t = _t; r = _r; } PieD subst(SubstV func){ return func.forTop(t,r); } } 每個closure都是有for…,for…的話可以拉上去變成abstract嗎？ 可以！！ 直接看像是function template，但是當成function type就是PieD -\u003e PieD!!\n所以這其實代表的是function type，與ml越來越像了\ninterface PieI { PieD forBot(); PieD forTop(Object t,PieD p); } (subst : ‘a Pie -\u003e ‘a Pie) 都抽成interface了，invoke的地方要不要統一一下 假設我們有許多closure，那每個都要給一個function name在variant的class，等著丟PieI的實體嗎？ 可以設一個invoke(在書上是accept)接收closure，再把需要的參數灌進去．\nabstract class PieD { abstract PieD invoke(PieI func); } class Bot extends PieD { PieD invoke(PieI func){ return func.forBot(); } } class Top extends PieD { Object t; PieD r; Top(Object _t, PieD _r){ t = _t; r = _r; } PieD invoke(PieI func){ return func.forTop(t,r); } } class SubstV { Object n,o; // …. PieD forBot() { return new Bot(); } PieD forTop (Object t, PieD r) { if (o.equals(t)) return new Top(n, r.invoke(this)); else return new Top(t, r.invoke(this)); } } 如果clousre有狀態? 如果是有acc（有狀態的）的函數\nclass LtdSubstV implements PieVisitorI { int c; Object n; Object o; LtdSubstV(int _c, Object _n, Object _o) { c = _c; n = _n; o = _o; } public PieD forBot() { return new Bot(); } public PieD forTop(Object t, PieD r) { if (c == 0) return new Top(t, r); else if (o.equals(t)) return new Top(n, r.accept(this); //這裡的狀態應該改變 else return new Top(t, r.accept(this)); } } 那就new一下，畢竟這裡是functional programming\nclass LtdSubstV implements PieVisitorI { int c; Object n; Object o; LtdSubstV(int _c, Object _n, Object _o) { c = _c; n = _n; o = _o; } public PieD forBot() { return new Bot(); } public PieD forTop(Object t, PieD r) { if (c == 0) return new Top(t, r); else if (o.equals(t)) return new Top(n, r.accept(LtdSubstV(c-1, n, o))); else return new Top(t, r.accept(this)); } } The sixth Bit of Advice When the additional consumed values change for a self-referenced use of a visitor, don’t forget to create a new visitor.\nCh7 tree recur \u0026 object as type var tree走訪 abstract class TreeD { abstract boolean accept(bTreeVisitorI ask); abstract int accept(iTreeVisitorI ask); abstract TreeD accept(tTreeVisitorI ask); } class Bud extends TreeD { boolean accept(bTreeVisitorI ask) { return ask.forBud(); } int accept(iTreeVisitorI ask) { return ask.forBud(); } TreeD accept(tTreeVisitorI ask) { return ask.forBud(); } } class Flat extends TreeD { FruitD f; TreeD t; Flat(FruitD _f, TreeD _t) { f = _f; t = _t; } boolean accept(bTreeVisitorI ask) { return ask.forFlat(f, t); } int accept(iTreeVisitorI ask) { return ask.forFlat(f, t); } TreeD accept(tTreeVisitorI ask) { return ask.forFlat(f, t); } } class Split extends TreeD { TreeD l; TreeD r; Split(Treed _l, TreeD _r) { l = _l; r = _r; } boolean accept(bTreeVisitorI ask) { return ask.forSplit(l, r); } int accept(iTreeVisitorI ask) { return ask.forSplit(l, r); } TreeD accept(tTreeVisitorI ask) { return ask.forFlat(l, r); } } 不想每個return type都寫一個interface (那個時候應該還沒有泛型) 把不同回傳type的值合併起來\ninterface TreeVisitorI { Object forBud(); Object forFlat(FruitD f, TreeD t); Object forSplit(TreeD l, TreeD r); } abstract class TreeD { abstract Object accept(TreeVisitorI ask); } class IsFlatV implements TreeVisitorI { public Object forBud() { return new Boolean(true); } public Object forFlat(FruitD f, TreeD t) { return t.accept(this); } public Object forSplit(TreeD l, TreeD r) { return new Boolean(false); } } class IsSplitV implements bTreeVisitorI { public boolean forBud() { return new Boolean(true); } public boolean forFlat(FruitD f, TreeD t) { return new Boolean(false); } public boolean forSplit(TreeD l, TreeD r) { if (((Boolean)(l.accept(this))).booleanValue()) return r.accept(this); else return new Boolean(false); } } 因為我們目前沒有範型，用範型才比較正常\nThe seventh bit of advice When designing visitor protocols for many different types, create a unifying protocol using Object.\nCh8 arith(abstract actions) \u0026 2 types of inherence 到處都是cast interface ExprVisitorI { Object forPlus(ExprD l, ExprD r); // 相加 Object forDiff(ExprD l, ExprD r); // 相减 Object forProd(ExprD l, ExprD r); // 相乘 Object forConst(Object c); // 常量 } class IntEvalV implements ExprVisitorI { public Object forPlus(ExprD l, ExprD r){ return plus(l.accept(this), r.accept(this)); } public Object forDiff(ExprD l, ExprD r){ return diff(l.accept(this), r.accept(this)); } public Object forProd(ExprD l, ExprD r){ return prod(l.accept(this), r.accept(this)); } public Object forConst(Object c){ return c; } Object plus(Object l, Object r){ return new Integer(((Integer)l).intValue()+((Integer)r).intValue()); } Object diff(Object l, Object r){ return new Integer(((Integer)l).intValue()-((Integer)r).intValue()); } Object prod(Object l, Object r){ return new Integer(((Integer)l).intValue()*((Integer)r).intValue()); } } 為了避免大量的轉換（其實就是隱藏plus, diff, prod的實作），所以把general action拉出來．\n再抽象一次 假設這裡要一個對set操作的eval，那可以\n直接cast用method，簡單暴力 class SetEvalV extends IntEvalV { Object plus(Object l, Object r){ return ((SetD)l).plus((SetD)r); } Object diff(Object l, Object r){ return ((SetD)l).diff((SetD)r); } Object prod(Object l, Object r){ return ((SetD)l).prod((SetD)r); } } 重新拉一個class出來 abstract class EvalD implements ExprVisitorI { public Object forPlus(ExprD l, ExprD r){ return plus(l.accept(this), r.accept(this)); } public Object forDiff(ExprD l, ExprD r){ return diff(l.accept(this), r.accept(this)); } public Object forProd(ExprD l, ExprD r){ return prod(l.accept(this), r.accept(this)); } public Object forConst(Object c){ return c; } abstract Object plus(Object l, Object r); abstract Object diff(Object l, Object r); abstract Object prod(Object l, Object r); } class IntEvalV extends EvalD { Object plus(Object l, Object r){ return new Integer(((Integer)l).intValue()+((Integer)r).intValue()); } Object diff(Object l, Object r){ return new Integer(((Integer)l).intValue()-((Integer)r).intValue()); } Object prod(Object l, Object r){ return new Integer(((Integer)l).intValue()*((Integer)r).intValue()); } } class SetEvalV extends EvalD { Object plus(Object l, Object r){ return ((SetD)l).plus((SetD)r); } Object diff(Object l, Object r){ return ((SetD)l).diff((SetD)r); } Object prod(Object l, Object r){ return ((SetD)l).prod((SetD)r); } } The eighth bits of advice When extending a class, use overriding to enrich its functionality.\n繼承有兩種，一個是繼承自通用class來做出自己想要的功能，這是理想case；而第二種是複寫原有功能的繼承，雖然說這不合理，然而現實中常常看不到別人的class，只能這樣來使用．\nCh9 extend visitor 用繼承增加支援的type 當要為datatype用那種比較討厭的繼承時來加variant時，visitor要怎麼調整\ndatatype shape = Union of Shape * Shape | … func f = … func newF(Union(a,b)) = …. | newF(x) = f(x) class Union extends ShapeD { ShapeD s; ShapeD t; Union(ShapeD _s, ShapeD _t) { s = _s; t = _t; } boolean accept(ShapeVisitorI ask) { // 這裡是implement原本的abstract ((UnionVisitorI)ask).forUnion(s, t); //要自己轉，不然看不到多加的part } } interface UnionVisitorI extends ShapeVisitorI { // interface 可以 extends !!! boolean forUnion(ShapeD s, ShapeD t); } class UnionHasPtV extends HasPtV implements ShapeVisitorI { UnionHasPtV(PointD _p) { super(_p); } public boolean forUnion(ShapeD s, ShapeD t) { return s.accept(this) || t.accept(this); } } 抽象constructor 這行Trans(CartP(3,7),Union(Square(10),Circle(10))).invoke(UnionV) 陪下面的code，會出事\nclass HasPtV implements ShapeVisitorI { PointD p; HasPtV(PointD _p) { p = _p; } public boolean forCircle(int r) { return p.distanceTo0() \u003c= r; } public boolean forSquare(int s) { return p.x \u003c= s \u0026\u0026 p.y \u003c= s; } public boolean forTrans(PointD q, ShapeD s) { return s.accept(new HasPtV(p.minus(q))); // 兇手 } } 因為Trans會call到上一層的visitor，之後就回不來UnionHasPtV了！！\n所以要有辦法讓它能夠產生新的，抽象constrctor\nclass HasPtV implements ShapeVisitorI { PointD p; HasPtV(PointD _p) { p = _p; } ShapeVisitorI newHasPt(PointD p) { // factory method return new HasPtV(p); } public boolean forCircle(int r) { return p.distanceTo0() \u003c= r; } public boolean forSquare(int s) { return p.x \u003c= s \u0026\u0026 p.y \u003c= s; } public boolean forTrans(PointD q, ShapeD s) { return s.accept(newHasPtV(p.minus(q))); } } The nineth bit of advice If a datatype may have to be extended, be forward looking and use a constructor-like(override) method so that visitors can be extended too.\nfactory method pattern class UnionHasPtV extends HasPtV implements UnionVisitorI { UnionHasPtV(PointD _p) { super(_p); } ShapeVisitorI newHasPt(PointD p) { // factory method return new UnionHasPtV(p); } public boolean forUnion(ShapeD s, ShapeD t) { return s.accept(this) || t.accept(this); } } Ch10 Visitor pattern(obj作為打包好的參數\u0026state[直接修改obj]) 觀察在class的invoke，都只是把field的東西傳到closure中而已，那object其實可以直接access自己的field，那可以直接傳obj?\ninterface PieVisitorI { Object forBot(Bot that); Object forTop(Top that); } abstract class PieD { abstract Object accept(PieVisitorI ask); } class Bot extends PieD { Object accept(PieVisitorI ask) { return ask.forBot(this); } } class Top extends PieD { Object t; PieD r; Top(Object _t, Object _r) { t = _t; r = _r; } Object accept(PieVisitorI ask) { return ask.forTop(this); } } class OccursV implements PieVisitorI { Object a; OccursV(Object _a) { a = _a; } public Object forBot(Bot that) { return new Integer(0); } public Object forTop(Top that) { if (that.t.equals(a)) return new Integer(((Integer)(that.r.accept(this))).intValue()+1); else return that.r.accept(this); } } 現在是直接傳物件，那能不能直接改，這樣就不用new了\nclass SubstV implements PieVisitorI { Object n; Object o; SubstV(Object _n, Object _o) { n = _n; o = _o; } public Object forBot(Bot that) { return new Bot(); } public Object forTop(Top that) { if (o.equals(that.t)) return new Top(n, (PieD)(that.r).accept(this)); else return new Top(that.t, (PieD)(that.r).accept(this)); } } class SubstV implements PieVisitorI { Object n; Object o; SubstV(Object _n, Object _o) { n = _n; o = _o; } public Object forBot(Bot that) { return that; } public Object forTop(Top that) { if (o.equals(that.t)) that.t = n; //直接被改完了，同時r也沒變，不用設回去 that.r.accept(this); return that; } } the tenth bit of advice When modifications to objects are needed, use a class to insulate the operations that modify objects. Otherwise, beware the consequences of your actions.\nY in Java datatype 'a T = Into of 'a T -\u003e 'a fun Y(f)= H(f)(Into(H(f))) and H(f)(a) = f(G(a)) and G(Into(a))(x) = a(Into(a))(x); class Mk { Func apply(Func f) { return new Fact(f); } } class Fact { Func f; Fact(Func _f) { f = _f; } Integer apply(Integer x) { if (x == 0) return 1; else return x * f.apply(x - 1); } } class Y { Func apply(Mk f) { H h = new H(f); return h.apply(h); } } class H { Mk f; H(Mk _f) { f = _f; } H apply(H a) { return f.apply(new G(a)); } } class G { H h; G(H _h) { h = _h; } Integer apply(Integer x) { return h.apply(h).apply(x); } } ","wordCount":"2913","inLanguage":"en","image":"https://littlebees.github.io/images/papermod-cover.png","datePublished":"2021-07-07T00:19:54Z","dateModified":"2021-07-07T00:19:54Z","author":{"@type":"Person","name":"zhengcf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://littlebees.github.io/2021/07/a-little-java-a-few-patterns%E7%AD%86%E8%A8%98/"},"publisher":{"@type":"Organization","name":"記事本","logo":{"@type":"ImageObject","url":"https://littlebees.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://littlebees.github.io/ accesskey=h title="記事本 (Alt + H)">記事本</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://littlebees.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://littlebees.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://littlebees.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://littlebees.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://littlebees.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">A little java, a few patterns筆記</h1><div class=post-meta><span title='2021-07-07 00:19:54 +0000 UTC'>July 7, 2021</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;zhengcf</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8b%95%e6%a9%9f aria-label=動機>動機</a></li><li><a href=#ch1-datatype-in-java aria-label="Ch1 datatype in Java">Ch1 datatype in Java</a><ul><li><a href=#the-first-bit-of-advice aria-label="The First Bit of Advice">The First Bit of Advice</a></li></ul></li><li><a href=#ch2-list-recur--type---bool--typea---a aria-label="Ch2 list recur ( [type] -> bool & [type(‘a)] -> ‘a)">Ch2 list recur ( [type] -> bool & [type(‘a)] -> ‘a)</a><ul><li><a href=#onlya aria-label=onlyA>onlyA</a></li><li><a href=#hold_what aria-label=hold_what>hold_what</a></li><li><a href=#the-second-bit-of-advice aria-label="The Second Bit of Advice">The Second Bit of Advice</a></li><li><a href=#template-method-pattern aria-label="template method pattern">template method pattern</a></li><li><a href=#my-tip aria-label="my tip">my tip</a></li></ul></li><li><a href=#ch3-list-recur-type---type aria-label="Ch3 list recur ([type] -> [type])">Ch3 list recur ([type] -> [type])</a><ul><li><a href=#rema aria-label=remA>remA</a></li><li><a href=#appb aria-label=appB>appB</a></li><li><a href=#repa aria-label=repA>repA</a></li><li><a href=#the-third-bit-of-advice aria-label="The Third Bit of Advice">The Third Bit of Advice</a></li><li><a href=#composite--interpreter-pattern aria-label="composite & interpreter pattern">composite & interpreter pattern</a></li></ul></li><li><a href=#ch4-pattern-match-ver1pass-all-args-by-myself--func-in-abstract-class aria-label="Ch4 pattern match ver1(pass all args by myself & func in abstract class)">Ch4 pattern match ver1(pass all args by myself & func in abstract class)</a><ul><li><a href=#%e5%be%9ejava%e5%88%b0sml aria-label=從Java到SML?>從Java到SML?</a></li><li><a href=#visitor-first-try aria-label="visitor (first try)">visitor (first try)</a></li><li><a href=#the-fourth-bit-of-advice aria-label="The Fourth Bit of Advice">The Fourth Bit of Advice</a></li></ul></li><li><a href=#ch5-equalmatch-self-defined-type--object-as-type-var aria-label="Ch5 equal!?(match self-defined type) & object as type var">Ch5 equal!?(match self-defined type) & object as type var</a><ul><li><a href=#%e5%8e%9f%e6%9c%ac%e6%87%89%e8%a9%b2%e8%a6%81%e7%94%a8equals%e5%8e%bb%e5%b9%b9%e4%b8%80%e5%80%8b%e4%bd%86%e6%88%91%e6%87%b6%e6%89%80%e4%bb%a5%e7%94%a8integer aria-label=原本應該要用equals去幹一個，但我懶所以用Integer>原本應該要用equals去幹一個，但我懶所以用Integer</a></li><li><a href=#substv aria-label=SubstV>SubstV</a></li></ul></li><li><a href=#ch6-pattern-match-ver2-pass-closure-to-invoker--curry-func aria-label="Ch6 pattern match ver2 (pass closure to invoker & curry func)">Ch6 pattern match ver2 (pass closure to invoker & curry func)</a><ul><li><a href=#%e5%be%9eupper-class%e5%82%b3closure%e8%ae%8a%e6%88%90%e5%be%9e%e5%8f%83%e6%95%b8%e5%82%b3 aria-label="從upper class傳closure變成從參數傳">從upper class傳closure變成從參數傳</a></li><li><a href=#%e9%83%bd%e6%8a%bd%e6%88%90interface%e4%ba%86invoke%e7%9a%84%e5%9c%b0%e6%96%b9%e8%a6%81%e4%b8%8d%e8%a6%81%e7%b5%b1%e4%b8%80%e4%b8%80%e4%b8%8b aria-label=都抽成interface了，invoke的地方要不要統一一下>都抽成interface了，invoke的地方要不要統一一下</a></li><li><a href=#%e5%a6%82%e6%9e%9cclousre%e6%9c%89%e7%8b%80%e6%85%8b aria-label=如果clousre有狀態?>如果clousre有狀態?</a></li><li><a href=#the-sixth-bit-of-advice aria-label="The sixth Bit of Advice">The sixth Bit of Advice</a></li></ul></li><li><a href=#ch7-tree-recur--object-as-type-var aria-label="Ch7 tree recur & object as type var">Ch7 tree recur & object as type var</a><ul><li><a href=#tree%e8%b5%b0%e8%a8%aa aria-label=tree走訪>tree走訪</a></li><li><a href=#%e4%b8%8d%e6%83%b3%e6%af%8f%e5%80%8breturn-type%e9%83%bd%e5%af%ab%e4%b8%80%e5%80%8binterface-%e9%82%a3%e5%80%8b%e6%99%82%e5%80%99%e6%87%89%e8%a9%b2%e9%82%84%e6%b2%92%e6%9c%89%e6%b3%9b%e5%9e%8b aria-label="不想每個return type都寫一個interface (那個時候應該還沒有泛型)">不想每個return type都寫一個interface (那個時候應該還沒有泛型)</a></li><li><a href=#the-seventh-bit-of-advice aria-label="The seventh bit of advice">The seventh bit of advice</a></li></ul></li><li><a href=#ch8-arithabstract-actions--2-types-of-inherence aria-label="Ch8 arith(abstract actions) & 2 types of inherence">Ch8 arith(abstract actions) & 2 types of inherence</a><ul><li><a href=#%e5%88%b0%e8%99%95%e9%83%bd%e6%98%afcast aria-label=到處都是cast>到處都是cast</a></li><li><a href=#%e5%86%8d%e6%8a%bd%e8%b1%a1%e4%b8%80%e6%ac%a1 aria-label=再抽象一次>再抽象一次</a></li><li><a href=#the-eighth-bits-of-advice aria-label="The eighth bits of advice">The eighth bits of advice</a></li></ul></li><li><a href=#ch9-extend-visitor aria-label="Ch9 extend visitor">Ch9 extend visitor</a><ul><li><a href=#%e7%94%a8%e7%b9%bc%e6%89%bf%e5%a2%9e%e5%8a%a0%e6%94%af%e6%8f%b4%e7%9a%84type aria-label=用繼承增加支援的type>用繼承增加支援的type</a></li><li><a href=#%e6%8a%bd%e8%b1%a1constructor aria-label=抽象constructor>抽象constructor</a></li><li><a href=#the-nineth-bit-of-advice aria-label="The nineth bit of advice">The nineth bit of advice</a></li><li><a href=#factory-method-pattern aria-label="factory method pattern">factory method pattern</a></li></ul></li><li><a href=#ch10-visitor-patternobj%e4%bd%9c%e7%82%ba%e6%89%93%e5%8c%85%e5%a5%bd%e7%9a%84%e5%8f%83%e6%95%b8state%e7%9b%b4%e6%8e%a5%e4%bf%ae%e6%94%b9obj aria-label="Ch10 Visitor pattern(obj作為打包好的參數&amp;state[直接修改obj])">Ch10 Visitor pattern(obj作為打包好的參數&amp;state[直接修改obj])</a><ul><li><a href=#the-tenth-bit-of-advice aria-label="the tenth bit of advice">the tenth bit of advice</a></li></ul></li><li><a href=#y-in-java aria-label="Y in Java">Y in Java</a></li></ul></div></details></div><div class=post-content><h2 id=動機>動機<a hidden class=anchor aria-hidden=true href=#動機>#</a></h2><p>這已經雪藏很久了，久在github page還沒用到之前就在我的google docs中
整理一下貼出來</p><h2 id=ch1-datatype-in-java>Ch1 datatype in Java<a hidden class=anchor aria-hidden=true href=#ch1-datatype-in-java>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>N</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Zero</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>AddOne</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></div><p>=></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=kt>N</span> <span class=p>=</span> <span class=nc>Zero</span> <span class=p>|</span> <span class=nc>AddOne</span> <span class=kr>of</span> <span class=n>N</span>
</span></span></code></pre></div><p>就是datatype</p><h3 id=the-first-bit-of-advice>The First Bit of Advice<a hidden class=anchor aria-hidden=true href=#the-first-bit-of-advice>#</a></h3><p>When specifying a collection data, use abstract classes for datatypes and extended classes for variants.</p><h2 id=ch2-list-recur--type---bool--typea---a>Ch2 list recur ( [type] -> bool & [type(‘a)] -> ‘a)<a hidden class=anchor aria-hidden=true href=#ch2-list-recur--type---bool--typea---a>#</a></h2><h3 id=onlya>onlyA<a hidden class=anchor aria-hidden=true href=#onlya>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>onlyA</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>ab.{{func}}</code>，在ML中的ab是{{func}}的參數！！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=kt>Ab</span> <span class=p>=</span> <span class=nc>Base</span> <span class=p>|</span> <span class=nc>A</span> <span class=kr>of</span> <span class=n>Ab</span> <span class=p>|</span> <span class=nc>B</span> <span class=kr>of</span> <span class=n>Ab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>fun</span> <span class=nf>onlyA</span><span class=p>(</span><span class=n>Base</span><span class=p>)</span> <span class=n>=</span> <span class=n>true</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>onlyA</span><span class=p>(</span><span class=n>A</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>onlyA</span><span class=p>(</span><span class=n>ab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>onlyA</span><span class=p>(</span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>false</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>onlyA</span> <span class=n>:</span> <span class=n>Ab</span> <span class=n>-&gt;</span> <span class=n>bool</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=hold_what>hold_what<a hidden class=anchor aria-hidden=true href=#hold_what>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>hold_what</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Object</span><span class=w> </span><span class=n>hold</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Base</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_hold</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>hold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_hold</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Object</span><span class=w> </span><span class=nf>hold_what</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>hold</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Object</span><span class=w> </span><span class=nf>hold_what</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>hold_what</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>onlyA</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Object</span><span class=w> </span><span class=nf>hold_what</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>hold_what</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=err>‘a</span> <span class=n>Ab</span> <span class=n>=</span> <span class=n>Base</span> <span class=kr>of</span> <span class=err>‘a</span> <span class=n>|</span> <span class=n>A</span> <span class=kr>of</span> <span class=n>Ab</span> <span class=n>|</span> <span class=n>B</span> <span class=kr>of</span> <span class=n>Ab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>fun</span> <span class=nf>hold_what</span><span class=p>(</span><span class=n>Base</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=n>=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>hold_what</span><span class=p>(</span><span class=n>A</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>hold_what</span><span class=p>(</span><span class=n>ab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>hold_what</span><span class=p>(</span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>hold_what</span><span class=p>(</span><span class=n>ab</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>hold_what</span> <span class=n>:</span> <span class=err>‘a</span> <span class=n>Ab</span> <span class=n>-&gt;</span> <span class=err>‘a)</span>
</span></span></code></pre></div><h3 id=the-second-bit-of-advice>The Second Bit of Advice<a hidden class=anchor aria-hidden=true href=#the-second-bit-of-advice>#</a></h3><p>When writing a function over a datatype, place a method in each of the variants that make up the datatype. If a field of a variant belongs to the same datatype, the method may call the corresponding method of the field in computing the function.</p><h3 id=template-method-pattern>template method pattern<a hidden class=anchor aria-hidden=true href=#template-method-pattern>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Point</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kd>abstract</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>closerTo</span><span class=p>(</span><span class=n>Point</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kd>abstract</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>dist</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>C</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Point</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>C</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=n>y</span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>;}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>colserTo</span><span class=p>(</span><span class=n>Point</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>dist</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>dist</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>int</span><span class=w> </span><span class=nf>dist</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>abs</span><span class=p>(</span><span class=n>sqrt</span><span class=p>(</span><span class=n>x</span><span class=o>*</span><span class=n>x</span><span class=o>+</span><span class=n>y</span><span class=o>*</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>M</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Point</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>C</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=n>y</span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>;}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>colserTo</span><span class=p>(</span><span class=n>Point</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>dist</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>dist</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>int</span><span class=w> </span><span class=nf>dist</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=o>+</span><span class=n>y</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以把相同的抽到abstract放著</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Point</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>closerTo</span><span class=p>(</span><span class=n>Point</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>dist</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>dist</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kd>abstract</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>dist</span><span class=p>();</span><span class=w> </span><span class=c1>// template，template method pattern</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=my-tip>my tip<a hidden class=anchor aria-hidden=true href=#my-tip>#</a></h3><p>在所有variant都一樣的function，可以放到abstract class</p><h2 id=ch3-list-recur-type---type>Ch3 list recur ([type] -> [type])<a hidden class=anchor aria-hidden=true href=#ch3-list-recur-type---type>#</a></h2><h3 id=rema>remA<a hidden class=anchor aria-hidden=true href=#rema>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Base</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>.</span><span class=na>remA</span><span class=p>());</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>remA</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=kt>Ab</span> <span class=p>=</span> <span class=nc>Base</span> <span class=p>|</span> <span class=nc>A</span> <span class=kr>of</span> <span class=n>Ab</span> <span class=p>|</span> <span class=nc>B</span> <span class=kr>of</span> <span class=n>Ab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>fun</span> <span class=nf>remA</span><span class=p>(</span><span class=n>Base</span><span class=p>)</span> <span class=n>=</span> <span class=n>Base</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>remA</span><span class=p>(</span><span class=n>A</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>remA</span><span class=p>(</span><span class=n>ab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>remA</span><span class=p>(</span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>B</span><span class=p>(</span><span class=n>remA</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>remA</span> <span class=n>:</span> <span class=n>Ab</span> <span class=n>-&gt;</span> <span class=n>Ab</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=appb>appB<a hidden class=anchor aria-hidden=true href=#appb>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=nf>appB</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Base</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>appB</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Base</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>.</span><span class=na>remA</span><span class=p>());</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>appB</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>.</span><span class=na>appB</span><span class=p>());</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>remA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>remA</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>appB</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>B</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>A</span><span class=p>(</span><span class=n>ab</span><span class=p>.</span><span class=na>appB</span><span class=p>()));</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>(這還需要翻成ML嗎)</p><p>如果 <code>appB().remA()</code>，其實與replace A成B是一樣的所以</p><h3 id=repa>repA<a hidden class=anchor aria-hidden=true href=#repa>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=nf>repA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>repA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Base</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>repA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>.</span><span class=na>repA</span><span class=p>());</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=nf>repA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>.</span><span class=na>repA</span><span class=p>());</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=the-third-bit-of-advice>The Third Bit of Advice<a hidden class=anchor aria-hidden=true href=#the-third-bit-of-advice>#</a></h3><p>When writing a function that returns values of a datatype, use new to create these values.</p><h3 id=composite--interpreter-pattern>composite & interpreter pattern<a hidden class=anchor aria-hidden=true href=#composite--interpreter-pattern>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>PizzaD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>remA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>topAwC</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Crust</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Crust</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>topAwC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Crust</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Crust</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Cheese</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cheese</span><span class=w> </span><span class=p>(</span><span class=n>PizzaD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>remA</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cheese</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>remA</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>topAwC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cheese</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>topAwC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cheese</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>subAbC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Olive</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Olive</span><span class=w> </span><span class=p>(</span><span class=n>PizzaD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>remA</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Olive</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>remA</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>topAwC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Olive</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>topAwC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Olive</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>subAbC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Anchovy</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Anchovy</span><span class=w> </span><span class=p>(</span><span class=n>PizzaD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>remA</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>remA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>topAwC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cheese</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Anchovy</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>topAwC</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cheese</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>subAbC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Sausage</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PizzaD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Sausage</span><span class=w> </span><span class=p>(</span><span class=n>PizzaD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>remA</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Sausage</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>remA</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>topAwC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Sausage</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>topAwC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PizzaD</span><span class=w> </span><span class=nf>subAbC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Sausage</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>subAbC</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>這兩個pattern的本質是都是自己嵌套自己的datatype，所以可以達成如同list效果，可以無限嵌套來組合</p><h2 id=ch4-pattern-match-ver1pass-all-args-by-myself--func-in-abstract-class>Ch4 pattern match ver1(pass all args by myself & func in abstract class)<a hidden class=anchor aria-hidden=true href=#ch4-pattern-match-ver1pass-all-args-by-myself--func-in-abstract-class>#</a></h2><h3 id=從java到sml>從Java到SML?<a hidden class=anchor aria-hidden=true href=#從java到sml>#</a></h3><p>先複習onlyA</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>onlyA</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>接著改寫成像ML的樣子，把<strong>所有動作都放到同一個地方</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>OnlyA</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// closure!! OR visitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forBase</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forA</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>ab</span><span class=p>.</span><span class=na>onlyA</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forB</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=kt>Ab</span> <span class=p>=</span> <span class=nc>Base</span> <span class=p>|</span> <span class=nc>A</span> <span class=kr>of</span> <span class=n>Ab</span> <span class=p>|</span> <span class=nc>B</span> <span class=kr>of</span> <span class=n>Ab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>fun</span> <span class=nf>onlyA</span><span class=p>(</span><span class=n>Base</span><span class=p>)</span> <span class=n>=</span> <span class=n>true</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>onlyA</span><span class=p>(</span><span class=n>A</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>onlyA</span><span class=p>(</span><span class=n>ab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nf>onlyA</span><span class=p>(</span><span class=n>B</span><span class=p>(</span><span class=n>ab</span><span class=p>))</span> <span class=n>=</span> <span class=n>false</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>onlyA</span> <span class=n>:</span> <span class=n>Ab</span> <span class=n>-&gt;</span> <span class=n>bool</span><span class=p>)</span>
</span></span></code></pre></div><p>這下把執行動作從variant分離出來了．</p><p>但這要怎麼用？？
如果這closure固定在一個所有variant可以碰到的地方的話</p><h3 id=visitor-first-try>visitor (first try)<a hidden class=anchor aria-hidden=true href=#visitor-first-try>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>OnlyA</span><span class=w> </span><span class=n>func</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OnlyA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Base</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forBase</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>B</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>B</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forB</span><span class=p>(</span><span class=n>ab</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>A</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Ab</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>Ab</span><span class=w> </span><span class=n>ab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>A</span><span class=p>(</span><span class=n>Ab</span><span class=w> </span><span class=n>_ab</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>ab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_ab</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onlyA</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forA</span><span class=p>(</span><span class=n>ab</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=the-fourth-bit-of-advice>The Fourth Bit of Advice<a hidden class=anchor aria-hidden=true href=#the-fourth-bit-of-advice>#</a></h3><p>When writing several functions for the same self-referential datatype, use visitor protocols so that all methods for a function can be found in a single class.</p><h2 id=ch5-equalmatch-self-defined-type--object-as-type-var>Ch5 equal!?(match self-defined type) & object as type var<a hidden class=anchor aria-hidden=true href=#ch5-equalmatch-self-defined-type--object-as-type-var>#</a></h2><h3 id=原本應該要用equals去幹一個但我懶所以用integer>原本應該要用equals去幹一個，但我懶所以用Integer<a hidden class=anchor aria-hidden=true href=#原本應該要用equals去幹一個但我懶所以用integer>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Rem1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>IntList</span><span class=w> </span><span class=nf>forNull</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Null</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>IntList</span><span class=w> </span><span class=nf>forCons</span><span class=p>(</span><span class=n>IntList</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>i</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=na>rem1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cons</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>l</span><span class=p>.</span><span class=na>rem1</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>IntList</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Rem1</span><span class=w> </span><span class=n>func</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Rem1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>abstract</span><span class=w> </span><span class=n>IntList</span><span class=w> </span><span class=nf>rem1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Null</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IntList</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>IntList</span><span class=w> </span><span class=nf>rem1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forNull</span><span class=p>();</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Cons</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IntList</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Integer</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>IntList</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// …..</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>IntList</span><span class=w> </span><span class=nf>rem1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forCons</span><span class=p>(</span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>這裡省略了一個地方，因為我這裡是用integer所以不用override euqals，但是書上是自訂的class(variant)，所以要用equals要自己實作，而相等的條件就是同類的class的實體，所以用instanceof．</p><h3 id=substv>SubstV<a hidden class=anchor aria-hidden=true href=#substv>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SubstV</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>forBot</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>forTop</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>subst</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>subst</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RemV</span><span class=w> </span><span class=n>remFn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RemV</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SubsbV</span><span class=w> </span><span class=n>substFn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SubstV</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>rem</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>subst</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Bot</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>rem</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>remFn</span><span class=p>.</span><span class=na>forBot</span><span class=p>(</span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>subst</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>substFn</span><span class=p>.</span><span class=na>forBot</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Top</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w> </span><span class=c1>// type var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Top</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>_r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>rem</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>remFn</span><span class=p>.</span><span class=na>forTop</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>subst</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>substFn</span><span class=p>.</span><span class=na>forTop</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>這是不是與list很像，不過注意到subst的Object n, Object o在遞迴的時候其實不會變，所以應該要把它抽出來，scheme是letrec或curry，ML是curry，那這邊要怎麼做？</p><h2 id=ch6-pattern-match-ver2-pass-closure-to-invoker--curry-func>Ch6 pattern match ver2 (pass closure to invoker & curry func)<a hidden class=anchor aria-hidden=true href=#ch6-pattern-match-ver2-pass-closure-to-invoker--curry-func>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SubstV</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ….</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>forBot</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>forTop</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>subst</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>subst</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如果照原本的把closure固定在一個所有variant可以碰到的地方的方式，我們沒機會使用我們自己new出來的clousre!!</p><h3 id=從upper-class傳closure變成從參數傳>從upper class傳closure變成從參數傳<a hidden class=anchor aria-hidden=true href=#從upper-class傳closure變成從參數傳>#</a></h3><p>那要做出一個空間出來！！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>subst</span><span class=p>(</span><span class=n>SubstV</span><span class=w> </span><span class=n>func</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Bot</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>subst</span><span class=p>(</span><span class=n>SubstV</span><span class=w> </span><span class=n>func</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forBot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Top</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Top</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>_r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>subst</span><span class=p>(</span><span class=n>SubstV</span><span class=w> </span><span class=n>func</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forTop</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>每個closure都是有for&mldr;,for&mldr;的話可以拉上去變成abstract嗎？
可以！！ 直接看像是function template，但是當成function type就是PieD -> PieD!!</p><p>所以這其實代表的是function type，與ml越來越像了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>PieI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>PieD</span><span class=w> </span><span class=nf>forBot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>PieD</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=n>PieD</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=p>(</span><span class=n>subst</span> <span class=n>:</span> <span class=err>‘a</span> <span class=n>Pie</span> <span class=n>-&gt;</span> <span class=err>‘a</span> <span class=n>Pie</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=都抽成interface了invoke的地方要不要統一一下>都抽成interface了，invoke的地方要不要統一一下<a hidden class=anchor aria-hidden=true href=#都抽成interface了invoke的地方要不要統一一下>#</a></h3><p>假設我們有許多closure，那每個都要給一個function name在variant的class，等著丟PieI的實體嗎？
可以設一個invoke(在書上是accept)接收closure，再把需要的參數灌進去．</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>PieI</span><span class=w> </span><span class=n>func</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Bot</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>PieI</span><span class=w> </span><span class=n>func</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forBot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Top</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Top</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>_r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>PieI</span><span class=w> </span><span class=n>func</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>forTop</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>SubstV</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ….</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>forBot</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=nf>forTop</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=如果clousre有狀態>如果clousre有狀態?<a hidden class=anchor aria-hidden=true href=#如果clousre有狀態>#</a></h3><p>如果是有acc（有狀態的）的函數</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>LtdSubstV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>PieVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LtdSubstV</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>_c</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>forBot</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w> </span><span class=c1>//這裡的狀態應該改變</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>那就new一下，畢竟這裡是functional programming</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>LtdSubstV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>PieVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LtdSubstV</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>_c</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>forBot</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>LtdSubstV</span><span class=p>(</span><span class=n>c</span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=the-sixth-bit-of-advice>The sixth Bit of Advice<a hidden class=anchor aria-hidden=true href=#the-sixth-bit-of-advice>#</a></h3><p>When the additional consumed values change for a self-referenced use of a visitor, don’t forget to create a new visitor.</p><h2 id=ch7-tree-recur--object-as-type-var>Ch7 tree recur & object as type var<a hidden class=anchor aria-hidden=true href=#ch7-tree-recur--object-as-type-var>#</a></h2><h3 id=tree走訪>tree走訪<a hidden class=anchor aria-hidden=true href=#tree走訪>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>TreeD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>bTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>iTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>tTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Bud</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>bTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forBud</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>iTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forBud</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TreeD</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>tTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forBud</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Flat</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FruitD</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TreeD</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Flat</span><span class=p>(</span><span class=n>FruitD</span><span class=w> </span><span class=n>_f</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>_t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>bTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forFlat</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>iTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forFlat</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TreeD</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>tTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forFlat</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Split</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TreeD</span><span class=w> </span><span class=n>l</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TreeD</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Split</span><span class=p>(</span><span class=n>Treed</span><span class=w> </span><span class=n>_l</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>_r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_l</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>bTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forSplit</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>iTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forSplit</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TreeD</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>tTreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forFlat</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=不想每個return-type都寫一個interface-那個時候應該還沒有泛型>不想每個return type都寫一個interface (那個時候應該還沒有泛型)<a hidden class=anchor aria-hidden=true href=#不想每個return-type都寫一個interface-那個時候應該還沒有泛型>#</a></h3><p>把不同回傳type的值合併起來</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>TreeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forBud</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forFlat</span><span class=p>(</span><span class=n>FruitD</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forSplit</span><span class=p>(</span><span class=n>TreeD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>TreeD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>TreeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>IsFlatV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>TreeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forBud</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Boolean</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forFlat</span><span class=p>(</span><span class=n>FruitD</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forSplit</span><span class=p>(</span><span class=n>TreeD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Boolean</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>IsSplitV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>bTreeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forBud</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Boolean</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forFlat</span><span class=p>(</span><span class=n>FruitD</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Boolean</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forSplit</span><span class=p>(</span><span class=n>TreeD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>TreeD</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(((</span><span class=n>Boolean</span><span class=p>)(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>))).</span><span class=na>booleanValue</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Boolean</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>因為我們目前沒有範型，用範型才比較正常</p><h3 id=the-seventh-bit-of-advice>The seventh bit of advice<a hidden class=anchor aria-hidden=true href=#the-seventh-bit-of-advice>#</a></h3><p>When designing visitor protocols for many different types, create a unifying protocol using Object.</p><h2 id=ch8-arithabstract-actions--2-types-of-inherence>Ch8 arith(abstract actions) & 2 types of inherence<a hidden class=anchor aria-hidden=true href=#ch8-arithabstract-actions--2-types-of-inherence>#</a></h2><h3 id=到處都是cast>到處都是cast<a hidden class=anchor aria-hidden=true href=#到處都是cast>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>ExprVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forPlus</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w> </span><span class=c1>// 相加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forDiff</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w> </span><span class=c1>// 相减</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forProd</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w> </span><span class=c1>// 相乘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forConst</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w> </span><span class=c1>// 常量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>IntEvalV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ExprVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forPlus</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>plus</span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forDiff</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>diff</span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forProd</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>prod</span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forConst</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>c</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>plus</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>intValue</span><span class=p>()</span><span class=o>+</span><span class=p>((</span><span class=n>Integer</span><span class=p>)</span><span class=n>r</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>diff</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>intValue</span><span class=p>()</span><span class=o>-</span><span class=p>((</span><span class=n>Integer</span><span class=p>)</span><span class=n>r</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>prod</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>intValue</span><span class=p>()</span><span class=o>*</span><span class=p>((</span><span class=n>Integer</span><span class=p>)</span><span class=n>r</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>為了避免大量的轉換（其實就是隱藏plus, diff, prod的實作），所以把general action拉出來．</p><h3 id=再抽象一次>再抽象一次<a hidden class=anchor aria-hidden=true href=#再抽象一次>#</a></h3><p>假設這裡要一個對set操作的eval，那可以</p><ol><li>直接cast用method，簡單暴力</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SetEvalV</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IntEvalV</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>plus</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>plus</span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>diff</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>diff</span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>prod</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>prod</span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol start=2><li>重新拉一個class出來</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>EvalD</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ExprVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forPlus</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>plus</span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forDiff</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>diff</span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forProd</span><span class=p>(</span><span class=n>ExprD</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>ExprD</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>prod</span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forConst</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>c</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>plus</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>diff</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>prod</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>IntEvalV</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>EvalD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>plus</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>intValue</span><span class=p>()</span><span class=o>+</span><span class=p>((</span><span class=n>Integer</span><span class=p>)</span><span class=n>r</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>diff</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>intValue</span><span class=p>()</span><span class=o>-</span><span class=p>((</span><span class=n>Integer</span><span class=p>)</span><span class=n>r</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>prod</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>intValue</span><span class=p>()</span><span class=o>*</span><span class=p>((</span><span class=n>Integer</span><span class=p>)</span><span class=n>r</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>SetEvalV</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>EvalD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>plus</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>plus</span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>diff</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>diff</span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>prod</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>r</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>l</span><span class=p>).</span><span class=na>prod</span><span class=p>((</span><span class=n>SetD</span><span class=p>)</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=the-eighth-bits-of-advice>The eighth bits of advice<a hidden class=anchor aria-hidden=true href=#the-eighth-bits-of-advice>#</a></h3><p>When extending a class, use overriding to enrich its functionality.</p><p>繼承有兩種，一個是繼承自通用class來做出自己想要的功能，這是理想case；而第二種是複寫原有功能的繼承，雖然說這不合理，然而現實中常常看不到別人的class，只能這樣來使用．</p><h2 id=ch9-extend-visitor>Ch9 extend visitor<a hidden class=anchor aria-hidden=true href=#ch9-extend-visitor>#</a></h2><h3 id=用繼承增加支援的type>用繼承增加支援的type<a hidden class=anchor aria-hidden=true href=#用繼承增加支援的type>#</a></h3><p>當要為datatype用那種比較討厭的繼承時來加variant時，visitor要怎麼調整</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=kt>shape</span> <span class=p>=</span> <span class=nc>Union</span> <span class=kr>of</span> <span class=n>Shape</span> <span class=n>*</span> <span class=n>Shape</span> <span class=n>|</span> <span class=err>…</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>func</span> <span class=n>f</span> <span class=n>=</span> <span class=err>…</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>func</span> <span class=n>newF</span><span class=p>(</span><span class=n>Union</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>))</span> <span class=n>=</span> <span class=err>….</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span> <span class=nc>newF</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=n>=</span> <span class=n>f</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Union</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ShapeD</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ShapeD</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Union</span><span class=p>(</span><span class=n>ShapeD</span><span class=w> </span><span class=n>_s</span><span class=p>,</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=n>_t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 這裡是implement原本的abstract</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>((</span><span class=n>UnionVisitorI</span><span class=p>)</span><span class=n>ask</span><span class=p>).</span><span class=na>forUnion</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w> </span><span class=c1>//要自己轉，不然看不到多加的part</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>UnionVisitorI</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// interface 可以 extends !!!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forUnion</span><span class=p>(</span><span class=n>ShapeD</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UnionHasPtV</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HasPtV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UnionHasPtV</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>_p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forUnion</span><span class=p>(</span><span class=n>ShapeD</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=抽象constructor>抽象constructor<a hidden class=anchor aria-hidden=true href=#抽象constructor>#</a></h3><p>這行<code>Trans(CartP(3,7),Union(Square(10),Circle(10))).invoke(UnionV)</code>
陪下面的code，會出事</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>HasPtV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PointD</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HasPtV</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forCircle</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>distanceTo0</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forSquare</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>x</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forTrans</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>q</span><span class=p>,</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HasPtV</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>minus</span><span class=p>(</span><span class=n>q</span><span class=p>)));</span><span class=w> </span><span class=c1>// 兇手</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>因為Trans會call到上一層的visitor，之後就回不來UnionHasPtV了！！</p><p>所以要有辦法讓它能夠產生新的，抽象constrctor</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>HasPtV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PointD</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HasPtV</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=nf>newHasPt</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// factory method</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HasPtV</span><span class=p>(</span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forCircle</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>distanceTo0</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forSquare</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>x</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forTrans</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>q</span><span class=p>,</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>newHasPtV</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>minus</span><span class=p>(</span><span class=n>q</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=the-nineth-bit-of-advice>The nineth bit of advice<a hidden class=anchor aria-hidden=true href=#the-nineth-bit-of-advice>#</a></h3><p>If a datatype may have to be extended, be forward looking and use a constructor-like(override) method so that visitors can be extended too.</p><h3 id=factory-method-pattern>factory method pattern<a hidden class=anchor aria-hidden=true href=#factory-method-pattern>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>UnionHasPtV</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HasPtV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UnionVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UnionHasPtV</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>_p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>_p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ShapeVisitorI</span><span class=w> </span><span class=nf>newHasPt</span><span class=p>(</span><span class=n>PointD</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// factory method</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnionHasPtV</span><span class=p>(</span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>forUnion</span><span class=p>(</span><span class=n>ShapeD</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>ShapeD</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=ch10-visitor-patternobj作為打包好的參數state直接修改obj>Ch10 Visitor pattern(obj作為打包好的參數&amp;state[直接修改obj])<a hidden class=anchor aria-hidden=true href=#ch10-visitor-patternobj作為打包好的參數state直接修改obj>#</a></h2><p>觀察在class的invoke，都只是把field的東西傳到closure中而已，那object其實可以直接access自己的field，那可以直接傳obj?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>PieVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forBot</span><span class=p>(</span><span class=n>Bot</span><span class=w> </span><span class=n>that</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Top</span><span class=w> </span><span class=n>that</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>PieVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Bot</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>PieVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forBot</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Top</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>PieD</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PieD</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Top</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_t</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>PieVisitorI</span><span class=w> </span><span class=n>ask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ask</span><span class=p>.</span><span class=na>forTop</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>OccursV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>PieVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>OccursV</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_a</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forBot</span><span class=p>(</span><span class=n>Bot</span><span class=w> </span><span class=n>that</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Top</span><span class=w> </span><span class=n>that</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>that</span><span class=p>.</span><span class=na>t</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>a</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=p>(((</span><span class=n>Integer</span><span class=p>)(</span><span class=n>that</span><span class=p>.</span><span class=na>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>))).</span><span class=na>intValue</span><span class=p>()</span><span class=o>+</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>that</span><span class=p>.</span><span class=na>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>現在是直接傳物件，那能不能直接改，這樣就不用new了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SubstV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>PieVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SubstV</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forBot</span><span class=p>(</span><span class=n>Bot</span><span class=w> </span><span class=n>that</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Top</span><span class=w> </span><span class=n>that</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>that</span><span class=p>.</span><span class=na>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>PieD</span><span class=p>)(</span><span class=n>that</span><span class=p>.</span><span class=na>r</span><span class=p>).</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Top</span><span class=p>(</span><span class=n>that</span><span class=p>.</span><span class=na>t</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>PieD</span><span class=p>)(</span><span class=n>that</span><span class=p>.</span><span class=na>r</span><span class=p>).</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>SubstV</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>PieVisitorI</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SubstV</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>_n</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forBot</span><span class=p>(</span><span class=n>Bot</span><span class=w> </span><span class=n>that</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>that</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>forTop</span><span class=p>(</span><span class=n>Top</span><span class=w> </span><span class=n>that</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>that</span><span class=p>.</span><span class=na>t</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>that</span><span class=p>.</span><span class=na>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>  </span><span class=c1>//直接被改完了，同時r也沒變，不用設回去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>that</span><span class=p>.</span><span class=na>r</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>that</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=the-tenth-bit-of-advice>the tenth bit of advice<a hidden class=anchor aria-hidden=true href=#the-tenth-bit-of-advice>#</a></h3><p>When modifications to objects are needed, use a class to insulate the operations that modify objects. Otherwise, beware the consequences of your actions.</p><h2 id=y-in-java>Y in Java<a hidden class=anchor aria-hidden=true href=#y-in-java>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sml data-lang=sml><span class=line><span class=cl><span class=kr>datatype</span> <span class=nd>&#39;a</span> <span class=kt>T</span> <span class=p>=</span> <span class=nc>Into</span> <span class=kr>of</span> <span class=nd>&#39;a</span> <span class=n>T</span> <span class=n>-&gt;</span> <span class=nd>&#39;a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>fun</span> <span class=nf>Y</span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=n>=</span> <span class=n>H</span><span class=p>(</span><span class=n>f</span><span class=p>)(</span><span class=n>Into</span><span class=p>(</span><span class=n>H</span><span class=p>(</span><span class=n>f</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=kr>and</span> <span class=nf>H</span><span class=p>(</span><span class=n>f</span><span class=p>)(</span><span class=n>a</span><span class=p>)</span> <span class=n>=</span> <span class=n>f</span><span class=p>(</span><span class=n>G</span><span class=p>(</span><span class=n>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=kr>and</span> <span class=nf>G</span><span class=p>(</span><span class=n>Into</span><span class=p>(</span><span class=n>a</span><span class=p>))(</span><span class=n>x</span><span class=p>)</span> <span class=n>=</span> <span class=n>a</span><span class=p>(</span><span class=n>Into</span><span class=p>(</span><span class=n>a</span><span class=p>))(</span><span class=n>x</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Mk</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Func</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=n>Func</span><span class=w> </span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Fact</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Fact</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Func</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Fact</span><span class=p>(</span><span class=n>Func</span><span class=w> </span><span class=n>_f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Integer</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>else</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Y</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Func</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=n>Mk</span><span class=w> </span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>H</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>H</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>H</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Mk</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>H</span><span class=p>(</span><span class=n>Mk</span><span class=w> </span><span class=n>_f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>H</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=n>H</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>G</span><span class=p>(</span><span class=n>a</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>G</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>H</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>G</span><span class=p>(</span><span class=n>H</span><span class=w> </span><span class=n>_h</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Integer</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>h</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://littlebees.github.io/tags/java/>Java</a></li></ul><nav class=paginav><a class=prev href=https://littlebees.github.io/2021/07/competitive-programming%E7%9A%84tips/><span class=title>« Prev</span><br><span>competitive programming的tips</span>
</a><a class=next href=https://littlebees.github.io/2021/07/bit-tricks/><span class=title>Next »</span><br><span>bit tricks</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://littlebees.github.io/>記事本</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>